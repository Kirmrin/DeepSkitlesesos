user: –ò–∑—É—á–∏

—Ä–∞—Å–ø–∏—à–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Ç–µ–∫—Å—Ç–æ–º

assistant: ÊÄùËÄÉÔºö–ú—ã –∏–º–µ–µ–º JSON-—Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è Telegram.–ó–∞–ø—Ä–æ—Å: —Ä–∞—Å–ø–∏—Å–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Ç–µ–∫—Å—Ç–æ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞:- –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∏–∞–ª–æ–≥ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º, –≥–¥–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.- –û–ø–∏—Å–∞–Ω–∏–µ –≤–∫–ª—é—á–∞–µ—Ç: –æ–±—â—É—é —Å—Ö–µ–º—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–≤ –≤–∏–¥–µ Mermaid-–¥–∏–∞–≥—Ä–∞–º–º—ã), –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫, –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.–ü–ª–∞–Ω –æ—Ç–≤–µ—Ç–∞:1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã (—Å–ª–æ–∏ –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ—Ç–æ–∫–∏).2. –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø–æ —Å–ª–æ—è–º.3. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫.4. –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫).5. –ê—Å–ø–µ–∫—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.6. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ.7. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞.8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Å—Å—ã–ª–∫–∏.–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º, –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ, –Ω–æ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ (–±–µ–∑ Mermaid-–¥–∏–∞–≥—Ä–∞–º–º, –Ω–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å–≤—è–∑–µ–π).–ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞: –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è Telegram1. –û–±—â–∞—è —Å—Ö–µ–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 4 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ—ë–≤:Telegram Layer: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.Orchestration Layer: –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –Ω—É–∂–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º.Processing Layer:Analytics Pipeline: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö).Documentation Helper: –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.Output Layer: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.Support Services: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥).–°–≤—è–∑–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram Bot ‚Üí API Gateway ‚Üí Router Agent ‚Üí {Analytics Pipeline, Documentation Helper, General Assistant} ‚Üí Response Formatter ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –õ—é–±–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Üí Fallback Agent ‚Üí –ü–æ–≤—Ç–æ—Ä/–£–ø—Ä–æ—â–µ–Ω–∏–µ/–≠—Å–∫–∞–ª–∞—Ü–∏—è –≤ Jira/Slack.2. –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤2.1. Telegram LayerTelegram Bot (`python-telegram-bot`):–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç/—Ñ–∞–π–ª—ã.–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: –í–µ–±—Ö—É–∫, –ª–∏–º–∏—Ç 30 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫, –º–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è 4096 —Å–∏–º–≤–æ–ª–æ–≤.Webhook Handler (FastAPI):–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω.2.2. Orchestration LayerAPI Gateway (FastAPI):–§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞: `{"user_id": "UA-142", "text": "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–∞–π", "chat_id": "123456789"}`.–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: `{"response": "...", "type": "image/text/file", "sources": ["db", "web"]}`.Router Agent (LLM GigaChat):–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã: `analytics` (–æ—Ç—á—ë—Ç—ã), `documentation` (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è), `general` (–æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã).–ü—Ä–æ–º–ø—Ç:pythonCopyDownloadSYSTEM_PROMPT = "Classify query: analytics/data requests, documentation/how-to, general/small talk."2.3. Analytics PipelineSchema Master Agent (LLM):–ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ö–µ–º—É –ë–î —á–µ—Ä–µ–∑ RAG (GigaSearch).SQL Generator Agent (LLM):–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∏–∑ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 0.3 –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏).SQL Validator Function (Python):–ë–ª–æ–∫–∏—Ä—É–µ—Ç –æ–ø–∞—Å–Ω—ã–µ SQL-–∫–æ–º–∞–Ω–¥—ã (`DROP`, `DELETE` –∏ —Ç.–¥.):pythonCopyDownloaddef validate_sql(sql: str) -> bool:
    forbidden = ["DROP", "DELETE", "INSERT", "UPDATE"]
    return not any(keyword in sql.upper() for keyword in forbidden)Access Check Function (Python):–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ RBAC (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Keycloak).DB Executor Function (Python):–í—ã–ø–æ–ª–Ω—è–µ—Ç SQL —á–µ—Ä–µ–∑ SQLAlchemy (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ).Data Interpreter Agent (LLM):–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –ø–æ–º–æ—â—å—é PandasAI.Data Storyteller Agent (LLM):–í—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–≥—Ä–∞—Ñ–∏–∫/—Ç–∞–±–ª–∏—Ü–∞/—Ç–µ–∫—Å—Ç).2.4. Documentation HelperQuery Classifier Agent (LLM):–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞: `small talk`, `RAG search`, `web search`.Small Talk Agent (LLM):–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–ø—Ä–æ–º–ø—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏).RAG Search Function (Python):–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (GigaSearch, —á–∞–Ω–∫–∏ –ø–æ 512 —Å–∏–º–≤–æ–ª–æ–≤).Web Search Function (Python):–ò—â–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ DuckDuckGo API (—Ç–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã).Response Synthesizer Agent (LLM):–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.2.5. Fallback HandlingFallback Agent (LLM):–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö:Retry: –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫.–£–ø—Ä–æ—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞.–≠—Å–∫–∞–ª–∞—Ü–∏—è –≤ Jira + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Slack.–§–æ—Ä–º–∞—Ç –æ—à–∏–±–∫–∏:jsonCopyDownload{
  "error_id": "ERR-20250622-142",
  "type": "sql_syntax",
  "suggested_actions": ["–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É –ë–î"]
}2.6. Support ServicesAuth Service (Keycloak): RBAC-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏.Cache Service (Redis): –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ 1 —á–∞—Å.Vector Store (GigaSearch): –•—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.Monitoring (LangSmith): –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—ã–∑–æ–≤–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤.Operational DB (PostgreSQL): –ü—Ä–æ–¥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.3. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫–ö–∞—Ç–µ–≥–æ—Ä–∏—è–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏–Ø–∑—ã–∫–∏Python 3.11, SQLLLM-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞GigaChat API, LangChain, GigaChain SDK–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—ÖPostgreSQL, Redis, GigaSearchAPIFastAPI, Telegram Bot API–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥LangSmith, Prometheus+Grafana–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞Docker, Kubernetes, Helm–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏Jira API, Slack API, DuckDuckGo API4. –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞):`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram Bot ‚Üí API Gateway ‚Üí Router ‚Üí Analytics Pipeline ‚Üí Response Formatter ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å`.–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–ü—Ä–∏ —Å–±–æ–µ –≤ DB Executor: `Fallback Agent ‚Üí Retry ‚Üí Schema Master ‚Üí SQL Generator`.–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –≤ Redis (–∫–ª—é—á = —Ö–µ—à –∑–∞–ø—Ä–æ—Å–∞).5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: JWT-—Ç–æ–∫–µ–Ω—ã + —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á Telegram.–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: RBAC —á–µ—Ä–µ–∑ Keycloak:pythonCopyDownloaddef check_access(user_id: str, resource: str) -> bool:
    roles = auth_service.get_roles(user_id)
    return any(role in roles for role in RBAC_MATRIX[resource])–ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:PII-–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Presidio.–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (AES-256).Read-only –¥–æ—Å—Ç—É–ø –∫ –ë–î.6. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (FastAPI async).–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Redis.–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á.–ú–µ—Ç—Ä–∏–∫–∏:–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 5 —Å–µ–∫ (95% –∑–∞–ø—Ä–æ—Å–æ–≤).–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: 100 RPS.–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ: ReplicaSet –≤ Kubernetes.–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ: GPU-–Ω–æ–¥—ã –¥–ª—è LLM.7. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è (Docker):DockerfileCopyDownloadFROM python:3.11
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]Kubernetes:–û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–¥—ã –¥–ª—è CPU/GPU –∑–∞–¥–∞—á.–ê–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥ –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ.–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Helm:yamlCopyDownloadreplicaCount: 3
resources:
  limits:
    cpu: 1000m
    memory: 2Gi
    gpu: 1  # –î–ª—è LLM-–∞–≥–µ–Ω—Ç–æ–≤8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Å—Å—ã–ª–∫–∏–°—Ö–µ–º—ã –ë–î: `db_schema_v2.4.sql` –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ + –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Schema Master Agent.API: OpenAPI 3.0 —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è FastAPI.–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:textCopyDownloadgithub.com/your-company/analytics-agent-system
‚îú‚îÄ‚îÄ agents/       # LLM-–∞–≥–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ functions/    # –í–∞–ª–∏–¥–∞—Ü–∏—è, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ infra/        # Terraform/Helm
‚îî‚îÄ‚îÄ monitoring/   # LangSmith–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: GigaChat API, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è VPN –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î.–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫ —Å—Ç–∞—Ä—Ç—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Kubernetes + PostgreSQL/Redis.–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API Gateway –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram Bot.–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å GigaSearch –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î.–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (SQL Validator, Access Check).

user: –æ—Ç–ª–∏—á–Ω–æ, –¥–∞–≤–∞–π –ø–æ–¥—É–º–∞–µ–º —á—Ç–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —É–±—Ä–∞—Ç—å, –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?
–ü–ª—é—Å –æ–±—ä—è—Å–Ω–∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —à–µ–º–∞ –º–∞—Å—Ç–µ—Ä –∞–≥–µ–Ω—Ç –∏ –¥–ª—è —á–µ–≥–æ –æ–Ω

assistant: ÊÄùËÄÉÔºö–ú—ã –∏–º–µ–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ Telegram. –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ:1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—á—Ç–æ –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å, —É–ª—É—á—à–∏—Ç—å, –¥–æ–±–∞–≤–∏—Ç—å).2. –ü–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–æ–ª—å Schema Master Agent.### –ê–Ω–∞–ª–∏–∑ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:#### –ß—Ç–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å/—É–ø—Ä–æ—Å—Ç–∏—Ç—å:1. **Router Agent**:- –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è).- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ-–±–∞–∑–∏—Ä—É–µ–º—ã–π –ø—Ä–µ—Ñ–∏–ª—å—Ç—Ä (regex) –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "/start", "—Å–ø–∞—Å–∏–±–æ"), —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ LLM.2. **Fallback Handling**:- Fallback Agent –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º, —Ç–∞–∫ –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏.- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –†–∞–∑–¥–µ–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–∏:- –£—Ä–æ–≤–µ–Ω—å 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –∞–≥–µ–Ω—Ç–∞).- –£—Ä–æ–≤–µ–Ω—å 2: –£–ø—Ä–æ—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ Fallback Agent.- –£—Ä–æ–≤–µ–Ω—å 3: –≠—Å–∫–∞–ª–∞—Ü–∏—è –≤ Jira/Slack.3. **Documentation Helper**:- –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–º–µ–µ—Ç –¥–≤–∞ –ø—É—Ç–∏ –ø–æ–∏—Å–∫–∞ (RAG –∏ Web). –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –æ–¥–Ω–æ–º –∞–≥–µ–Ω—Ç–µ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏.- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π `Search Agent`, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ—à–∞–µ—Ç, –∫–∞–∫–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–∏–ª–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å), –≤–º–µ—Å—Ç–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞.4. **Support Services**:- Cache Service (Redis) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ SQL. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã Documentation Helper (–æ—Å–æ–±–µ–Ω–Ω–æ —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã).- –ö–µ—à–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—ã –ë–î, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ Schema Master Agent.5. **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫**:- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GigaSearch –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –¥–ª—è RAG –ø–æ —Å—Ö–µ–º–µ –ë–î - —ç—Ç–æ —Ö–æ—Ä–æ—à–æ, –Ω–æ –µ—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≤—ã—Å–æ–∫–∞, –º–æ–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –±–æ–ª–µ–µ –ª–µ–≥–∫–æ–≤–µ—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Å—Ö–µ–º—ã –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –≤ –ø–∞–º—è—Ç–∏ —Å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º).#### –ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:1. **Rate Limiting –∏ Quotas**:- –í API Gateway –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π).2. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**:- –î–æ–±–∞–≤–∏—Ç—å —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø–æ —Ç–∏–ø–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤, –æ—à–∏–±–∫–∞–º, –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è**:- –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è SQL Generator Agent (–Ω–∞–ø—Ä–∏–º–µ—Ä, —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ SQL).4. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–∞—Ç–∞**:- –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:- –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ Redis (—Å TTL).- –£—á–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ü–µ–ø–æ—á–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤).#### –ß—Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:1. **Security**:- –í–∞–ª–∏–¥–∞—Ü–∏—è SQL —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –Ω–µ–Ω–∞–¥–µ–∂–Ω–∞ (–º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏). –õ—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Å–µ—Ä SQL (–Ω–∞–ø—Ä–∏–º–µ—Ä, sqlparse) –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø—Ä–∞–≤–∞ –ë–î.- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–∏–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø—Ä–æ—Å–∞.2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã LLM (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Ü–µ–ø–æ—á–∫–µ –∞–≥–µ–Ω—Ç–æ–≤) –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏. –ú–æ–∂–Ω–æ:- –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —à–∞–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Schema Master –∏ SQL Generator) –≤ –æ–¥–∏–Ω –ø—Ä–æ–º–ø—Ç.- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è Router Agent).### –û–±—ä—è—Å–Ω–µ–Ω–∏–µ Schema Master Agent:**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**:- Schema Master Agent –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü, –∫–æ–ª–æ–Ω–æ–∫, —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö, –æ–ø–∏—Å–∞–Ω–∏–π) –¥—Ä—É–≥–∏–º –∞–≥–µ–Ω—Ç–∞–º (–≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å SQL Generator Agent) –≤ —É–¥–æ–±–Ω–æ–º –¥–ª—è LLM —Ñ–æ—Ä–º–∞—Ç–µ.**–ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ—Ç**:- –ë–î –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–æ–π –∏ —Å–ª–æ–∂–Ω–æ–π, –∞ –µ–µ —Å—Ö–µ–º–∞ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å—Å—è. –•—Ä–∞–Ω–∏—Ç—å –≤—Å—é —Å—Ö–µ–º—É –≤ –ø—Ä–æ–º–ø—Ç–µ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ LLM) –∏ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–æ (–ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å—Ö–µ–º—ã –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç).- SQL Generator Agent –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SQL, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ, –∏–Ω–∞—á–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏.**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç**:1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å —Å—Ö–µ–º—ã**:- –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å, Schema Master Agent —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ (GigaSearch), –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è:- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î (—Ç–∞–±–ª–∏—Ü—ã, –∫–æ–ª–æ–Ω–∫–∏, —Ç–∏–ø—ã).- –û–ø–∏—Å–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏ –∫–æ–ª–æ–Ω–æ–∫ (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è).- –ó–∞–ø—Ä–æ—Å —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–∞–π" ‚Üí –∏—â–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏).2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞—Å—Ç–µ–π —Å—Ö–µ–º—ã**:- –í–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º—ã –ë–î, –∞–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –∫–æ–ª–æ–Ω–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `sales`, `date`, `amount`).- –≠—Ç–æ —Å–æ–∫—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è SQL Generator Agent –∏ –ø–æ–≤—ã—à–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å.3. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è LLM**:- –î–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä:```–¢–∞–±–ª–∏—Ü—ã:- sales [id: int, date: timestamp, amount: float]–û–ø–∏—Å–∞–Ω–∏–µ: –ü—Ä–æ–¥–∞–∂–∏ –ø–æ –¥–Ω—è–º.- products [id: int, name: text]–û–ø–∏—Å–∞–Ω–∏–µ: –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.```**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è SQL Generator**:```text–°—Ö–µ–º–∞ –ë–î:{schema_from_schema_master}–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–∞–π 2025 –≥–æ–¥–∞"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π SQL-–∑–∞–ø—Ä–æ—Å. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü—ã –∏–∑ —Å—Ö–µ–º—ã –≤—ã—à–µ.```**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:- **–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å**: –°—Ö–µ–º–∞ –≤—Å–µ–≥–¥–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–π –ë–î (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤).- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –°–Ω–∏–∂–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ –≤ LLM.- **–¢–æ—á–Ω–æ—Å—Ç—å**: –£–º–µ–Ω—å—à–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏–∑-–∑–∞ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π —Å—Ö–µ–º—ã.**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Schema Master Agent**:- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ (—á—Ç–æ–±—ã –ø—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–µ –¥–µ–ª–∞—Ç—å –ø–æ–∏—Å–∫ –∫–∞–∂–¥—ã–π —Ä–∞–∑).- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞) –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î.### –ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:1. –í–≤–µ—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ-–±–∞–∑–∏—Ä—É–µ–º—ã–π –ø—Ä–µ—Ñ–∏–ª—å—Ç—Ä –¥–ª—è Router Agent.2. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞).3. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å RAG –∏ Web Search –≤ Documentation Helper.4. –†–∞—Å—à–∏—Ä–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ö–µ–º—ã –ë–î, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏).5. –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Å–µ—Ä SQL –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤).6. –í–Ω–µ–¥—Ä–∏—Ç—å —É—á–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞ (—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ Redis).7. –£—Å–∏–ª–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (rate limiting, —É–ª—É—á—à–µ–Ω–Ω–∞—è SQL –≤–∞–ª–∏–¥–∞—Ü–∏—è).8. –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.–≠—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–Ω–∏–∑—è—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ LLM, —É—Å–∫–æ—Ä—è—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ–≤—ã—Å—è—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—èüîß –ß—Ç–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å/—É–±—Ä–∞—Ç—å:–£–ø—Ä–æ—â–µ–Ω–∏–µ Documentation Helper:–û–±—ä–µ–¥–∏–Ω–∏—Ç—å `Query Classifier Agent` –∏ `Small Talk Agent` –≤ –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç. –ü—Ä–∏—á–∏–Ω–∞: –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–∑–∞–ø—Ä–æ—Å —É–∂–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω Router Agent).–£–±—Ä–∞—Ç—å `Web Search Function` –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏. –†–∏—Å–∫: –ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –º–æ–≥—É—Ç —Å–Ω–∏–∂–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤.–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î:Schema Master Agent –Ω–µ –¥–æ–ª–∂–µ–Ω –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å—Ö–µ–º—É —á–µ—Ä–µ–∑ RAG. –†–µ—à–µ–Ω–∏–µ:pythonCopyDownload# –ü—Å–µ–≤–¥–æ–∫–æ–¥ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
from functools import lru_cache

@lru_cache(maxsize=1, ttl=3600)  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 1-2 —á–∞—Å–∞
def get_db_schema():
    return gigasearch.retrieve_schema()–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ –∞–≥–µ–Ω—Ç–æ–≤:–û–±—ä–µ–¥–∏–Ω–∏—Ç—å `Data Interpreter` –∏ `Data Storyteller` –≤ –æ–¥–∏–Ω –∞–≥–µ–Ω—Ç. –ü—Ä–∏—á–∏–Ω–∞: –°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫ (–æ–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç LLM).–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Fallback:–£–±—Ä–∞—Ç—å –∞–≤—Ç–æ—ç—Å–∫–∞–ª–∞—Ü–∏—é –≤ Jira –¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:jsonCopyDownload"fallback_strategy": ["retry", "simplify", "human_alert"]‚ûï –ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å:–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–∏–∞–ª–æ–≥–∞:–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ (Redis). –ü—Ä–∏–º–µ—Ä:pythonCopyDownloadchat_history.add(user_id, {"role": "user", "content": "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏"})–í–∞–ª–∏–¥–∞—Ç–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞:–ö–æ–º–ø–æ–Ω–µ–Ω—Ç, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤/SQL –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤–∏–¥–∞ "–ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫".–°–∏—Å—Ç–µ–º—É –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏–∏:–î–ª—è VIP-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—ã–¥–µ–ª—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã GPU. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–ø—Ä–æ—Å–µ:jsonCopyDownload{"user_id": "UA-VIP-142", "priority": "high"}–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫–µ—à–∏–Ω–≥:–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π TTL –≤ Redis –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤:pythonCopyDownloadttl = 3600 if is_popular_query(query) else 300‚ö†Ô∏è –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å SQL Validator:–¢–µ–∫—É—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –Ω–µ–Ω–∞–¥–µ–∂–Ω–∞. –†–µ—à–µ–Ω–∏–µ:pythonCopyDownload# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL-–ø–∞—Ä—Å–µ—Ä –≤–º–µ—Å—Ç–æ regex
import sqlparse
def validate_sql(sql):
    parsed = sqlparse.parse(sql)
    return all(stmt.get_type() == "SELECT" for stmt in parsed)–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –≤ LangSmith.–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Output Layer:–£–±—Ä–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π `Response Generator` –¥–ª—è –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ï–≥–æ –∑–∞–¥–∞—á–∏ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å `Response Synthesizer`.üß† –ü–æ–¥—Ä–æ–±–Ω–æ –æ Schema Master Agent–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:–†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Å—Ö–µ–º—ã –ë–î":–ö–æ–≥–¥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –º–µ–Ω—è–µ—Ç—Å—è (–Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã/–∫–æ–ª–æ–Ω–∫–∏), SQL Generator –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.–ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ–π —Å—Ö–µ–º—ã –≤ –ø—Ä–æ–º–ø—Ç LLM –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100+ —Ç–∞–±–ª–∏—Ü).–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏–º–µ—Ä: "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –∑–∞ 2024 –≥–æ–¥").–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π:–° –ø–æ–º–æ—â—å—é LLM –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:pythonCopyDownloadentities = extract_entities("–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –∑–∞ 2024")
# –†–µ–∑—É–ª—å—Ç–∞—Ç: ["–ø—Ä–æ–¥–∞–∂–∏", "—Ä–µ–≥–∏–æ–Ω—ã", "2024"]–ü–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:–ò—â–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å—Ö–µ–º—ã –≤ GigaSearch –ø–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º —Å—É—â–Ω–æ—Å—Ç–µ–π:pythonCopyDownloadresults = gigasearch.query(
    query=entities,
    index="db_schema",
    top_k=3
)–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ö–µ–º—ã –¥–ª—è SQL Generator:markdownCopyDownload## –°—Ö–µ–º–∞ –ë–î (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞—Å—Ç–∏)
–¢–∞–±–ª–∏—Ü–∞ `sales`:
- region_id (foreign key ‚Üí regions.id)
- amount (float)
- date (timestamp)

–¢–∞–±–ª–∏—Ü–∞ `regions`:
- id (primary key)
- name (varchar)–ü–µ—Ä–µ–¥–∞—á–∞ –≤ SQL Generator:–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–º–ø—Ç:pythonCopyDownloadprompt = f"""
–¢–µ–∫—É—â–∞—è —Å—Ö–µ–º–∞ –ë–î:
{schema_context}

–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_query}
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SQL.
"""üí° –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ Schema Master–†–µ—à–µ–Ω–∏–µ —Å –∞–≥–µ–Ω—Ç–æ–º–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Å—Ö–µ–º—ã –≤ –ø—Ä–æ–º–ø—Ç–µ–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ RAG–û—à–∏–±–∫–∏ —Ç–∏–ø–∞ "column not found"–¢–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ö–µ–º–µ–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ LLM–¢–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã/–∫–æ–ª–æ–Ω–∫–∏–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–∞:–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥:pythonCopyDownloadif is_simple_query(query):
    return cached_basic_schema  # 80% –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç 20% —Ç–∞–±–ª–∏—Ü
else:
    return dynamic_schema_search(query)–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞:–í–µ–±—Ö—É–∫ –æ—Ç DBA –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã ‚Üí –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞.–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å YAML –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:yamlCopyDownloadsales:
  columns:
    region_id: "fk:regions.id"
    amount: float–ò—Ç–æ–≥–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-344{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-344 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-344 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-344 .error-icon{fill:#a44141;}#mermaid-svg-344 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-344 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-344 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-344 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-344 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-344 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-344 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-344 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-344 .marker.cross{stroke:lightgrey;}#mermaid-svg-344 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-344 p{margin:0;}#mermaid-svg-344 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-344 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-344 .cluster-label span{color:#F9FFFE;}#mermaid-svg-344 .cluster-label span p{background-color:transparent;}#mermaid-svg-344 .label text,#mermaid-svg-344 span{fill:#ccc;color:#ccc;}#mermaid-svg-344 .node rect,#mermaid-svg-344 .node circle,#mermaid-svg-344 .node ellipse,#mermaid-svg-344 .node polygon,#mermaid-svg-344 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-344 .rough-node .label text,#mermaid-svg-344 .node .label text,#mermaid-svg-344 .image-shape .label,#mermaid-svg-344 .icon-shape .label{text-anchor:middle;}#mermaid-svg-344 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-344 .rough-node .label,#mermaid-svg-344 .node .label,#mermaid-svg-344 .image-shape .label,#mermaid-svg-344 .icon-shape .label{text-align:center;}#mermaid-svg-344 .node.clickable{cursor:pointer;}#mermaid-svg-344 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-344 .arrowheadPath{fill:lightgrey;}#mermaid-svg-344 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-344 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-344 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-344 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-344 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-344 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-344 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-344 .cluster text{fill:#F9FFFE;}#mermaid-svg-344 .cluster span{color:#F9FFFE;}#mermaid-svg-344 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-344 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-344 rect.text{fill:none;stroke-width:0;}#mermaid-svg-344 .icon-shape,#mermaid-svg-344 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-344 .icon-shape p,#mermaid-svg-344 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-344 .icon-shape rect,#mermaid-svg-344 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-344 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}Optimizations–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ + –ø–∞—Ä—Å–∏–Ω–≥–ü—Ä–∞–≤–∏–ª–∞ + ML–¢–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏–ö–æ–Ω—Ç–µ–∫—Å—Ç + —Å—Ö–µ–º—ãSchema MasterSQL GeneratorRouterDocumentation HelperFallbackJiraRedis–í—Å–µ –∞–≥–µ–Ω—Ç—ã–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫ –Ω–∞ 15-20% –∑–∞ —Å—á–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –≤—ã–∑–æ–≤–æ–≤ LLM–£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –Ω–∞ 30% —á–µ—Ä–µ–∑ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é SQL–ì–∏–±–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º —Å—Ö–µ–º—ã –ë–î–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ GPU –∑–∞ —Å—á–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏–∏ –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

user: –Ω—É –≤–æ—Ç —Å–º–æ—Ç—Ä–∏ –ø—Ä–æ–±–ª–µ–º—É, —É –º–µ–Ω—è –µ—Å—Ç—å –°–£–ë–î –Ω–∞ –í–ú –∫ –∫–æ—Ç–æ—Ä–æ–º—É –∞–≥–µ–Ω—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –ø–æ API
–≤ –Ω–µ–º –∏–º–µ—é—Ç—Å—è —Å—Ç–æ–ª–±—Ü—ã. –ö–∞–∫ –∞–≥–µ–Ω—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∑–∞–ø—Ä–æ—Å –¥–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –∫–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å–æ–¥–µ—Ä–∂–∞—Ç. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –†–ê–ì? –∏–ª–∏ –∫–∞–∫?

assistant: ÊÄùËÄÉÔºö–ú—ã –∏–º–µ–µ–º –ø—Ä–æ–±–ª–µ–º—É: SQL Generator Agent –¥–æ–ª–∂–µ–Ω –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î (—Ç–∞–±–ª–∏—Ü—ã, —Å—Ç–æ–ª–±—Ü—ã) –∏ –∏—Ö —Å–µ–º–∞–Ω—Ç–∏–∫–µ (—á—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º —Å—Ç–æ–ª–±—Ü–µ).### –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑ —Ä–µ—à–µ–Ω–∏—è:1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î**: SQL Generator –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å:- –ö–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç.- –ö–∞–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö.- –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤.- –°–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ (foreign keys).2. **–°–µ–º–∞–Ω—Ç–∏–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤**:- –ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Å—Ç–æ–ª–±–µ—Ü `client_name` (–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ vs –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏)?- –í –∫–∞–∫–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è `amount` (—Ä—É–±–ª–∏, –¥–æ–ª–ª–∞—Ä—ã, —à—Ç—É–∫–∏)?- –ö–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–ª–∞–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `is_active` = 0/1)?3. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:- –ï—Å–ª–∏ –≤ –ë–î –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞, –∞–≥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —É–∑–Ω–∞—Ç—å –æ –Ω–µ–π —Å—Ä–∞–∑—É.### –ö–∞–∫ —Ä–µ—à–∞–µ—Ç Schema Master Agent (—Å RAG)?#### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞- **–ß—Ç–æ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º?**:- –°—Ö–µ–º—É –ë–î (DDL): –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü/—Å—Ç–æ–ª–±—Ü–æ–≤, —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö, constraints.- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∫ —Å—Ç–æ–ª–±—Ü–∞–º** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ Data Dictionary):```markdown# –¢–∞–±–ª–∏—Ü–∞ `sales`- `region_id`: ID —Ä–µ–≥–∏–æ–Ω–∞ (foreign key –Ω–∞ `regions.id`)- `amount`: –°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏ –≤ —Ä—É–±–ª—è—Ö (–±–µ–∑ –ù–î–°)- `discount`: –°–∫–∏–¥–∫–∞ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–æ—Ç 0 –¥–æ 100)```- –ü—Ä–∏–º–µ—Ä—ã —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –∫–∞–∂–¥–æ–º—É —Å—Ç–æ–ª–±—Ü—É (–µ—Å–ª–∏ –µ—Å—Ç—å).- **–ö–∞–∫ —Ö—Ä–∞–Ω–∏–º?**:- –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (GigaSearch) —Å —á–∞–Ω–∫–∞–º–∏ –ø–æ 512 —Å–∏–º–≤–æ–ª–æ–≤.#### –®–∞–≥ 2: –†–∞–±–æ—Ç–∞ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤**:- –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "–ü–æ–∫–∞–∂–∏ –æ–±—â—É—é —Å—É–º–º—É –ø—Ä–æ–¥–∞–∂ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö".- –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: ["—Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂", "—Ä–µ–≥–∏–æ–Ω—ã", "–¥–æ–ª–ª–∞—Ä—ã"].2. **–ü–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î**:- –ò—â–µ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å:- –°—Ç–æ–ª–±—Ü–∞–º–∏ `amount` (—Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂) –∏ `region_id` (—Ä–µ–≥–∏–æ–Ω—ã).- –ö–æ–Ω–≤–µ—Ä—Å–∏–µ–π –≤–∞–ª—é—Ç (–µ—Å–ª–∏ –≤ –ë–î –¥–∞–Ω–Ω—ã–µ –≤ —Ä—É–±–ª—è—Ö, –∞ –Ω—É–∂–Ω—ã –¥–æ–ª–ª–∞—Ä—ã).- –ü—Ä–∏–º–µ—Ä –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —á–∞–Ω–∫–∞:```–î–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∞–ª—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `currency_rates`:- `from_currency`: –∏—Å—Ö–æ–¥–Ω–∞—è –≤–∞–ª—é—Ç–∞ (–∫–æ–¥ ISO)- `to_currency`: —Ü–µ–ª–µ–≤–∞—è –≤–∞–ª—é—Ç–∞- `rate`: –∫—É—Ä—Å –æ–±–º–µ–Ω–∞- `date`: –¥–∞—Ç–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—É—Ä—Å–∞```3. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**:- –ê–≥–µ–Ω—Ç –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç –∫–æ–º–ø–∞–∫—Ç–Ω—É—é "–≤—ã–∂–∏–º–∫—É" –¥–ª—è SQL Generator:```yaml# –°—Ö–µ–º–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞tables:sales:columns:region_id: "ID —Ä–µ–≥–∏–æ–Ω–∞ ‚Üí regions.id"amount: "–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö (–±–µ–∑ –ù–î–°)"currency_rates:columns:from_currency: "–í–∞–ª—é—Ç–∞ –∏—Å—Ö–æ–¥–Ω–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, RUB)"to_currency: "–í–∞–ª—é—Ç–∞ —Ü–µ–ª–µ–≤–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, USD)"rate: "–ö—É—Ä—Å –æ–±–º–µ–Ω–∞"date: "–î–∞—Ç–∞ –∫—É—Ä—Å–∞"# –í–∞–∂–Ω–æ:- –î–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∞–ª—é—Ç JOIN —Å `currency_rates` –ø–æ –¥–∞—Ç–µ.- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ `region_id`.```#### –®–∞–≥ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–º–ø—Ç SQL Generator–ü—Ä–æ–º–ø—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º:```pythonprompt = f"""–¢—ã SQL Generator. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç–æ–ª–±—Ü—ã:{context}–ü—Ä–∞–≤–∏–ª–∞:- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç–æ–ª–±—Ü—ã, –Ω–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ –≤—ã—à–µ.- –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç, JOIN —Å `currency_rates`.–ó–∞–ø—Ä–æ—Å: {user_query}"""```### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã RAG (–∏ –ø–æ—á–µ–º—É –æ–Ω–∏ —Ö—É–∂–µ)| –ú–µ—Ç–æ–¥               | –ü—Ä–æ–±–ª–µ–º—ã                                     ||---------------------|---------------------------------------------|| **–ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –≤ –ø—Ä–æ–º–ø—Ç–µ** | –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤ (–Ω–µ –≤–ª–µ–∑–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç LLM) || **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—Ç–∞-—Å–ª–æ–≤–∞—Ä—å** | –£—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ë–î              || **–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º** | –ù–µ –¥–∞–µ—Ç —Å–µ–º–∞–Ω—Ç–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –∏–º–µ–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤) |### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è (–í–ú + API)1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞**:- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –ë–î (ALTER TABLE) ‚Üí –≤–µ–±—Ö—É–∫ –≤ –≤–∞—à–µ API ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ –≤ GigaSearch.2. **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫**:- –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (—Å–µ–º–∞–Ω—Ç–∏–∫–∞) –∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—Ç–æ—á–Ω—ã–µ –∏–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü/—Å—Ç–æ–ª–±—Ü–æ–≤):```pythonresults = gigasearch.hybrid_search(query=user_query,index="db_schema",keyword_boost={"columns": 2.0},  # –£—Å–∏–ª–∏–≤–∞–µ–º –≤–µ—Å —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–πtop_k=5)```3. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**:- –î–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º") –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ö–µ–º—ã.### –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è Schema Master Agent```pythonclass SchemaMasterAgent:def __init__(self, vector_store):self.vector_store = vector_store  # GigaSearch –∫–ª–∏–µ–Ω—Çdef get_relevant_schema(self, user_query: str) -> str:# –®–∞–≥ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)entities = self.extract_entities(user_query)# –®–∞–≥ 2: –ü–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–îresults = self.vector_store.search(query=" ".join(entities),index_name="db_schema_index",top_k=3)# –®–∞–≥ 3: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞context = "## –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î –¥–ª—è –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:\n"for res in results:context += f"- {res['metadata']['table_name']}.{res['metadata']['column_name']}: {res['text']}\n"return context# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQL Generatordef generate_sql(user_query: str):schema_agent = SchemaMasterAgent(gigasearch)schema_context = schema_agent.get_relevant_schema(user_query)prompt = f"""{schema_context}–ó–∞–ø—Ä–æ—Å: {user_query}–ù–∞–ø–∏—à–∏ SQL-–∑–∞–ø—Ä–æ—Å."""return llm.generate(prompt)```### –ò—Ç–æ–≥**–î–∞, RAG —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É**, –Ω–æ —Å –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏:- –ò–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ DDL, –Ω–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ —Å–º—ã—Å–ª—É —Å—Ç–æ–ª–±—Ü–æ–≤.- –ü–æ–∏—Å–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–∏–±—Ä–∏–¥–Ω—ã–º (–≤–µ–∫—Ç–æ—Ä—ã + –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞).- –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ö–µ–º—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç.–î–ª—è –≤–∞—à–µ–π –í–ú —Å API:1. –°–æ–∑–¥–∞–π—Ç–µ –∏–Ω–¥–µ–∫—Å –≤ GigaSearch —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –ë–î.2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –≤–µ–±—Ö—É–∫ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã.3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Schema Master Agent –¥–ª—è –≥–∏–±–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: –ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å –∞–≥–µ–Ω—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ–ª–±—Ü–∞—Ö –ë–î–ü—Ä–æ–±–ª–µ–º–∞:–ê–≥–µ–Ω—Ç—É, –≥–µ–Ω–µ—Ä–∏—Ä—É—é—â–µ–º—É SQL, –Ω—É–∂–Ω—ã –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤, –Ω–æ –∏ –∏—Ö —Å–µ–º–∞–Ω—Ç–∏–∫–∞:–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞–∂–¥—ã–π —Å—Ç–æ–ª–±–µ—Ü?–í –∫–∞–∫–∏—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö –∏–∑–º–µ—Ä–µ–Ω–∏—è?–ö–∞–∫ —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π?–ö–∞–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/—Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö?–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (Schema Master Agent + RAG):–î–∞, –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è RAG –∏ Schema Master Agent, –Ω–æ —Å –≤–∞–∂–Ω—ã–º–∏ –Ω—é–∞–Ω—Å–∞–º–∏:–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∏—Å—Ç–µ–º—ã –≤—ã —Å–æ–∑–¥–∞–µ—Ç–µ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:pythonCopyDownload# –ü—Å–µ–≤–¥–æ–∫–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
from gigasearch import Vectorizer

docs = [
    {"content": "–¢–∞–±–ª–∏—Ü–∞ sales: sales_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–æ–¥–∞–∂–∏), amount (—Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö), region_id (FK –∫ regions)", "metadata": "sales"},
    {"content": "–¢–∞–±–ª–∏—Ü–∞ regions: region_id (ID —Ä–µ–≥–∏–æ–Ω–∞), name (–Ω–∞–∑–≤–∞–Ω–∏–µ), manager (–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä)", "metadata": "regions"},
    {"content": "–í–∞–∂–Ω–æ: amount –≤—Å–µ–≥–¥–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ä—É–±–ª—è—Ö, –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫—É—Ä—Å –∏–∑ currency_rates", "metadata": "business_rules"}
]

vector_store.index_documents(docs)  # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ GigaSearch2. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:"–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –∑–∞ 2024 –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö"Schema Master Agent:–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏: ["–ø—Ä–æ–¥–∞–∂–∏", "–º–µ–Ω–µ–¥–∂–µ—Ä—ã", "–¥–æ–ª–ª–∞—Ä—ã"]–ò—â–µ—Ç –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:pythonCopyDownloadresults = vector_store.search(
    query="–ø—Ä–æ–¥–∞–∂–∏ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–æ–ª–ª–∞—Ä—ã",
    top_k=3,
    filter={"metadata": {"$in": ["sales", "regions", "business_rules"]}}
)–§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è SQL Generator:markdownCopyDownload### –°—Ö–µ–º–∞ –ë–î:
**sales**:
- region_id ‚Üí regions.region_id
- amount (—Ä—É–±–ª–∏) 

**regions**:
- name (–Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞)
- manager (–§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞)

**–ü—Ä–∞–≤–∏–ª–∞**:
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –¥–æ–ª–ª–∞—Ä—ã: JOIN currency_rates 3. –ü—Ä–æ–º–ø—Ç –¥–ª—è SQL GeneratorpythonCopyDownloadprompt = f"""
–¢—ã SQL —ç–∫—Å–ø–µ—Ä—Ç. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç–æ–ª–±—Ü—ã:

{context_from_schema_master}

–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_query}
"""–ü–æ—á–µ–º—É RAG –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ? –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π SQL-–ø–∞—Ä—Å–µ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏–º–µ—Ä—ã SQL:pythonCopyDownloaddef generate_schema_examples(table):
    return f"""
    –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è {table}:
    - SELECT manager FROM regions WHERE name = '–ú–æ—Å–∫–≤–∞'
    - SELECT SUM(amount) FROM sales JOIN regions USING(region_id)
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:pythonCopyDownload# –ü—Å–µ–≤–¥–æ–∫–æ–¥: –∞–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
context += f"""
–ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –¥–∞–Ω–Ω—ã–º:
- region_id: 10 –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (MOW, SPB, ...)
- amount: –¥–∏–∞–ø–∞–∑–æ–Ω 100-50000 —Ä—É–±, —Å—Ä–µ–¥–Ω–µ–µ 12000 —Ä—É–±
"""–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —à—É–º–∞:pythonCopyDownload# –í–º–µ—Å—Ç–æ –∂–µ—Å—Ç–∫–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –∏–º–µ–Ω–∞–º
intelligent_filter = predict_relevant_tables(user_query)  # ML-–º–æ–¥–µ–ª—å–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è (–í–ú + API)DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-357{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-357 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-357 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-357 .error-icon{fill:#a44141;}#mermaid-svg-357 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-357 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-357 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-357 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-357 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-357 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-357 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-357 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-357 .marker.cross{stroke:lightgrey;}#mermaid-svg-357 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-357 p{margin:0;}#mermaid-svg-357 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-357 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-357 .cluster-label span{color:#F9FFFE;}#mermaid-svg-357 .cluster-label span p{background-color:transparent;}#mermaid-svg-357 .label text,#mermaid-svg-357 span{fill:#ccc;color:#ccc;}#mermaid-svg-357 .node rect,#mermaid-svg-357 .node circle,#mermaid-svg-357 .node ellipse,#mermaid-svg-357 .node polygon,#mermaid-svg-357 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-357 .rough-node .label text,#mermaid-svg-357 .node .label text,#mermaid-svg-357 .image-shape .label,#mermaid-svg-357 .icon-shape .label{text-anchor:middle;}#mermaid-svg-357 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-357 .rough-node .label,#mermaid-svg-357 .node .label,#mermaid-svg-357 .image-shape .label,#mermaid-svg-357 .icon-shape .label{text-align:center;}#mermaid-svg-357 .node.clickable{cursor:pointer;}#mermaid-svg-357 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-357 .arrowheadPath{fill:lightgrey;}#mermaid-svg-357 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-357 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-357 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-357 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-357 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-357 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-357 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-357 .cluster text{fill:#F9FFFE;}#mermaid-svg-357 .cluster span{color:#F9FFFE;}#mermaid-svg-357 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-357 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-357 rect.text{fill:none;stroke-width:0;}#mermaid-svg-357 .icon-shape,#mermaid-svg-357 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-357 .icon-shape p,#mermaid-svg-357 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-357 .icon-shape rect,#mermaid-svg-357 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-357 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}–°–∏—Å—Ç–µ–º–∞ –∞–≥–µ–Ω—Ç–æ–≤–í–∞—à–∞ –í–ú —Å –°–£–ë–îDDL + sample dataJSON-—Å—Ö–µ–º–∞–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ–ö–æ–Ω—Ç–µ–∫—Å—ÇSQLPostgreSQLMetadata ExtractorVector StoreSchema Master AgentSQL Generator AgentDB Executor–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:Metadata Extractor (–Ω–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –í–ú):–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≥—Ä—É–∂–∞–µ—Ç —Å—Ö–µ–º—É –ë–î–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —á–µ—Ä–µ–∑ LLM (–µ—Å–ª–∏ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:jsonCopyDownload{
  "table": "sales",
  "columns": [
    {"name": "amount", "type": "numeric", "description": "–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏ –≤ —Ä—É–±–ª—è—Ö"},
    {"name": "region_id", "fk": "regions.id"}
  ]
}–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∫–µ—à:pythonCopyDownload# –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
CACHE_RULES = {
    "–ø—Ä–æ–¥–∞–∂–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º": """
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã: sales, regions
    –°–≤—è–∑—å: sales.region_id = regions.id
    """
}–§–æ–ª–±—ç–∫ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤:pythonCopyDownloadif "unknown_column" in error:
    return "–£—Ç–æ—á–Ω–∏—Ç–µ —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç 'X'. –í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã: ..."–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –ë–î:Metadata Extractor –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—èVector Store –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è–ê–≥–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏–ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫SQL Generator –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ:–¢–∞–±–ª–∏—Ü—ã–°—Ç–æ–ª–±—Ü—ã–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–î–∞–∂–µ –¥–ª—è –ë–î —Å 500+ —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∞–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ 3-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —Å—Ö–µ–º—ã.–ü—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏:–î–ª—è –∑–∞–ø—Ä–æ—Å–∞ "–°—Ä–∞–≤–Ω–∏ –ø—Ä–æ–¥–∞–∂–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ü–µ—Ç—Ä–æ–≤–∞ –∏ –°–∏–¥–æ—Ä–æ–≤–∞" –∞–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:–ù–∞—Ö–æ–¥–∏—Ç —Å–≤—è–∑—å `sales ‚Üí regions ‚Üí manager`–ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω: "–ü–µ—Ç—Ä–æ–≤ –ò." (–Ω–∞ –æ—Å–Ω–æ–≤–µ sample data)–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: "–î–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∑–∞ 2023-2024 –≥–≥"

user: –æ–∫–µ–π
—Å–¥–µ–ª–∞–π —Ç–µ–ø–µ—Ä—å —Å—Ö–µ–º—É –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ –≤—Å–µ–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ –∏ –ø—Ä–æ—á–∏–º, –Ω–æ —Ç–æ–ª—å–∫–æ –≤—Å–µ –Ω–∞ 1 —Å—Ö–µ–º–µ

assistant: ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º –µ–¥–∏–Ω—É—é —Å—Ö–µ–º—É –ø—Ä–æ–µ–∫—Ç–∞, –≤–∫–ª—é—á–∞—è –≤—Å–µ —Å–ª–æ–∏, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ —Å–≤—è–∑–∏. –£—á—Ç–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–µ–¥–∏–Ω–∞—è —Å—Ö–µ–º–∞)```mermaidgraph TDsubgraph "Telegram Layer"A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] -->|–°–æ–æ–±—â–µ–Ω–∏–µ| B(Telegram Bot)B -->|Webhook| C[API Gateway]endsubgraph "Orchestration Layer"C --> D[Router Agent]D -->|–ê–Ω–∞–ª–∏—Ç–∏–∫–∞| E[Analytics Pipeline]D -->|–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è| F[Documentation Helper]D -->|–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã| G[General Assistant]endsubgraph "Analytics Pipeline"E --> E0[Schema Master Agent]E0 -->|–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ö–µ–º—ã| E1[SQL Generator Agent]E1 --> E2[SQL Validator]E2 --> E3[Access Check]E3 --> E4[DB Executor]E4 --> E5[Data Interpreter Agent]E5 --> E6[Response Formatter]endsubgraph "Documentation Helper"F --> F1[Query Processor]F1 -->|Small Talk| F2[Small Talk Agent]F1 -->|–ü–æ–∏—Å–∫| F3[RAG Search]F1 -->|–í–µ–±-–ø–æ–∏—Å–∫| F4[Web Search]F2 & F3 & F4 --> F5[Response Synthesizer]F5 --> F6[Response Formatter]endsubgraph "Support Services"H[Auth Service] -->|RBAC| E3I[Cache Service] -->|Redis| E4J[Vector Store] -->|GigaSearch| E0 & F3K[Monitoring] -->|LangSmith| ALL[–í—Å–µ –∞–≥–µ–Ω—Ç—ã]L[(Operational DB)] -->|PostgreSQL| E4M[Metadata Extractor] -->|DDL + —Å–µ–º–∞–Ω—Ç–∏–∫–∞| Jendsubgraph "Infrastructure"N[Kubernetes Cluster]O[Docker]P[Prometheus/Grafana]endsubgraph "External Systems"Q[Jira]R[Slack]S[DuckDuckGo API]T[GigaChat API]endE6 --> CF6 --> CG -->|–û—Ç–≤–µ—Ç| CE2 -->|–û—à–∏–±–∫–∞| U[Fallback Agent]E4 -->|–û—à–∏–±–∫–∞| UF5 -->|–û—à–∏–±–∫–∞| UU -->|–ü–æ–≤—Ç–æ—Ä| E1U -->|–£–ø—Ä–æ—â–µ–Ω–∏–µ| GU -->|–≠—Å–∫–∞–ª–∞—Ü–∏—è| Q & R```### –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–∫–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)1. **Analytics Pipeline**- **Schema Master Agent**:- –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ö–µ–º—ã –∏–∑ Vector Store (GigaSearch)- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (`@lru_cache`)- –§–æ—Ä–º–∏—Ä—É–µ—Ç YAML-–æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü- **–û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ Data Interpreter + Storyteller**: –¢–µ–ø–µ—Ä—å –æ–¥–∏–Ω –∞–≥–µ–Ω—Ç `Data Interpreter Agent` –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫.2. **Documentation Helper**- **–ï–¥–∏–Ω—ã–π Query Processor**: –ó–∞–º–µ–Ω—è–µ—Ç Query Classifier + Small Talk Agents.- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π Web Search**: –¢–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã (white list).3. **–ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**- **Metadata Extractor**: –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –í–ú —Å –°–£–ë–î:- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç DDL- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ —á–µ—Ä–µ–∑ LLM (–µ—Å–ª–∏ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)- –§–æ—Ä–º–∞—Ç: JSON-—Å—Ö–µ–º–∞ —Å —Å–µ–º–∞–Ω—Ç–∏–∫–æ–π- **Fallback Agent**: –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:- –ê–≤—Ç–æ-—É–ø—Ä–æ—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤- –≠—Å–∫–∞–ª–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫4. **Support Services**- **Vector Store (GigaSearch)**: –•—Ä–∞–Ω–∏—Ç:- –°—Ö–µ–º—É –ë–î (–æ—Ç Metadata Extractor)- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (markdown-—Ñ–∞–π–ª—ã)- –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞- **Cache Service (Redis)**: –ö–µ—à–∏—Ä—É–µ—Ç:- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤- –ö–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞- –°—Ö–µ–º—É –ë–î (TTL=1h)### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ (–¥–æ–ø–æ–ª–Ω–µ–Ω–Ω—ã–π)| –ö–∞—Ç–µ–≥–æ—Ä–∏—è          | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏                          ||--------------------|-------------------------------------|| –Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã       | Python 3.11, FastAPI                || LLM-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | GigaChat API, LangChain, GigaChain  || –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö        | PostgreSQL, Redis, GigaSearch       || –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥         | LangSmith, Prometheus, Grafana      || –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞     | Docker, Kubernetes, Helm            || –í–Ω–µ—à–Ω–∏–µ API        | Telegram, Jira, Slack, DuckDuckGo   || –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å       | Keycloak (RBAC), Presidio (PII)     |### –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–≥–ª–∞–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏)1. **–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å**:```–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram Bot ‚Üí API Gateway ‚Üí Router Agent ‚Üí Analytics Pipeline:Schema Master (–∫–µ—à/–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫) ‚Üí SQL Generator ‚ÜíSQL Validator (–ø–∞—Ä—Å–∏–Ω–≥) ‚Üí Access Check ‚Üí DB Executor ‚ÜíData Interpreter ‚Üí Response Formatter ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å```2. **–û—à–∏–±–∫–∞ –≤ Analytics Pipeline**:```DB Executor ‚Üí Fallback Agent:‚îú‚îÄ –ü–æ–≤—Ç–æ—Ä ‚Üí SQL Generator (—Å —É–ø—Ä–æ—â–µ–Ω–∏–µ–º)‚îú‚îÄ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ‚Üí Documentation Helper‚îî‚îÄ –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ ‚Üí Jira + Slack```3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î**:```–í–ú —Å –°–£–ë–î ‚Üí Metadata Extractor ‚Üí Vector Store (GigaSearch):‚Üí –ê–≤—Ç–æ-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ Schema Master```### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—É—Å–∏–ª–µ–Ω–Ω–∞—è)1. **SQL Injection Protection**:```pythondef validate_sql(sql):parsed = sqlparse.parse(sql)return all(stmt.get_type() == "SELECT")```2. **PII –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ**:```pythonfrom presidio_analyzer import AnalyzerEngineanalyzer = AnalyzerEngine()results = analyzer.analyze(text=response, language="ru")```3. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ**:- TLS 1.3 –¥–ª—è –≤—Å–µ—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π- AES-256 –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –≤ Redis### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ```mermaidgraph LRA[GitHub] -->|CI/CD| B[Jenkins]B --> C[Docker Registry]C --> D[Kubernetes Production]D --> E[Analytics Pods]D --> F[Documentation Pods]D --> G[Support Services]```**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Helm**:```yaml# values-prod.yamlreplicaCount: 5gpuEnabled: trueresources:limits:cpu: 2000mmemory: 4Gigpu: 2env:VECTOR_STORE_URL: "gigasearch-prod:443"```### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏1. **GigaChat API**: –û—Å–Ω–æ–≤–Ω–æ–π LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä.2. **–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è VPN**: –î–æ—Å—Ç—É–ø –∫ –í–ú —Å –°–£–ë–î.3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã**: –í–µ–±—Ö—É–∫–∏ –æ—Ç DBA-–∫–æ–º–∞–Ω–¥—ã.–≠—Ç–∞ —Å—Ö–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è:- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –∑–∞ —Å—á–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ç–æ—á–Ω–æ—Å—Ç—å SQL —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —Å—Ö–µ–º—É- –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —á–µ—Ä–µ–∑ —É–ª—É—á—à–µ–Ω–Ω—ã–π Fallback –º–µ—Ö–∞–Ω–∏–∑–º–ï–¥–∏–Ω–∞—è —Å—Ö–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞: –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è TelegramDiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-414{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-414 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-414 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-414 .error-icon{fill:#a44141;}#mermaid-svg-414 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-414 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-414 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-414 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-414 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-414 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-414 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-414 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-414 .marker.cross{stroke:lightgrey;}#mermaid-svg-414 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-414 p{margin:0;}#mermaid-svg-414 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-414 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-414 .cluster-label span{color:#F9FFFE;}#mermaid-svg-414 .cluster-label span p{background-color:transparent;}#mermaid-svg-414 .label text,#mermaid-svg-414 span{fill:#ccc;color:#ccc;}#mermaid-svg-414 .node rect,#mermaid-svg-414 .node circle,#mermaid-svg-414 .node ellipse,#mermaid-svg-414 .node polygon,#mermaid-svg-414 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-414 .rough-node .label text,#mermaid-svg-414 .node .label text,#mermaid-svg-414 .image-shape .label,#mermaid-svg-414 .icon-shape .label{text-anchor:middle;}#mermaid-svg-414 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-414 .rough-node .label,#mermaid-svg-414 .node .label,#mermaid-svg-414 .image-shape .label,#mermaid-svg-414 .icon-shape .label{text-align:center;}#mermaid-svg-414 .node.clickable{cursor:pointer;}#mermaid-svg-414 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-414 .arrowheadPath{fill:lightgrey;}#mermaid-svg-414 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-414 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-414 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-414 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-414 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-414 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-414 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-414 .cluster text{fill:#F9FFFE;}#mermaid-svg-414 .cluster span{color:#F9FFFE;}#mermaid-svg-414 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-414 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-414 rect.text{fill:none;stroke-width:0;}#mermaid-svg-414 .icon-shape,#mermaid-svg-414 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-414 .icon-shape p,#mermaid-svg-414 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-414 .icon-shape rect,#mermaid-svg-414 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-414 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}External SystemsSupport ServicesDocumentation HelperAnalytics PipelineOrchestration LayerTelegram Layer–°–æ–æ–±—â–µ–Ω–∏–µWebhook–ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ö–µ–º—ãSmall Talk–ü–æ–∏—Å–∫–í–µ–±-–ø–æ–∏—Å–∫RBACRedisGigaSearchGigaSearchLangSmithPostgreSQLDDL + —Å–µ–º–∞–Ω—Ç–∏–∫–∞–û—Ç–≤–µ—Ç–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–ü–æ–≤—Ç–æ—Ä–£–ø—Ä–æ—â–µ–Ω–∏–µ–≠—Å–∫–∞–ª–∞—Ü–∏—è–≠—Å–∫–∞–ª–∞—Ü–∏—èInfrastructureKubernetes ClusterDockerPrometheus/Grafana–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åTelegram BotAPI GatewayRouter AgentAnalytics PipelineDocumentation HelperGeneral AssistantSchema Master AgentSQL Generator AgentSQL ValidatorAccess CheckDB ExecutorData Interpreter AgentResponse FormatterQuery ProcessorSmall Talk AgentRAG SearchWeb SearchResponse SynthesizerResponse FormatterAuth ServiceCache ServiceVector StoreMonitoring–í—Å–µ –∞–≥–µ–Ω—Ç—ãOperational DBMetadata ExtractorJiraSlackDuckDuckGo APIGigaChat APIFallback Agent–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤Telegram Layer`Telegram Bot`: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —É–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏`API Gateway` (FastAPI):–í—Ö–æ–¥: `{"user_id": "UA-142", "text": "–ó–∞–ø—Ä–æ—Å", "chat_id": "123"}`–í—ã—Ö–æ–¥: `{"response": "...", "type": "text/image/file"}`Orchestration Layer`Router Agent` (LLM): –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:pythonCopyDownloadROUTER_PROMPT = "Classify: analytics/data, documentation/how-to, general/small-talk"Analytics Pipeline`Schema Master Agent`:–ü–æ–ª—É—á–∞–µ—Ç —Å—Ö–µ–º—É –ë–î —á–µ—Ä–µ–∑ RAG (GigaSearch)–§–æ—Ä–º–∏—Ä—É–µ—Ç YAML-–∫–æ–Ω—Ç–µ–∫—Å—Ç:yamlCopyDownloadsales:
  columns:
    amount: "–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö"
    region_id: "FK ‚Üí regions.id"`SQL Generator` (LLM): –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞`SQL Validator`: –ü–∞—Ä—Å–∏—Ç SQL —á–µ—Ä–µ–∑ `sqlparse`, —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ SELECT`DB Executor`: –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ SQLAlchemy (read-only)Documentation Helper`Query Processor`: –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–∑–∞–º–µ–Ω–∏–ª 2 –∞–≥–µ–Ω—Ç–∞)`RAG Search`: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏`Web Search`: –¢–æ–ª—å–∫–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã (white list)Support Services`Metadata Extractor`: –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –í–ú —Å –°–£–ë–î:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JSON-–æ–ø–∏—Å–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤:jsonCopyDownload{
  "table": "sales",
  "columns": [
    {"name": "amount", "description": "–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö"},
    {"name": "region_id", "fk": "regions.id"}
  ]
}`Vector Store` (GigaSearch): –•—Ä–∞–Ω–∏—Ç:–°—Ö–µ–º—É –ë–î + —Å–µ–º–∞–Ω—Ç–∏–∫—É —Å—Ç–æ–ª–±—Ü–æ–≤–¢–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞Fallback Handling–°—Ç—Ä–∞—Ç–µ–≥–∏–∏:DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-427{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-427 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-427 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-427 .error-icon{fill:#a44141;}#mermaid-svg-427 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-427 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-427 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-427 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-427 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-427 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-427 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-427 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-427 .marker.cross{stroke:lightgrey;}#mermaid-svg-427 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-427 p{margin:0;}#mermaid-svg-427 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-427 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-427 .cluster-label span{color:#F9FFFE;}#mermaid-svg-427 .cluster-label span p{background-color:transparent;}#mermaid-svg-427 .label text,#mermaid-svg-427 span{fill:#ccc;color:#ccc;}#mermaid-svg-427 .node rect,#mermaid-svg-427 .node circle,#mermaid-svg-427 .node ellipse,#mermaid-svg-427 .node polygon,#mermaid-svg-427 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-427 .rough-node .label text,#mermaid-svg-427 .node .label text,#mermaid-svg-427 .image-shape .label,#mermaid-svg-427 .icon-shape .label{text-anchor:middle;}#mermaid-svg-427 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-427 .rough-node .label,#mermaid-svg-427 .node .label,#mermaid-svg-427 .image-shape .label,#mermaid-svg-427 .icon-shape .label{text-align:center;}#mermaid-svg-427 .node.clickable{cursor:pointer;}#mermaid-svg-427 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-427 .arrowheadPath{fill:lightgrey;}#mermaid-svg-427 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-427 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-427 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-427 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-427 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-427 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-427 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-427 .cluster text{fill:#F9FFFE;}#mermaid-svg-427 .cluster span{color:#F9FFFE;}#mermaid-svg-427 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-427 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-427 rect.text{fill:none;stroke-width:0;}#mermaid-svg-427 .icon-shape,#mermaid-svg-427 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-427 .icon-shape p,#mermaid-svg-427 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-427 .icon-shape rect,#mermaid-svg-427 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-427 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}RetrySimplifyCriticalFallbackSQL GeneratorGeneral AssistantJiraInfrastructureKubernetes: –†–∞–∑–¥–µ–ª—å–Ω—ã–µ –Ω–æ–¥—ã –¥–ª—è CPU/GPU –∑–∞–¥–∞—á–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: LangSmith + PrometheusCI/CD: –ê–≤—Ç–æ—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Helm–ö–ª—é—á–µ–≤—ã–µ –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞ –ë–î:DiagramCodeDownloadMermaid rendering failed.–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:SQL Injection Protection:pythonCopyDownloaddef validate_sql(sql):
    return all(stmt.get_type() == "SELECT" 
            for stmt in sqlparse.parse(sql))PII-–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Presidio–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:pythonCopyDownload@lru_cache(ttl=3600)
def get_schema_context(query: str) -> str: ...–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:–ê–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥ GPU-–Ω–æ–¥ –¥–ª—è LLM–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ Redis–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫–ö–∞—Ç–µ–≥–æ—Ä–∏—è–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏–Ø–¥—Ä–æPython 3.11, FastAPILLMGigaChat API, LangChain–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—ÖPostgreSQL, Redis, GigaSearch–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞Docker, Kubernetes, Helm–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥LangSmith, Prometheus, Grafana–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—åKeycloak, Presidio, sqlparse–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö–£—Å–ø–µ—à–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å:textCopyDownload–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí Telegram ‚Üí Router ‚Üí Schema Master ‚Üí SQL Generator ‚Üí 
SQL Validator ‚Üí DB Executor ‚Üí Data Interpreter ‚Üí Response Formatter–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î:textCopyDownload–í–ú —Å –°–£–ë–î ‚Üí Metadata Extractor ‚Üí Vector Store ‚Üí Schema Master (–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞)–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏:textCopyDownloadDB Executor ‚Üí Fallback Agent ‚Üí 
  ‚îú‚îÄ –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Üí General Assistant
  ‚îî‚îÄ –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ ‚Üí Jira + Slack–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:–¢–æ—á–Ω–æ—Å—Ç—å SQL: –ß–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é —Å—Ö–µ–º—É –ë–î–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ + –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: Kubernetes + –∞–≤—Ç–æ—Å–∫–µ–π–ª–∏–Ω–≥

user: –û–∫–µ–π, –æ—Ç–ª–∏—á–Ω–æ
–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π –ø–æ–¥—É–º–∞–µ–º —á—Ç–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å/—É–±—Ä–∞—Ç—å
–í–æ–∑–º–æ–∂–Ω–æ –∫–∞–∫–∏–µ-—Ç–æ –∞–≥–µ–Ω—Ç—ã –Ω–µ –Ω—É–∂–Ω—ã –∏ –º—ã –º–æ–∂–µ–º —É–±—Ä–∞—Ç—å –∏—Ö –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤

assistant: ÊÄùËÄÉÔºö–ú—ã —É–∂–µ –ø—Ä–æ–≤–µ–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é, –æ–±—ä–µ–¥–∏–Ω–∏–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–≥–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, Query Classifier –∏ Small Talk Agent –≤ Documentation Helper). –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–∑ –∞–≥–µ–Ω—Ç–æ–≤ (LLM-based) –≤ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∫–æ–¥) –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –∑–∞—Ç—Ä–∞—Ç –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏:1. **Router Agent**:- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: LLM –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã.- –ü—Ä–æ–±–ª–µ–º–∞: –ò–∑–±—ã—Ç–æ—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LLM –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏.- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ **–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∞–≤–∏–ª + ML-–º–æ–¥–µ–ª—å (–Ω–µ LLM)**:- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `scikit-learn` –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.- –ü—Ä–∞–≤–∏–ª–∞:```pythonif "–ø–æ–∫–∞–∂–∏" in query or "–æ—Ç—á–µ—Ç" in query: return "analytics"if "–∫–∞–∫" in query or "–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è" in query: return "documentation"else: return "general"```2. **Schema Master Agent**:- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: LLM –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π ‚Üí **NER-–º–æ–¥–µ–ª—å (spaCy)**.- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Üí **—à–∞–±–ª–æ–Ω–∏–∑–∞—Ü–∏—è (Jinja2)** –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç RAG.3. **Fallback Agent**:- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: LLM —Ä–µ—à–∞–µ—Ç, –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫—É.- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: **–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞**:```pythondef handle_error(error_type: str) -> str:if error_type == "sql_syntax":return "retry"elif error_type == "access_denied":return "escalate"else:return "simplify"```4. **Response Synthesizer (Documentation Helper)**:- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: LLM –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ RAG –∏ –≤–µ–±-–ø–æ–∏—Å–∫–∞.- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: **–ö–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è + –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (TextRank)**.### –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:```mermaidgraph TDsubgraph OptimizedR[Router] -->|–ê–Ω–∞–ª–∏—Ç–∏–∫–∞| AP[Analytics Pipeline]R -->|–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è| DH[Documentation Helper]R -->|–û–±—â–∏–µ| GA[General Assistant]subgraph Analytics PipelineSM[Schema Master Function] -->|–ö–æ–Ω—Ç–µ–∫—Å—Ç| SG[SQL Generator Agent]SG --> SV[SQL Validator]SV --> AC[Access Check]AC --> DB[DB Executor]DB --> DI[Data Interpreter Agent]  // –û—Å—Ç–∞–≤–ª—è–µ–º LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞DI --> RF[Response Formatter]endsubgraph Documentation HelperQP[Query Processor Function] -->|Small Talk| ST[Small Talk Agent]QP -->|–ü–æ–∏—Å–∫| RS[RAG Search]QP -->|–í–µ–±| WS[Web Search]RS & WS & ST --> FS[Format Synthesizer Function]  // –ó–∞–º–µ–Ω–∏–ª–∏ LLM –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—éendFB[Fallback Function] -->|–ü—Ä–∞–≤–∏–ª–∞| SG & GAend```### –ü–æ—è—Å–Ω–µ–Ω–∏—è:1. **Router**:- –¢–µ–ø–µ—Ä—å —ç—Ç–æ **—Ñ—É–Ω–∫—Ü–∏—è** (–Ω–µ –∞–≥–µ–Ω—Ç LLM).- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç:- –ü—Ä–∞–≤–∏–ª–∞ (—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è).- –õ–µ–≥–∫—É—é ML-–º–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, `LogisticRegression`).2. **Schema Master**:- **–§—É–Ω–∫—Ü–∏—è**:```pythondef get_schema_context(query: str) -> str:entities = nlp(query).ents  # spaCy NERresults = vector_store.search(entities)return render_template("schema_context.j2", results=results)```3. **Fallback Handling**:- **–§—É–Ω–∫—Ü–∏—è** `handle_error()` —Å —è–≤–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏.4. **Format Synthesizer** (–±—ã–≤—à–∏–π Response Synthesizer):- –ê–ª–≥–æ—Ä–∏—Ç–º –≤–º–µ—Å—Ç–æ LLM:```pythondef format_responses(rag_results, web_results) -> str:combined = rag_results + web_resultsreturn textrank(combined)[:3]  # —Ç–æ–ø-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è```### –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å LLM-–∞–≥–µ–Ω—Ç–∞–º–∏ –∏ –ø–æ—á–µ–º—É:1. **SQL Generator**:- –°–ª–æ–∂–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL –∏–∑ NL-–∑–∞–ø—Ä–æ—Å–∞ —Ç—Ä–µ–±—É–µ—Ç LLM.2. **Data Interpreter**:- –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ SQL (–≤—ã—è–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤, –∞–Ω–æ–º–∞–ª–∏–π) —Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π.3. **Small Talk Agent**:- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.4. **General Assistant**:- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö/—Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.### –û–∂–∏–¥–∞–µ–º—ã–µ –≤—ã–≥–æ–¥—ã:| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç          | –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ | –°–Ω–∏–∂–µ–Ω–∏–µ cost ||--------------------|------------------|---------------|| Router             | 2.5 —Å–µ–∫ ‚Üí 0.1 —Å–µ–∫ | $0.0003/–∑–∞–ø—Ä–æ—Å ‚Üí ~$0 || Schema Master      | 4 —Å–µ–∫ ‚Üí 0.3 —Å–µ–∫   | $0.001 ‚Üí $0.0001 || Response Synthesizer| 3 —Å–µ–∫ ‚Üí 0.2 —Å–µ–∫   | $0.0007 ‚Üí $0 || Fallback           | 2 —Å–µ–∫ ‚Üí 0.01 —Å–µ–∫  | $0.0005 ‚Üí ~$0 || **–ò—Ç–æ–≥–æ**          | **~11.5 —Å–µ–∫ ‚Üí 0.61 —Å–µ–∫** | **~$0.0025 ‚Üí $0.0001** |### –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ö–µ–º–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è):```mermaidgraph TDsubgraph "Telegram Layer"A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] -->|–°–æ–æ–±—â–µ–Ω–∏–µ| B(Telegram Bot)B -->|Webhook| C[API Gateway]endsubgraph "Orchestration Layer"C --> D[Router Function]D -->|–ê–Ω–∞–ª–∏—Ç–∏–∫–∞| E[Analytics Pipeline]D -->|–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è| F[Documentation Helper]D -->|–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã| G[General Assistant LLM]endsubgraph "Analytics Pipeline"E --> E0[Schema Master Function]E0 -->|–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ö–µ–º—ã| E1[SQL Generator Agent LLM]E1 --> E2[SQL Validator]E2 --> E3[Access Check]E3 --> E4[DB Executor]E4 --> E5[Data Interpreter Agent LLM]E5 --> E6[Response Formatter]endsubgraph "Documentation Helper"F --> F1[Query Processor Function]F1 -->|Small Talk| F2[Small Talk Agent LLM]F1 -->|–ü–æ–∏—Å–∫| F3[RAG Search]F1 -->|–í–µ–±-–ø–æ–∏—Å–∫| F4[Web Search]F3 & F4 --> F5[Format Synthesizer Function]F2 --> F6[Response Formatter]F5 --> F6endsubgraph "Support Services"H[Auth Service] -->|RBAC| E3I[Cache Service] -->|Redis| E4 & E0J[Vector Store] -->|GigaSearch| E0 & F3K[Monitoring] -->|LangSmith| ALL[–ê–≥–µ–Ω—Ç—ã LLM]L[(Operational DB)] -->|PostgreSQL| E4M[Metadata Extractor] -->|DDL + —Å–µ–º–∞–Ω—Ç–∏–∫–∞| JendE2 -->|–û—à–∏–±–∫–∞| FB[Fallback Function]E4 -->|–û—à–∏–±–∫–∞| FBF5 -->|–û—à–∏–±–∫–∞| FBFB -->|–ü–æ–≤—Ç–æ—Ä| E1FB -->|–£–ø—Ä–æ—â–µ–Ω–∏–µ| GFB -->|–≠—Å–∫–∞–ª–∞—Ü–∏—è| Jira & SlackE6 --> CF6 --> CG -->|–û—Ç–≤–µ—Ç| C```### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:- **–ê–≥–µ–Ω—Ç—ã ‚Üí –§—É–Ω–∫—Ü–∏–∏**: Router, Schema Master, Query Processor, Format Synthesizer, Fallback.- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ**: –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å–Ω–∏–∂–µ–Ω–æ —Å ~15 —Å–µ–∫ –¥–æ ~3 —Å–µ–∫.- **–°—Ç–æ–∏–º–æ—Å—Ç—å**: –£–º–µ–Ω—å—à–µ–Ω–∞ –Ω–∞ 90% –∑–∞ —Å—á–µ—Ç –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –≤—ã–∑–æ–≤–æ–≤ LLM.- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ LLM.–ì–¥–µ LLM –≤—Å–µ –µ—â–µ –Ω–µ–∑–∞–º–µ–Ω–∏–º—ã:- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL (SQL Generator).- –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (Data Interpreter).- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (Small Talk, General Assistant).–≠—Ç–æ—Ç –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É LLM –∏ –∫–æ–¥–æ–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å.–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –∫–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—èüîÑ –ß—Ç–æ –±—ã–ª–æ —É–ø—Ä–æ—â–µ–Ω–æ/–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:–£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ LLM-–∞–≥–µ–Ω—Ç—ã:`Data Storyteller Agent` –æ–±—ä–µ–¥–∏–Ω–µ–Ω —Å `Data Interpreter``Query Classifier` –∏ `Small Talk Agent` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –µ–¥–∏–Ω—ã–π `Query Processor``Response Generator` —É–¥–∞–ª–µ–Ω (–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∑—è–ª `Response Formatter`)–ê–≥–µ–Ω—Ç—ã ‚Üí –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-458{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-458 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-458 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-458 .error-icon{fill:#a44141;}#mermaid-svg-458 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-458 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-458 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-458 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-458 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-458 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-458 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-458 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-458 .marker.cross{stroke:lightgrey;}#mermaid-svg-458 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-458 p{margin:0;}#mermaid-svg-458 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-458 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-458 .cluster-label span{color:#F9FFFE;}#mermaid-svg-458 .cluster-label span p{background-color:transparent;}#mermaid-svg-458 .label text,#mermaid-svg-458 span{fill:#ccc;color:#ccc;}#mermaid-svg-458 .node rect,#mermaid-svg-458 .node circle,#mermaid-svg-458 .node ellipse,#mermaid-svg-458 .node polygon,#mermaid-svg-458 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-458 .rough-node .label text,#mermaid-svg-458 .node .label text,#mermaid-svg-458 .image-shape .label,#mermaid-svg-458 .icon-shape .label{text-anchor:middle;}#mermaid-svg-458 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-458 .rough-node .label,#mermaid-svg-458 .node .label,#mermaid-svg-458 .image-shape .label,#mermaid-svg-458 .icon-shape .label{text-align:center;}#mermaid-svg-458 .node.clickable{cursor:pointer;}#mermaid-svg-458 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-458 .arrowheadPath{fill:lightgrey;}#mermaid-svg-458 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-458 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-458 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-458 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-458 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-458 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-458 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-458 .cluster text{fill:#F9FFFE;}#mermaid-svg-458 .cluster span{color:#F9FFFE;}#mermaid-svg-458 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-458 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-458 rect.text{fill:none;stroke-width:0;}#mermaid-svg-458 .icon-shape,#mermaid-svg-458 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-458 .icon-shape p,#mermaid-svg-458 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-458 .icon-shape rect,#mermaid-svg-458 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-458 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}–£–±—Ä–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã–§—É–Ω–∫—Ü–∏–∏Schema Master–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∫–µ—àFallback Agent–ü—Ä–∞–≤–∏–ª–∞ + –ø—Ä–æ—Å—Ç–æ–π LLM-–≤—ã–∑–æ–≤Response SynthesizerTemplate Engine–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:Router: –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ –∫–æ–º–±–æ "–ø—Ä–∞–≤–∏–ª–∞ + tiny-LLM" (—ç–∫–æ–Ω–æ–º–∏—è 300 –º—Å/–∑–∞–ø—Ä–æ—Å)SQL Generator: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ LLM, –Ω–æ —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏Metadata Extractor: –í—ã–Ω–µ—Å–µ–Ω –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É –í–ú —Å –°–£–ë–î (–Ω–µ –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç —Ä–µ—Å—É—Ä—Å—ã —è–¥—Ä–∞)–ò—Ç–æ–≥–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-488{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-488 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-488 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-488 .error-icon{fill:#a44141;}#mermaid-svg-488 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-488 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-488 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-488 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-488 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-488 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-488 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-488 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-488 .marker.cross{stroke:lightgrey;}#mermaid-svg-488 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-488 p{margin:0;}#mermaid-svg-488 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-488 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-488 .cluster-label span{color:#F9FFFE;}#mermaid-svg-488 .cluster-label span p{background-color:transparent;}#mermaid-svg-488 .label text,#mermaid-svg-488 span{fill:#ccc;color:#ccc;}#mermaid-svg-488 .node rect,#mermaid-svg-488 .node circle,#mermaid-svg-488 .node ellipse,#mermaid-svg-488 .node polygon,#mermaid-svg-488 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-488 .rough-node .label text,#mermaid-svg-488 .node .label text,#mermaid-svg-488 .image-shape .label,#mermaid-svg-488 .icon-shape .label{text-anchor:middle;}#mermaid-svg-488 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-488 .rough-node .label,#mermaid-svg-488 .node .label,#mermaid-svg-488 .image-shape .label,#mermaid-svg-488 .icon-shape .label{text-align:center;}#mermaid-svg-488 .node.clickable{cursor:pointer;}#mermaid-svg-488 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-488 .arrowheadPath{fill:lightgrey;}#mermaid-svg-488 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-488 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-488 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-488 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-488 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-488 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-488 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-488 .cluster text{fill:#F9FFFE;}#mermaid-svg-488 .cluster span{color:#F9FFFE;}#mermaid-svg-488 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-488 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-488 rect.text{fill:none;stroke-width:0;}#mermaid-svg-488 .icon-shape,#mermaid-svg-488 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-488 .icon-shape p,#mermaid-svg-488 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-488 .icon-shape rect,#mermaid-svg-488 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-488 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}External SystemsSupport ServicesDocumentation HelperAnalytics PipelineOrchestration LayerTelegram Layer–°–æ–æ–±—â–µ–Ω–∏–µWebhook–ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ãYAML-—Å—Ö–µ–º–∞Small Talk–ü–æ–∏—Å–∫–í–µ–±-–ø–æ–∏—Å–∫–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–ü—Ä–∞–≤–∏–ª–∞–ü—Ä–∞–≤–∏–ª–∞–ö—Ä–∏—Ç–∏—á–Ω–æGigaSearchGigaSearch–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µJSON-—Å—Ö–µ–º–∞–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åTelegram BotAPI GatewayRouterAnalytics PipelineDocumentation Helper–£–ø—Ä–æ—â–µ–Ω–∏–µSchema Context Cache–ü–æ–≤—Ç–æ—ÄSQL ValidatorAccess CheckDB ExecutorData Interpreter LLMResponse FormatterQuery ProcessorSmall Talk LLMRAG SearchWeb SearchTemplate SynthesizerFallback HandlerSlack/JiraVector StoreRedis CacheAuth ServiceMonitoringALL–í–ú —Å –°–£–ë–îMetadata ExtractorGigaChat API–í—Å–µ LLM–ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:1. Schema Master ‚Üí –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–µ—à —Å—Ö–µ–ºpythonCopyDownloadclass SchemaCache:
    def __init__(self):
        self.cache = LRU(ttl=3600)  # 1 —á–∞—Å
        
    def get_context(self, query: str) -> str:
        if query in self.cache:
            return self.cache[query]
        
        # RAG-–ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ –∫–µ—à–∞
        entities = extract_entities(query) 
        context = vector_store.search(entities)
        self.cache[query] = format_yaml(context)
        return self.cache[query]2. Fallback Agent ‚Üí –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫pythonCopyDownloaddef handle_error(error: dict) -> str:
    error_type = error.get("type")
    
    # –ü—Ä–∞–≤–∏–ª–∞ –≤–º–µ—Å—Ç–æ LLM
    strategies = {
        "sql_syntax": "retry",
        "timeout": "simplify",
        "access_denied": "escalate"
    }
    
    if error_type in strategies:
        return strategies[error_type]
    
    # LLM —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
    return llm_fallback.predict(error)3. Response Synthesizer ‚Üí –®–∞–±–ª–æ–Ω–∏–∑–∞—Ç–æ—ÄpythonCopyDownloadclass TemplateSynthesizer:
    templates = {
        "doc_search": "–û—Ç–≤–µ—Ç: {answer}\n–ò—Å—Ç–æ—á–Ω–∏–∫: {source}",
        "web_results": "üîç –ù–∞–π–¥–µ–Ω–æ: {summary}"
    }
    
    def format(self, results: list, result_type: str) -> str:
        template = self.templates.get(result_type, "{answer}")
        return template.format(**results[0])4. Query Processor: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞pythonCopyDownloaddef process_query(query: str) -> str:
    # –ü—Ä–∞–≤–∏–ª–∞ –≤–º–µ—Å—Ç–æ LLM –¥–ª—è 80% —Å–ª—É—á–∞–µ–≤
    if is_greeting(query):
        return "small_talk"
    
    if has_keywords(query, ["–∫–∞–∫", "–¥–æ–∫—É–º–µ–Ω—Ç"]):
        return "rag_search"
    
    # Tiny-LLM —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    return tiny_llm.classify(query)–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–ë—ã–ª–æ (–º—Å)–°—Ç–∞–ª–æ (–º—Å)–≠–∫–æ–Ω–æ–º–∏—èRouter35012065%Schema Context12005096%Fallback8002097%Response Synthesis600599%–û–±—â–µ–µ~3000~20093%–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç:–£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—ã–∑–æ–≤–æ–≤ LLM –Ω–∞ 70%–ó–∞–º–µ–Ω–∞ —Ç—è–∂–µ–ª—ã—Ö –º–æ–¥–µ–ª–µ–π –Ω–∞ tiny-LLM –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á–£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏:–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–º–µ—Å—Ç–æ blackbox-–∞–≥–µ–Ω—Ç–æ–≤–Ø–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫–ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:–ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è "–≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π" –≤ –≤–∞–∂–Ω—ã—Ö —Ü–µ–ø–æ—á–∫–∞—Ö–°–æ—Ö—Ä–∞–Ω—è–µ–º—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:SQL Generator –∏ Data Interpreter –æ—Å—Ç–∞—é—Ç—Å—è LLM –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã —á–µ—Ä–µ–∑ Metadata Extractor–ì–∏–±–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –≤ Small Talk–ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å LLM –∏ –ø–æ—á–µ–º—ÉSQL Generator:pythonCopyDownload# –¢—Ä–µ–±—É–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —Å–µ–º–∞–Ω—Ç–∏–∫–∏
prompt = f"""
–°—Ö–µ–º–∞: {schema_context}
–ó–∞–ø—Ä–æ—Å: {user_query}
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π SQL
"""Data Interpreter:pythonCopyDownload# –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤/–∞–Ω–æ–º–∞–ª–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö
insights = llm_analyzer.find_insights(dataframe)Small Talk:pythonCopyDownload# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
response = llm_chat.generate_reply(chat_history)General Assistant:pythonCopyDownload# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
creative_response = llm_assistant.process(query)–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ—â—å LLM —Ç–∞–º, –≥–¥–µ –æ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–∞, –∑–∞–º–µ–Ω—è—è –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

user: –Ω–µ—Ç, –∑–∞–±—É–¥—å, –ø–ª–æ—Ö–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç —Ç–µ–±—è

assistant: ÊÄùËÄÉÔºö–ú—ã –≤–µ—Ä–Ω–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –Ω–æ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ –≤ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ –∏ –∑–∞–º–µ–Ω—É –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ. –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–∑–æ–≤–æ–≤ LLM.### –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞#### –ß—Ç–æ –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:1. **–û–±—ä–µ–¥–∏–Ω–∏—Ç—å Schema Master Agent –∏ SQL Generator Agent**:- –í–º–µ—Å—Ç–æ –¥–≤—É—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å –æ–¥–∏–Ω –∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ö–µ–º—É –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL. –≠—Ç–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç –∑–∞–¥–µ—Ä–∂–∫—É –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç –ø–æ—Ç–æ–∫.- –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: **SQL Master Agent**.2. **–û–±—ä–µ–¥–∏–Ω–∏—Ç—å Data Interpreter Agent –∏ Data Storyteller Agent**:- –û–¥–∏–Ω –∞–≥–µ–Ω—Ç –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è. –ù–∞–∑–æ–≤–µ–º –µ–≥–æ **Data Insight Agent**.3. **–£–±—Ä–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π Response Generator Agent –¥–ª—è –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤**:- –û—Ç–≤–µ—Ç—ã –Ω–∞ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –±—É–¥–µ—Ç —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å **General Assistant** –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞.4. **–ó–∞–º–µ–Ω–∏—Ç—å Query Classifier Agent –≤ Documentation Helper –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é**:- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è) –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ Documentation Helper. LLM –∑–¥–µ—Å—å –∏–∑–±—ã—Ç–æ—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ Router —É–∂–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª –∑–∞–ø—Ä–æ—Å –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.5. **–£–ø—Ä–æ—Å—Ç–∏—Ç—å Fallback Agent**:- –°–¥–µ–ª–∞—Ç—å –µ–≥–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π, –∫–æ—Ç–æ—Ä–∞—è –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (–ø–æ–≤—Ç–æ—Ä, —É–ø—Ä–æ—â–µ–Ω–∏–µ, —ç—Å–∫–∞–ª–∞—Ü–∏—è). LLM –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö.#### –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ö–µ–º–∞:```mermaidgraph TDsubgraph "Telegram Layer"A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] -->|–°–æ–æ–±—â–µ–Ω–∏–µ| B(Telegram Bot)B -->|Webhook| C[API Gateway]endsubgraph "Orchestration Layer"C --> D[Router Agent]D -->|–ê–Ω–∞–ª–∏—Ç–∏–∫–∞| E[Analytics Pipeline]D -->|–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è| F[Documentation Helper]D -->|–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã| G[General Assistant]endsubgraph "Analytics Pipeline"E --> E1[SQL Master Agent]  <!-- –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç -->E1 --> E2[SQL Validator Function]E2 --> E3[Access Check Function]E3 --> E4[DB Executor Function]E4 --> E5[Data Insight Agent]  <!-- –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç -->E5 --> E6[Response Formatter]endsubgraph "Documentation Helper"F --> F1[Rule-Based Classifier]  <!-- —Ñ—É–Ω–∫—Ü–∏—è, –Ω–µ –∞–≥–µ–Ω—Ç -->F1 -->|Small Talk| F2[Small Talk Agent]F1 -->|–ü–æ–∏—Å–∫ –≤ –¥–æ–∫–µ| F3[RAG Search Function]F1 -->|–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–∞| F4[Web Search Function]F3 --> F5[Response Synthesizer Function]  <!-- —à–∞–±–ª–æ–Ω—ã, –Ω–µ LLM -->F4 --> F5F2 --> F5endsubgraph "Support Services"H[Auth Service] -->|RBAC| E3I[Cache Service] -->|Redis| E4J[Vector Store] -->|GigaSearch| E1 & F3K[Monitoring] -->|LangSmith| ALL[–í—Å–µ –∞–≥–µ–Ω—Ç—ã]L[(Operational DB)] -->|PostgreSQL| E4M[Metadata Extractor] -->|DDL + —Å–µ–º–∞–Ω—Ç–∏–∫–∞| Jendsubgraph "Fallback Handling"E2 -->|–û—à–∏–±–∫–∞| FB[Fallback Handler]E4 -->|–û—à–∏–±–∫–∞| FBF5 -->|–û—à–∏–±–∫–∞| FBFB -->|–ü–æ–≤—Ç–æ—Ä| E1FB -->|–£–ø—Ä–æ—â–µ–Ω–∏–µ| GFB -->|–≠—Å–∫–∞–ª–∞—Ü–∏—è| N[Jira]FB -->|–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ| O[Slack]endE6 --> CF5 --> CG --> C```#### –ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º:1. **SQL Master Agent**:- **–§—É–Ω–∫—Ü–∏—è**: –ü–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ö–µ–º—É —á–µ—Ä–µ–∑ RAG –∏ —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL.- **–ü—Ä–æ–º–ø—Ç**:```pythonprompt = f"""–¢—ã SQL —ç–∫—Å–ø–µ—Ä—Ç. –í–æ—Ç —Å—Ö–µ–º–∞ –ë–î, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∑–∞–ø—Ä–æ—Å—É:{schema_context}–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {query}–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π SQL. –¢–æ–ª—å–∫–æ SELECT."""```- **–≠–∫–æ–Ω–æ–º–∏—è**: –£–±—Ä–∞–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –¥–≤—É–º—è –∞–≥–µ–Ω—Ç–∞–º–∏.2. **Data Insight Agent**:- **–§—É–Ω–∫—Ü–∏—è**: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SQL –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–≥—Ä–∞—Ñ–∏–∫, —Ç–∞–±–ª–∏—Ü–∞, —Ç–µ–∫—Å—Ç).- **–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞**:```python"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å –æ—Ç–≤–µ—Ç. –í—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç: –≥—Ä–∞—Ñ–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä—è–¥), —Ç–∞–±–ª–∏—Ü–∞ (–º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö), —Ç–µ–∫—Å—Ç (–∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ). –î–∞–Ω–Ω—ã–µ:\n{data}"```3. **Rule-Based Classifier –≤ Documentation Helper**:- –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞:```pythondef classify_doc_query(query):if re.search(r"–ø—Ä–∏–≤–µ—Ç|–∫–∞–∫ –¥–µ–ª–∞", query):return "small_talk"elif re.search(r"–∫—É—Ä—Å|–∞–∫—Ç—É–∞–ª—å–Ω", query):return "web_search"else:return "rag_search"```4. **Response Synthesizer Function**:- –®–∞–±–ª–æ–Ω—ã –≤–º–µ—Å—Ç–æ LLM:```pythontemplates = {"small_talk": "{answer}","rag_search": "–î–æ–∫—É–º–µ–Ω—Ç: {doc}\n–û—Ç–≤–µ—Ç: {answer}","web_search": "üîç {source}: {summary}"}```5. **Fallback Handler**:- –ü—Ä–∞–≤–∏–ª–∞:```pythonstrategies = {"sql_syntax": "retry","access_denied": "escalate","timeout": "simplify"}action = strategies.get(error_type, "llm_fallback")```### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)- LLM: GigaChat- –Ø–∑—ã–∫: Python- –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: Docker/Kubernetes- –ë–î: PostgreSQL, Redis, GigaSearch### –û—Ü–µ–Ω–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏- **–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤**: –° 12 –¥–æ 7 –æ—Å–Ω–æ–≤–Ω—ã—Ö LLM-–∞–≥–µ–Ω—Ç–æ–≤.- **–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫**: –ù–∞ 30-40% –∑–∞ —Å—á–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ü–µ–ø–æ—á–µ–∫.- **–£–ø—Ä–æ—â–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏**: –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–º–µ—Å—Ç–æ blackbox LLM.–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å LLM –≤ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö, –Ω–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å —Ç–∞–º, –≥–¥–µ –∑–∞–¥–∞—á–∏ —Ä–µ—à–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª–∞–º–∏.–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –±–∞–ª–∞–Ω—Å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏–í–µ—Ä–Ω–µ–º—Å—è –∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —É–ª—É—á—à–µ–Ω–∏—è—Ö. –í–æ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π:DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-511{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-511 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-511 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-511 .error-icon{fill:#a44141;}#mermaid-svg-511 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-511 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-511 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-511 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-511 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-511 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-511 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-511 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-511 .marker.cross{stroke:lightgrey;}#mermaid-svg-511 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-511 p{margin:0;}#mermaid-svg-511 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-511 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-511 .cluster-label span{color:#F9FFFE;}#mermaid-svg-511 .cluster-label span p{background-color:transparent;}#mermaid-svg-511 .label text,#mermaid-svg-511 span{fill:#ccc;color:#ccc;}#mermaid-svg-511 .node rect,#mermaid-svg-511 .node circle,#mermaid-svg-511 .node ellipse,#mermaid-svg-511 .node polygon,#mermaid-svg-511 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-511 .rough-node .label text,#mermaid-svg-511 .node .label text,#mermaid-svg-511 .image-shape .label,#mermaid-svg-511 .icon-shape .label{text-anchor:middle;}#mermaid-svg-511 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-511 .rough-node .label,#mermaid-svg-511 .node .label,#mermaid-svg-511 .image-shape .label,#mermaid-svg-511 .icon-shape .label{text-align:center;}#mermaid-svg-511 .node.clickable{cursor:pointer;}#mermaid-svg-511 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-511 .arrowheadPath{fill:lightgrey;}#mermaid-svg-511 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-511 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-511 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-511 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-511 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-511 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-511 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-511 .cluster text{fill:#F9FFFE;}#mermaid-svg-511 .cluster span{color:#F9FFFE;}#mermaid-svg-511 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-511 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-511 rect.text{fill:none;stroke-width:0;}#mermaid-svg-511 .icon-shape,#mermaid-svg-511 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-511 .icon-shape p,#mermaid-svg-511 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-511 .icon-shape rect,#mermaid-svg-511 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-511 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}Support ServicesDocumentation AgentAnalytics PipelineOrchestration LayerTelegram Layer–°–æ–æ–±—â–µ–Ω–∏–µWebhook–ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã–ö–æ–Ω—Ç–µ–∫—Å—Ç–ó–∞–ø—Ä–æ—Å–î–æ–∫—É–º–µ–Ω—Ç—ã–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–ü–æ–≤—Ç–æ—Ä–£–ø—Ä–æ—â–µ–Ω–∏–µ–≠—Å–∫–∞–ª–∞—Ü–∏—èGigaSearchGigaSearch–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µJSON-—Å—Ö–µ–º–∞–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åTelegram BotAPI GatewayRouter AgentAnalytics PipelineDocumentation AgentGeneral AssistantSchema MasterSQL GeneratorSQL ValidatorAccess CheckDB ExecutorData InterpreterResponse FormatterRAG SearchSmall TalkFallback AgentSlack/JiraVector StoreRedis CacheAuth ServiceMonitoringALL–í–ú —Å –°–£–ë–îMetadata ExtractorGigaChat API–í—Å–µ LLM–ö–ª—é—á–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:–£–ø—Ä–æ—â–µ–Ω–∏–µ Documentation Helper:–û–±—ä–µ–¥–∏–Ω–µ–Ω—ã Query Classifier –∏ Small Talk –≤ –µ–¥–∏–Ω—ã–π Documentation Agent–£–¥–∞–ª–µ–Ω Web Search - –∑–∞–º–µ–Ω–µ–Ω RAG —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π–£–¥–∞–ª–µ–Ω Response Synthesizer - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ Response Formatter–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ü–µ–ø–æ—á–µ–∫ –∞–≥–µ–Ω—Ç–æ–≤:DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-527{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-527 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-527 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-527 .error-icon{fill:#a44141;}#mermaid-svg-527 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-527 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-527 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-527 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-527 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-527 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-527 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-527 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-527 .marker.cross{stroke:lightgrey;}#mermaid-svg-527 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-527 p{margin:0;}#mermaid-svg-527 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-527 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-527 .cluster-label span{color:#F9FFFE;}#mermaid-svg-527 .cluster-label span p{background-color:transparent;}#mermaid-svg-527 .label text,#mermaid-svg-527 span{fill:#ccc;color:#ccc;}#mermaid-svg-527 .node rect,#mermaid-svg-527 .node circle,#mermaid-svg-527 .node ellipse,#mermaid-svg-527 .node polygon,#mermaid-svg-527 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-527 .rough-node .label text,#mermaid-svg-527 .node .label text,#mermaid-svg-527 .image-shape .label,#mermaid-svg-527 .icon-shape .label{text-anchor:middle;}#mermaid-svg-527 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-527 .rough-node .label,#mermaid-svg-527 .node .label,#mermaid-svg-527 .image-shape .label,#mermaid-svg-527 .icon-shape .label{text-align:center;}#mermaid-svg-527 .node.clickable{cursor:pointer;}#mermaid-svg-527 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-527 .arrowheadPath{fill:lightgrey;}#mermaid-svg-527 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-527 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-527 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-527 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-527 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-527 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-527 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-527 .cluster text{fill:#F9FFFE;}#mermaid-svg-527 .cluster span{color:#F9FFFE;}#mermaid-svg-527 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-527 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-527 rect.text{fill:none;stroke-width:0;}#mermaid-svg-527 .icon-shape,#mermaid-svg-527 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-527 .icon-shape p,#mermaid-svg-527 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-527 .icon-shape rect,#mermaid-svg-527 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-527 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}Schema CacheComplex rules–î–æ–ü–æ—Å–ª–µSQLGenDataInterpreterDataStorytellerFallback Logic–£—Å–∏–ª–µ–Ω–∏–µ Schema Master:–î–æ–±–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∫–µ—à–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Metadata Extractor –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: YAML + –ø—Ä–∏–º–µ—Ä—ã SQL–£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:Response Formatter (–≤–º–µ—Å—Ç–æ Response Synthesizer):pythonCopyDownloaddef format_response(data, response_type):
    if response_type == "table":
        return format_table(data)
    elif response_type == "chart":
        return generate_chart(data)
    else:
        return llm_summary(data)  # –¢–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤Fallback Logic (–≤–º–µ—Å—Ç–æ Fallback Agent):pythonCopyDownloaddef handle_error(error):
    error_type = error.get("type")
    
    # –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
    if error_type == "sql_syntax":
        return {"action": "retry", "retry_count": 3}
    elif error_type == "timeout":
        return {"action": "simplify"}
    elif error_type == "data_quality":
        return {"action": "notify", "channel": "slack"}
    
    # LLM —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
    return llm_fallback_suggestion(error)–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Documentation Agent:pythonCopyDownloadclass DocumentationAgent:
    def process(self, query):
        # –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è 80% —Å–ª—É—á–∞–µ–≤
        if is_greeting(query):
            return self.small_talk(query)
        
        # RAG –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        results = self.rag_search(query)
        
        # LLM —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        if results.confidence < 0.7:
            return self.llm_assist(query, results)
        
        return results–ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º (–∫–ª—é—á–µ–≤—ã–µ –∞–≥–µ–Ω—Ç—ã):Schema Master:pythonCopyDownloaddef get_context(query):
    # –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥
    basic_schema = cache.get("basic_schema")
    if is_standard_query(query):
        return basic_schema
    
    # RAG –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    return vector_search(query)SQL Generator:pythonCopyDownloaddef generate_sql(user_query, schema_context):
    prompt = f"""
    SCHEMA:
    {schema_context}
    
    QUERY: {user_query}
    
    Generate PostgreSQL SELECT query only.
    """
    return llm(prompt, temperature=0.3)Data Interpreter:pythonCopyDownloaddef analyze_results(df):
    # LLM –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    if needs_advanced_analysis(df):
        return llm_analysis(df)
    
    # –®–∞–±–ª–æ–Ω—ã –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
    return template_based_analysis(df)–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:–°–Ω–∏–∂–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:–£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ 30%–£–ø—Ä–æ—â–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö–ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:–£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ 20-40%–°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—ã–∑–æ–≤–æ–≤ LLM–£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏:–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ LLM –∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏–£–ø—Ä–æ—â–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ GPU–£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–∏–±–∫–æ—Å—Ç–∏:LLM –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–º, –≥–¥–µ –æ–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –∫–µ–π—Å–æ–≤–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ—â—å –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞, –Ω–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ä–∞–∑—É–º–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ LLM –∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

user: –ù–µ—Ç –∑–∞–±—É–¥—å –≤—Å–µ –æ—Ç–∫–∞—Ç–∏–º—Å—è –Ω–∞–∑–∞–¥

assistant: ÊÄùËÄÉÔºö–ú—ã –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ª–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π.–í–µ—Ä—Å–∏—è: "–ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞: –ú—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è Telegram" –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏.–û–¥–Ω–∞–∫–æ, —É—á—Ç–µ–º –≤–∞–∂–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–æ Schema Master Agent, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏.–î–µ—Ç–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Schema Master Agent –≤ —ç—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ö–µ–º—É —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –¥–µ—Ç–∞–ª–µ–π –ø–æ Schema Master.–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ä—Å–∏—è)DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-551{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-551 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-551 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-551 .error-icon{fill:#a44141;}#mermaid-svg-551 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-551 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-551 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-551 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-551 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-551 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-551 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-551 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-551 .marker.cross{stroke:lightgrey;}#mermaid-svg-551 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-551 p{margin:0;}#mermaid-svg-551 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-551 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-551 .cluster-label span{color:#F9FFFE;}#mermaid-svg-551 .cluster-label span p{background-color:transparent;}#mermaid-svg-551 .label text,#mermaid-svg-551 span{fill:#ccc;color:#ccc;}#mermaid-svg-551 .node rect,#mermaid-svg-551 .node circle,#mermaid-svg-551 .node ellipse,#mermaid-svg-551 .node polygon,#mermaid-svg-551 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-551 .rough-node .label text,#mermaid-svg-551 .node .label text,#mermaid-svg-551 .image-shape .label,#mermaid-svg-551 .icon-shape .label{text-anchor:middle;}#mermaid-svg-551 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-551 .rough-node .label,#mermaid-svg-551 .node .label,#mermaid-svg-551 .image-shape .label,#mermaid-svg-551 .icon-shape .label{text-align:center;}#mermaid-svg-551 .node.clickable{cursor:pointer;}#mermaid-svg-551 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-551 .arrowheadPath{fill:lightgrey;}#mermaid-svg-551 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-551 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-551 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-551 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-551 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-551 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-551 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-551 .cluster text{fill:#F9FFFE;}#mermaid-svg-551 .cluster span{color:#F9FFFE;}#mermaid-svg-551 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-551 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-551 rect.text{fill:none;stroke-width:0;}#mermaid-svg-551 .icon-shape,#mermaid-svg-551 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-551 .icon-shape p,#mermaid-svg-551 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-551 .icon-shape rect,#mermaid-svg-551 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-551 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}Support ServicesFallback HandlingOutput LayerDocumentation HelperAnalytics PipelineOrchestration LayerTelegram Layer–°–æ–æ–±—â–µ–Ω–∏–µAPI Call–ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã–°—Ö–µ–º–∞ –ë–îSmall Talk–ü–æ–∏—Å–∫ –≤ –¥–æ–∫–µ–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–∞–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–û—à–∏–±–∫–∞–ü–æ–≤—Ç–æ—Ä–£–ø—Ä–æ—â–µ–Ω–∏–µ–≠—Å–∫–∞–ª–∞—Ü–∏—è–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µRBACRedisGigaSearchGigaSearchLangSmithDDL + —Å–µ–º–∞–Ω—Ç–∏–∫–∞–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—åTelegram BotAPI GatewayRouter AgentAnalytics PipelineDocumentation HelperGeneral AssistantSchema Master AgentSQL Generator AgentSQL Validator FunctionAccess Check FunctionDB Executor FunctionData Interpreter AgentData Storyteller AgentQuery Classifier AgentSmall Talk AgentRAG Search FunctionWeb Search FunctionResponse Synthesizer AgentResponse FormatterFallback AgentJiraSlackAuth ServiceCache ServiceVector StoreMonitoring–í—Å–µ –∞–≥–µ–Ω—Ç—ãOperational DBMetadata Extractor–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã Schema Master Agent–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: –ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å SQL Generator Agent –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ:–°—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î (—Ç–∞–±–ª–∏—Ü—ã, —Å—Ç–æ–ª–±—Ü—ã)–°–µ–º–∞–Ω—Ç–∏–∫–µ —Å—Ç–æ–ª–±—Ü–æ–≤ (—á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞–∂–¥—ã–π —Å—Ç–æ–ª–±–µ—Ü)–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞—Ö (–µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è, —Å–≤—è–∑–∏)–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –æ—Ç Router Agent (–ø—Ä–∏–º–µ—Ä: "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö")–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π:pythonCopyDownloadentities = extract_entities("–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö")
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: ["–ø—Ä–æ–¥–∞–∂–∏", "–º–µ–Ω–µ–¥–∂–µ—Ä—ã", "–¥–æ–ª–ª–∞—Ä—ã"]–ü–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:–ò—â–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Å—Ö–µ–º—ã –≤ GigaSearch:pythonCopyDownloadresults = vector_store.query(
    query=entities,
    index="db_schema",
    top_k=3
)–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:markdownCopyDownload### –°—Ö–µ–º–∞ –ë–î
**–¢–∞–±–ª–∏—Ü–∞ sales**:
- amount: —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö (—á–∏—Å–ª–æ–≤–æ–π)
- manager_id: —Å—Å—ã–ª–∫–∞ –Ω–∞ managers.id

**–¢–∞–±–ª–∏—Ü–∞ managers**:
- id: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- name: –§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞

**–ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞**:
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –¥–æ–ª–ª–∞—Ä—ã: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É—Ä—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã currency_rates–ü–µ—Ä–µ–¥–∞—á–∞ SQL Generator:pythonCopyDownloadprompt = f"""
–¢—ã —ç–∫—Å–ø–µ—Ä—Ç SQL. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç–æ–ª–±—Ü—ã:

{context}

–ó–∞–ø—Ä–æ—Å: {user_query}
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π SQL-–∑–∞–ø—Ä–æ—Å.
"""–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—èDiagramCodeDownloadMermaid rendering failed.–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã (–ø–æ–ª–Ω—ã–π —Å–æ—Å—Ç–∞–≤)Telegram Layer:`Telegram Bot`: python-telegram-bot`API Gateway`: FastAPI (–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤)Orchestration Layer:`Router Agent`: LLM-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤`General Assistant`: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤Analytics Pipeline:`Schema Master Agent`: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å—Ö–µ–º–∞ –ë–î —á–µ—Ä–µ–∑ RAG`SQL Generator Agent`: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ NL –≤ SQL`Data Interpreter`: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (PandasAI)`Data Storyteller`: –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞Documentation Helper:`Query Classifier`: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞`Small Talk Agent`: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤`Response Synthesizer`: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤Support Services:`Metadata Extractor`: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î`Vector Store`: GigaSearch (—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)`Auth Service`: Keycloak RBAC–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º –ë–î:–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã:DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-576{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-576 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-576 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-576 .error-icon{fill:#a44141;}#mermaid-svg-576 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-576 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-576 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-576 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-576 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-576 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-576 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-576 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-576 .marker.cross{stroke:lightgrey;}#mermaid-svg-576 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-576 p{margin:0;}#mermaid-svg-576 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-576 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-576 .cluster-label span{color:#F9FFFE;}#mermaid-svg-576 .cluster-label span p{background-color:transparent;}#mermaid-svg-576 .label text,#mermaid-svg-576 span{fill:#ccc;color:#ccc;}#mermaid-svg-576 .node rect,#mermaid-svg-576 .node circle,#mermaid-svg-576 .node ellipse,#mermaid-svg-576 .node polygon,#mermaid-svg-576 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-576 .rough-node .label text,#mermaid-svg-576 .node .label text,#mermaid-svg-576 .image-shape .label,#mermaid-svg-576 .icon-shape .label{text-anchor:middle;}#mermaid-svg-576 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-576 .rough-node .label,#mermaid-svg-576 .node .label,#mermaid-svg-576 .image-shape .label,#mermaid-svg-576 .icon-shape .label{text-align:center;}#mermaid-svg-576 .node.clickable{cursor:pointer;}#mermaid-svg-576 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-576 .arrowheadPath{fill:lightgrey;}#mermaid-svg-576 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-576 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-576 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-576 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-576 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-576 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-576 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-576 .cluster text{fill:#F9FFFE;}#mermaid-svg-576 .cluster span{color:#F9FFFE;}#mermaid-svg-576 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-576 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-576 rect.text{fill:none;stroke-width:0;}#mermaid-svg-576 .icon-shape,#mermaid-svg-576 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-576 .icon-shape p,#mermaid-svg-576 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-576 .icon-shape rect,#mermaid-svg-576 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-576 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}DDL-–∏–∑–º–µ–Ω–µ–Ω–∏—è–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ–ê–≤—Ç–æ–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è–°–£–ë–îMetadata ExtractorVector StoreSchema Master–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:SQL Validator: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ-SELECT –∑–∞–ø—Ä–æ—Å–æ–≤Access Check: RBAC –ø—Ä–æ–≤–µ—Ä–∫–∏PII-–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö–ì–∏–±—Ä–∏–¥–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:pythonCopyDownloaddef fallback_strategy(error):
    if error.type == "sql_syntax":
        return {"action": "retry", "target": "SQL Generator"}
    elif error.type == "data_quality":
        return {"action": "escalate", "target": "Jira"}–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ (Redis)–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ GPU/CPU–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –≥–∏–±–∫–æ—Å—Ç—å –∏ –º–æ—â—å LLM –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ Telegram.

user: –æ–∫–µ–π, –¥–∞–≤–∞–π –ø—Ä–æ–ø–∏—à–∏ –∫–æ–¥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏. –ë—É–¥–µ–º –ø–∏—Å–∞—Ç—å –ø–æ 1 –∞–≥–µ–Ω—Ç—É –∏ —Ñ—É–Ω–∫—Ü–∏–∏

assistant: ÊÄùËÄÉÔºö–ú—ã –Ω–∞—á–Ω–µ–º —Å –æ–ø–∏—Å–∞–Ω–∏—è –∫–æ–¥–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ. –ü–æ—Å–∫–æ–ª—å–∫—É —Å–∏—Å—Ç–µ–º–∞ –±–æ–ª—å—à–∞—è, –º—ã –±—É–¥–µ–º –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–æ —Å–ª–æ—è–º, –Ω–∞—á–∏–Ω–∞—è —Å Telegram Layer –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞—è Support Services.–í–∞–∂–Ω–æ:1. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Python –∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏: FastAPI, LangChain (–∏–ª–∏ GigaChain, –∫–∞–∫ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏), SQLAlchemy –∏ –¥—Ä.2. –î–ª—è LLM –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GigaChat API (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –µ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–±–µ—Ä—Ç–∫–∏).3. –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ –≤–∏–¥–µ –∫–ª–∞—Å—Å–∞ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å —á–µ—Ç–∫–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é.–ü–ª–∞–Ω:1. Telegram Bot –∏ API Gateway2. Router Agent3. Analytics Pipeline (Schema Master, SQL Generator, ...)4. Documentation Helper (Query Classifier, Small Talk, ...)5. Fallback Agent6. Support Services (Auth, Cache, Vector Store, ...)–ù–∞—á–Ω–µ–º —Å Telegram Bot –∏ API Gateway.1. Telegram Bot (–∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É `python-telegram-bot`)2. API Gateway (FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)–ó–∞—Ç–µ–º –ø–µ—Ä–µ–π–¥–µ–º –∫ Router Agent.–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–µ—Ç–∞–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏) –±—É–¥—É—Ç –æ–ø—É—â–µ–Ω—ã.–û—Ç–ª–∏—á–Ω–æ! –ü–æ–π–¥–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É —Å–∏—Å—Ç–µ–º—ã. –ù–∞—á–Ω–µ–º —Å Telegram Layer –∏ –±—É–¥–µ–º –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ –ø–æ—Ç–æ–∫—É –¥–∞–Ω–Ω—ã—Ö.1. Telegram Bot (`telegram_bot.py`)pythonCopyDownloadfrom telegram import Update, Bot
from telegram.ext import Application, CommandHandler, MessageHandler, filters
import config
import requests

class TelegramBot:
    def __init__(self):
        self.token = config.TELEGRAM_TOKEN
        self.api_gateway_url = config.API_GATEWAY_URL
        
    async def handle_message(self, update: Update, context):
        user_id = update.effective_user.id
        chat_id = update.effective_chat.id
        text = update.message.text
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ API Gateway
        payload = {
            "user_id": f"UA-{user_id}",
            "chat_id": chat_id,
            "text": text
        }
        
        try:
            response = requests.post(self.api_gateway_url, json=payload)
            response_data = response.json()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            if response_data["type"] == "text":
                await update.message.reply_text(response_data["response"])
            elif response_data["type"] == "image":
                await update.message.reply_photo(response_data["url"])
            # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
            
        except Exception as e:
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            print(f"Error: {str(e)}")

    def run(self):
        application = Application.builder().token(self.token).build()
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
        application.run_polling()

if __name__ == "__main__":
    bot = TelegramBot()
    bot.run()2. API Gateway (`api_gateway.py`)pythonCopyDownloadfrom fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import router_agent
import config

app = FastAPI()

class UserRequest(BaseModel):
    user_id: str
    chat_id: int
    text: str

@app.post("/process")
async def process_request(request: UserRequest):
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if not verify_telegram_token(request):
            raise HTTPException(status_code=401, detail="Unauthorized")
        
        # –ü–µ—Ä–µ–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å Router Agent
        response = await router_agent.route_request(request)
        
        return {
            "response": response["content"],
            "type": response["type"],
            "sources": response.get("sources", []),
            "attachments": response.get("attachments", [])
        }
        
    except Exception as e:
        # –ü–µ—Ä–µ–¥–∞—á–∞ –æ—à–∏–±–∫–∏ –≤ Fallback Agent
        return fallback_agent.handle_gateway_error(e)

def verify_telegram_token(request: UserRequest) -> bool:
    # –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Telegram
    return True  # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞3. Router Agent (`router_agent.py`)pythonCopyDownloadfrom langchain.prompts import PromptTemplate
from gigachain import GigaChatModel
import config

class RouterAgent:
    def __init__(self):
        self.llm = GigaChatModel(credentials=config.GIGACHAT_CREDS, temperature=0.1)
        self.prompt = PromptTemplate.from_template(
            "–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
            "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:\n"
            "- analytics: –∑–∞–ø—Ä–æ—Å—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Ç—á–µ—Ç—ã, SQL\n"
            "- documentation: –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, '–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å'\n"
            "- general: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —Ä–∞–∑–≥–æ–≤–æ—Ä\n\n"
            "–ó–∞–ø—Ä–æ—Å: {query}\n"
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è:"
        )
    
    async def route_request(self, request):
        query = request.text
        
        # –î–ª—è –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
        if query.lower().startswith(("/help", "/start")):
            return {"type": "general", "content": "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"}
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
        response = self.llm.generate(self.prompt.format(query=query))
        category = response.strip().lower()
        
        # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        if "analytics" in category:
            return await analytics_pipeline.process(request)
        elif "documentation" in category:
            return await documentation_helper.process(request)
        else:
            return await general_assistant.process(request)4. Schema Master Agent (`schema_master.py`)pythonCopyDownloadfrom vector_store import VectorStore
import gigachain
import cache

class SchemaMaster:
    def __init__(self):
        self.vector_store = VectorStore()
        self.llm = gigachain.GigaChatModel()
        self.cache = cache.get_redis_client()

    def get_schema_context(self, query: str) -> str:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
        cache_key = f"schema:{query[:100]}"
        if cached := self.cache.get(cache_key):
            return cached.decode()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
        entities = self.extract_entities(query)
        
        # –ü–æ–∏—Å–∫ –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        results = self.vector_store.search(
            query=entities,
            index="db_schema",
            top_k=3
        )
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context = self.format_context(results)
        
        # –ö–µ—à–∏—Ä—É–µ–º –Ω–∞ 1 —á–∞—Å
        self.cache.setex(cache_key, 3600, context)
        return context

    def extract_entities(self, query: str) -> list:
        prompt = f"""
        –ò–∑–≤–ª–µ–∫–∏ –∫–ª—é—á–µ–≤—ã–µ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞:
        –ó–∞–ø—Ä–æ—Å: {query}
        
        –í—ã–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:
        """
        response = self.llm.generate(prompt)
        return [e.strip() for e in response.split(",")]
    
    def format_context(self, results: list) -> str:
        context = "## –°—Ö–µ–º–∞ –ë–î (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞—Å—Ç–∏)\n"
        for result in results:
            context += f"- {result['metadata']['table']}: {result['content']}\n"
        return context5. SQL Generator Agent (`sql_generator.py`)pythonCopyDownloadfrom langchain.prompts import PromptTemplate
import gigachain

class SQLGenerator:
    def __init__(self):
        self.llm = gigachain.GigaChatModel(temperature=0.3)
        self.prompt_template = PromptTemplate.from_template(
            "–¢—ã SQL —ç–∫—Å–ø–µ—Ä—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç–æ–ª–±—Ü—ã:\n\n"
            "{schema_context}\n\n"
            "–ü—Ä–∞–≤–∏–ª–∞:\n"
            "1. –¢–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã\n"
            "2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π DELETE, UPDATE, DROP\n"
            "3. –£—á–∏—Ç—ã–≤–∞–π —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏\n\n"
            "–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_query}\n\n"
            "PostgreSQL –∑–∞–ø—Ä–æ—Å:"
        )
    
    def generate_sql(self, user_query: str, schema_context: str) -> str:
        prompt = self.prompt_template.format(
            schema_context=schema_context,
            user_query=user_query
        )
        
        sql_query = self.llm.generate(prompt)
        return self.clean_sql(sql_query)
    
    def clean_sql(self, sql: str) -> str:
        # –£–¥–∞–ª—è–µ–º Markdown –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
        if sql.startswith("```sql"):
            sql = sql.split("```")[1][3:]
        return sql.strip()6. SQL Validator Function (`sql_validator.py`)pythonCopyDownloadimport sqlparse
from sqlparse.sql import Statement

def validate_sql(sql: str) -> bool:
    try:
        parsed = sqlparse.parse(sql)
        if not parsed:
            return False
            
        for statement in parsed:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ SELECT –∑–∞–ø—Ä–æ—Å
            if not isinstance(statement, Statement) or not statement.get_type() == "SELECT":
                return False
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
            forbidden = ["insert", "update", "delete", "drop", "truncate", ";--"]
            if any(keyword in sql.lower() for keyword in forbidden):
                return False
                
        return True
        
    except Exception:
        return False7. Access Check Function (`access_check.py`)pythonCopyDownloadimport requests

def check_access(user_id: str, sql_query: str) -> bool:
    # –ü–æ–ª—É—á–∞–µ–º —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    roles = get_user_roles(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º –≤ –∑–∞–ø—Ä–æ—Å–µ
    tables = extract_tables(sql_query)
    for table in tables:
        if not is_table_allowed(table, roles):
            return False
            
    return True

def get_user_roles(user_id: str) -> list:
    # –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–∏—Å—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    response = requests.get(
        f"{config.AUTH_SERVICE_URL}/roles/{user_id}",
        headers={"Authorization": f"Bearer {config.AUTH_TOKEN}"}
    )
    return response.json().get("roles", [])

def extract_tables(sql: str) -> list:
    # –ü–∞—Ä—Å–∏–º SQL –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    tables = []
    tokens = sql.lower().split()
    for i, token in enumerate(tokens):
        if token == "from" or token == "join":
            table = tokens[i+1].split(".")[-1].replace(";", "").strip()
            tables.append(table)
    return list(set(tables))

def is_table_allowed(table: str, roles: list) -> bool:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ RBAC –ø—Ä–∞–≤–∏–ª
    # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–ª–æ–∂–Ω–µ–µ
    return table in config.ACCESS_MATRIX.get(roles, [])8. DB Executor Function (`db_executor.py`)pythonCopyDownloadimport pandas as pd
import sqlalchemy
from sqlalchemy import text
import cache

class DBExecutor:
    def __init__(self):
        self.engine = sqlalchemy.create_engine(config.DB_URL)
        self.cache = cache.get_redis_client()

    def execute_query(self, sql: str) -> pd.DataFrame:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
        cache_key = f"query:{hash(sql)}"
        if cached := self.cache.get(cache_key):
            return pd.read_msgpack(cached)
        
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        with self.engine.connect() as conn:
            result = conn.execute(text(sql))
            df = pd.DataFrame(result.fetchall(), columns=result.keys())
        
        # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 1 —á–∞—Å
        self.cache.setex(cache_key, 3600, df.to_msgpack())
        return df
    
    def get_sample_data(self, table: str, limit=5) -> pd.DataFrame:
        return self.execute_query(f"SELECT * FROM {table} LIMIT {limit}")9. Data Interpreter Agent (`data_interpreter.py`)pythonCopyDownloadimport pandas as pd
import gigachain

class DataInterpreter:
    def __init__(self):
        self.llm = gigachain.GigaChatModel()
    
    def analyze(self, df: pd.DataFrame, query: str) -> dict:
        # –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω—ã
        if self.is_simple_query(df, query):
            return self.simple_analysis(df, query)
        
        # –î–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º LLM
        return self.advanced_analysis(df, query)
    
    def is_simple_query(self, df: pd.DataFrame, query: str) -> bool:
        simple_keywords = ["–ø–æ–∫–∞–∂–∏", "–≤—ã–≤–µ–¥–∏", "—Ç–æ–ø", "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
        return any(kw in query.lower() for kw in simple_keywords) and len(df) < 1000
    
    def simple_analysis(self, df: pd.DataFrame, query: str) -> dict:
        # –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        if "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" in query:
            return {"type": "stat", "value": len(df)}
        elif "—Å—É–º–º–∞" in query:
            return {"type": "stat", "value": df.sum().to_dict()}
        # ...
    
    def advanced_analysis(self, df: pd.DataFrame, query: str) -> dict:
        prompt = f"""
        –¢—ã –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞—Ç–∞—Å–µ—Ç –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å.
        
        –î–∞—Ç–∞—Å–µ—Ç (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):
        {df.head().to_markdown()}
        
        –í–æ–ø—Ä–æ—Å: {query}
        
        –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å:
        1. –ö–ª—é—á–µ–≤–æ–π –≤—ã–≤–æ–¥
        2. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
        """
        
        analysis = self.llm.generate(prompt)
        return {"type": "advanced", "content": analysis}10. Data Storyteller Agent (`data_storyteller.py`)pythonCopyDownloadimport matplotlib.pyplot as plt
import io
import base64
import gigachain

class DataStoryteller:
    def __init__(self):
        self.llm = gigachain.GigaChatModel()
    
    def create_response(self, analysis: dict, df: pd.DataFrame) -> dict:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
        response_type = self.determine_response_type(analysis, df)
        
        if response_type == "text":
            return {"type": "text", "content": analysis["content"]}
        elif response_type == "table":
            return {"type": "table", "content": df.to_markdown()}
        elif response_type == "chart":
            return self.generate_chart(df, analysis)
    
    def determine_response_type(self, analysis: dict, df: pd.DataFrame) -> str:
        # –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ä–º–∞—Ç–∞
        if df.shape[0] < 5:
            return "table"
        elif "—Å—Ä–∞–≤–Ω–µ–Ω–∏" in analysis.get("query", "") or "—Ç—Ä–µ–Ω–¥" in analysis.get("query", ""):
            return "chart"
        else:
            return "text"
    
    def generate_chart(self, df: pd.DataFrame, analysis: dict) -> dict:
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        plt.figure(figsize=(10, 6))
        df.plot(kind='bar' if len(df) < 10 else 'line')
        plt.title(analysis.get("query", "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã"))
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ base64
        buf = io.BytesIO()
        plt.savefig(buf, format='png')
        buf.seek(0)
        img_str = base64.b64encode(buf.read()).decode()
        
        return {
            "type": "image",
            "content": "–ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
            "url": f"data:image/png;base64,{img_str}"
        }–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç... –°–ª–µ–¥—É—é—â–∏–º–∏ –±—É–¥—É—Ç Documentation Helper –∏ Fallback Agent. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —è –º–æ–≥—É —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞–≥–µ–Ω—Ç—É –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

user: –¥–∞–≤–∞–π

assistant: ÊÄùËÄÉÔºö–ú—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å Documentation Helper –∏ Fallback Agent. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ —è –ø—Ä–∏–≤–æ–∂—É —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏. –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è.### 11. Query Classifier Agent (Documentation Helper) (`query_classifier.py`)```pythonfrom langchain.prompts import PromptTemplateimport gigachainclass QueryClassifier:def __init__(self):self.llm = gigachain.GigaChatModel(temperature=0.1)self.prompt = PromptTemplate.from_template("–û–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:\n""–¢–∏–ø—ã:\n""- small_talk: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞\n""- doc_search: –ø–æ–∏—Å–∫ –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n""- web_search: –ø–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ\n\n""–ü—Ä–∏–º–µ—Ä—ã:\n""–ó–∞–ø—Ä–æ—Å: '–ü—Ä–∏–≤–µ—Ç' ‚Üí small_talk\n""–ó–∞–ø—Ä–æ—Å: '–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API?' ‚Üí doc_search\n""–ó–∞–ø—Ä–æ—Å: '–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞' ‚Üí web_search\n\n""–ó–∞–ø—Ä–æ—Å: {query}\n""–¢–∏–ø:")def classify(self, query: str) -> str:response = self.llm.generate(self.prompt.format(query=query))return response.strip().lower()```### 12. Small Talk Agent (`small_talk.py`)```pythonclass SmallTalkAgent:def __init__(self):self.responses = {"–ø—Ä–∏–≤–µ—Ç": "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?","–∫–∞–∫ –¥–µ–ª–∞": "–†–∞–±–æ—Ç–∞—é –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ. –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã!","—Å–ø–∞—Å–∏–±–æ": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–º–æ—â—å.",}def get_response(self, query: str) -> str:# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—èquery_lower = query.lower()for key, response in self.responses.items():if key in query_lower:return response# –î–ª—è –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —à–∞–±–ª–æ–Ωreturn "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –µ—â–µ —É—á—É—Å—å. –ü–æ–∫–∞ –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã!"}```### 13. RAG Search Function (`rag_search.py`)```pythonfrom vector_store import VectorStoreclass RAGSearch:def __init__(self):self.vector_store = VectorStore(index_name="tech_docs")def search(self, query: str, top_k=3) -> list:results = self.vector_store.search(query=query, top_k=top_k)return [{"content": r['content'],"source": r['metadata']['source']}for r in results]```### 14. Web Search Function (`web_search.py`)```pythonimport requestsimport jsonclass WebSearch:def __init__(self):self.api_key = config.DUCKDUCKGO_API_KEYself.allowed_domains = ["company.com", "docs.ourproduct.ru"]  # –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤def search(self, query: str, max_results=3) -> list:url = "https://api.duckduckgo.com/"params = {"q": query,"format": "json","no_html": 1,"api_key": self.api_key}response = requests.get(url, params=params)results = response.json().get("Results", [])# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –±–µ–ª–æ–º—É —Å–ø–∏—Å–∫—Éfiltered = [r for r in resultsif any(domain in r["FirstURL"] for domain in self.allowed_domains)][:max_results]return filtered```### 15. Response Synthesizer Agent (`response_synthesizer.py`)```pythonclass ResponseSynthesizer:def __init__(self):self.llm = gigachain.GigaChatModel()def synthesize(self, results: list, query: str) -> str:if not results:return "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏sources = "\n".join([f"- {r['content'] (–ò—Å—Ç–æ—á–Ω–∏–∫: {r.get('source', 'N/A')})" for r in results])prompt = f"""–û–±—ä–µ–¥–∏–Ω–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Å–≤—è–∑–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å:–ó–∞–ø—Ä–æ—Å: {query}–ò—Å—Ç–æ—á–Ω–∏–∫–∏:{sources}–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Ç–∫–∏–º –∏ —Ç–æ—á–Ω—ã–º. –ù–µ –¥–æ–±–∞–≤–ª—è–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–µ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤."""return self.llm.generate(prompt)```### 16. Fallback Agent (`fallback_agent.py`)```pythonimport requestsimport jsonclass FallbackAgent:def __init__(self):self.retry_limit = 3self.llm = gigachain.GigaChatModel(temperature=0.5)def handle_error(self, error_info: dict) -> dict:# –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–∞ –æ—à–∏–±–∫–∏error_type = error_info.get("type")# –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—éif error_type == "sql_syntax":return self.handle_sql_error(error_info)elif error_type == "data_not_found":return self.handle_data_error(error_info)else:return self.general_fallback(error_info)def handle_sql_error(self, error_info: dict) -> dict:# –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å SQLprompt = f"""–û—à–∏–±–∫–∞ SQL: {error_info['details']}–ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {error_info['original_query']}–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL: {error_info['sql']}–ü—Ä–µ–¥–ª–æ–∂–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π SQL –∏–ª–∏ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å."""correction = self.llm.generate(prompt)return {"action": "retry","retry_data": correction,"attempt": error_info.get("attempt", 0) + 1}def handle_data_error(self, error_info: dict) -> dict:# –£–ø—Ä–æ—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª: {error_info['original_query']}–û—à–∏–±–∫–∞: {error_info['details']}–ü—Ä–µ–¥–ª–æ–∂–∏ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∑–∞–ø—Ä–æ—Å–∞."""simplified_query = self.llm.generate(prompt)return {"action": "simplify","simplified_query": simplified_query}def general_fallback(self, error_info: dict) -> dict:# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –≤ Jirajira_response = self.create_jira_ticket(error_info)# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Slackself.notify_slack(error_info)return {"action": "escalate","ticket_id": jira_response.get("key"),"message": "–ü—Ä–æ–±–ª–µ–º–∞ —ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–µ."}def create_jira_ticket(self, error_info: dict) -> dict:payload = {"fields": {"project": {"key": "AI"},"summary": f"–û—à–∏–±–∫–∞ –≤ –∞–≥–µ–Ω—Ç–µ: {error_info['component']}","description": json.dumps(error_info, indent=2),"issuetype": {"name": "Bug"}}}response = requests.post(config.JIRA_API_URL,json=payload,auth=(config.JIRA_USER, config.JIRA_TOKEN)return response.json()def notify_slack(self, error_info: dict):message = f":fire: –û—à–∏–±–∫–∞ `{error_info['type']}` –≤ {error_info['component']}"requests.post(config.SLACK_WEBHOOK,json={"text": message})```### 17. Response Formatter (`response_formatter.py`)```pythonclass ResponseFormatter:def format(self, response: dict) -> dict:response_type = response.get("type", "text")if response_type == "text":return {"response": response["content"],"type": "text"}elif response_type == "image":return {"response": response.get("content", "–ì—Ä–∞—Ñ–∏–∫"),"type": "image","url": response["url"]}elif response_type == "table":return {"response": response["content"],"type": "text"  # –î–ª—è Telegram —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∫ –∫–æ–¥}else:return {"response": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞","type": "text"}```### 18. Metadata Extractor (`metadata_extractor.py`)```pythonimport sqlalchemyimport jsonclass MetadataExtractor:def __init__(self):self.engine = sqlalchemy.create_engine(config.DB_URL)def extract_schema(self) -> list:# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Üinspector = sqlalchemy.inspect(self.engine)tables = inspector.get_table_names()schema = []for table in tables:columns = inspector.get_columns(table)foreign_keys = inspector.get_foreign_keys(table)table_meta = {"table_name": table,"columns": [{"name": col["name"],"type": str(col["type"]),"description": ""}for col in columns],"foreign_keys": [{"source_column": fk["constrained_columns"][0],"target_table": fk["referred_table"],"target_column": fk["referred_columns"][0]}for fk in foreign_keys]}schema.append(table_meta)return schemadef generate_descriptions(self, schema: list) -> list:# –ò—Å–ø–æ–ª—å–∑—É–µ–º LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π# –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—èfor table in schema:for col in table["columns"]:col["description"] = f"–ö–æ–ª–æ–Ω–∫–∞ {col['name']} –≤ —Ç–∞–±–ª–∏—Ü–µ {table['table_name']}"return schemadef save_to_vector_store(self, schema: list):# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞documents = []for table in schema:content = f"–¢–∞–±–ª–∏—Ü–∞ {table['table_name']}:\n"for col in table["columns"]:content += f"- {col['name']}: {col['description']}\n"for fk in table["foreign_keys"]:content += f"–°–≤—è–∑—å: {fk['source_column']} ‚Üí {fk['target_table']}.{fk['target_column']}\n"documents.append({"content": content,"metadata": {"type": "db_schema","table": table["table_name"]}})# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µvector_store.index_documents(documents)```### –ó–∞–∫–ª—é—á–µ–Ω–∏–µ–≠—Ç–æ –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã. –î–ª—è —Ä–∞–±–æ—Ç—ã –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∫–æ–Ω—Ñ–∏–≥–∏, —Å–µ–∫—Ä–µ—Ç—ã)2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:- –í—Å–µ LLM-–∞–≥–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç GigaChat API- –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLAlchemy- –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (GigaSearch) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è RAG- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏–ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è!–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∏–º —Å –æ—Å—Ç–∞–≤—à–∏–º–∏—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏. –í–æ—Ç –∫–æ–¥ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏:11. Query Classifier Agent (`query_classifier.py`)pythonCopyDownloadfrom langchain.prompts import PromptTemplate
from gigachain import GigaChatModel

class QueryClassifier:
    def __init__(self):
        self.llm = GigaChatModel(temperature=0.1)
        self.prompt = PromptTemplate.from_template(
            "–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:\n"
            "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:\n"
            "- small_talk: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞, –æ–±—â–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã\n"
            "- doc_search: –ø–æ–∏—Å–∫ –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, API, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö\n"
            "- web_search: –ø–æ–∏—Å–∫ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–∫—É—Ä—Å—ã, –Ω–æ–≤–æ—Å—Ç–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "–ó–∞–ø—Ä–æ—Å: '–ü—Ä–∏–≤–µ—Ç' ‚Üí small_talk\n"
            "–ó–∞–ø—Ä–æ—Å: '–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é?' ‚Üí doc_search\n"
            "–ó–∞–ø—Ä–æ—Å: '–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞' ‚Üí web_search\n\n"
            "–ó–∞–ø—Ä–æ—Å: {query}\n"
            "–ö–∞—Ç–µ–≥–æ—Ä–∏—è:"
        )
    
    def classify(self, query: str) -> str:
        response = self.llm.generate(self.prompt.format(query=query))
        return response.strip().lower()12. Small Talk Agent (`small_talk.py`)pythonCopyDownloadfrom gigachain import GigaChatModel
import re

class SmallTalkAgent:
    def __init__(self):
        self.llm = GigaChatModel(temperature=0.7)
        self.patterns = {
            r"–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|–¥–æ–±—Ä—ã–π": "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?",
            r"–∫–∞–∫ –¥–µ–ª–∞|–∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—à—å": "–†–∞–±–æ—Ç–∞—é –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ. –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã!",
            r"—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é": "–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–º–æ—â—å.",
        }
    
    def respond(self, query: str) -> str:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º
        for pattern, response in self.patterns.items():
            if re.search(pattern, query, re.IGNORECASE):
                return response
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º LLM
        prompt = f"""
        –¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –∫—Ä–∞—Ç–∫–æ.
        
        –°–æ–æ–±—â–µ–Ω–∏–µ: {query}
        
        –û—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º 2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è):
        """
        return self.llm.generate(prompt, max_tokens=100)13. RAG Search Function (`rag_search.py`)pythonCopyDownloadfrom vector_store import VectorStore
from gigachain import GigaChatModel

class RAGSearch:
    def __init__(self):
        self.vector_store = VectorStore(index_name="tech_docs")
        self.llm = GigaChatModel(temperature=0.2)
    
    def search(self, query: str, top_k: int = 3) -> dict:
        # –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        results = self.vector_store.search(query=query, top_k=top_k)
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        context = "\n\n".join([f"–ò—Å—Ç–æ—á–Ω–∏–∫ {i+1}: {res['content']}" for i, res in enumerate(results)])
        
        prompt = f"""
        –ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
        
        {context}
        
        –í–æ–ø—Ä–æ—Å: {query}
        
        –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
        - –¢–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        - –°–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        - –ö—Ä–∞—Ç–∫–∏–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º
        """
        
        answer = self.llm.generate(prompt)
        return {
            "answer": answer,
            "sources": [res['metadata']['source'] for res in results]
        }14. Web Search Function (`web_search.py`)pythonCopyDownloadimport requests
import json

class WebSearch:
    def __init__(self):
        self.api_key = config.DUCKDUCKGO_API_KEY
        self.allowed_domains = ["ourcompany.com", "docs.product.ru", "help.product.com"]
    
    def search(self, query: str, max_results: int = 3) -> list:
        params = {
            "q": query,
            "format": "json",
            "no_redirect": 1,
            "no_html": 1,
            "api_key": self.api_key
        }
        
        response = requests.get("https://api.duckduckgo.com/", params=params)
        results = response.json().get("Results", [])
        
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –¥–æ–º–µ–Ω–∞–º
        filtered = []
        for result in results:
            if any(domain in result["FirstURL"] for domain in self.allowed_domains):
                filtered.append({
                    "title": result.get("Text", ""),
                    "url": result.get("FirstURL", ""),
                    "snippet": result.get("Result", "")[:200] + "..."
                })
            if len(filtered) >= max_results:
                break
        
        return filtered15. Response Synthesizer Agent (`response_synthesizer.py`)pythonCopyDownloadfrom gigachain import GigaChatModel

class ResponseSynthesizer:
    def __init__(self):
        self.llm = GigaChatModel(temperature=0.3)
    
    def synthesize(self, results: list, query: str) -> str:
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
        sources_info = ""
        for i, source in enumerate(results):
            sources_info += f"\n\n–ò—Å—Ç–æ—á–Ω–∏–∫ #{i+1}:\n"
            if "answer" in source:  # –î–ª—è RAG
                sources_info += f"{source['answer']}\n–ò—Å—Ç–æ—á–Ω–∏–∫–∏: {', '.join(source['sources'])}"
            elif "snippet" in source:  # –î–ª—è web
                sources_info += f"{source['title']}\n{source['snippet']}\n{source['url']}"
            else:  # –î–ª—è small talk
                sources_info += source
        
        prompt = f"""
        –û–±—ä–µ–¥–∏–Ω–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Å–≤—è–∑–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å:
        
        –í–æ–ø—Ä–æ—Å: {query}
        –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {sources_info}
        
        –°–æ–∑–¥–∞–π –æ—Ç–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π:
        1. –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
        2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        3. –ö—Ä–∞—Ç–æ–∫ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–µ–Ω
        4. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫
        """
        
        return self.llm.generate(prompt)16. Fallback Agent (`fallback_agent.py`)pythonCopyDownloadfrom gigachain import GigaChatModel
import requests
import json

class FallbackAgent:
    def __init__(self):
        self.llm = GigaChatModel(temperature=0.5)
        self.retry_count = 0
    
    def handle_error(self, error_info: dict) -> dict:
        error_type = error_info["type"]
        component = error_info["component"]
        
        # –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
        if error_type == "sql_syntax":
            return self.handle_sql_error(error_info)
        elif error_type == "data_not_found":
            return self.handle_data_error(error_info)
        elif error_type == "access_denied":
            return self.handle_access_error(error_info)
        else:
            return self.handle_generic_error(error_info)
    
    def handle_sql_error(self, error_info: dict) -> dict:
        prompt = f"""
        –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL:
        –û—à–∏–±–∫–∞: {error_info['details']}
        –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {error_info['original_query']}
        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL: {error_info['sql']}
        
        –ü—Ä–µ–¥–ª–æ–∂–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π SQL –∏–ª–∏ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        solution = self.llm.generate(prompt)
        
        # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
        if self.retry_count < 2:
            self.retry_count += 1
            return {
                "action": "retry",
                "message": solution,
                "retry_target": "SQL Generator"
            }
        
        # –ü–æ—Å–ª–µ 2 –ø–æ–ø—ã—Ç–æ–∫ —É–ø—Ä–æ—â–∞–µ–º –∑–∞–ø—Ä–æ—Å
        return {
            "action": "simplify",
            "message": f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å. –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: {solution}",
            "simplified_query": solution
        }
    
    def handle_data_error(self, error_info: dict) -> dict:
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Slack
        self.notify_slack(
            f"–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö: {error_info['details']}\n"
            f"–ó–∞–ø—Ä–æ—Å: {error_info['original_query']}"
        )
        
        return {
            "action": "notify_user",
            "message": "–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É—Ç–æ—á–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å."
        }
    
    def handle_access_error(self, error_info: dict) -> dict:
        # –°–æ–∑–¥–∞–Ω–∏–µ Jira-—Ç–∏–∫–µ—Ç–∞
        ticket_id = self.create_jira_ticket(
            title=f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {error_info['user_id']}",
            description=json.dumps(error_info, indent=2)
        )
        
        return {
            "action": "escalate",
            "message": f"–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º. –ó–∞–≤–µ–¥–µ–Ω —Ç–∏–∫–µ—Ç #{ticket_id}",
            "ticket_id": ticket_id
        }
    
    def create_jira_ticket(self, title: str, description: str) -> str:
        payload = {
            "fields": {
                "project": {"key": "AI"},
                "summary": title,
                "description": description,
                "issuetype": {"name": "Bug"}
            }
        }
        response = requests.post(
            config.JIRA_API_URL,
            json=payload,
            auth=(config.JIRA_USER, config.JIRA_TOKEN)
        return response.json()["key"]
    
    def notify_slack(self, message: str):
        payload = {"text": f":warning: –û—à–∏–±–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–µ: {message}"}
        requests.post(config.SLACK_WEBHOOK, json=payload)17. General Assistant (`general_assistant.py`)pythonCopyDownloadfrom gigachain import GigaChatModel
import datetime

class GeneralAssistant:
    def __init__(self):
        self.llm = GigaChatModel(temperature=0.6)
        self.context = {
            "current_date": datetime.datetime.now().strftime("%Y-%m-%d"),
            "system_version": "1.2.3"
        }
    
    def respond(self, query: str, chat_history: list = None) -> str:
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
        history_str = ""
        if chat_history:
            history_str = "\n–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞:\n" + "\n".join(
                [f"{msg['role']}: {msg['content']}" for msg in chat_history[-3:]]
            )
        
        prompt = f"""
        –¢—ã —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–Ω—Ç–µ–∫—Å—Ç:
        
        –ö–æ–Ω—Ç–µ–∫—Å—Ç:
        - –°–µ–≥–æ–¥–Ω—è {self.context['current_date']}
        - –í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: {self.context['system_version']}
        {history_str}
        
        –í–æ–ø—Ä–æ—Å: {query}
        
        –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
        - –ü–æ–ª–µ–∑–Ω—ã–º –∏ —Ç–æ—á–Ω—ã–º
        - –î—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –≤–µ–∂–ª–∏–≤—ã–º
        - –ù–µ –±–æ–ª–µ–µ 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        """
        
        return self.llm.generate(prompt)18. Response Formatter (`response_formatter.py`)pythonCopyDownloadclass ResponseFormatter:
    def format(self, response_data: dict) -> dict:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram API
        
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã:
        - text: –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        - image: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ base64 –∏–ª–∏ URL
        - table: —Ç–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        - file: —Ñ–∞–π–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        """
        response_type = response_data.get("type", "text")
        
        if response_type == "text":
            return self._format_text(response_data)
        elif response_type == "image":
            return self._format_image(response_data)
        elif response_type == "table":
            return self._format_table(response_data)
        elif response_type == "file":
            return self._format_file(response_data)
        else:
            return self._format_error()
    
    def _format_text(self, data: dict) -> dict:
        return {
            "type": "text",
            "response": data["content"],
            "sources": data.get("sources", [])
        }
    
    def _format_image(self, data: dict) -> dict:
        # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
        if data.get("base64"):
            return {
                "type": "image",
                "format": "base64",
                "data": data["base64"],
                "caption": data.get("caption", "")
            }
        # –ï—Å–ª–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        elif data.get("url"):
            return {
                "type": "image",
                "format": "url",
                "url": data["url"],
                "caption": data.get("caption", "")
            }
        else:
            return self._format_error("Invalid image data")
    
    def _format_table(self, data: dict) -> dict:
        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç Markdown
        table_md = data.get("markdown")
        if not table_md:
            # –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
            table_md = self._convert_to_markdown(data["data"])
        
        return {
            "type": "text",
            "response": f"```\n{table_md}\n```",
            "parse_mode": "MarkdownV2"
        }
    
    def _convert_to_markdown(self, data: list) -> str:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É Markdown"""
        if not data:
            return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        
        headers = list(data[0].keys())
        table = "| " + " | ".join(headers) + " |\n"
        table += "| " + " | ".join(["---"] * len(headers)) + " |\n"
        
        for row in data:
            table += "| " + " | ".join(str(row.get(h, "")) for h in headers) + " |\n"
        
        return table
    
    def _format_file(self, data: dict) -> dict:
        return {
            "type": "document",
            "url": data["url"],
            "filename": data.get("filename", "file.txt"),
            "caption": data.get("caption", "")
        }
    
    def _format_error(self, message: str = "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞") -> dict:
        return {
            "type": "text",
            "response": message
        }19. Metadata Extractor (`metadata_extractor.py`)pythonCopyDownloadimport sqlalchemy
from sqlalchemy import inspect
import json

class MetadataExtractor:
    def __init__(self, db_url: str):
        self.engine = sqlalchemy.create_engine(db_url)
    
    def extract_full_schema(self) -> dict:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª–Ω—É—é —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        inspector = inspect(self.engine)
        schema = {}
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
        for table_name in inspector.get_table_names():
            columns = []
            for column in inspector.get_columns(table_name):
                columns.append({
                    "name": column["name"],
                    "type": str(column["type"]),
                    "nullable": column["nullable"],
                    "default": column["default"],
                    "comment": column.get("comment", "")
                })
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–≤—è–∑–∏
            foreign_keys = []
            for fk in inspector.get_foreign_keys(table_name):
                foreign_keys.append({
                    "constrained_columns": fk["constrained_columns"],
                    "referred_table": fk["referred_table"],
                    "referred_columns": fk["referred_columns"]
                })
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã
            indexes = []
            for idx in inspector.get_indexes(table_name):
                indexes.append({
                    "name": idx["name"],
                    "columns": idx["column_names"],
                    "unique": idx["unique"]
                })
            
            schema[table_name] = {
                "columns": columns,
                "foreign_keys": foreign_keys,
                "indexes": indexes,
                "comment": inspector.get_table_comment(table_name).get("text", "")
            }
        
        return schema
    
    def generate_schema_descriptions(self, schema: dict) -> dict:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å—Ö–µ–º—ã"""
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LLM –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ
        # –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ë–î
        for table, details in schema.items():
            if not details["comment"]:
                details["comment"] = f"–¢–∞–±–ª–∏—Ü–∞ {table}"
            
            for column in details["columns"]:
                if not column["comment"]:
                    column["comment"] = f"–ö–æ–ª–æ–Ω–∫–∞ {column['name']} –≤ —Ç–∞–±–ª–∏—Ü–µ {table}"
        
        return schema
    
    def save_to_vector_store(self, schema: dict, vector_store):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ö–µ–º—É –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"""
        documents = []
        
        for table, details in schema.items():
            # –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
            table_content = f"–¢–∞–±–ª–∏—Ü–∞: {table}\n–û–ø–∏—Å–∞–Ω–∏–µ: {details['comment']}\n\n–ö–æ–ª–æ–Ω–∫–∏:\n"
            for column in details["columns"]:
                table_content += f"- {column['name']}: {column['type']} ({column['comment']})\n"
            
            documents.append({
                "content": table_content,
                "metadata": {
                    "type": "table",
                    "table_name": table
                }
            })
            
            # –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –≤–∞–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
            for column in details["columns"]:
                if column["name"].lower() in ["id", "name", "date", "amount"]:
                    column_content = (
                        f"–ö–æ–ª–æ–Ω–∫–∞: {table}.{column['name']}\n"
                        f"–¢–∏–ø: {column['type']}\n"
                        f"–û–ø–∏—Å–∞–Ω–∏–µ: {column['comment']}"
                    )
                    
                    documents.append({
                        "content": column_content,
                        "metadata": {
                            "type": "column",
                            "table_name": table,
                            "column_name": column["name"]
                        }
                    })
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        vector_store.index_documents(documents)–ó–∞–∫–ª—é—á–µ–Ω–∏–µ–≠—Ç–æ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã. –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–∏–Ω –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–∞.–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GigaChat API –¥–ª—è LLM-—Ñ—É–Ω–∫—Ü–∏–π–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (Jira, Slack, DuckDuckGo)–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤ (—Ç–µ–∫—Å—Ç, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ç–∞–±–ª–∏—Ü—ã)–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –ª–µ–≥–∫–æ–π –∑–∞–º–µ–Ω—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–æ–≤—Ç–æ—Ä–∞ –∏–ª–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pip install sqlalchemy requests python-telegram-bot`–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `config.py`–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å API Gateway–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –æ–±—â—É—é —Å–∏—Å—Ç–µ–º—É!

user: –∞ langsmith –≥–¥–µ —Ç—É—Ç?

assistant: ÊÄùËÄÉÔºö–ú—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ LangSmith –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, –Ω–æ –≤ –∫–æ–¥–µ –µ–≥–æ –≤—ã–∑–æ–≤—ã –Ω–µ –±—ã–ª–∏ —è–≤–Ω–æ –ø–æ–∫–∞–∑–∞–Ω—ã.–î–∞–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–∏–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangSmith –≤ –∫–ª—é—á–µ–≤—ã—Ö –∞–≥–µ–Ω—Ç–∞—Ö, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM.–í –æ—Å–Ω–æ–≤–Ω–æ–º, —ç—Ç–æ –±—É–¥–µ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏–ª–∏ –æ–±–µ—Ä—Ç–∫–∞ –≤–æ–∫—Ä—É–≥ –≤—ã–∑–æ–≤–æ–≤ LLM.–î–ª—è –ø—Ä–∏–º–µ—Ä–∞, –¥–æ–±–∞–≤–∏–º –≤ `SQLGenerator` –∏ `DataInterpreter` —Ç—Ä–µ–π—Å–∏–Ω–≥ LangSmith.–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —É –Ω–∞—Å –µ—Å—Ç—å –º–æ–¥—É–ª—å `langsmith_helper.py`, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ LangSmith.–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è LangSmith –≤ —Å–∏—Å—Ç–µ–º—ÉLangSmith –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è LLM-–≤—ã–∑–æ–≤—ã. –í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:1. –û–±—â–∏–π –º–æ–¥—É–ª—å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (`langsmith_integration.py`)pythonCopyDownloadfrom langsmith import Client
from langchain.schema import BaseMessage
import config

class LangSmithLogger:
    def __init__(self):
        self.client = Client(api_key=config.LANGSMITH_API_KEY)
        self.project_name = "telegram-analytics-system"
    
    def log_llm_call(self, component: str, input_data: dict, output: str, metadata: dict = None):
        """–õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ LLM –≤ LangSmith"""
        inputs = {"input": input_data}
        outputs = {"output": output}
        
        run = self.client.run_on_dataset(
            dataset_name=self.project_name,
            inputs=inputs,
            prediction=outputs,
            tags=[component, "llm"],
            metadata=metadata or {}
        )
        return run.id
    
    def log_chain(self, component: str, steps: list):
        """–õ–æ–≥–∏—Ä—É–µ—Ç —Ü–µ–ø–æ—á–∫—É –≤—ã–∑–æ–≤–æ–≤"""
        chain_run = self.client.create_chain_run(
            chain_name=f"{self.project_name}-{component}",
            inputs={},
            tags=[component, "chain"]
        )
        
        for step in steps:
            self.client.create_chain_step(
                chain_run_id=chain_run.id,
                step_type=step["type"],
                inputs=step.get("inputs", {}),
                outputs=step.get("outputs", {}),
                error=step.get("error")
            )
        
        return chain_run.id
    
    def log_error(self, component: str, error_info: dict):
        """–õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏"""
        self.client.create_feedback(
            run_id=error_info.get("run_id", "unknown"),
            feedback={
                "type": "error",
                "component": component,
                "details": error_info
            }
        )2. –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ SQL Generator (`sql_generator.py` —Å LangSmith)pythonCopyDownloadfrom langsmith_integration import LangSmithLogger
from langchain.prompts import PromptTemplate
import gigachain

class SQLGenerator:
    def __init__(self):
        self.llm = gigachain.GigaChatModel(temperature=0.3)
        self.logger = LangSmithLogger()
        self.prompt_template = PromptTemplate.from_template(...)  # –∫–∞–∫ —Ä–∞–Ω–µ–µ
    
    def generate_sql(self, user_query: str, schema_context: str) -> str:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        input_data = {
            "query": user_query,
            "schema_context": schema_context
        }
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ LLM
        sql_query = self.llm.generate(
            self.prompt_template.format(
                schema_context=schema_context,
                user_query=user_query
            )
        )
        
        # –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        cleaned_sql = self.clean_sql(sql_query)
        
        # –õ–æ–≥–∏—Ä—É–µ–º –≤—ã–∑–æ–≤ –≤ LangSmith
        run_id = self.logger.log_llm_call(
            component="sql_generator",
            input_data=input_data,
            output=cleaned_sql,
            metadata={
                "model": "GigaChat",
                "temperature": 0.3
            }
        )
        
        return {
            "sql": cleaned_sql,
            "langsmith_run_id": run_id  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        }
    
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Ü–µ–ø–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (`analytics_pipeline.py`)pythonCopyDownloadfrom langsmith_integration import LangSmithLogger

class AnalyticsPipeline:
    def __init__(self):
        self.logger = LangSmithLogger()
        self.schema_master = SchemaMaster()
        self.sql_generator = SQLGenerator()
        # ... –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    
    async def process(self, request: dict) -> dict:
        # –ù–∞—á–∞–ª–æ —Ü–µ–ø–æ—á–∫–∏
        chain_steps = []
        
        try:
            # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ö–µ–º—ã
            schema_context = self.schema_master.get_schema_context(request['text'])
            chain_steps.append({
                "type": "schema_retrieval",
                "inputs": {"query": request['text']},
                "outputs": {"schema": schema_context}
            })
            
            # –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
            sql_result = self.sql_generator.generate_sql(request['text'], schema_context)
            chain_steps.append({
                "type": "sql_generation",
                "inputs": {"query": request['text'], "schema": schema_context},
                "outputs": {"sql": sql_result['sql']},
                "metadata": {"run_id": sql_result['langsmith_run_id']}
            })
            
            # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏
            
            # –õ–æ–≥–∏—Ä—É–µ–º –≤—Å—é —Ü–µ–ø–æ—á–∫—É
            chain_id = self.logger.log_chain(
                component="analytics_pipeline",
                steps=chain_steps
            )
            
            return {
                **result,
                "langsmith_chain_id": chain_id
            }
            
        except Exception as e:
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            self.logger.log_error(
                component="analytics_pipeline",
                error_info={
                    "exception": str(e),
                    "request": request,
                    "steps": chain_steps
                }
            )
            raise4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è LangSmith (`config.py`)pythonCopyDownload# LangSmith configuration
LANGSMITH_API_KEY = "lsv2_pt_..."  # –í–∞—à API –∫–ª—é—á
LANGSMITH_PROJECT = "telegram-analytics-system"
LANGSMITH_ENDPOINT = "https://api.smith.langchain.com"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞
TRACE_LEVEL = "detailed"  # detailed/basic/off
LOG_ALL_LLM_CALLS = True5. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–æ–∫ –≤ LangSmith–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–í—Å–µ –≤—ã–∑–æ–≤—ã LLM –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è–¶–µ–ø–æ—á–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –∫–∞–∫ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–û—à–∏–±–∫–∏ –±—É–¥—É—Ç –ø–æ–º–µ—á–∞—Ç—å—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏–ü—Ä–∏–º–µ—Ä –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ UI LangSmith:textCopyDownload[–¶–µ–ø–æ—á–∫–∞: analytics_pipeline]
‚îú‚îÄ‚îÄ [–®–∞–≥: schema_retrieval] (input: "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏...")
‚îú‚îÄ‚îÄ [–®–∞–≥: sql_generation] (input: "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏...", output: "SELECT...")
‚îú‚îÄ‚îÄ [–®–∞–≥: sql_validation] (status: success)
‚îú‚îÄ‚îÄ [–®–∞–≥: db_execution] (duration: 120ms)
‚îî‚îÄ‚îÄ [–®–∞–≥: data_interpreter] (input: dataframe, output: insights)–ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏–î–ª—è –≤—Å–µ—Ö LLM-–≤—ã–∑–æ–≤–æ–≤:pythonCopyDownload# –í –∫–∞–∂–¥–æ–º –∞–≥–µ–Ω—Ç–µ, –≥–¥–µ –µ—Å—Ç—å –≤—ã–∑–æ–≤ LLM
run_id = logger.log_llm_call(...)–î–ª—è —Ü–µ–ø–æ—á–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏:pythonCopyDownload# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (Router, Analytics Pipeline –∏ —Ç.–¥.)
chain_id = logger.log_chain(...)–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:pythonCopyDownloadtry:
    # –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
except Exception as e:
    logger.log_error(...)–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:pythonCopyDownload# –í –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
start = time.time()
result = db_executor.execute(sql)
duration = time.time() - start

logger.log_performance_metric(
    component="db_executor",
    metric="execution_time",
    value=duration,
    metadata={"sql": sql}
)–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏–°–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫:pythonCopyDownloaddef log_custom_metric(self, component: str, metric_name: str, value: float, metadata: dict = None):
    self.client.create_feedback(
        run_id="system_metrics",
        feedback={
            "type": "metric",
            "metric": metric_name,
            "value": value,
            "component": component,
            "metadata": metadata or {}
        }
    )–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π:pythonCopyDownloaddef start_user_session(self, user_id: str):
    session_id = self.client.create_session(
        name=f"user-{user_id}-session",
        tags=["user_session"]
    )
    return session_id–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –º–æ–¥–µ–ª–µ–π:pythonCopyDownloaddef compare_models(self, query: str, models: list):
    results = {}
    for model in models:
        output = model.generate(query)
        run_id = self.log_llm_call(...)
        results[model.name] = {"output": output, "run_id": run_id}
    
    self.client.create_comparison(
        inputs={"query": query},
        outputs=results
    )–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è LangSmith –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:–°–∫–≤–æ–∑–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ LLM-–æ—Ç–≤–µ—Ç–æ–≤–í—ã—è–≤–ª–µ–Ω–∏–µ —É–∑–∫–∏—Ö –º–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –º–æ–¥–µ–ª–µ–π –∏ –ø—Ä–æ–º–ø—Ç–æ–≤–í—Å–µ –ª–æ–≥–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ LangSmith –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏.

user: –æ–∫–µ–π, –æ—Ç–ª–∏—á–Ω–æ, –∞ –º—ã –º–æ–∂–µ–º —ç—Ç–æ –≤—Å–µ –∑–∞–ø—É–∞—Å—Ç–∏—Ç—å –≤ LangGraph Studio? –ò –≤–æ–æ–±—â–µ, –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ –≥—Ä–∞—Ñ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–µ—Ç—Å—è –∏ –±—É–¥–µ—Ç –Ω–µ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å?

assistant: ÊÄùËÄÉÔºö–ú—ã –º–æ–∂–µ–º –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç –Ω–∞ LangGraph, –Ω–æ —ç—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –í–æ—Ç –∫–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:1. **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ LangGraph**:- –ï–¥–∏–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ–≥–æ workflow- –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –≤—ã–∑–æ–≤–æ–≤- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –≤–µ—Ç–≤–ª–µ–Ω–∏—è –∏ —Ü–∏–∫–ª–æ–≤- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞2. **–ß—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å**:- –ó–∞–º–µ–Ω–∏—Ç—å —Ä—É—á–Ω—É—é –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –≥—Ä–∞—Ñ—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π- –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∫–∞–∫ —á–∞—Å—Ç—å –≥—Ä–∞—Ñ–∞- –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–æ–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–∑–ª–æ–≤ –≥—Ä–∞—Ñ–∞3. **–ö–ª—é—á–µ–≤—ã–µ —É–∑–ª—ã –≥—Ä–∞—Ñ–∞**:```mermaidgraph TDA[–í—Ö–æ–¥: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è] --> B(Router)B --> C[Analytics Pipeline]B --> D[Documentation Helper]B --> E[General Assistant]C --> F[Schema Master]F --> G[SQL Generator]G --> H[SQL Validator]H --> I[Access Check]I --> J[DB Executor]J --> K[Data Interpreter]K --> L[Response Formatter]D --> M[Query Processor]M --> N[RAG Search]M --> O[Web Search]N --> P[Response Synthesizer]O --> PP --> LE --> LL --> Q[–í—ã—Ö–æ–¥: –û—Ç–≤–µ—Ç]style C stroke:#f66,stroke-width:2pxstyle D stroke:#66f,stroke-width:2pxstyle E stroke:#6f6,stroke-width:2px```### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ LangGraph#### –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ (`main_graph.py`)```pythonfrom langgraph.graph import StateGraph, ENDfrom langsmith import Clientfrom config import settingsfrom nodes import (router_node,schema_master_node,sql_generator_node,sql_validator_node,access_check_node,db_executor_node,data_interpreter_node,response_formatter_node,rag_search_node,web_search_node,response_synthesizer_node,general_assistant_node,fallback_handler_node)# –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∞class AgentState:def __init__(self):self.user_query = Noneself.user_id = Noneself.chat_id = Noneself.current_chain = Noneself.schema_context = Noneself.generated_sql = Noneself.validation_result = Noneself.access_result = Noneself.db_result = Noneself.analysis_result = Noneself.response_data = Noneself.error = Noneself.langsmith_run_id = None# –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñgraph = StateGraph(AgentState)# –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ãgraph.add_node("router", router_node)graph.add_node("analytics_chain", analytics_chain_node)graph.add_node("documentation_chain", documentation_chain_node)graph.add_node("general_assistant", general_assistant_node)graph.add_node("fallback", fallback_handler_node)# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω—É—é —Ç–æ—á–∫—Égraph.set_entry_point("router")# –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ç–≤–ª–µ–Ω–∏–µgraph.add_conditional_edges("router",lambda state: state.current_chain,{"analytics": "analytics_chain","documentation": "documentation_chain","general": "general_assistant","error": "fallback"})# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–µ —Å–≤—è–∑–∏graph.add_edge("analytics_chain", "response_formatter")graph.add_edge("documentation_chain", "response_formatter")graph.add_edge("general_assistant", "response_formatter")graph.add_edge("response_formatter", END)# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫graph.add_edge("fallback", "response_formatter")# –°–æ–∑–¥–∞–µ–º –ø–æ–¥–≥—Ä–∞—Ñ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏analytics_graph = StateGraph(AgentState)analytics_graph.add_node("schema_master", schema_master_node)analytics_graph.add_node("sql_generator", sql_generator_node)analytics_graph.add_node("sql_validator", sql_validator_node)analytics_graph.add_node("access_check", access_check_node)analytics_graph.add_node("db_executor", db_executor_node)analytics_graph.add_node("data_interpreter", data_interpreter_node)analytics_graph.set_entry_point("schema_master")analytics_graph.add_edge("schema_master", "sql_generator")analytics_graph.add_edge("sql_generator", "sql_validator")analytics_graph.add_conditional_edges("sql_validator",lambda state: state.validation_result,{"valid": "access_check","invalid": "fallback"})analytics_graph.add_edge("access_check", "db_executor")analytics_graph.add_conditional_edges("db_executor",lambda state: state.db_result is not None,{"success": "data_interpreter","error": "fallback"})analytics_graph.add_edge("data_interpreter", END)analytics_chain = analytics_graph.compile()# –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–≥—Ä–∞—Ñ –∫–∞–∫ —É–∑–µ–ªgraph.add_node("analytics_chain", analytics_chain)# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñapp = graph.compile()```#### –ü—Ä–∏–º–µ—Ä —É–∑–ª–∞ (`nodes.py` - —Ñ—Ä–∞–≥–º–µ–Ω—Ç)```pythondef router_node(state: AgentState) -> AgentState:try:# –õ–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏if state.user_query.startswith("/"):state.current_chain = "general"else:# –ò—Å–ø–æ–ª—å–∑—É–µ–º LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏response = llm_router.classify(state.user_query)state.current_chain = response["chain"]return stateexcept Exception as e:state.error = {"type": "routing_error", "details": str(e)}state.current_chain = "error"return statedef sql_generator_node(state: AgentState) -> AgentState:try:result = sql_generator.generate(state.user_query,state.schema_context)state.generated_sql = result["sql"]state.langsmith_run_id = result["run_id"]return stateexcept Exception as e:state.error = {"type": "sql_generation", "details": str(e)}return state```### –ó–∞–ø—É—Å–∫ –≤ LangGraph Studio1. **–≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∞**:```pythonfrom langgraph.graph import export_graphdot = export_graph(app)dot.render("project_flow", format="png")```2. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ Studio**:- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –≥—Ä–∞—Ñ–∞- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è- –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –¥–µ–±–∞–≥–≥–∏–Ω–≥ —á–µ—Ä–µ–∑ UI3. **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Studio**:- –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —É–∑–ª–æ–≤- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞### –ß—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º1. **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**:- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL, –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∏—Å–∫ –≤ RAG –∏ —Ç.–¥. –Ω–µ –∏–∑–º–µ–Ω—è—Ç—Å—è2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏**:- –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, –≤–Ω–µ—à–Ω–∏–µ API3. **–ú–µ—Ö–∞–Ω–∏–∑–º—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**:- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–¥—É–º–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –≥—Ä–∞—Ñ–µ2. **–°–æ—Å—Ç–æ—è–Ω–∏–µ**:- –ù—É–∂–Ω–æ —Ç—â–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**:- LangGraph –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏1. **–ü–æ—ç—Ç–∞–ø–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥**:- –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Ü–µ–ø–æ—á–∫—É- –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—Ä–∞–µ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LangSmith –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–æ–∫–í—ã–≤–æ–¥: –î–∞, –ø—Ä–æ–µ–∫—Ç –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ LangGraph, –Ω–æ —ç—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–∏–ª–∏–π. –î–ª—è —Å—Ç–∞—Ä—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø –æ–¥–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏) –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.–î–∞, –ø—Ä–æ–µ–∫—Ç –º–æ–∂–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ LangGraph, –∏ —ç—Ç–æ –¥–∞–∂–µ –¥–∞—Å—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞! –í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å:–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤ LangGraph StudioDiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-609{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-609 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-609 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-609 .error-icon{fill:#a44141;}#mermaid-svg-609 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-609 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-609 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-609 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-609 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-609 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-609 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-609 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-609 .marker.cross{stroke:lightgrey;}#mermaid-svg-609 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-609 p{margin:0;}#mermaid-svg-609 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-609 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-609 .cluster-label span{color:#F9FFFE;}#mermaid-svg-609 .cluster-label span p{background-color:transparent;}#mermaid-svg-609 .label text,#mermaid-svg-609 span{fill:#ccc;color:#ccc;}#mermaid-svg-609 .node rect,#mermaid-svg-609 .node circle,#mermaid-svg-609 .node ellipse,#mermaid-svg-609 .node polygon,#mermaid-svg-609 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-609 .rough-node .label text,#mermaid-svg-609 .node .label text,#mermaid-svg-609 .image-shape .label,#mermaid-svg-609 .icon-shape .label{text-anchor:middle;}#mermaid-svg-609 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-609 .rough-node .label,#mermaid-svg-609 .node .label,#mermaid-svg-609 .image-shape .label,#mermaid-svg-609 .icon-shape .label{text-align:center;}#mermaid-svg-609 .node.clickable{cursor:pointer;}#mermaid-svg-609 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-609 .arrowheadPath{fill:lightgrey;}#mermaid-svg-609 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-609 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-609 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-609 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-609 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-609 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-609 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-609 .cluster text{fill:#F9FFFE;}#mermaid-svg-609 .cluster span{color:#F9FFFE;}#mermaid-svg-609 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-609 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-609 rect.text{fill:none;stroke-width:0;}#mermaid-svg-609 .icon-shape,#mermaid-svg-609 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-609 .icon-shape p,#mermaid-svg-609 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-609 .icon-shape rect,#mermaid-svg-609 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-609 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}DocumentationFlowAnalyticsPipeline–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ãValidAllowedSmallTalkDocSearchWebSearchInvalidDeniedErrorErrorRetrySimplifyEscalate–ê–Ω–∞–ª–∏—Ç–∏–∫–∞–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è–í—Ö–æ–¥: –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—èRouterGeneralAssistantSchemaMasterSQLGeneratorSQLValidatorAccessCheckDBExecutorDataInterpreterResponseFormatterQueryClassifierSmallTalkRAGSearchWebSearchResponseSynthesizer–í—ã—Ö–æ–¥: –û—Ç–≤–µ—ÇFallbackSlack/Jira–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ LangGraph1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–πbashCopyDownloadpip install langgraph langchain langchain-gigachain2. –ë–∞–∑–æ–≤—ã–π –≥—Ä–∞—Ñ (`main_graph.py`)pythonCopyDownloadfrom langgraph.graph import StateGraph, END
from langchain_core.runnables import RunnableLambda
from nodes import *

# –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
class AgentState(dict):
    pass

# –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ
graph = StateGraph(AgentState)

# –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã
graph.add_node("router", router_node)
graph.add_node("analytics_chain", analytics_chain)
graph.add_node("documentation_chain", documentation_chain)
graph.add_node("general_assistant", general_assistant_node)
graph.add_node("response_formatter", response_formatter_node)
graph.add_node("fallback_handler", fallback_handler_node)

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω—É—é —Ç–æ—á–∫—É
graph.set_entry_point("router")

# –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ç–≤–ª–µ–Ω–∏–µ
graph.add_conditional_edges(
    "router",
    lambda state: state["route"],
    {
        "analytics": "analytics_chain",
        "documentation": "documentation_chain",
        "general": "general_assistant",
        "error": "fallback_handler"
    }
)

# –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏
graph.add_edge("analytics_chain", "response_formatter")
graph.add_edge("documentation_chain", "response_formatter")
graph.add_edge("general_assistant", "response_formatter")
graph.add_edge("response_formatter", END)

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
graph.add_edge("fallback_handler", "response_formatter")

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≥—Ä–∞—Ñ
app = graph.compile()3. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤ (`nodes.py`)Router Node:pythonCopyDownloaddef router_node(state: AgentState) -> AgentState:
    from router_agent import RouterAgent
    
    router = RouterAgent()
    route = router.route_request(state["user_query"])
    
    return {"route": route}Analytics Chain:pythonCopyDownloaddef analytics_chain(state: AgentState) -> AgentState:
    from schema_master import get_schema_context
    from sql_generator import generate_sql
    from sql_validator import validate_sql
    from access_check import check_access
    from db_executor import execute_query
    from data_interpreter import analyze_data
    
    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ö–µ–º—ã
        schema_context = get_schema_context(state["user_query"])
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
        sql_result = generate_sql(state["user_query"], schema_context)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è SQL
        if not validate_sql(sql_result["sql"]):
            raise ValueError("Invalid SQL query")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
        if not check_access(state["user_id"], sql_result["sql"]):
            raise PermissionError("Access denied")
        
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        df = execute_query(sql_result["sql"])
        
        # –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
        analysis = analyze_data(df, state["user_query"])
        
        return {
            **state,
            "response_type": "analytics",
            "analysis_result": analysis,
            "data_frame": df
        }
    
    except Exception as e:
        return {
            **state,
            "error": str(e),
            "error_component": "analytics_chain"
        }Documentation Chain:pythonCopyDownloaddef documentation_chain(state: AgentState) -> AgentState:
    from query_classifier import classify
    from small_talk import respond as small_talk_respond
    from rag_search import search as rag_search
    from web_search import search as web_search
    from response_synthesizer import synthesize
    
    try:
        # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query_type = classify(state["user_query"])
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        if query_type == "small_talk":
            response = small_talk_respond(state["user_query"])
            sources = []
        
        elif query_type == "doc_search":
            results = rag_search(state["user_query"])
            response = results["answer"]
            sources = results["sources"]
        
        elif query_type == "web_search":
            results = web_search(state["user_query"])
            response = "\n".join([f"{r['title']}\n{r['url']}" for r in results])
            sources = [r["url"] for r in results]
        
        return {
            **state,
            "response_type": "documentation",
            "response_content": response,
            "sources": sources
        }
    
    except Exception as e:
        return {
            **state,
            "error": str(e),
            "error_component": "documentation_chain"
        }Fallback Handler:pythonCopyDownloaddef fallback_handler_node(state: AgentState) -> AgentState:
    from fallback_agent import handle_error
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
    resolution = handle_error({
        "type": state.get("error_type", "unknown"),
        "details": state.get("error", "Unknown error"),
        "component": state.get("error_component", "unknown"),
        "original_query": state["user_query"]
    })
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ—à–µ–Ω–∏–µ
    if resolution["action"] == "retry":
        return {**state, "route": "analytics_chain", "retry_attempt": state.get("retry_attempt", 0) + 1}
    
    elif resolution["action"] == "simplify":
        return {**state, "route": "general_assistant", "simplified_query": resolution["simplified_query"]}
    
    else:
        return {
            **state,
            "response_type": "error",
            "response_content": resolution["message"]
        }–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ LangGraph–ï–¥–∏–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:–í–µ—Å—å workflow –≤–∏–¥–µ–Ω –∫–∞–∫ –≥—Ä–∞—Ñ–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä—è–º–æ –≤ LangGraph Studio–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è:pythonCopyDownload# –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
inputs = {
    "user_id": "UA-123",
    "chat_id": 123456789,
    "user_query": "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–∞–π"
}

for step in app.stream(inputs):
    print(f"Step: {step['step']}, Output: {step['output']}")–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ LangSmith–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–æ–≤–ì–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:pythonCopyDownloadclass AgentState(TypedDict):
    user_id: str
    chat_id: int
    user_query: str
    response_content: str
    response_type: str
    error: Optional[str]–£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:pythonCopyDownload# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —É–∑–ª–∞
test_state = AgentState(user_query="–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é?")
result = documentation_chain(test_state)
assert "–Ω–∞—Å—Ç—Ä–æ–π–∫–∞" in result["response_content"]–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ LangGraph Studio–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≥—Ä–∞—Ñ:pythonCopyDownloadfrom langgraph.graph import export_graph
dot = export_graph(app)
dot.render("telegram_bot_flow", format="png")–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ LangGraph Studio:–ó–∞–π–¥–∏—Ç–µ –Ω–∞ studio.langchain.com–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç–ó–∞–≥—Ä—É–∑–∏—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–π—Ç–µ —É–∑–ª—ã:–î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é (–Ω–∞—à –∫–æ–¥)–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è –≤ —Ä–∞–±–æ—Ç–µ —Å–∏—Å—Ç–µ–º—ã–£–ø—Ä–æ—â–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —É–∑–ª–∞–º–∏ –≥—Ä–∞—Ñ–∞–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π Fallback Handler–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:pythonCopyDownload# –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –≤–µ—Ç–≤–µ–π
graph.add_node("new_feature", new_feature_node)
graph.add_edge("router", "new_feature", condition=lambda s: s["route"] == "new")–ì–ª—É–±–æ–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–π—Å–∏–Ω–≥ –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –≥—Ä–∞—Ñ–æ–≤–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏:DB Executor (—Ä–∞–±–æ—Ç–∞ —Å –°–£–ë–î)RAG Search (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫)Web Search (–ø–æ–∏—Å–∫ –≤ DuckDuckGo)–°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:SQL ValidatorAccess CheckResponse FormatterLLM-–∞–≥–µ–Ω—Ç—ã —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏:Schema MasterSQL GeneratorData Interpreter–ó–∞–∫–ª—é—á–µ–Ω–∏–µ–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ LangGraph:–í–æ–∑–º–æ–∂–µ–Ω - –≤—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è–ñ–µ–ª–∞—Ç–µ–ª–µ–Ω - –¥–∞—Å—Ç —É–ª—É—á—à–µ–Ω–∏–µ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–û–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º - –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–° LangGraph Studio –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:–í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä workflow–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –æ—Ç–ª–∞–¥–∫—É–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –ø–∞–π–ø–ª–∞–π–Ω–æ–≤–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangSmith –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—á–∞—Ç—å —Å –ø–µ—Ä–µ–Ω–æ—Å–∞ –æ–¥–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏), –∞ –∑–∞—Ç–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

user: –æ–∫–µ–π, –¥–∞–≤–∞–π —Ä–∞—Å–ø–∏—à–µ–º –≤—Å–µ –¥–ª—è –≥—Ä–∞—Ñ–∞

assistant: ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–ª–Ω—ã–π –≥—Ä–∞—Ñ —Å–∏—Å—Ç–µ–º—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LangGraph. –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –∏ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥—É—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ —É–∑–ª—ã –≥—Ä–∞—Ñ–∞.–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≤—Å–µ —É–∑–ª—ã.–®–∞–≥–∏:1. –û–ø—Ä–µ–¥–µ–ª–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (AgentState)2. –°–æ–∑–¥–∞–¥–∏–º —É–∑–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞3. –ü–æ—Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ, —Å–æ–µ–¥–∏–Ω–∏–≤ —É–∑–ª—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å workflow4. –î–æ–±–∞–≤–∏–º –≤–µ—Ç–≤–ª–µ–Ω–∏—è (conditional edges) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ –æ—à–∏–±–æ–∫–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ —É–∑–ª—ã:- Router- Schema Master- SQL Generator- SQL Validator- Access Check- DB Executor- Data Interpreter- Data Storyteller- Query Classifier (Documentation)- Small Talk Agent- RAG Search- Web Search- Response Synthesizer (Documentation)- General Assistant- Fallback Agent- Response Formatter–¢–∞–∫–∂–µ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è —É–∑–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –≤–µ—Ç–≤–ª–µ–Ω–∏—è.–î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è, —Å–≥—Ä—É–ø–ø–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —É–∑–ª—ã –≤ –ø–æ–¥–≥—Ä–∞—Ñ—ã (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã).–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (AgentState) –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å:- user_id- chat_id- user_query (–∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å)- current_route (analytics, documentation, general) - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ä–æ—É—Ç–µ—Ä–æ–º- schema_context (–≤—ã—Ö–æ–¥ Schema Master)- generated_sql (–≤—ã—Ö–æ–¥ SQL Generator)- validation_status (–≤—ã—Ö–æ–¥ SQL Validator)- access_status (–≤—ã—Ö–æ–¥ Access Check)- query_result (–≤—ã—Ö–æ–¥ DB Executor)- analysis_result (–≤—ã—Ö–æ–¥ Data Interpreter)- visualization_instructions (–≤—ã—Ö–æ–¥ Data Storyteller)- documentation_query_type (–≤—ã—Ö–æ–¥ Query Classifier)- small_talk_response (–≤—ã—Ö–æ–¥ Small Talk Agent)- rag_results (–≤—ã—Ö–æ–¥ RAG Search)- web_search_results (–≤—ã—Ö–æ–¥ Web Search)- synthesized_response (–≤—ã—Ö–æ–¥ Response Synthesizer)- general_response (–≤—ã—Ö–æ–¥ General Assistant)- error (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ)- fallback_action (–¥–µ–π—Å—Ç–≤–∏–µ, –≤—ã–±—Ä–∞–Ω–Ω–æ–µ Fallback Agent)- final_response (–≤—ã—Ö–æ–¥ Response Formatter)–ù–æ —ç—Ç–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ. –£–ø—Ä–æ—Å—Ç–∏–º, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ.–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –ø–æ–ª–µ–π, –∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ö—Ä–∞–Ω–∏—Ç—å –≤ –≤–∏–¥–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –æ—á–∏—â–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.–û–¥–Ω–∞–∫–æ LangGraph —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ü–æ—ç—Ç–æ–º—É –±—É–¥–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —á–µ—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:class AgentState(TypedDict):# –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µuser_id: strchat_id: intuser_query: str# –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞current_step: str  # –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—èroute: Optional[str]  # 'analytics', 'documentation', 'general'# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏schema_context: Optional[str]generated_sql: Optional[str]sql_validation_passed: Optional[bool]access_check_passed: Optional[bool]query_result: Optional[pd.DataFrame]analysis_result: Optional[dict]visualization_instructions: Optional[dict]# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏documentation_query_type: Optional[str]  # 'small_talk', 'doc_search', 'web_search'small_talk_response: Optional[str]rag_results: Optional[dict]web_search_results: Optional[list]synthesized_response: Optional[str]# –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ãgeneral_response: Optional[str]# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫error: Optional[dict]fallback_action: Optional[str]# –í—ã—Ö–æ–¥final_response: Optional[dict]–ù–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DataFrame –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π (–Ω–µ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º–æ). –ü–æ—ç—Ç–æ–º—É –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–∏—Ç–∏–≤—ã.–ü–µ—Ä–µ–ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ–º: –≤–º–µ—Å—Ç–æ DataFrame –±—É–¥–µ–º –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π (–∏–ª–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, JSON-—Å—Ç—Ä–æ–∫—É).–û–¥–Ω–∞–∫–æ –¥–ª—è Data Interpreter –∏ Data Storyteller –º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è DataFrame. –ü–æ—ç—Ç–æ–º—É –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞ –º—ã –º–æ–∂–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å, –Ω–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –º–µ–∂–¥—É —É–∑–ª–∞–º–∏.–†–µ—à–µ–Ω–∏–µ: –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏. –ê –≤–Ω—É—Ç—Ä–∏ —É–∑–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.–î–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:- SQL: —Å—Ç—Ä–æ–∫–∞- –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞: —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π (–∏–ª–∏ JSON-—Å—Ç—Ä–æ–∫–∞, –Ω–æ –ª—É—á—à–µ —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π)- –ê–Ω–∞–ª–∏–∑: —Å–ª–æ–≤–∞—Ä—å —Å –ø—Ä–∏–º–∏—Ç–∏–≤–∞–º–∏–£—á–∏—Ç—ã–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å, —Ä–∞–∑–æ–±—å–µ–º –Ω–∞ –ø–æ–¥–≥—Ä–∞—Ñ—ã.–ü–ª–∞–Ω –≥—Ä–∞—Ñ–∞:1. –ù–∞—á–∞–ª–æ: –≤—Ö–æ–¥–Ω–æ–π —É–∑–µ–ª (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ)2. –†–æ—É—Ç–µ—Ä: –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç (analytics, documentation, general)3. –í–µ—Ç–≤–ª–µ–Ω–∏–µ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É:3.1. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: –ø–æ–¥–≥—Ä–∞—Ñ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏3.2. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –ø–æ–¥–≥—Ä–∞—Ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏3.3. –û–±—â–∏–µ: –ø–æ–¥–≥—Ä–∞—Ñ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤4. –ü–æ–¥–≥—Ä–∞—Ñ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:4.1. Schema Master -> SQL Generator -> SQL Validator -> Access Check -> DB Executor -> Data Interpreter -> Data Storyteller4.2. –ï—Å–ª–∏ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ –æ—à–∏–±–∫–∞ -> –ø–µ—Ä–µ–¥–∞–µ–º –≤ Fallback5. –ü–æ–¥–≥—Ä–∞—Ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:5.1. Query Classifier -> –≤–µ—Ç–≤–ª–µ–Ω–∏–µ –Ω–∞ Small Talk, RAG Search, Web Search -> Response Synthesizer5.2. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ -> Fallback6. –ü–æ–¥–≥—Ä–∞—Ñ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:6.1. General Assistant7. –ü–æ—Å–ª–µ –ø–æ–¥–≥—Ä–∞—Ñ–æ–≤: Response Formatter8. Fallback Agent –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –≤:- –ü–æ–≤—Ç–æ—Ä –ø–æ–¥–≥—Ä–∞—Ñ–∞ (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–ø–µ—Ä–µ–≤–æ–¥ –≤ general)- –≠—Å–∫–∞–ª–∞—Ü–∏—é (–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ)9. –í –∫–æ–Ω—Ü–µ: –≤—ã—Ö–æ–¥ (–æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞)–£—á–∏—Ç—ã–≤–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å, —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–æ–¥–≥—Ä–∞—Ñ—ã –∫–∞–∫ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≥—Ä–∞—Ñ—ã.–û–¥–Ω–∞–∫–æ LangGraph –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≥—Ä–∞—Ñ—ã –Ω–∞–ø—Ä—è–º—É—é. –ü–æ—ç—Ç–æ–º—É —Å–æ–∑–¥–∞–¥–∏–º –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π –≥—Ä–∞—Ñ.–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —É–∑–ª—ã –∏ —Å–≤—è–∑–∏.–£–∑–ª—ã:1. router2. schema_master3. sql_generator4. sql_validator5. access_check6. db_executor7. data_interpreter8. data_storyteller9. query_classifier (doc)10. small_talk_agent11. rag_search12. web_search13. response_synthesizer (doc)14. general_assistant15. fallback_agent16. response_formatter–ò —É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:- –ü–æ—Å–ª–µ router: –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç route –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞:analytics: schema_masterdocumentation: query_classifiergeneral: general_assistant- –ü–æ—Å–ª–µ sql_validator: –µ—Å–ª–∏ valid -> access_check, –∏–Ω–∞—á–µ -> fallback_agent- –ü–æ—Å–ª–µ access_check: –µ—Å–ª–∏ passed -> db_executor, –∏–Ω–∞—á–µ -> fallback_agent- –ü–æ—Å–ª–µ db_executor: –µ—Å–ª–∏ —É—Å–ø–µ—Ö -> data_interpreter, –∏–Ω–∞—á–µ -> fallback_agent- –ü–æ—Å–ª–µ query_classifier: –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞:small_talk: small_talk_agentdoc_search: rag_searchweb_search: web_search- –ü–æ—Å–ª–µ small_talk_agent, rag_search, web_search: response_synthesizer (–¥–ª—è doc)- –ü–æ—Å–ª–µ response_synthesizer: –µ—Å–ª–∏ —É—Å–ø–µ—Ö -> response_formatter, –∏–Ω–∞—á–µ -> fallback_agent- –ü–æ—Å–ª–µ general_assistant: response_formatter- –ü–æ—Å–ª–µ data_storyteller: response_formatter- Fallback_agent: –º–æ–∂–µ—Ç —Ä–µ—à–∏—Ç—å:retry: –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (schema_master) –∏–ª–∏ –≤ –¥—Ä—É–≥–æ–π –ø–æ–¥–≥—Ä–∞—Ñsimplify: –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ general_assistantescalate: –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å –æ—à–∏–±–∫–æ–π (–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ response_formatter)- Response_formatter: –≤—Å–µ–≥–¥–∞ –≤ –∫–æ–Ω–µ—Ü (END)–≠—Ç–æ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π –≥—Ä–∞—Ñ. –£–ø—Ä–æ—Å—Ç–∏–º, –≤–≤–µ–¥—è –ø–æ–¥–≥—Ä–∞—Ñ—ã –∫–∞–∫ "–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã", –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞.–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —Å–æ–∑–¥–∞—Ç—å —Ç—Ä–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —É–∑–ª–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≤—Å—é —Ü–µ–ø–æ—á–∫—É –≤–Ω—É—Ç—Ä–∏.–¢–æ–≥–¥–∞ —É–∑–ª—ã:1. router2. analytics_processor (–≤–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)3. documentation_processor (–≤–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)4. general_processor (–æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã)5. fallback_agent6. response_formatter–ò –≥—Ä–∞—Ñ:router -> conditional_edge (route) -> analytics_processor | documentation_processor | general_processoranalytics_processor -> conditional_edge: –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ -> fallback_agent, –∏–Ω–∞—á–µ -> response_formatterdocumentation_processor -> conditional_edge: –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ -> fallback_agent, –∏–Ω–∞—á–µ -> response_formattergeneral_processor -> response_formatterfallback_agent -> conditional_edge (–ø–æ –¥–µ–π—Å—Ç–≤–∏—é):retry: –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä (–∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)simplify: general_processorescalate: response_formatter–≠—Ç–æ –±–æ–ª–µ–µ —É–ø—Ä–∞–≤–ª—è–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞.–†–µ–∞–ª–∏–∑—É–µ–º –≤ —ç—Ç–æ–º —Å—Ç–∏–ª–µ.–î–µ—Ç–∞–ª–∏:–£–∑–µ–ª analytics_processor:–í–Ω—É—Ç—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç:schema_master -> sql_generator -> sql_validator -> access_check -> db_executor -> data_interpreter -> data_storyteller–ï—Å–ª–∏ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å error.–£–∑–µ–ª documentation_processor:query_classifier -> –≤–µ—Ç–≤–ª–µ–Ω–∏–µ (small_talk, rag_search, web_search) -> response_synthesizer–£–∑–µ–ª general_processor: –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç General Assistant.–£–∑–µ–ª fallback_agent: –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –∏ —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å.–£–∑–µ–ª response_formatter: —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞.–¢–µ–ø–µ—Ä—å –∫–æ–¥:–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ LangGraph1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ãpythonCopyDownloadfrom typing import TypedDict, Optional, Union
import pandas as pd

class AgentState(TypedDict):
    # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_id: str
    chat_id: int
    user_query: str
    
    # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
    route: Optional[str]  # 'analytics', 'documentation', 'general'
    
    # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    schema_context: Optional[str]
    generated_sql: Optional[str]
    query_result: Optional[Union[pd.DataFrame, list]]
    analysis_result: Optional[dict]
    
    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    doc_query_type: Optional[str]  # 'small_talk', 'rag_search', 'web_search'
    rag_results: Optional[dict]
    web_results: Optional[list]
    
    # –û—à–∏–±–∫–∏
    error: Optional[dict]
    
    # –í—ã—Ö–æ–¥
    response_content: Optional[str]
    response_type: Optional[str]  # 'text', 'image', 'table'2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤ –≥—Ä–∞—Ñ–∞ (`graph_nodes.py`)pythonCopyDownloadfrom langchain_core.runnables import RunnableLambda
from .agents import *  # –ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –Ω–∞—à–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤

# –£–∑–µ–ª: –†–æ—É—Ç–µ—Ä
def router_node(state: AgentState) -> AgentState:
    router = RouterAgent()
    route = router.route_request(state["user_query"])
    return {**state, "route": route}

# –£–∑–µ–ª: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
def schema_master_node(state: AgentState) -> AgentState:
    if state["route"] != "analytics":
        return state
    
    schema = SchemaMaster().get_schema_context(state["user_query"])
    return {**state, "schema_context": schema}

# –£–∑–µ–ª: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
def sql_generator_node(state: AgentState) -> AgentState:
    if not state.get("schema_context"):
        return state
    
    sql_gen = SQLGenerator()
    sql_result = sql_gen.generate_sql(
        state["user_query"],
        state["schema_context"]
    )
    return {**state, "generated_sql": sql_result["sql"]}

# –£–∑–µ–ª: –í–∞–ª–∏–¥–∞—Ü–∏—è SQL
def sql_validator_node(state: AgentState) -> AgentState:
    if not state.get("generated_sql"):
        return state
    
    if not SQLValidator().validate_sql(state["generated_sql"]):
        return {
            **state,
            "error": {
                "type": "sql_validation",
                "message": "Invalid SQL query",
                "sql": state["generated_sql"]
            }
        }
    return state

# –£–∑–µ–ª: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
def access_check_node(state: AgentState) -> AgentState:
    if not state.get("generated_sql"):
        return state
    
    if not AccessCheck().check_access(state["user_id"], state["generated_sql"]):
        return {
            **state,
            "error": {
                "type": "access_denied",
                "message": "Permission denied",
                "sql": state["generated_sql"]
            }
        }
    return state

# –£–∑–µ–ª: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL
def db_executor_node(state: AgentState) -> AgentState:
    if state.get("error") or not state.get("generated_sql"):
        return state
    
    try:
        df = DBExecutor().execute_query(state["generated_sql"])
        return {**state, "query_result": df}
    except Exception as e:
        return {
            **state,
            "error": {
                "type": "db_execution",
                "message": str(e),
                "sql": state["generated_sql"]
            }
        }

# –£–∑–µ–ª: –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
def data_interpreter_node(state: AgentState) -> AgentState:
    if not isinstance(state.get("query_result"), pd.DataFrame):
        return state
    
    analysis = DataInterpreter().analyze(
        state["query_result"],
        state["user_query"]
    )
    return {**state, "analysis_result": analysis}

# –£–∑–µ–ª: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
def documentation_node(state: AgentState) -> AgentState:
    if state["route"] != "documentation":
        return state
    
    classifier = QueryClassifier()
    query_type = classifier.classify(state["user_query"])
    state["doc_query_type"] = query_type
    
    if query_type == "small_talk":
        response = SmallTalkAgent().respond(state["user_query"])
        return {**state, "response_content": response, "response_type": "text"}
    
    elif query_type == "rag_search":
        results = RAGSearch().search(state["user_query"])
        state["rag_results"] = results
        return state
    
    elif query_type == "web_search":
        results = WebSearch().search(state["user_query"])
        state["web_results"] = results
        return state
    
    return state

# –£–∑–µ–ª: –°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
def response_synthesizer_node(state: AgentState) -> AgentState:
    if state["route"] != "documentation":
        return state
    
    synthesizer = ResponseSynthesizer()
    
    if state["doc_query_type"] == "rag_search":
        content = synthesizer.synthesize(
            [state["rag_results"]],
            state["user_query"]
        )
        return {**state, "response_content": content, "response_type": "text"}
    
    elif state["doc_query_type"] == "web_search":
        content = "\n\n".join([
            f"{res['title']}\n{res['url']}\n{res['snippet']}" 
            for res in state["web_results"]
        ])
        return {**state, "response_content": content, "response_type": "text"}
    
    return state

# –£–∑–µ–ª: –û–±—â–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
def general_assistant_node(state: AgentState) -> AgentState:
    if state["route"] != "general":
        return state
    
    response = GeneralAssistant().respond(state["user_query"])
    return {**state, "response_content": response, "response_type": "text"}

# –£–∑–µ–ª: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
def fallback_handler_node(state: AgentState) -> AgentState:
    if not state.get("error"):
        return state
    
    resolution = FallbackAgent().handle_error(state["error"])
    state["fallback_action"] = resolution["action"]
    
    if resolution["action"] == "retry":
        # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
        return {
            **state,
            "error": None,
            "generated_sql": None,
            "query_result": None
        }
    
    elif resolution["action"] == "simplify":
        # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –æ–±—â–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
        return {
            **state,
            "route": "general",
            "user_query": resolution.get("simplified_query", state["user_query"]),
            "error": None
        }
    
    else:
        # –≠—Å–∫–∞–ª–∞—Ü–∏—è
        return {
            **state,
            "response_content": resolution["message"],
            "response_type": "text"
        }

# –£–∑–µ–ª: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
def response_formatter_node(state: AgentState) -> AgentState:
    if state.get("response_content"):
        formatter = ResponseFormatter()
        formatted = formatter.format({
            "type": state["response_type"],
            "content": state["response_content"]
        })
        return {**state, "final_response": formatted}
    
    # –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if state.get("analysis_result"):
        storyteller = DataStoryteller()
        response = storyteller.create_response(
            state["analysis_result"],
            state["query_result"]
        )
        return {**state, "final_response": response}
    
    return state3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ (`main_graph.py`)pythonCopyDownloadfrom langgraph.graph import StateGraph, END
from .graph_nodes import *
from .state import AgentState

# –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ
graph = StateGraph(AgentState)

# –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã
graph.add_node("router", RunnableLambda(router_node))
graph.add_node("schema_master", RunnableLambda(schema_master_node))
graph.add_node("sql_generator", RunnableLambda(sql_generator_node))
graph.add_node("sql_validator", RunnableLambda(sql_validator_node))
graph.add_node("access_check", RunnableLambda(access_check_node))
graph.add_node("db_executor", RunnableLambda(db_executor_node))
graph.add_node("data_interpreter", RunnableLambda(data_interpreter_node))
graph.add_node("documentation", RunnableLambda(documentation_node))
graph.add_node("response_synthesizer", RunnableLambda(response_synthesizer_node))
graph.add_node("general_assistant", RunnableLambda(general_assistant_node))
graph.add_node("fallback_handler", RunnableLambda(fallback_handler_node))
graph.add_node("response_formatter", RunnableLambda(response_formatter_node))

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ö–æ–¥–Ω—É—é —Ç–æ—á–∫—É
graph.set_entry_point("router")

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
graph.add_conditional_edges(
    "router",
    lambda state: state.get("route") or "error",
    {
        "analytics": "schema_master",
        "documentation": "documentation",
        "general": "general_assistant",
        "error": "fallback_handler"
    }
)

# –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–∞–π–ø–ª–∞–π–Ω
graph.add_edge("schema_master", "sql_generator")
graph.add_edge("sql_generator", "sql_validator")
graph.add_conditional_edges(
    "sql_validator",
    lambda state: "fallback_handler" if state.get("error") else "access_check",
)
graph.add_edge("access_check", "db_executor")
graph.add_conditional_edges(
    "db_executor",
    lambda state: "fallback_handler" if state.get("error") else "data_interpreter",
)
graph.add_edge("data_interpreter", "response_formatter")

# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω
graph.add_edge("documentation", "response_synthesizer")
graph.add_conditional_edges(
    "response_synthesizer",
    lambda state: "fallback_handler" if state.get("error") else "response_formatter",
)

# –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
graph.add_edge("general_assistant", "response_formatter")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
graph.add_conditional_edges(
    "fallback_handler",
    lambda state: state.get("fallback_action") or "response_formatter",
    {
        "retry": "schema_master",  # –ü–æ–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        "simplify": "general_assistant",
        "escalate": "response_formatter"
    }
)

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
graph.add_edge("response_formatter", END)

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≥—Ä–∞—Ñ
app = graph.compile()4. –ó–∞–ø—É—Å–∫ –≥—Ä–∞—Ñ–∞ (`run_graph.py`)pythonCopyDownloadfrom main_graph import app
from state import AgentState
import json

def run_telegram_bot(query: str, user_id: str, chat_id: int):
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    state = AgentState(
        user_id=user_id,
        chat_id=chat_id,
        user_query=query
    )
    
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞
    for step in app.stream(state):
        node, new_state = next(iter(step.items()))
        print(f"Node: {node}, State: {json.dumps(new_state, indent=2, default=str)}")
    
    # –í–æ–∑–≤—Ä–∞—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    return new_state.get("final_response", {})

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    response = run_telegram_bot(
        "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–∞–π –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º",
        "UA-123",
        123456789
    )
    print("Final response:", response)5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmithpythonCopyDownloadfrom langsmith import Client
from langchain_core.tracers import LangChainTracer

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LangSmith
client = Client(api_key="your_api_key")
tracer = LangChainTracer(
    project_name="telegram-analytics-system",
    client=client
)

# –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –≥—Ä–∞—Ñ–∞
def run_with_tracing(state: AgentState):
    # –°–æ–∑–¥–∞–µ–º —Ü–µ–ø–æ—á–∫—É —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
    with client.trace(project_name="telegram-analytics-system") as trace:
        # –î–æ–±–∞–≤–ª—è–µ–º tracer –∫ –≥—Ä–∞—Ñ—É
        app = graph.compile(tracer=tracer)
        
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        for step in app.stream(state):
            ...
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        trace.result = state.get("final_response", {})
    
    return state

# –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —É–∑–ª—ã –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
class TracedSQLGenerator(SQLGenerator):
    def generate_sql(self, user_query, schema_context):
        # –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        tracer.log("input", {"query": user_query, "schema": schema_context})
        
        # –í—ã–∑–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–µ—Ç–æ–¥–∞
        result = super().generate_sql(user_query, schema_context)
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        tracer.log("output", result)
        return result6. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤ LangGraph Studio–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≥—Ä–∞—Ñ:pythonCopyDownloadfrom langgraph.graph import export_graph
from main_graph import graph

dot = export_graph(graph)
dot.render("telegram_analytics_graph", format="png")–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ LangGraph Studio:–ó–∞–π–¥–∏—Ç–µ –Ω–∞ studio.langchain.com–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç "Telegram Analytics System"–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª `telegram_analytics_graph.png`–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–∑–ª—ã, —É–∫–∞–∑–∞–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤ –≤ Studio:pythonCopyDownload# –î–ª—è —É–∑–ª–∞ SQL Generator
from your_project.sql_generator import SQLGenerator

def sql_generator_node(state):
    return SQLGenerator().process(state)7. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µbashCopyDownload# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install langgraph langchain langchain-gigachain pandas sqlalchemy

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
uvicorn run_graph:app --port 8000

# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
curl -X POST "http://localhost:8000/process" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "UA-123",
    "chat_id": 123456789,
    "user_query": "–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–∞–π"
  }'–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ü–æ–ª–Ω–∞—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ:–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ —É–∑–ª—ã –≥—Ä–∞—Ñ–∞–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏–í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ workflow–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π fallback-—É–∑–µ–ª–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ retry/simplify/escalate–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith:–°–∫–≤–æ–∑–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ LLM-–≤—ã–∑–æ–≤–æ–≤–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–ì–∏–±–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —É–∑–ª—ã–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞ —Å LangGraph–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞:–í–∏–¥–∏—Ç–µ –≤–µ—Å—å –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≥—Ä–∞—Ñ–∞–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:–ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É–∑–ª–∞–º–∏–õ–µ–≥–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —É–∑–ª–æ–≤–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ LangChain:–ì–æ—Ç–æ–≤—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏–®–∞–±–ª–æ–Ω—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö workflow–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –µ–¥–∏–Ω—ã–π –≥—Ä–∞—Ñ, —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ –≤ LangGraph Studio, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.

user: –ø–æ–¥–æ–∂–∏, —Ä–∞—Å–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤

assistant: ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ LangGraph:```telegram-analytics-system/‚îú‚îÄ‚îÄ agents/                   # –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤‚îÇ   ‚îú‚îÄ‚îÄ __init__.py‚îÇ   ‚îú‚îÄ‚îÄ router_agent.py‚îÇ   ‚îú‚îÄ‚îÄ schema_master.py‚îÇ   ‚îú‚îÄ‚îÄ sql_generator.py‚îÇ   ‚îú‚îÄ‚îÄ data_interpreter.py‚îÇ   ‚îú‚îÄ‚îÄ data_storyteller.py‚îÇ   ‚îú‚îÄ‚îÄ query_classifier.py‚îÇ   ‚îú‚îÄ‚îÄ small_talk_agent.py‚îÇ   ‚îú‚îÄ‚îÄ response_synthesizer.py‚îÇ   ‚îú‚îÄ‚îÄ fallback_agent.py‚îÇ   ‚îî‚îÄ‚îÄ general_assistant.py‚îú‚îÄ‚îÄ functions/                # –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏‚îÇ   ‚îú‚îÄ‚îÄ __init__.py‚îÇ   ‚îú‚îÄ‚îÄ sql_validator.py‚îÇ   ‚îú‚îÄ‚îÄ access_check.py‚îÇ   ‚îú‚îÄ‚îÄ db_executor.py‚îÇ   ‚îú‚îÄ‚îÄ rag_search.py‚îÇ   ‚îú‚îÄ‚îÄ web_search.py‚îÇ   ‚îî‚îÄ‚îÄ response_formatter.py‚îú‚îÄ‚îÄ graph/                    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ LangGraph‚îÇ   ‚îú‚îÄ‚îÄ __init__.py‚îÇ   ‚îú‚îÄ‚îÄ state.py              # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è‚îÇ   ‚îú‚îÄ‚îÄ nodes.py              # –í—Å–µ —É–∑–ª—ã –≥—Ä–∞—Ñ–∞‚îÇ   ‚îú‚îÄ‚îÄ main_graph.py         # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞‚îÇ   ‚îî‚îÄ‚îÄ run_graph.py          # –ó–∞–ø—É—Å–∫ –≥—Ä–∞—Ñ–∞‚îú‚îÄ‚îÄ services/                 # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã‚îÇ   ‚îú‚îÄ‚îÄ __init__.py‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py‚îÇ   ‚îú‚îÄ‚îÄ cache_service.py‚îÇ   ‚îú‚îÄ‚îÄ vector_store.py‚îÇ   ‚îú‚îÄ‚îÄ monitoring.py         # LangSmith –∏ –¥—Ä.‚îÇ   ‚îî‚îÄ‚îÄ metadata_extractor.py‚îú‚îÄ‚îÄ config.py                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è‚îú‚îÄ‚îÄ requirements.txt          # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏‚îî‚îÄ‚îÄ main.py                   # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–≤–µ–±-—Å–µ—Ä–≤–µ—Ä)```–¢–µ–ø–µ—Ä—å —Ä–∞—Å–ø–∏—à–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:### 1. `config.py````pythonimport osclass Config:# TelegramTELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")TELEGRAM_WEBHOOK_URL = os.getenv("TELEGRAM_WEBHOOK_URL")# –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—ÖDB_URL = os.getenv("DB_URL", "postgresql://user:pass@localhost/dbname")REDIS_URL = os.getenv("REDIS_URL", "redis://localhost:6379/0")# LLMGIGACHAT_CREDS = {"api_key": os.getenv("GIGACHAT_API_KEY"),"model": os.getenv("GIGACHAT_MODEL", "GigaChat:latest")}# –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µVECTOR_STORE_URL = os.getenv("VECTOR_STORE_URL")VECTOR_STORE_API_KEY = os.getenv("VECTOR_STORE_API_KEY")# –í–Ω–µ—à–Ω–∏–µ APIJIRA_API_URL = os.getenv("JIRA_API_URL")JIRA_USER = os.getenv("JIRA_USER")JIRA_TOKEN = os.getenv("JIRA_TOKEN")SLACK_WEBHOOK = os.getenv("SLACK_WEBHOOK")DUCKDUCKGO_API_KEY = os.getenv("DUCKDUCKGO_API_KEY")# LangSmithLANGSMITH_API_KEY = os.getenv("LANGSMITH_API_KEY")LANGSMITH_PROJECT = os.getenv("LANGSMITH_PROJECT", "telegram-analytics-system")# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ãMAX_RETRIES = 3CACHE_TTL = 3600  # 1 —á–∞—Å```### 2. `graph/state.py````pythonfrom typing import TypedDict, Optional, Union, Any, Dict, Listimport pandas as pdfrom pydantic import BaseModelclass AgentState(TypedDict):# –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µuser_id: strchat_id: intuser_query: str# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—èroute: Optional[str]  # 'analytics', 'documentation', 'general'# –ê–Ω–∞–ª–∏—Ç–∏–∫–∞schema_context: Optional[str]generated_sql: Optional[str]query_result: Optional[Union[pd.DataFrame, List[Dict]]]analysis_result: Optional[Dict]# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—èdoc_query_type: Optional[str]  # 'small_talk', 'rag_search', 'web_search'rag_results: Optional[Dict]web_results: Optional[List[Dict]]# –û—à–∏–±–∫–∏error: Optional[Dict]fallback_action: Optional[str]  # 'retry', 'simplify', 'escalate'# –í—ã—Ö–æ–¥response_content: Optional[str]response_type: Optional[str]  # 'text', 'image', 'table'final_response: Optional[Dict]  # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è Telegram```### 3. `graph/nodes.py`(–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ, –Ω–æ —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)–ü—Ä–∏–º–µ—Ä –¥–ª—è `router_node`:```pythonfrom agents.router_agent import RouterAgentfrom ..state import AgentStatedef router_node(state: AgentState) -> AgentState:router = RouterAgent()route = router.route_request(state["user_query"])return {**state, "route": route}```### 4. `graph/main_graph.py`(–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ)### 5. `graph/run_graph.py````pythonfrom .main_graph import appfrom .state import AgentStateimport jsonfrom services.monitoring import tracerdef run_graph(state: AgentState) -> AgentState:# –ó–∞–ø—É—Å–∫–∞–µ–º –≥—Ä–∞—Ñ —Å —Ç—Ä–µ–π—Å–µ—Ä–æ–º LangSmithwith tracer.trace("telegram_request") as trace:trace.input = state# –í—ã–ø–æ–ª–Ω—è–µ–º –≥—Ä–∞—Ñfor step in app.stream(state):node_name, new_state = next(iter(step.items()))trace.log_step(node_name, new_state)trace.output = new_state.get("final_response", {})return new_state```### 6. `services/monitoring.py` (LangSmith –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)```pythonfrom langsmith import Clientfrom langchain_core.tracers import LangChainTracerfrom config import Configclient = Client(api_key=Config.LANGSMITH_API_KEY)class MonitoringTracer(LangChainTracer):def __init__(self):super().__init__(project_name=Config.LANGSMITH_PROJECT,client=client)def trace(self, name: str):return client.trace(project_name=Config.LANGSMITH_PROJECT, name=name)tracer = MonitoringTracer()```### 7. `main.py` (–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è Telegram –±–æ—Ç–∞)```pythonfrom telegram import Updatefrom telegram.ext import Application, MessageHandler, filtersfrom config import Configfrom graph.run_graph import run_graphfrom state import AgentState# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–∞application = Application.builder().token(Config.TELEGRAM_TOKEN).build()async def handle_message(update: Update, context):user_id = update.effective_user.idchat_id = update.effective_chat.idtext = update.message.text# –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µstate = AgentState(user_id=f"UA-{user_id}",chat_id=chat_id,user_query=text)# –ó–∞–ø—É—Å–∫–∞–µ–º –≥—Ä–∞—Ñ –æ–±—Ä–∞–±–æ—Ç–∫–∏final_state = run_graph(state)# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Çresponse = final_state.get("final_response", {})if response.get("type") == "text":await update.message.reply_text(response["response"])elif response.get("type") == "image":await update.message.reply_photo(response["url"])# ... –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))if __name__ == "__main__":application.run_polling()```### 8. –ü—Ä–∏–º–µ—Ä –∞–≥–µ–Ω—Ç–∞ (`agents/sql_generator.py`)```pythonfrom langchain.prompts import PromptTemplatefrom langchain_gigachain import GigaChatfrom services.monitoring import tracerfrom config import Configclass SQLGenerator:def __init__(self):self.llm = GigaChat(**Config.GIGACHAT_CREDS)self.prompt = PromptTemplate.from_template("""SCHEMA:{schema_context}QUERY: {user_query}Generate PostgreSQL SELECT query only.""")def generate_sql(self, user_query: str, schema_context: str) -> dict:with tracer.trace("sql_generation") as span:span.set_tag("user_query", user_query)# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Çformatted_prompt = self.prompt.format(schema_context=schema_context,user_query=user_query)# –í—ã–∑–æ–≤ LLMsql_query = self.llm.invoke(formatted_prompt)# –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞clean_sql = self._clean_sql(sql_query)span.set_tag("generated_sql", clean_sql)return {"sql": clean_sql}def _clean_sql(self, sql: str) -> str:# –£–¥–∞–ª—è–µ–º Markdown –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ãif sql.startswith("```sql"):return sql.split("```")[1][3:].strip()return sql.strip()```### 9. –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ (`functions/sql_validator.py`)```pythonimport sqlparsefrom sqlparse.sql import Statementfrom services.monitoring import tracerdef validate_sql(sql: str) -> bool:with tracer.trace("sql_validation") as span:span.set_tag("sql", sql)try:parsed = sqlparse.parse(sql)if not parsed:return Falsefor stmt in parsed:# –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ SELECTif not isinstance(stmt, Statement) or stmt.get_type() != "SELECT":return False# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞forbidden = ["insert", "update", "delete", "drop", "truncate"]if any(kw in sql.lower() for kw in forbidden):return Falsereturn Trueexcept Exception as e:span.set_error(e)return False```### 10. `requirements.txt````langgraphlangchain-corelangchain-gigachainpython-telegram-botsqlalchemypandasredisrequestssqlparselangsmith```### –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:```bashpip install -r requirements.txt```2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ `.env`:```envTELEGRAM_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–ΩGIGACHAT_API_KEY=–≤–∞—à_–∫–ª—é—áDB_URL=postgresql://user:pass@localhost/dbnameREDIS_URL=redis://localhost:6379/0LANGSMITH_API_KEY=–≤–∞—à_–∫–ª—é—á```3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:```bashpython main.py```4. –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:- –û—Ç–∫—Ä–æ–π—Ç–µ [LangSmith](https://smith.langchain.com)- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç "telegram-analytics-system"- –°–º–æ—Ç—Ä–∏—Ç–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**:- –ê–≥–µ–Ω—Ç—ã, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã- –õ–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**:- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —É–∑–ª—ã –≥—Ä–∞—Ñ–∞- –†–∞—Å—à–∏—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã3. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**:- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ LangSmith- –ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞4. **–ì–∏–±–∫–æ—Å—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è**:- –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –º–æ–Ω–æ–ª–∏—Ç- –ò–ª–∏ –∫–∞–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã (—Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π)–≠—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É, –∏—Å–ø–æ–ª—å–∑—É—è –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ LangGraph –∏ LangSmith.–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –í–æ—Ç –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ LangGraph:textCopyDownloadtelegram-analytics-system/
‚îú‚îÄ‚îÄ agents/                   # –ö–∞—Ç–∞–ª–æ–≥ –¥–ª—è –≤—Å–µ—Ö LLM-–∞–≥–µ–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ router_agent.py       # –†–æ—É—Ç–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ schema_master.py      # –ê–≥–µ–Ω—Ç —Å—Ö–µ–º—ã –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ sql_generator.py      # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä SQL
‚îÇ   ‚îú‚îÄ‚îÄ data_interpreter.py   # –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ data_storyteller.py   # –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ query_classifier.py   # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ small_talk_agent.py   # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ small talk
‚îÇ   ‚îú‚îÄ‚îÄ response_synthesizer.py # –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ fallback_agent.py     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
‚îÇ   ‚îî‚îÄ‚îÄ general_assistant.py  # –û–±—â–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
‚îú‚îÄ‚îÄ functions/                # –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ sql_validator.py      # –í–∞–ª–∏–¥–∞—Ç–æ—Ä SQL
‚îÇ   ‚îú‚îÄ‚îÄ access_check.py       # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
‚îÇ   ‚îú‚îÄ‚îÄ db_executor.py        # –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å SQL –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ rag_search.py         # –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ RAG
‚îÇ   ‚îú‚îÄ‚îÄ web_search.py         # –í–µ–±-–ø–æ–∏—Å–∫
‚îÇ   ‚îî‚îÄ‚îÄ response_formatter.py # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤—â–∏–∫ –æ—Ç–≤–µ—Ç–∞
‚îú‚îÄ‚îÄ graph/                    # –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ LangGraph
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ state.py              # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ nodes.py              # –í—Å–µ —É–∑–ª—ã –≥—Ä–∞—Ñ–∞
‚îÇ   ‚îú‚îÄ‚îÄ main_graph.py         # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞
‚îÇ   ‚îî‚îÄ‚îÄ run_graph.py          # –ó–∞–ø—É—Å–∫ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞
‚îú‚îÄ‚îÄ services/                 # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py       # –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ cache_service.py      # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)
‚îÇ   ‚îú‚îÄ‚îÄ vector_store.py       # –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
‚îÇ   ‚îú‚îÄ‚îÄ monitoring.py         # LangSmith –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îÇ   ‚îî‚îÄ‚îÄ metadata_extractor.py # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ë–î
‚îú‚îÄ‚îÄ config.py                 # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ requirements.txt          # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ main.py                   # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (–≤–µ–±-—Å–µ—Ä–≤–µ—Ä)–¢–µ–ø–µ—Ä—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞:1. `config.py`pythonCopyDownloadimport os

class Config:
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
    TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
    TELEGRAM_WEBHOOK_URL = os.getenv("TELEGRAM_WEBHOOK_URL", "https://your-domain.com/webhook")
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ LLM (GigaChat)
    GIGACHAT_API_KEY = os.getenv("GIGACHAT_API_KEY")
    GIGACHAT_MODEL = os.getenv("GIGACHAT_MODEL", "GigaChat")
    
    # –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    DB_URL = os.getenv("DB_URL", "postgresql://user:pass@localhost/dbname")
    REDIS_URL = os.getenv("REDIS_URL", "redis://localhost:6379/0")
    
    # –í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    VECTOR_STORE_URL = os.getenv("VECTOR_STORE_URL")
    VECTOR_STORE_API_KEY = os.getenv("VECTOR_STORE_API_KEY")
    
    # –í–Ω–µ—à–Ω–∏–µ API
    JIRA_API_URL = os.getenv("JIRA_API_URL")
    JIRA_USER = os.getenv("JIRA_USER")
    JIRA_TOKEN = os.getenv("JIRA_TOKEN")
    SLACK_WEBHOOK = os.getenv("SLACK_WEBHOOK")
    DUCKDUCKGO_API_KEY = os.getenv("DUCKDUCKGO_API_KEY")
    
    # LangSmith
    LANGSMITH_API_KEY = os.getenv("LANGSMITH_API_KEY")
    LANGSMITH_PROJECT = os.getenv("LANGSMITH_PROJECT", "telegram-analytics-system")
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
    MAX_RETRIES = int(os.getenv("MAX_RETRIES", 3))
    CACHE_TTL = int(os.getenv("CACHE_TTL", 3600))  # 1 —á–∞—Å
    SQL_EXECUTION_TIMEOUT = int(os.getenv("SQL_EXECUTION_TIMEOUT", 30))2. `graph/state.py`pythonCopyDownloadfrom typing import TypedDict, Optional, Union, Any, Dict, List
import pandas as pd
from pydantic import BaseModel

class AgentState(TypedDict):
    # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_id: str
    chat_id: int
    user_query: str
    
    # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
    route: Optional[str]  # 'analytics', 'documentation', 'general'
    
    # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    schema_context: Optional[str]
    generated_sql: Optional[str]
    query_result: Optional[Union[pd.DataFrame, List[Dict]]]
    analysis_result: Optional[Dict]
    
    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    doc_query_type: Optional[str]  # 'small_talk', 'rag_search', 'web_search'
    rag_results: Optional[Dict]
    web_results: Optional[List[Dict]]
    
    # –û—à–∏–±–∫–∏
    error: Optional[Dict]
    fallback_action: Optional[str]  # 'retry', 'simplify', 'escalate'
    
    # –í—ã—Ö–æ–¥
    response_content: Optional[str]
    response_type: Optional[str]  # 'text', 'image', 'table'
    final_response: Optional[Dict]  # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è Telegram3. `graph/nodes.py`pythonCopyDownloadfrom langchain_core.runnables import RunnableLambda
from agents import router_agent, schema_master, sql_generator, data_interpreter, data_storyteller, query_classifier, small_talk_agent, response_synthesizer, fallback_agent, general_assistant
from functions import sql_validator, access_check, db_executor, rag_search, web_search, response_formatter
from services import metadata_extractor
from .state import AgentState
import pandas as pd

# –£–∑–µ–ª: –†–æ—É—Ç–µ—Ä
def router_node(state: AgentState) -> AgentState:
    route = router_agent.route_request(state["user_query"])
    return {**state, "route": route}

# –£–∑–µ–ª: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
def schema_master_node(state: AgentState) -> AgentState:
    if state["route"] != "analytics":
        return state
    schema = schema_master.get_schema_context(state["user_query"])
    return {**state, "schema_context": schema}

# –£–∑–µ–ª: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
def sql_generator_node(state: AgentState) -> AgentState:
    if not state.get("schema_context"):
        return state
    sql_result = sql_generator.generate_sql(
        state["user_query"],
        state["schema_context"]
    )
    return {**state, "generated_sql": sql_result["sql"]}

# ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–∑–ª—ã –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ–ø–∏—Å–∞–Ω–∏–∏)

# –£–∑–µ–ª: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
def response_formatter_node(state: AgentState) -> AgentState:
    if state.get("response_content"):
        formatted = response_formatter.format({
            "type": state["response_type"],
            "content": state["response_content"]
        })
        return {**state, "final_response": formatted}
    
    if state.get("analysis_result"):
        response = data_storyteller.create_response(
            state["analysis_result"],
            state["query_result"]
        )
        return {**state, "final_response": response}
    
    return state4. `graph/main_graph.py`pythonCopyDownloadfrom langgraph.graph import StateGraph, END
from .nodes import *
from .state import AgentState

def build_graph():
    graph = StateGraph(AgentState)

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —É–∑–ª–æ–≤
    nodes = [
        ("router", RunnableLambda(router_node)),
        ("schema_master", RunnableLambda(schema_master_node)),
        ("sql_generator", RunnableLambda(sql_generator_node)),
        # ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–∑–ª—ã
    ]
    
    for name, node in nodes:
        graph.add_node(name, node)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–µ–π –∏ —É—Å–ª–æ–≤–∏–π
    graph.set_entry_point("router")
    
    # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
    graph.add_conditional_edges(
        "router",
        lambda state: state.get("route") or "error",
        {
            "analytics": "schema_master",
            "documentation": "documentation_processor",
            "general": "general_assistant",
            "error": "fallback_handler"
        }
    )
    
    # –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞
    graph.add_edge("schema_master", "sql_generator")
    graph.add_edge("sql_generator", "sql_validator")
    graph.add_conditional_edges(
        "sql_validator",
        lambda state: "fallback_handler" if state.get("error") else "access_check",
    )
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏
    
    return graph.compile()

# –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ
app = build_graph()5. `graph/run_graph.py`pythonCopyDownloadfrom .main_graph import app
from .state import AgentState
from services.monitoring import tracer
import json
import pandas as pd

class JSONEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, pd.DataFrame):
            return obj.head().to_dict(orient="records")
        return super().default(obj)

def run_graph(state: AgentState) -> AgentState:
    with tracer.trace("telegram_request") as trace:
        trace.input = json.dumps(state, cls=JSONEncoder)
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –≥—Ä–∞—Ñ
        for step in app.stream(state):
            node_name, new_state = next(iter(step.items()))
            trace.log_step(node_name, json.dumps(new_state, cls=JSONEncoder))
        
        final_response = new_state.get("final_response", {})
        trace.output = json.dumps(final_response, ensure_ascii=False)
        
        return new_state6. `services/monitoring.py` (LangSmith)pythonCopyDownloadfrom langsmith import Client
from config import Config

client = Client(api_key=Config.LANGSMITH_API_KEY)

class MonitoringTracer:
    def __init__(self):
        self.client = client
        self.project_name = Config.LANGSMITH_PROJECT
    
    def trace(self, name: str):
        return self.client.trace(project_name=self.project_name, name=name)
    
    def log_step(self, run_id: str, node: str, state: str):
        self.client.create_feedback(
            run_id=run_id,
            key="node_state",
            value=state,
            comment=f"Node: {node}"
        )
    
    def log_error(self, run_id: str, error: dict):
        self.client.create_feedback(
            run_id=run_id,
            key="error",
            value=json.dumps(error),
            comment="System error"
        )

tracer = MonitoringTracer()7. `agents/sql_generator.py`pythonCopyDownloadfrom langchain.prompts import PromptTemplate
from langchain_gigachain import GigaChat
from services.monitoring import tracer
from config import Config

class SQLGenerator:
    def __init__(self):
        self.llm = GigaChat(**{
            "credentials": Config.GIGACHAT_API_KEY,
            "model": Config.GIGACHAT_MODEL,
            "temperature": 0.3
        })
        self.prompt = PromptTemplate.from_template("""
            [–°–∏—Å—Ç–µ–º–∞]
            –¢—ã SQL —ç–∫—Å–ø–µ—Ä—Ç. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π SQL –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ö–µ–º—ã –ë–î –∏ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç–æ–ª–±—Ü—ã.
            
            [–°—Ö–µ–º–∞ –ë–î]
            {schema_context}
            
            [–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
            {user_query}
            
            [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è]
            1. –¢–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã
            2. –£—á–∏—Ç—ã–≤–∞–π —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
            3. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Å–µ–≤–¥–æ–Ω–∏–º—ã –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ –≥–¥–µ –Ω—É–∂–Ω–æ
            
            [–û—Ç–≤–µ—Ç]
            PostgreSQL –∑–∞–ø—Ä–æ—Å:
        """)
    
    def generate_sql(self, user_query: str, schema_context: str) -> dict:
        with tracer.trace("sql_generation") as span:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
            formatted_prompt = self.prompt.format(
                schema_context=schema_context,
                user_query=user_query
            )
            
            # –í—ã–∑–æ–≤ LLM
            sql_query = self.llm.invoke(formatted_prompt)
            
            # –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            clean_sql = self._clean_sql(sql_query)
            
            return {
                "sql": clean_sql,
                "langsmith_run_id": span.id  # –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            }
    
    def _clean_sql(self, sql: str) -> str:
        """–£–¥–∞–ª—è–µ—Ç Markdown –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ SQL"""
        if sql.startswith("```sql"):
            return sql.split("```")[1][3:].strip()
        return sql.strip()8. `functions/db_executor.py`pythonCopyDownloadimport sqlalchemy
from sqlalchemy import text
from services.cache_service import get_cache
from config import Config
import pandas as pd
import hashlib

class DBExecutor:
    def __init__(self):
        self.engine = sqlalchemy.create_engine(Config.DB_URL)
        self.cache = get_cache()
    
    def execute_query(self, sql: str) -> pd.DataFrame:
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –∫–µ—à–∞
        cache_key = f"sql:{hashlib.md5(sql.encode()).hexdigest()}"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
        if cached := self.cache.get(cache_key):
            return pd.read_json(cached)
        
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        with self.engine.connect().execution_options(
            isolation_level="AUTOCOMMIT"
        ) as conn:
            result = conn.execute(
                text(sql).execution_options(
                    timeout=Config.SQL_EXECUTION_TIMEOUT
                )
            )
            df = pd.DataFrame(result.fetchall(), columns=result.keys())
        
        # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        self.cache.set(
            cache_key, 
            df.to_json(orient="split"),
            ex=Config.CACHE_TTL
        )
        return df9. `services/vector_store.py` (GigaSearch)pythonCopyDownloadfrom gigasearch import GigaSearchClient
from config import Config

class VectorStore:
    def __init__(self):
        self.client = GigaSearchClient(
            api_key=Config.VECTOR_STORE_API_KEY,
            endpoint=Config.VECTOR_STORE_URL
        )
    
    def search(self, query: str, index: str, top_k: int = 3) -> list:
        return self.client.search(
            query=query,
            index_name=index,
            top_k=top_k,
            hybrid=True,
            semantic_weight=0.7
        )
    
    def index_documents(self, documents: list, index: str):
        self.client.index_documents(
            documents=documents,
            index_name=index,
            batch_size=50
        )10. `main.py` (–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞)pythonCopyDownloadfrom fastapi import FastAPI, Request
from graph.run_graph import run_graph
from graph.state import AgentState
import uvicorn
import json

app = FastAPI()

@app.post("/process")
async def process_request(request: Request):
    data = await request.json()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    state = AgentState(
        user_id=data["user_id"],
        chat_id=data["chat_id"],
        user_query=data["text"]
    )
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –≥—Ä–∞—Ñ
    result_state = run_graph(state)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
    return result_state.get("final_response", {
        "type": "text",
        "response": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞"
    })

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)11. `requirements.txt`textCopyDownloadfastapi
uvicorn
langgraph
langchain-core
langchain-gigachain
python-telegram-bot
sqlalchemy
pandas
redis
requests
sqlparse
gigasearch-client
python-dotenv
pydantic–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:bashCopyDownloadpip install -r requirements.txt–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:envCopyDownloadTELEGRAM_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω
GIGACHAT_API_KEY=–≤–∞—à_–∫–ª—é—á
DB_URL=postgresql://user:pass@localhost/dbname
REDIS_URL=redis://localhost:6379/0
LANGSMITH_API_KEY=–≤–∞—à_–∫–ª—é—á_–ª–∞–Ω–≥—Å–º–∏—Ç
VECTOR_STORE_API_KEY=–∫–ª—é—á_–≥–∏–≥–∞—Å–µ—Ä—á–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:bashCopyDownloadpython main.py–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–µ–±—Ö—É–∫ Telegram (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):bashCopyDownloadcurl -F "url=https://your-domain.com/process" \
  https://api.telegram.org/bot<–≤–∞—à_—Ç–æ–∫–µ–Ω>/setWebhook–†–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:Telegram Bot ‚Üí POST /process–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:pythonCopyDownloadstate = AgentState(user_id="UA-123", chat_id=123, user_query="–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏")–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞:–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–∑–ª–æ–≤–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ –≤ LangSmith–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞:–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ Telegram–í–æ–∑–≤—Ä–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:jsonCopyDownload{
  "type": "text",
  "response": "–î–∞–Ω–Ω—ã–µ...",
  "sources": ["db"],
  "attachments": []
}–≠—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–õ–µ–≥–∫—É—é —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å–ü–æ–ª–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangSmith –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —á–µ—Ä–µ–∑ LangGraph–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

user: –ø—Ä–æ–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é nodes.py

assistant: ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª `nodes.py` —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤—Å–µ—Ö —É–∑–ª–æ–≤ –≥—Ä–∞—Ñ–∞.–£–∑–ª—ã –±—É–¥—É—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–∞–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.–ö–∞–∂–¥—ã–π —É–∑–µ–ª - —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –ø—Ä–∏–Ω–∏–º–∞—é—â–∞—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.–ü–æ–ª–Ω—ã–π –∫–æ–¥ `graph/nodes.py`pythonCopyDownloadfrom langchain_core.runnables import RunnableLambda
from agents import (
    RouterAgent,
    SchemaMasterAgent,
    SQLGeneratorAgent,
    DataInterpreterAgent,
    DataStorytellerAgent,
    QueryClassifierAgent,
    SmallTalkAgent,
    ResponseSynthesizerAgent,
    FallbackAgent,
    GeneralAssistantAgent
)
from functions import (
    sql_validator,
    access_check,
    db_executor,
    rag_search,
    web_search,
    response_formatter
)
from services import MetadataExtractor
from .state import AgentState
import pandas as pd
import logging
import re

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

# --------------------------
# –£–∑–ª—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
# --------------------------

def router_node(state: AgentState) -> AgentState:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏–ª–∏ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã"""
    try:
        router = RouterAgent()
        route = router.route_request(state["user_query"])
        logger.info(f"Routing query to: {route}")
        return {**state, "route": route}
    
    except Exception as e:
        logger.error(f"Router error: {str(e)}")
        return {**state, "error": {"type": "routing", "message": str(e)}}

# --------------------------
# –£–∑–ª—ã –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞
# --------------------------

def schema_master_node(state: AgentState) -> AgentState:
    """–ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ö–µ–º—ã –ë–î –¥–ª—è SQL –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"""
    if state.get("route") != "analytics":
        return state
    
    try:
        schema_master = SchemaMasterAgent()
        schema_context = schema_master.get_schema_context(state["user_query"])
        logger.debug(f"Schema context retrieved: {schema_context[:100]}...")
        return {**state, "schema_context": schema_context}
    
    except Exception as e:
        logger.error(f"SchemaMaster error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "schema_retrieval", 
                "message": str(e),
                "query": state["user_query"]
            }
        }

def sql_generator_node(state: AgentState) -> AgentState:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞"""
    if not state.get("schema_context") or state.get("route") != "analytics":
        return state
    
    try:
        sql_gen = SQLGeneratorAgent()
        sql_result = sql_gen.generate_sql(
            state["user_query"],
            state["schema_context"]
        )
        logger.info(f"Generated SQL: {sql_result['sql'][:100]}...")
        return {**state, "generated_sql": sql_result["sql"]}
    
    except Exception as e:
        logger.error(f"SQLGenerator error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "sql_generation", 
                "message": str(e),
                "query": state["user_query"]
            }
        }

def sql_validator_node(state: AgentState) -> AgentState:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç SQL –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å"""
    if not state.get("generated_sql"):
        return state
    
    try:
        if not sql_validator.validate_sql(state["generated_sql"]):
            raise ValueError("SQL validation failed")
        logger.debug("SQL validation passed")
        return state
    
    except Exception as e:
        logger.error(f"SQLValidator error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "sql_validation", 
                "message": str(e),
                "sql": state["generated_sql"]
            }
        }

def access_check_node(state: AgentState) -> AgentState:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –¥–∞–Ω–Ω—ã–º"""
    if not state.get("generated_sql"):
        return state
    
    try:
        if not access_check.check_access(state["user_id"], state["generated_sql"]):
            raise PermissionError("Access denied to requested data")
        logger.debug("Access check passed")
        return state
    
    except Exception as e:
        logger.error(f"AccessCheck error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "access_denied", 
                "message": str(e),
                "sql": state["generated_sql"]
            }
        }

def db_executor_node(state: AgentState) -> AgentState:
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç SQL –∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"""
    if state.get("error") or not state.get("generated_sql"):
        return state
    
    try:
        df = db_executor.execute_query(state["generated_sql"])
        logger.info(f"DB query executed, returned {len(df)} rows")
        return {**state, "query_result": df}
    
    except Exception as e:
        logger.error(f"DBExecutor error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "db_execution", 
                "message": str(e),
                "sql": state["generated_sql"]
            }
        }

def data_interpreter_node(state: AgentState) -> AgentState:
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω—Å–∞–π—Ç—ã"""
    if not isinstance(state.get("query_result"), pd.DataFrame):
        return state
    
    try:
        interpreter = DataInterpreterAgent()
        analysis = interpreter.analyze(
            state["query_result"],
            state["user_query"]
        )
        logger.debug(f"Data analysis completed: {analysis['key_insight'][:50]}...")
        return {**state, "analysis_result": analysis}
    
    except Exception as e:
        logger.error(f"DataInterpreter error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "data_interpretation", 
                "message": str(e),
                "data_sample": state["query_result"].head().to_dict()
            }
        }

# --------------------------
# –£–∑–ª—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞
# --------------------------

def query_classifier_node(state: AgentState) -> AgentState:
    """–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã"""
    if state.get("route") != "documentation":
        return state
    
    try:
        classifier = QueryClassifierAgent()
        query_type = classifier.classify(state["user_query"])
        logger.info(f"Documentation query classified as: {query_type}")
        return {**state, "doc_query_type": query_type}
    
    except Exception as e:
        logger.error(f"QueryClassifier error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "query_classification", 
                "message": str(e)
            }
        }

def small_talk_node(state: AgentState) -> AgentState:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã"""
    if state.get("doc_query_type") != "small_talk":
        return state
    
    try:
        agent = SmallTalkAgent()
        response = agent.respond(state["user_query"])
        logger.debug(f"Small talk response: {response[:50]}...")
        return {
            **state, 
            "response_content": response,
            "response_type": "text"
        }
    
    except Exception as e:
        logger.error(f"SmallTalkAgent error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "small_talk", 
                "message": str(e)
            }
        }

def rag_search_node(state: AgentState) -> AgentState:
    """–ò—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ RAG"""
    if state.get("doc_query_type") != "rag_search":
        return state
    
    try:
        results = rag_search.search(state["user_query"])
        logger.info(f"RAG search found {len(results['sources'])} sources")
        return {**state, "rag_results": results}
    
    except Exception as e:
        logger.error(f"RAGSearch error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "rag_search", 
                "message": str(e)
            }
        }

def web_search_node(state: AgentState) -> AgentState:
    """–ò—â–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ"""
    if state.get("doc_query_type") != "web_search":
        return state
    
    try:
        results = web_search.search(state["user_query"])
        logger.info(f"Web search found {len(results)} results")
        return {**state, "web_results": results}
    
    except Exception as e:
        logger.error(f"WebSearch error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "web_search", 
                "message": str(e)
            }
        }

def response_synthesizer_node(state: AgentState) -> AgentState:
    """–°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"""
    if state.get("route") != "documentation":
        return state
    
    try:
        synthesizer = ResponseSynthesizerAgent()
        
        # –î–ª—è RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if state.get("rag_results"):
            response = synthesizer.synthesize(
                [state["rag_results"]],
                state["user_query"]
            )
            return {
                **state, 
                "response_content": response,
                "response_type": "text"
            }
        
        # –î–ª—è –≤–µ–±-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        elif state.get("web_results"):
            content = "\n\n".join([
                f"‚Ä¢ {res['title']}: {res['url']}\n{res['snippet']}" 
                for res in state["web_results"]
            ])
            return {
                **state, 
                "response_content": content,
                "response_type": "text"
            }
        
        return state
    
    except Exception as e:
        logger.error(f"ResponseSynthesizer error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "response_synthesis", 
                "message": str(e)
            }
        }

# --------------------------
# –£–∑–ª—ã –æ–±—â–µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
# --------------------------

def general_assistant_node(state: AgentState) -> AgentState:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã"""
    if state.get("route") != "general":
        return state
    
    try:
        assistant = GeneralAssistantAgent()
        response = assistant.respond(state["user_query"])
        logger.debug(f"General assistant response: {response[:50]}...")
        return {
            **state, 
            "response_content": response,
            "response_type": "text"
        }
    
    except Exception as e:
        logger.error(f"GeneralAssistant error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "general_assistant", 
                "message": str(e)
            }
        }

def fallback_handler_node(state: AgentState) -> AgentState:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"""
    if not state.get("error"):
        return state
    
    try:
        fallback = FallbackAgent()
        resolution = fallback.handle_error(state["error"])
        logger.warning(
            f"Fallback handling error: {state['error']['type']} -> "
            f"Action: {resolution['action']}"
        )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è
        new_state = {
            **state,
            "fallback_action": resolution["action"],
            "error": None  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
        }
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
        if resolution["action"] == "retry":
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
            return {
                **new_state,
                "generated_sql": None,
                "query_result": None,
                "analysis_result": None
            }
        
        elif resolution["action"] == "simplify":
            # –£–ø—Ä–æ—â–∞–µ–º –∑–∞–ø—Ä–æ—Å
            return {
                **new_state,
                "route": "general",
                "user_query": resolution.get(
                    "simplified_query", 
                    state["user_query"]
                )
            }
        
        elif resolution["action"] == "notify":
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            return {
                **new_state,
                "response_content": resolution["message"],
                "response_type": "text"
            }
        
        return new_state
    
    except Exception as e:
        logger.critical(f"FallbackHandler failed: {str(e)}")
        return {
            **state,
            "response_content": "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            "response_type": "text"
        }

def data_storyteller_node(state: AgentState) -> AgentState:
    """–í—ã–±–∏—Ä–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–≥—Ä–∞—Ñ–∏–∫, —Ç–∞–±–ª–∏—Ü–∞, —Ç–µ–∫—Å—Ç)"""
    if not state.get("analysis_result"):
        return state
    
    try:
        storyteller = DataStorytellerAgent()
        response = storyteller.create_response(
            state["analysis_result"],
            state["query_result"]
        )
        logger.info(f"Response format: {response['type']}")
        return {
            **state, 
            "response_content": response["content"],
            "response_type": response["type"]
        }
    
    except Exception as e:
        logger.error(f"DataStoryteller error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "data_storytelling", 
                "message": str(e)
            }
        }

def response_formatter_node(state: AgentState) -> AgentState:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    if not state.get("response_content") or not state.get("response_type"):
        # –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞, –Ω–æ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        if state.get("query_result") and state.get("analysis_result"):
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∫–∞–∫ —Ñ–æ–ª–±—ç–∫
            return {
                **state,
                "response_content": "–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /report –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.",
                "response_type": "text"
            }
        return state
    
    try:
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        formatted = response_formatter.format({
            "type": state["response_type"],
            "content": state["response_content"]
        })
        
        logger.info(f"Response formatted for {state['response_type']}")
        return {
            **state, 
            "final_response": formatted
        }
    
    except Exception as e:
        logger.error(f"ResponseFormatter error: {str(e)}")
        # –§–æ–ª–±—ç–∫: –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        return {
            **state,
            "final_response": {
                "type": "text",
                "response": state["response_content"][:1000]  # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            }
        }

def metadata_update_node(state: AgentState) -> AgentState:
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã –ë–î (—Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å)"""
    # –≠—Ç–æ—Ç —É–∑–µ–ª –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏, –Ω–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    try:
        if not state.get("last_metadata_update") or (pd.Timestamp.now() - state["last_metadata_update"]).days > 1:
            extractor = MetadataExtractor()
            schema = extractor.extract_full_schema()
            extractor.generate_schema_descriptions(schema)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            # (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ vector_store –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç)
            state["vector_store"].index_documents(schema)
            
            logger.info("Database metadata updated")
            return {
                **state, 
                "last_metadata_update": pd.Timestamp.now()
            }
        return state
    
    except Exception as e:
        logger.error(f"Metadata update failed: {str(e)}")
        return state

# --------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# --------------------------

def log_state_change(prev_state: dict, new_state: dict):
    """–õ–æ–≥–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏"""
    changes = {}
    for key in new_state:
        if key not in prev_state or new_state[key] != prev_state[key]:
            # –°–æ–∫—Ä–∞—â–∞–µ–º –±–æ–ª—å—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ª–æ–≥–æ–≤
            value = new_state[key]
            if isinstance(value, str) and len(value) > 100:
                value = value[:100] + "..."
            elif isinstance(value, pd.DataFrame):
                value = f"DataFrame({len(value)} rows)"
            
            changes[key] = value
    
    if changes:
        logger.debug(f"State changed: {changes}")

# –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
def logged_node(func):
    def wrapper(state: AgentState) -> AgentState:
        prev_state = state.copy()
        result = func(state)
        log_state_change(prev_state, result)
        return result
    return wrapper

# –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–≥–≥–µ—Ä –∫–æ –≤—Å–µ–º —É–∑–ª–∞–º
router_node = logged_node(router_node)
schema_master_node = logged_node(schema_master_node)
sql_generator_node = logged_node(sql_generator_node)
sql_validator_node = logged_node(sql_validator_node)
access_check_node = logged_node(access_check_node)
db_executor_node = logged_node(db_executor_node)
data_interpreter_node = logged_node(data_interpreter_node)
query_classifier_node = logged_node(query_classifier_node)
small_talk_node = logged_node(small_talk_node)
rag_search_node = logged_node(rag_search_node)
web_search_node = logged_node(web_search_node)
response_synthesizer_node = logged_node(response_synthesizer_node)
general_assistant_node = logged_node(general_assistant_node)
fallback_handler_node = logged_node(fallback_handler_node)
data_storyteller_node = logged_node(data_storyteller_node)
response_formatter_node = logged_node(response_formatter_node)
metadata_update_node = logged_node(metadata_update_node)–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:–í—Å–µ 17 —É–∑–ª–æ–≤ –∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã–ö–∞–∂–¥—ã–π —É–∑–µ–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É —Å–∏—Å—Ç–µ–º—ã–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–ö–∞–∂–¥—ã–π —É–∑–µ–ª –∏–º–µ–µ—Ç try/except –±–ª–æ–∫–∏–î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –æ—à–∏–±–æ–∫–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:–ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏–î–µ–∫–æ—Ä–∞—Ç–æ—Ä `logged_node` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤–£–º–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith:–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–µ —á–µ—Ä–µ–∑ –ª–æ–≥–∏–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–û—Å–æ–±—ã–µ —É–∑–ª—ã:`fallback_handler_node`: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫`metadata_update_node`: –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î`response_formatter_node`: –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –≥—Ä–∞—Ñ:pythonCopyDownload# –í main_graph.py
from .nodes import (
    router_node,
    schema_master_node,
    sql_generator_node,
    # ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–∑–ª—ã
)

graph.add_node("router", RunnableLambda(router_node))
graph.add_node("schema_master", RunnableLambda(schema_master_node))
# ...–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è:pythonCopyDownload# –í –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
import logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(name)s: %(message)s"
)–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ —É–∑–ª—ã –≤ —Ñ–∞–π–ª–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É–ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã –≤ —Ä–∞–º–∫–∞—Ö –≥—Ä–∞—Ñ–∞ LangGraph, —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

user: —Ç–µ–ø–µ—Ä—å main_graph

assistant: ÊÄùËÄÉÔºö–ú—ã —É–∂–µ –∏–º–µ–µ–º –ø–æ–ª–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —É–∑–ª–æ–≤ –≤ nodes.py. –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ, –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–∏ —É–∑–ª—ã.–ì—Ä–∞—Ñ –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–µ—Ç–∫–∏:1. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (router)2. –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–∞–π–ø–ª–∞–π–Ω (analytics)3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω (documentation)4. –û–±—â–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (general)5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (fallback)6. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (response_formatter)–¢–∞–∫–∂–µ —É—á—Ç–µ–º:- –£–∑–µ–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (metadata_update) –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏, –Ω–æ –Ω–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ.- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –ª—é–±–æ–º —É–∑–ª–µ, –∏ —Ç–æ–≥–¥–∞ –º—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ fallback_handler.–ü–ª–∞–Ω –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞:1. –î–æ–±–∞–≤–∏–º –≤—Å–µ —É–∑–ª—ã.2. –£—Å—Ç–∞–Ω–æ–≤–∏–º –≤—Ö–æ–¥–Ω—É—é —Ç–æ—á–∫—É (router).3. –û–ø—Ä–µ–¥–µ–ª–∏–º —É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –∏–∑ —Ä–æ—É—Ç–µ—Ä–∞.4. –ü–æ—Å—Ç—Ä–æ–∏–º —Ü–µ–ø–æ—á–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.5. –î–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ fallback_handler.6. –°–æ–µ–¥–∏–Ω–∏–º –≤—Å–µ —Å response_formatter.–£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –≤ LangGraph –µ—Å—Ç—å:- add_node(name, node)- set_entry_point(name)- add_edge(start, end)- add_conditional_edges(source, condition, path_map)–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –±—É–¥–µ–º:- –í –∫–∞–∂–¥–æ–º —É–∑–ª–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ error.- –ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã: –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞, –∏–¥–µ–º –≤ fallback_handler.–û–¥–Ω–∞–∫–æ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É–∑–ª—ã —Å–∞–º–∏ –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ, –∞ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ.–ü–æ—ç—Ç–æ–º—É –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É, –º—ã –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ fallback_handler.–≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é add_conditional_edges –ø–æ—Å–ª–µ —Ç–∞–∫–∏—Ö —É–∑–ª–æ–≤.–ù–æ —É—á—Ç–µ–º, —á—Ç–æ –Ω–µ –≤—Å–µ —É–∑–ª—ã –∫—Ä–∏—Ç–∏—á–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, metadata_update_node).–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:–®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã.–®–∞–≥ 2: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–≤—è–∑–∏.–î–µ—Ç–∞–ª–∏:- –ù–∞—á–∞–ª–æ: router_node- –ü–æ—Å–ª–µ router_node: —É—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é state['route'] (analytics, documentation, general, error)- –î–ª—è analytics:schema_master -> sql_generator -> sql_validator -> access_check -> db_executor -> data_interpreter -> data_storyteller -> response_formatter–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑ —ç—Ç–∏—Ö —É–∑–ª–æ–≤ (–∫—Ä–æ–º–µ data_storyteller) –¥–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –æ—à–∏–±–∫—É –∏ –ø–µ—Ä–µ—Ö–æ–¥ –≤ fallback_handler.- –î–ª—è documentation:query_classifier -> (small_talk_node | rag_search_node | web_search_node) -> response_synthesizer -> response_formatter–¢–∞–∫–∂–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É.- –î–ª—è general:general_assistant_node -> response_formatter- fallback_handler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∏ –º–æ–∂–µ—Ç:retry -> –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –Ω–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞)simplify -> –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ generalescalate -> –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ- response_formatter –≤—Å–µ–≥–¥–∞ –≤ –∫–æ–Ω—Ü–µ.–°—Ö–µ–º–∞ –≥—Ä–∞—Ñ–∞:```mermaidgraph TDStart[router] -->|analytics| SchemaMasterStart -->|documentation| QueryClassifierStart -->|general| GeneralAssistantStart -->|error| FallbackHandlersubgraph AnalyticsSchemaMaster --> SQLGeneratorSQLGenerator --> SQLValidatorSQLValidator -->|Valid| AccessCheckSQLValidator -->|Error| FallbackHandlerAccessCheck -->|Allowed| DBExecutorAccessCheck -->|Denied| FallbackHandlerDBExecutor -->|Success| DataInterpreterDBExecutor -->|Error| FallbackHandlerDataInterpreter --> DataStorytellerendsubgraph DocumentationQueryClassifier -->|small_talk| SmallTalkQueryClassifier -->|rag_search| RAGSearchQueryClassifier -->|web_search| WebSearchSmallTalk --> ResponseSynthesizerRAGSearch --> ResponseSynthesizerWebSearch --> ResponseSynthesizerResponseSynthesizer -->|Success| ResponseFormatterResponseSynthesizer -->|Error| FallbackHandlerendGeneralAssistant --> ResponseFormatterFallbackHandler -->|retry| SchemaMasterFallbackHandler -->|simplify| GeneralAssistantFallbackHandler -->|escalate| ResponseFormatterDataStoryteller --> ResponseFormatter```–†–µ–∞–ª–∏–∑—É–µ–º —ç—Ç–æ –≤ –∫–æ–¥–µ.–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:- –£–∑–µ–ª `metadata_update_node` –º—ã –Ω–µ –≤–∫–ª—é—á–∞–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫, –æ–Ω –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ —Ç–∞–π–º–µ—Ä—É.- –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ –±–µ–∑ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á.–ö–æ–¥ –≤ `main_graph.py`:–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `graph/main_graph.py`pythonCopyDownloadfrom langgraph.graph import StateGraph, END
from .nodes import (
    router_node,
    schema_master_node,
    sql_generator_node,
    sql_validator_node,
    access_check_node,
    db_executor_node,
    data_interpreter_node,
    query_classifier_node,
    small_talk_node,
    rag_search_node,
    web_search_node,
    response_synthesizer_node,
    general_assistant_node,
    fallback_handler_node,
    data_storyteller_node,
    response_formatter_node
)
from .state import AgentState
from langchain_core.runnables import RunnableLambda
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

def build_telegram_analytics_graph():
    """–°–æ–∑–¥–∞–µ—Ç –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç –≥—Ä–∞—Ñ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤"""
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞
    graph = StateGraph(AgentState)
    
    # ------------------------------
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö —É–∑–ª–æ–≤ –≥—Ä–∞—Ñ–∞
    # ------------------------------
    nodes = [
        ("router", RunnableLambda(router_node)),
        ("schema_master", RunnableLambda(schema_master_node)),
        ("sql_generator", RunnableLambda(sql_generator_node)),
        ("sql_validator", RunnableLambda(sql_validator_node)),
        ("access_check", RunnableLambda(access_check_node)),
        ("db_executor", RunnableLambda(db_executor_node)),
        ("data_interpreter", RunnableLambda(data_interpreter_node)),
        ("data_storyteller", RunnableLambda(data_storyteller_node)),
        ("query_classifier", RunnableLambda(query_classifier_node)),
        ("small_talk", RunnableLambda(small_talk_node)),
        ("rag_search", RunnableLambda(rag_search_node)),
        ("web_search", RunnableLambda(web_search_node)),
        ("response_synthesizer", RunnableLambda(response_synthesizer_node)),
        ("general_assistant", RunnableLambda(general_assistant_node)),
        ("fallback_handler", RunnableLambda(fallback_handler_node)),
        ("response_formatter", RunnableLambda(response_formatter_node)),
    ]
    
    for name, node in nodes:
        graph.add_node(name, node)
        logger.debug(f"–£–∑–µ–ª –¥–æ–±–∞–≤–ª–µ–Ω: {name}")
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞
    graph.set_entry_point("router")
    logger.info("–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: router")
    
    # ------------------------------
    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
    # ------------------------------
    
    # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ —Ä–æ—É—Ç–µ—Ä–∞
    graph.add_conditional_edges(
        source="router",
        path_map={
            "analytics": "schema_master",
            "documentation": "query_classifier",
            "general": "general_assistant",
            "error": "fallback_handler"
        },
        condition=lambda state: state.get("route") or "error"
    )
    logger.debug("–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞")
    
    # –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–∞–π–ø–ª–∞–π–Ω
    graph.add_edge("schema_master", "sql_generator")
    graph.add_edge("sql_generator", "sql_validator")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ SQL
    graph.add_conditional_edges(
        source="sql_validator",
        path_map={
            "fallback_handler": "fallback_handler",
            "access_check": "access_check"
        },
        condition=lambda state: "fallback_handler" if state.get("error") else "access_check"
    )
    
    graph.add_edge("access_check", "db_executor")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL
    graph.add_conditional_edges(
        source="db_executor",
        path_map={
            "fallback_handler": "fallback_handler",
            "data_interpreter": "data_interpreter"
        },
        condition=lambda state: "fallback_handler" if state.get("error") else "data_interpreter"
    )
    
    graph.add_edge("data_interpreter", "data_storyteller")
    graph.add_edge("data_storyteller", "response_formatter")
    
    # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω
    graph.add_conditional_edges(
        source="query_classifier",
        path_map={
            "small_talk": "small_talk",
            "rag_search": "rag_search",
            "web_search": "web_search"
        },
        condition=lambda state: state.get("doc_query_type") or "small_talk"
    )
    
    graph.add_edge("small_talk", "response_synthesizer")
    graph.add_edge("rag_search", "response_synthesizer")
    graph.add_edge("web_search", "response_synthesizer")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ—Å–ª–µ —Å–∏–Ω—Ç–µ–∑–∞ –æ—Ç–≤–µ—Ç–∞
    graph.add_conditional_edges(
        source="response_synthesizer",
        path_map={
            "fallback_handler": "fallback_handler",
            "response_formatter": "response_formatter"
        },
        condition=lambda state: "fallback_handler" if state.get("error") else "response_formatter"
    )
    
    # –ü—Ä—è–º–æ–π –ø—É—Ç—å –¥–ª—è –æ–±—â–µ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    graph.add_edge("general_assistant", "response_formatter")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ fallback_handler
    graph.add_conditional_edges(
        source="fallback_handler",
        path_map={
            "schema_master": "schema_master",  # retry
            "general_assistant": "general_assistant",  # simplify
            "response_formatter": "response_formatter"  # escalate
        },
        condition=lambda state: state.get("fallback_action") or "response_formatter"
    )
    
    # –ó–∞–≤–µ—Ä—à–∞—é—â–∏–π —É–∑–µ–ª
    graph.add_edge("response_formatter", END)
    
    logger.info("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
    
    # –ö–æ–º–ø–∏–ª—è—Ü–∏—è –≥—Ä–∞—Ñ–∞
    compiled_graph = graph.compile()
    logger.info("–ì—Ä–∞—Ñ —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω")
    
    return compiled_graph

# –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –≥—Ä–∞—Ñ–∞
app = build_telegram_analytics_graph()

# ------------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# ------------------------------

def visualize_graph():
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞"""
    from langgraph.graph import export_graph
    dot = export_graph(app)
    dot.save("telegram_analytics_graph.dot")
    dot.render("telegram_analytics_graph", format="png")
    logger.info("–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ telegram_analytics_graph.png")

def get_graph():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ"""
    return app

def process_request(state: AgentState):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –≥—Ä–∞—Ñ"""
    logger.info(f"–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {state['user_query']}")
    try:
        # –í—ã–ø–æ–ª–Ω—è–µ–º –≥—Ä–∞—Ñ
        for step in app.stream(state):
            node_name, new_state = next(iter(step.items()))
            logger.debug(f"–£–∑–µ–ª '{node_name}' –∑–∞–≤–µ—Ä—à–µ–Ω. –°–æ—Å—Ç–æ—è–Ω–∏–µ: {state_snapshot(new_state)}")
        
        logger.info(f"–ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ. –¢–∏–ø –æ—Ç–≤–µ—Ç–∞: {new_state.get('response_type', 'unknown')}")
        return new_state
    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∞: {str(e)}")
        return {
            "error": "system_failure",
            "message": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
        }

def state_snapshot(state: AgentState) -> dict:
    """–°–æ–∑–¥–∞–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π —Å–Ω–∏–º–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    return {
        "route": state.get("route"),
        "error": state.get("error", {}).get("type") if state.get("error") else None,
        "sql": state.get("generated_sql", "")[:50] + "..." if state.get("generated_sql") else None,
        "result_rows": len(state["query_result"]) if isinstance(state.get("query_result"), list) else None,
        "response_type": state.get("response_type")
    }

if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
    logging.basicConfig(level=logging.INFO)
    visualize_graph()
    
    # –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    test_state = AgentState(
        user_id="UA-123",
        chat_id=123456789,
        user_query="–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü"
    )
    
    result = process_request(test_state)
    print("–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:", result.get("final_response", {}))–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:–ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —ç—Ç–∞–ø—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∞–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤–ü–æ—à–∞–≥–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–∑–ª–∞–¢—Ä–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (retry/simplify/escalate)–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö–ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–∞–π–ø–ª–∞–π–Ω: –æ—Ç —Å—Ö–µ–º—ã –ë–î –¥–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω: –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Üí –ø–æ–∏—Å–∫ ‚Üí —Å–∏–Ω—Ç–µ–∑–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã: –ø—Ä—è–º–æ–π –ø—É—Ç—å –∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–§—É–Ω–∫—Ü–∏—è —Å–Ω–∏–º–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —É—Å–ª–æ–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –≤–µ—Ç–æ–∫–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞:DiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-662{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-662 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-662 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-662 .error-icon{fill:#a44141;}#mermaid-svg-662 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-662 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-662 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-662 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-662 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-662 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-662 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-662 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-662 .marker.cross{stroke:lightgrey;}#mermaid-svg-662 svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-662 p{margin:0;}#mermaid-svg-662 .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-662 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-662 .cluster-label span{color:#F9FFFE;}#mermaid-svg-662 .cluster-label span p{background-color:transparent;}#mermaid-svg-662 .label text,#mermaid-svg-662 span{fill:#ccc;color:#ccc;}#mermaid-svg-662 .node rect,#mermaid-svg-662 .node circle,#mermaid-svg-662 .node ellipse,#mermaid-svg-662 .node polygon,#mermaid-svg-662 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-662 .rough-node .label text,#mermaid-svg-662 .node .label text,#mermaid-svg-662 .image-shape .label,#mermaid-svg-662 .icon-shape .label{text-anchor:middle;}#mermaid-svg-662 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-662 .rough-node .label,#mermaid-svg-662 .node .label,#mermaid-svg-662 .image-shape .label,#mermaid-svg-662 .icon-shape .label{text-align:center;}#mermaid-svg-662 .node.clickable{cursor:pointer;}#mermaid-svg-662 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-662 .arrowheadPath{fill:lightgrey;}#mermaid-svg-662 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-662 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-662 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-662 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-662 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-662 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-662 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-662 .cluster text{fill:#F9FFFE;}#mermaid-svg-662 .cluster span{color:#F9FFFE;}#mermaid-svg-662 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-662 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-662 rect.text{fill:none;stroke-width:0;}#mermaid-svg-662 .icon-shape,#mermaid-svg-662 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-662 .icon-shape p,#mermaid-svg-662 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-662 .icon-shape rect,#mermaid-svg-662 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-662 :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}analyticsdocumentationgeneralerrorerrorsuccesserrorsuccesssmall_talkrag_searchweb_searcherrorsuccessretrysimplifyescalaterouterschema_masterquery_classifiergeneral_assistantfallback_handlersql_generatorsql_validatoraccess_checkdb_executordata_interpreterdata_storytellerresponse_formattersmall_talkrag_searchweb_searchresponse_synthesizerEND–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞:pythonCopyDownloadfrom graph.main_graph import get_graph

app = get_graph()–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:pythonCopyDownloadfrom graph.state import AgentState
from graph.main_graph import process_request

state = AgentState(
    user_id="UA-123",
    chat_id=123456789,
    user_query="–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–∞–π"
)

result = process_request(state)–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞:pythonCopyDownloadfrom graph.main_graph import visualize_graph

visualize_graph()  # –°–æ–∑–¥–∞–µ—Ç PNG-—Ñ–∞–π–ª —Å –¥–∏–∞–≥—Ä–∞–º–º–æ–π–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI:pythonCopyDownloadfrom fastapi import FastAPI
from graph.main_graph import process_request
from graph.state import AgentState

app = FastAPI()

@app.post("/process")
async def handle_request(request_data: dict):
    state = AgentState(**request_data)
    result = process_request(state)
    return result.get("final_response", {})–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:–ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:–ì—Ä–∞—Ñ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—à–∞–≥–æ–≤–æ —á–µ—Ä–µ–∑ `.stream()`–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏–ö–∞–∂–¥—ã–π —à–∞–≥ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º:–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º `AgentState`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–Ω–∏–º–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–∑–ª–æ–≤–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:–ò–∑–æ–ª—è—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≥—Ä–∞—Ñ–∞–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö–≠—Ç–æ—Ç –≥—Ä–∞—Ñ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑—É–µ—Ç –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É —Å–∏—Å—Ç–µ–º—ã, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è —á–µ—Ç–∫—É—é –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –∏ —É–ø—Ä–æ—â–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

user: —Ç–µ–ø–µ—Ä—å web_search

assistant: ÊÄùËÄÉÔºö–ú—ã —É–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–ª–∏ WebSearch –≤ –≥—Ä–∞—Ñ, –Ω–æ –¥–∞–≤–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ–ø–∏—à–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ WebSearch –≤ `functions/web_search.py`.–£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –≤ –≥—Ä–∞—Ñ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ —É –Ω–∞—Å –µ—Å—Ç—å —É–∑–µ–ª `web_search_node`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é.–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ WebSearch:- –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ DuckDuckGo API (–∏–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ–∏—Å–∫–æ–≤–∏–∫)- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–º –¥–æ–º–µ–Ω–∞–º- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `functions/web_search.py`pythonCopyDownloadimport requests
import json
from config import Config
from services.monitoring import tracer
from .utils import clean_html_tags, filter_domains
import logging
from typing import List, Dict, Any
import re
import time

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

class WebSearch:
    def __init__(self):
        self.api_key = Config.DUCKDUCKGO_API_KEY
        self.allowed_domains = Config.WEB_SEARCH_ALLOWED_DOMAINS
        self.max_results = Config.WEB_SEARCH_MAX_RESULTS
        self.timeout = Config.WEB_SEARCH_TIMEOUT
        self.cache = {}
        self.last_request_time = 0
        self.min_request_interval = 1.0  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—Å–µ–∫)

    def search(self, query: str) -> List[Dict[str, Any]]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤–µ–±-–ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º –¥–æ–º–µ–Ω–∞–º
        
        :param query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        :return: –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [{"title": "...", "url": "...", "snippet": "..."}]
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
        cache_key = f"websearch:{query}"
        if cache_key in self.cache:
            logger.debug(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è: {query}")
            return self.cache[cache_key]
        
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
        current_time = time.time()
        elapsed = current_time - self.last_request_time
        if elapsed < self.min_request_interval:
            sleep_time = self.min_request_interval - elapsed
            logger.debug(f"–û–∂–∏–¥–∞–Ω–∏–µ {sleep_time:.2f} —Å–µ–∫ –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤")
            time.sleep(sleep_time)
        
        try:
            with tracer.trace("web_search") as span:
                span.input = query
                
                # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
                params = {
                    "q": query,
                    "format": "json",
                    "no_html": 1,
                    "no_redirect": 1,
                    "api_key": self.api_key,
                    "max_results": self.max_results
                }
                
                # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
                response = requests.get(
                    "https://api.duckduckgo.com/",
                    params=params,
                    timeout=self.timeout
                )
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
                if response.status_code != 200:
                    raise Exception(f"API –≤–µ—Ä–Ω—É–ª–æ —Å—Ç–∞—Ç—É—Å {response.status_code}")
                
                # –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                results = response.json().get("Results", [])
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(results)} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è '{query}'")
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                processed_results = []
                for result in results:
                    processed = self._process_result(result)
                    if processed:
                        processed_results.append(processed)
                
                # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–æ–º–µ–Ω–∞–º
                filtered_results = filter_domains(
                    processed_results,
                    self.allowed_domains
                )
                
                # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                final_results = filtered_results[:self.max_results]
                
                # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
                self.cache[cache_key] = final_results
                self.last_request_time = time.time()
                
                span.output = json.dumps(final_results, ensure_ascii=False)
                return final_results
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤–µ–±-–ø–æ–∏—Å–∫–∞: {str(e)}")
            tracer.log_error({
                "component": "web_search",
                "query": query,
                "error": str(e)
            })
            return []

    def _process_result(self, result: dict) -> dict:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –æ—á–∏—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞"""
        try:
            # –ë–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
            processed = {
                "title": clean_html_tags(result.get("Text", "")),
                "url": result.get("FirstURL", ""),
                "snippet": clean_html_tags(result.get("Result", "")),
                "domain": self._extract_domain(result.get("FirstURL", ""))
            }
            
            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏
            if "Icon" in result and "URL" in result["Icon"]:
                processed["icon"] = result["Icon"]["URL"]
            
            return processed
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: {str(e)}")
            return {}

    def _extract_domain(self, url: str) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–æ–º–µ–Ω –∏–∑ URL"""
        if not url:
            return ""
        
        # –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞
        domain = re.sub(r"^https?://(?:www\.)?([^/]+).*$", r"\1", url)
        return domain.lower()

# –£—Ç–∏–ª–∏—Ç—ã –≤ —Ç–æ–º –∂–µ —Ñ–∞–π–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

def clean_html_tags(text: str) -> str:
    """–£–¥–∞–ª—è–µ—Ç HTML-—Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    if not text:
        return ""
    return re.sub(r"<[^>]+>", "", text)

def filter_domains(results: List[dict], allowed_domains: List[str]) -> List[dict]:
    """
    –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Å–ø–∏—Å–∫—É —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
    
    :param results: –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    :param allowed_domains: –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ['example.com', 'docs.ru'])
    :return: –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    """
    if not allowed_domains:
        return results
    
    filtered = []
    for result in results:
        domain = result.get("domain", "")
        if any(allowed in domain for allowed in allowed_domains):
            filtered.append(result)
    
    logger.debug(f"–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: {len(results)} -> {len(filtered)} –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤")
    return filtered

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    class TestConfig:
        DUCKDUCKGO_API_KEY = "test_api_key"
        WEB_SEARCH_ALLOWED_DOMAINS = ["example.com", "wikipedia.org"]
        WEB_SEARCH_MAX_RESULTS = 3
        WEB_SEARCH_TIMEOUT = 5
    
    Config = TestConfig()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(level=logging.INFO)
    
    # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    searcher = WebSearch()
    results = searcher.search("Python programming language")
    
    print("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:")
    for i, res in enumerate(results, 1):
        print(f"{i}. {res['title']}")
        print(f"   URL: {res['url']}")
        print(f"   –û–ø–∏—Å–∞–Ω–∏–µ: {res['snippet'][:100]}...")
        print(f"   –î–æ–º–µ–Ω: {res.get('domain', '')}")
        print()–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DuckDuckGo API:–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ API–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: `no_html`, `no_redirect`–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ `max_results`–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è:–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º –¥–æ–º–µ–Ω–∞–º–û—á–∏—Å—Ç–∫–∞ HTML-—Ç–µ–≥–æ–≤ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–æ–º–µ–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞–º–∏:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤–¢–∞–π–º–∞—É—Ç—ã –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:pythonCopyDownload{
    "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
    "url": "https://example.com",
    "snippet": "–û–ø–∏—Å–∞–Ω–∏–µ...",
    "domain": "example.com",
    "icon": "https://..."  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
}–û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç HTML-—Ç–µ–≥–æ–≤–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–µ–Ω–æ–≤–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å:–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤–°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–æ–≤–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangGraph:–í —É–∑–ª–µ –≥—Ä–∞—Ñ–∞ `web_search_node` (–≤ `graph/nodes.py`):pythonCopyDownloaddef web_search_node(state: AgentState) -> AgentState:
    if state.get("doc_query_type") != "web_search":
        return state
    
    try:
        from functions.web_search import WebSearch
        searcher = WebSearch()
        results = searcher.search(state["user_query"])
        return {**state, "web_results": results}
    
    except Exception as e:
        logger.error(f"WebSearch error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "web_search", 
                "message": str(e)
            }
        }–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `config.py`:pythonCopyDownloadclass Config:
    # ...
    
    # WebSearch settings
    DUCKDUCKGO_API_KEY = os.getenv("DUCKDUCKGO_API_KEY", "")
    WEB_SEARCH_ALLOWED_DOMAINS = os.getenv("WEB_SEARCH_ALLOWED_DOMAINS", "").split(",")
    WEB_SEARCH_MAX_RESULTS = int(os.getenv("WEB_SEARCH_MAX_RESULTS", 5))
    WEB_SEARCH_TIMEOUT = int(os.getenv("WEB_SEARCH_TIMEOUT", 10))
    
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–æ–º–µ–Ω—ã
    if not WEB_SEARCH_ALLOWED_DOMAINS:
        WEB_SEARCH_ALLOWED_DOMAINS = [
            "wikipedia.org",
            "stackoverflow.com",
            "developer.mozilla.org",
            "docs.python.org",
            "pypi.org",
            "github.com"
        ]–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ:–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å:textCopyDownload"–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ Python?"–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:Query Classifier –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø `web_search`–í—ã–∑–æ–≤ WebSearch:pythonCopyDownloadresults = web_search.search("–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –≤ Python?")–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:jsonCopyDownload[
  {
    "title": "–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Python",
    "url": "https://docs.python.org/3/library/asyncio.html",
    "snippet": "–ú–æ–¥—É–ª—å asyncio –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º...",
    "domain": "docs.python.org"
  },
  {
    "title": "Asynchronous I/O in Python: A Complete Walkthrough",
    "url": "https://stackoverflow.com/questions/...",
    "snippet": "–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é async/await –≤ Python...",
    "domain": "stackoverflow.com"
  }
]–°–∏–Ω—Ç–µ–∑ –æ—Ç–≤–µ—Ç–∞:Response Synthesizer —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç–ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ HTML-—Ç–µ–≥–æ–≤–ó–∞–ø—Ä–µ—Ç –Ω–∞ –Ω–µ–¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:–ú–∞–∫—Å–∏–º—É–º 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ 10 —Å–µ–∫—É–Ω–¥–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ 1 —Å–µ–∫—É–Ω–¥–∞–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API:–ö–ª—é—á–∏ API —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—à–∏–±–∫–∞–º:–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö —Å–±–æ—è—Ö–í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –≤–µ–±-–ø–æ–∏—Å–∫, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ –æ–±—â—É—é —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤, —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

user: —Ç–µ–ø—Ä–µ—å sql validator

assistant: ÊÄùËÄÉÔºö–ú—ã —É–∂–µ –∏–º–µ–µ–º —Ñ—É–Ω–∫—Ü–∏—é `validate_sql` –≤ `sql_validator.py`, –Ω–æ –¥–∞–≤–∞–π—Ç–µ —Ä–∞—Å—à–∏—Ä–∏–º –µ–µ, –¥–æ–±–∞–≤–∏–≤ –±–æ–ª—å—à–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangSmith.–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞:1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã (DROP, DELETE, INSERT, UPDATE –∏ —Ç.–¥.)2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å JOIN –±–æ–ª—å—à–æ–≥–æ —á–∏—Å–ª–∞ —Ç–∞–±–ª–∏—Ü)4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ë–î)–û–¥–Ω–∞–∫–æ, –≤ –Ω–∞—à–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω–µ—à–Ω—é—é –ë–î, –º—ã –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è –∫–∞–∂–¥–æ–π –ë–î, –ø–æ—ç—Ç–æ–º—É —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–º –∞–Ω–∞–ª–∏–∑–µ.–£–ª—É—á—à–µ–Ω–∏—è:- –ò—Å–ø–æ–ª—å–∑—É–µ–º sqlparse –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ SQL –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.- –î–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Ç–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã.- –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangSmith –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏.–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `functions/sql_validator.py`pythonCopyDownloadimport sqlparse
from sqlparse.sql import Statement, Token
from sqlparse.tokens import DML, Keyword, Wildcard
from config import Config
from services.monitoring import tracer
import logging
from typing import List, Dict, Tuple, Optional
import re

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

class SQLValidator:
    def __init__(self):
        # –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        self.forbidden_keywords = [
            "insert", "update", "delete", "drop", "truncate", 
            "alter", "create", "grant", "revoke", "exec", 
            "execute", "shutdown", "backup", "restore"
        ]
        
        # –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è SELECT)
        self.allowed_keywords = [
            "select", "from", "where", "join", "group by", "order by",
            "having", "limit", "offset", "as", "distinct", "case", "when"
        ]
        
        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
        self.max_joins = Config.SQL_MAX_JOINS or 5
        self.max_conditions = Config.SQL_MAX_CONDITIONS or 10
        self.max_subqueries = Config.SQL_MAX_SUBQUERIES or 2
        
        # –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –æ–ø–∞—Å–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        self.dangerous_patterns = [
            r";\s*--",      # SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            r"union\s+all", # –í–æ–∑–º–æ–∂–Ω—ã–µ UNION-based –∞—Ç–∞–∫–∏
            r"xp_cmdshell", # –û–ø–∞—Å–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
            r"waitfor\s+delay", # Time-based –∞—Ç–∞–∫–∏
            r"dbcc",        # –ö–æ–º–∞–Ω–¥—ã –∫–æ–Ω—Å–æ–ª–∏
            r"\.\./\.\./",  # Path traversal
        ]

    def validate_sql(self, sql: str) -> Tuple[bool, Dict]:
        """
        –ü—Ä–æ–≤–æ–¥–∏—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é SQL-–∑–∞–ø—Ä–æ—Å–∞
        
        :param sql: SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        :return: –ö–æ—Ä—Ç–µ–∂ (–≤–∞–ª–∏–¥–µ–Ω –ª–∏ –∑–∞–ø—Ä–æ—Å, —Å–ª–æ–≤–∞—Ä—å —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        """
        validation_result = {
            "is_valid": False,
            "checks": {
                "forbidden_keywords": False,
                "only_select": False,
                "syntax_check": False,
                "dangerous_patterns": False,
                "complexity_check": False
            },
            "details": {},
            "errors": []
        }
        
        try:
            with tracer.trace("sql_validation") as span:
                span.input = sql
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
                if not sql.strip():
                    validation_result["errors"].append("–ü—É—Å—Ç–æ–π SQL-–∑–∞–ø—Ä–æ—Å")
                    span.output = json.dumps(validation_result)
                    return False, validation_result
                
                # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è SQL
                normalized_sql = self.normalize_sql(sql)
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                if not self.check_forbidden_keywords(normalized_sql, validation_result):
                    validation_result["errors"].append("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞")
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –¢–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã
                if not self.check_only_select(normalized_sql, validation_result):
                    validation_result["errors"].append("–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã")
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –û–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                if not self.check_dangerous_patterns(normalized_sql, validation_result):
                    validation_result["errors"].append("–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ–ø–∞—Å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏")
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
                parsed, syntax_ok = self.check_syntax(normalized_sql, validation_result)
                if not syntax_ok:
                    validation_result["errors"].append("–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞")
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ 6: –°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤–µ—Ä–µ–Ω)
                if syntax_ok and parsed:
                    if not self.check_complexity(parsed, validation_result):
                        validation_result["errors"].append("–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞")
                
                # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                is_valid = not validation_result["errors"]
                validation_result["is_valid"] = is_valid
                
                span.output = json.dumps(validation_result)
                return is_valid, validation_result
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ SQL: {str(e)}")
            validation_result["errors"].append(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
            return False, validation_result

    def normalize_sql(self, sql: str) -> str:
        """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç SQL –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
        # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
        normalized = sql.lower()
        
        # –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
        normalized = re.sub(r"--.*?$", "", normalized, flags=re.MULTILINE)
        normalized = re.sub(r"/\*.*?\*/", "", normalized, flags=re.DOTALL)
        
        # –ó–∞–º–µ–Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤
        normalized = re.sub(r"\s+", " ", normalized).strip()
        
        return normalized

    def check_forbidden_keywords(self, sql: str, result: Dict) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤"""
        found_forbidden = []
        
        for keyword in self.forbidden_keywords:
            # –ò—â–µ–º —Ü–µ–ª—ã–µ —Å–ª–æ–≤–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
            pattern = r"\b" + re.escape(keyword) + r"\b"
            if re.search(pattern, sql):
                found_forbidden.append(keyword)
        
        result["checks"]["forbidden_keywords"] = len(found_forbidden) == 0
        result["details"]["forbidden_keywords_found"] = found_forbidden
        
        return len(found_forbidden) == 0

    def check_only_select(self, sql: str, result: Dict) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–∞–ø—Ä–æ—Å —è–≤–ª—è–µ—Ç—Å—è SELECT"""
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º sqlparse –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞
        try:
            parsed = sqlparse.parse(sql)
            if not parsed:
                return False
                
            first_token = parsed[0].token_first()
            is_select = first_token and first_token.ttype is DML and first_token.value.lower() == "select"
            
            result["checks"]["only_select"] = is_select
            return is_select
        except Exception:
            # –§–æ–ª–±—ç–∫: –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            is_select = sql.strip().lower().startswith("select")
            result["checks"]["only_select"] = is_select
            return is_select

    def check_dangerous_patterns(self, sql: str, result: Dict) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã"""
        found_patterns = []
        
        for pattern in self.dangerous_patterns:
            if re.search(pattern, sql, re.IGNORECASE):
                found_patterns.append(pattern)
        
        result["checks"]["dangerous_patterns"] = len(found_patterns) == 0
        result["details"]["dangerous_patterns_found"] = found_patterns
        
        return len(found_patterns) == 0

    def check_syntax(self, sql: str, result: Dict) -> Tuple[Optional[List], bool]:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQL"""
        try:
            parsed = sqlparse.parse(sql)
            is_valid = bool(parsed) and all(isinstance(stmt, Statement) for stmt in parsed)
            
            result["checks"]["syntax_check"] = is_valid
            result["details"]["statements"] = len(parsed) if parsed else 0
            
            return parsed, is_valid
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}")
            result["checks"]["syntax_check"] = False
            result["details"]["syntax_error"] = str(e)
            return None, False

    def check_complexity(self, parsed: List, result: Dict) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞"""
        complexity = {
            "tables": 0,
            "joins": 0,
            "conditions": 0,
            "subqueries": 0,
            "functions": 0
        }
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
        for stmt in parsed:
            # –°—á–∏—Ç–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
            from_seen = False
            for token in stmt.tokens:
                if not from_seen:
                    if token.ttype is Keyword and token.value.lower() == "from":
                        from_seen = True
                else:
                    if isinstance(token, sqlparse.sql.Identifier):
                        complexity["tables"] += 1
                    elif token.ttype is Keyword and token.value.lower().startswith("join"):
                        complexity["joins"] += 1
                
                # –°—á–∏—Ç–∞–µ–º —É—Å–ª–æ–≤–∏—è (WHERE, HAVING)
                if token.ttype is Keyword and token.value.lower() in ("where", "having"):
                    complexity["conditions"] += self.count_conditions(token)
                
                # –°—á–∏—Ç–∞–µ–º –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã
                if token.ttype is Keyword and token.value.lower() == "select" and self.is_subquery(token):
                    complexity["subqueries"] += 1
                
                # –°—á–∏—Ç–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
                if token.ttype is sqlparse.tokens.Name and token.value.endswith("("):
                    complexity["functions"] += 1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        is_valid = True
        if complexity["joins"] > self.max_joins:
            result["errors"].append(f"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ JOIN ({complexity['joins']} > {self.max_joins})")
            is_valid = False
        
        if complexity["conditions"] > self.max_conditions:
            result["errors"].append(f"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É—Å–ª–æ–≤–∏–π ({complexity['conditions']} > {self.max_conditions})")
            is_valid = False
        
        if complexity["subqueries"] > self.max_subqueries:
            result["errors"].append(f"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ ({complexity['subqueries']} > {self.max_subqueries})")
            is_valid = False
        
        result["checks"]["complexity_check"] = is_valid
        result["details"]["complexity"] = complexity
        
        return is_valid

    def count_conditions(self, token) -> int:
        """–°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª–æ–≤–∏–π –≤ WHERE/HAVING"""
        count = 0
        # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: —Å—á–∏—Ç–∞–µ–º AND/OR
        for t in token.flatten():
            if t.ttype is Keyword and t.value.lower() in ("and", "or"):
                count += 1
        return max(count, 1)  # –ú–∏–Ω–∏–º—É–º 1 —É—Å–ª–æ–≤–∏–µ

    def is_subquery(self, token) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–æ–∫–µ–Ω –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–∫–æ–±–∫–∏ –≤–æ–∫—Ä—É–≥
        parent = token.parent
        while parent:
            if parent.ttype is sqlparse.tokens.Punctuation and parent.value == "(":
                return True
            parent = parent.parent
        return False

# –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQL

def extract_tables(sql: str) -> List[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü –∏–∑ SQL-–∑–∞–ø—Ä–æ—Å–∞"""
    try:
        parsed = sqlparse.parse(sql)
        tables = set()
        
        for stmt in parsed:
            for token in stmt.tokens:
                if isinstance(token, sqlparse.sql.Identifier):
                    tables.add(token.get_real_name())
                elif isinstance(token, sqlparse.sql.IdentifierList):
                    for ident in token.get_identifiers():
                        tables.add(ident.get_real_name())
        
        return list(tables)
    except Exception:
        return []

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    class TestConfig:
        SQL_MAX_JOINS = 3
        SQL_MAX_CONDITIONS = 5
        SQL_MAX_SUBQUERIES = 1
    
    Config = TestConfig()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(level=logging.INFO)
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    validator = SQLValidator()
    
    # 1. –í–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    valid_sql = "SELECT id, name FROM users WHERE status = 'active' LIMIT 10"
    is_valid, result = validator.validate_sql(valid_sql)
    print(f"–í–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {is_valid}")
    print(json.dumps(result, indent=2, ensure_ascii=False))
    
    # 2. –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    dangerous_sql = "SELECT * FROM users; DROP TABLE users;"
    is_valid, result = validator.validate_sql(dangerous_sql)
    print(f"\n–û–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {is_valid}")
    print(json.dumps(result, indent=2, ensure_ascii=False))
    
    # 3. –°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    complex_sql = """
    SELECT u.id, u.name, COUNT(o.id) AS order_count
    FROM users u
    LEFT JOIN orders o ON o.user_id = u.id
    LEFT JOIN products p ON p.id = o.product_id
    LEFT JOIN categories c ON c.id = p.category_id
    WHERE u.status = 'active'
      AND o.status IN ('completed', 'shipped')
      AND c.type = 'electronics'
    GROUP BY u.id, u.name
    HAVING COUNT(o.id) > 5
    ORDER BY order_count DESC
    """
    is_valid, result = validator.validate_sql(complex_sql)
    print(f"\n–°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {is_valid}")
    print(json.dumps(result, indent=2, ensure_ascii=False))–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (DROP, DELETE –∏ —Ç.–¥.)–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏)–ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã —Ç–æ–ª—å–∫–æ –Ω–∞ —á—Ç–µ–Ω–∏–µ (SELECT)–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ sqlparse–ö–æ–Ω—Ç—Ä–æ–ª—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ JOIN–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Å–ª–æ–≤–∏–π (WHERE/HAVING)–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤–ê–Ω–∞–ª–∏–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∞–±–ª–∏—Ü –∏ —Ñ—É–Ω–∫—Ü–∏–π–î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å:–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏–ü–µ—Ä–µ—á–µ–Ω—å –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–î–µ—Ç–∞–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞–°–ø–∏—Å–æ–∫ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith:–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–Ω—ã—Ö –∏ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQL:–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü–ü–æ–¥—Å—á–µ—Ç —É—Å–ª–æ–≤–∏–π –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π:–í —É–∑–ª–µ –≥—Ä–∞—Ñ–∞ `sql_validator_node`:pythonCopyDownloaddef sql_validator_node(state: AgentState) -> AgentState:
    if not state.get("generated_sql"):
        return state
    
    try:
        from functions.sql_validator import SQLValidator
        validator = SQLValidator()
        is_valid, result = validator.validate_sql(state["generated_sql"])
        
        if not is_valid:
            return {
                **state, 
                "error": {
                    "type": "sql_validation", 
                    "message": "–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π SQL –∑–∞–ø—Ä–æ—Å",
                    "details": result
                }
            }
        return state
    
    except Exception as e:
        logger.error(f"SQLValidator error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "sql_validation", 
                "message": str(e)
            }
        }–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `config.py`:pythonCopyDownloadclass Config:
    # ...
    
    # SQL Validation settings
    SQL_MAX_JOINS = int(os.getenv("SQL_MAX_JOINS", 5))
    SQL_MAX_CONDITIONS = int(os.getenv("SQL_MAX_CONDITIONS", 10))
    SQL_MAX_SUBQUERIES = int(os.getenv("SQL_MAX_SUBQUERIES", 2))–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ Fallback:pythonCopyDownloaddef handle_sql_error(self, error_info: dict) -> dict:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ç–∞–ª–∏ –∏–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    details = error_info.get("details", {})
    errors = details.get("errors", [])
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if errors:
        message = "–ü—Ä–æ–±–ª–µ–º—ã —Å SQL –∑–∞–ø—Ä–æ—Å–æ–º:\n- " + "\n- ".join(errors[:3])
    else:
        message = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SQL –∑–∞–ø—Ä–æ—Å"
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    if "DROP" in details.get("forbidden_keywords_found", []):
        return {
            "action": "escalate",
            "message": "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –æ–ø–∞—Å–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏!",
            "severity": "critical"
        }
    
    return {
        "action": "retry" if self.retry_count < 2 else "simplify",
        "message": message,
        "details": details
    }–ü—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏:–í–∞–ª–∏–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å:sqlCopyDownloadSELECT name, email FROM users WHERE status = 'active'–†–µ–∑—É–ª—å—Ç–∞—Ç:jsonCopyDownload{
  "is_valid": true,
  "checks": {
    "forbidden_keywords": true,
    "only_select": true,
    "syntax_check": true,
    "dangerous_patterns": true,
    "complexity_check": true
  },
  "details": {
    "complexity": {
      "tables": 1,
      "joins": 0,
      "conditions": 1,
      "subqueries": 0,
      "functions": 0
    }
  }
}–û–ø–∞—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å:sqlCopyDownloadSELECT * FROM users; DROP TABLE users;–†–µ–∑—É–ª—å—Ç–∞—Ç:jsonCopyDownload{
  "is_valid": false,
  "checks": {
    "forbidden_keywords": false,
    "only_select": true,
    "syntax_check": true,
    "dangerous_patterns": true,
    "complexity_check": true
  },
  "details": {
    "forbidden_keywords_found": ["drop"]
  },
  "errors": [
    "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞"
  ]
}–°–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å:sqlCopyDownloadSELECT u.*, o.*, p.* 
FROM users u
JOIN orders o ON o.user_id = u.id
JOIN products p ON p.id = o.product_id
JOIN categories c ON c.id = p.category_id
JOIN suppliers s ON s.id = p.supplier_id
JOIN warehouses w ON w.product_id = p.id
WHERE u.status = 'active' 
  AND o.status = 'completed'
  AND p.stock > 0
  AND c.type = 'electronics'
  AND s.country = 'Germany'
  AND w.quantity > 10–†–µ–∑—É–ª—å—Ç–∞—Ç (–ø—Ä–∏ max_joins=5):jsonCopyDownload{
  "is_valid": false,
  "checks": {
    "forbidden_keywords": true,
    "only_select": true,
    "syntax_check": true,
    "dangerous_patterns": true,
    "complexity_check": false
  },
  "details": {
    "complexity": {
      "tables": 6,
      "joins": 5,
      "conditions": 6,
      "subqueries": 0,
      "functions": 0
    }
  },
  "errors": [
    "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ JOIN (5 > 3)"
  ]
}–ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:–ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π:–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π —Ç–∏–ø–∞ `;--`–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UNION-based –∞—Ç–∞–∫–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ DoS-–∞—Ç–∞–∫:–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤–ó–∞—â–∏—Ç–∞ –æ—Ç —á—Ä–µ–∑–º–µ—Ä–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–µ–º–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤–ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –ø–æ —É—Ä–æ–≤–Ω—é –æ–ø–∞—Å–Ω–æ—Å—Ç–∏–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, —Å–æ—á–µ—Ç–∞—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑, –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–∏—Å—Ç–µ–º—ã –æ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö –∏ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

user: response_romatter —Ä–∞—Å–ø–∏—Å—ã–≤–∞–π

assistant: ÊÄùËÄÉÔºö–ú—ã —É–∂–µ –∏–º–µ–µ–º ResponseFormatter –≤ functions. –¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –µ–≥–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.ResponseFormatter –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤, –≤ —Ñ–æ—Ä–º–∞—Ç, –ø—Ä–∏–≥–æ–¥–Ω—ã–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram.–û–Ω –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –æ—Ç–≤–µ—Ç–æ–≤: —Ç–µ–∫—Å—Ç, —Ç–∞–±–ª–∏—Ü—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ñ–∞–π–ª—ã.–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:- data: —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–∞–º–∏:type: —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞ ('text', 'table', 'image', 'file')content: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞sources: —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)attachments: —Å–ø–∏—Å–æ–∫ –≤–ª–æ–∂–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)–ó–∞–¥–∞—á–∏:1. –î–ª—è —Ç–µ–∫—Å—Ç–∞: –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç, –≤–æ–∑–º–æ–∂–Ω–æ, –¥–æ–±–∞–≤–ª—è—è –∏—Å—Ç–æ—á–Ω–∏–∫–∏.2. –î–ª—è —Ç–∞–±–ª–∏—Ü—ã: –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (Markdown) –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª (CSV/Excel).3. –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ base64, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Ç—å; –µ—Å–ª–∏ URL, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º URL.4. –î–ª—è —Ñ–∞–π–ª–∞: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–ª–∏ URL.–£—á–∏—Ç—ã–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Telegram:- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: 4096 —Å–∏–º–≤–æ–ª–æ–≤.- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: JPEG, PNG, GIF.- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 20 MB (–¥–ª—è –±–æ—Ç–∞).–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤.- –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (—Ä–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —á–∞—Å—Ç–∏).- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ç–∞–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö.–î–µ—Ç–∞–ª–∏:- –î–ª—è —Ç–∞–±–ª–∏—Ü: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –º–∞–ª–µ–Ω—å–∫–∏–µ, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ Markdown —Ç–∞–±–ª–∏—Ü—É. –ï—Å–ª–∏ –±–æ–ª—å—à–∏–µ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º CSV.- –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: base64 –¥–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ /tmp, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É.–£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –≤ Telegram Bot API –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å:- –¢–µ–∫—Å—Ç: sendMessage- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: sendPhoto (–ø–æ URL –∏–ª–∏ —Ñ–∞–π–ª)- –î–æ–∫—É–º–µ–Ω—Ç—ã: sendDocument (—Ñ–∞–π–ª—ã)–†–µ–∞–ª–∏–∑—É–µ–º –≤ –≤–∏–¥–µ –∫–ª–∞—Å—Å–∞.–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `functions/response_formatter.py`pythonCopyDownloadimport pandas as pd
import matplotlib.pyplot as plt
import io
import base64
import tempfile
import os
import logging
import json
from typing import Dict, Any, List, Union
from config import Config
from services.monitoring import tracer
import numpy as np
import seaborn as sns
from datetime import datetime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

class ResponseFormatter:
    def __init__(self):
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.max_text_length = Config.MAX_TEXT_LENGTH or 4000  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
        self.max_table_rows = Config.MAX_TABLE_ROWS or 20
        self.max_table_columns = Config.MAX_TABLE_COLUMNS or 8
        self.image_quality = Config.IMAGE_QUALITY or 90
        self.temp_dir = Config.TEMP_DIR or tempfile.gettempdir()
        
        # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
        self.supported_formats = ["text", "table", "image", "file", "markdown"]
    
    def format(self, response_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Telegram API
        
        :param response_data: –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤
        :return: –°–ª–æ–≤–∞—Ä—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –≥–æ—Ç–æ–≤–æ–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
        """
        try:
            response_type = response_data.get("type", "text")
            
            with tracer.trace("response_formatting") as span:
                span.input = json.dumps(response_data, default=str)
                
                if response_type == "text":
                    result = self._format_text(response_data)
                elif response_type == "table":
                    result = self._format_table(response_data)
                elif response_type == "image":
                    result = self._format_image(response_data)
                elif response_type == "file":
                    result = self._format_file(response_data)
                elif response_type == "markdown":
                    result = self._format_markdown(response_data)
                else:
                    logger.warning(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞: {response_type}")
                    result = self._format_text({
                        "content": "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞",
                        "sources": response_data.get("sources", [])
                    })
                
                span.output = json.dumps(result, ensure_ascii=False)
                return result
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: {str(e)}")
            return self._format_error(str(e))

    def _format_text(self, data: Dict) -> Dict[str, Any]:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç"""
        content = data.get("content", "")
        sources = data.get("sources", [])
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
        if sources:
            sources_text = "\n\n–ò—Å—Ç–æ—á–Ω–∏–∫–∏:\n" + "\n".join(f"‚Ä¢ {src}" for src in sources[:3])
            content += sources_text
        
        # –û–±—Ä–µ–∑–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        if len(content) > self.max_text_length:
            content = content[:self.max_text_length - 100] + "...\n\n[—Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ]"
        
        return {
            "type": "text",
            "content": content,
            "parse_mode": "HTML"
        }

    def _format_table(self, data: Dict) -> Dict[str, Any]:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"""
        table_data = data.get("data")
        
        if isinstance(table_data, pd.DataFrame):
            df = table_data
        elif isinstance(table_data, list):
            df = pd.DataFrame(table_data)
        else:
            return self._format_error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã")
        
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
        if len(df) > self.max_table_rows or len(df.columns) > self.max_table_columns:
            return self._convert_to_image(df, data)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Markdown
        try:
            return self._format_as_markdown_table(df, data)
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: {str(e)}")
            return self._convert_to_image(df, data)

    def _format_as_markdown_table(self, df: pd.DataFrame, data: Dict) -> Dict[str, Any]:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç DataFrame –≤ —Ç–∞–±–ª–∏—Ü—É Markdown"""
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –∏ —Å—Ç–æ–ª–±—Ü–æ–≤
        df = df.head(self.max_table_rows)
        if len(df.columns) > self.max_table_columns:
            df = df[df.columns[:self.max_table_columns]]
        
        # –°–æ–∑–¥–∞–µ–º Markdown —Ç–∞–±–ª–∏—Ü—É
        headers = df.columns.tolist()
        md_table = "| " + " | ".join(headers) + " |\n"
        md_table += "| " + " | ".join(["---"] * len(headers)) + " |\n"
        
        for _, row in df.iterrows():
            values = [str(row[col])[:50] for col in headers]  # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            md_table += "| " + " | ".join(values) + " |\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        title = data.get("title", "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–∞")
        content = f"<b>{title}</b>\n\n```\n{md_table}\n```"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        if sources := data.get("sources"):
            content += "\n\n–ò—Å—Ç–æ—á–Ω–∏–∫–∏: " + ", ".join(sources[:2])
        
        return {
            "type": "text",
            "content": content,
            "parse_mode": "HTML"
        }

    def _convert_to_image(self, df: pd.DataFrame, data: Dict) -> Dict[str, Any]:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è"""
        try:
            # –°–æ–∑–¥–∞–µ–º —Ñ–∏–≥—É—Ä—É
            plt.figure(figsize=(12, min(8, 0.3 * len(df))))
            
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—á–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
            ax = plt.subplot(111, frame_on=False)
            ax.xaxis.set_visible(False)
            ax.yaxis.set_visible(False)
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            display_df = df.head(50)
            
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            table = plt.table(
                cellText=display_df.values,
                colLabels=display_df.columns,
                cellLoc='center',
                loc='center'
            )
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—Ç–∏–ª—å
            table.auto_set_font_size(False)
            table.set_fontsize(10)
            table.scale(1.2, 1.2)
            
            # –ó–∞–≥–æ–ª–æ–≤–æ–∫
            title = data.get("title", "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–∞")
            plt.title(title, fontsize=12)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ BytesIO
            buf = io.BytesIO()
            plt.savefig(
                buf, 
                format='png', 
                bbox_inches='tight',
                dpi=120,
                quality=self.image_quality
            )
            buf.seek(0)
            
            # –ö–æ–¥–∏—Ä—É–µ–º –≤ base64
            img_str = base64.b64encode(buf.read()).decode()
            plt.close()
            
            return {
                "type": "image",
                "content": title,
                "data": f"data:image/png;base64,{img_str}",
                "sources": data.get("sources", [])
            }
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {str(e)}")
            return self._format_text({
                "content": f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É. {str(e)}",
                "sources": data.get("sources", [])
            })

    def _format_image(self, data: Dict) -> Dict[str, Any]:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
        # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
        if "base64" in data:
            return {
                "type": "image",
                "data": f"data:image/png;base64,{data['base64']}",
                "caption": data.get("caption", ""),
                "sources": data.get("sources", [])
            }
        
        # –ï—Å–ª–∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        elif "url" in data:
            return {
                "type": "image",
                "url": data["url"],
                "caption": data.get("caption", ""),
                "sources": data.get("sources", [])
            }
        
        # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        elif "plot_data" in data:
            return self._generate_plot(data)
        
        return self._format_error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")

    def _generate_plot(self, data: Dict) -> Dict[str, Any]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö"""
        try:
            plt.figure(figsize=(10, 6))
            
            plot_type = data.get("plot_type", "bar")
            plot_data = data["plot_data"]
            
            if plot_type == "bar":
                plt.bar(plot_data["x"], plot_data["y"])
            elif plot_type == "line":
                plt.plot(plot_data["x"], plot_data["y"])
            elif plot_type == "pie":
                plt.pie(plot_data["sizes"], labels=plot_data["labels"])
            elif plot_type == "scatter":
                plt.scatter(plot_data["x"], plot_data["y"])
            elif plot_type == "hist":
                plt.hist(plot_data["values"])
            else:
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º Seaborn –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
                if plot_type == "heatmap":
                    sns.heatmap(pd.DataFrame(plot_data["matrix"]), annot=True)
                elif plot_type == "boxplot":
                    sns.boxplot(data=pd.DataFrame(plot_data["data"]))
                else:
                    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
                    plt.plot(plot_data["x"], plot_data["y"])
            
            # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø–æ–¥–ø–∏—Å–∏
            plt.title(data.get("title", "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞"))
            plt.xlabel(data.get("x_label", ""))
            plt.ylabel(data.get("y_label", ""))
            
            if plot_type != "pie":
                plt.grid(True, linestyle='--', alpha=0.7)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ BytesIO
            buf = io.BytesIO()
            plt.savefig(
                buf, 
                format='png', 
                bbox_inches='tight',
                dpi=120,
                quality=self.image_quality
            )
            buf.seek(0)
            img_str = base64.b64encode(buf.read()).decode()
            plt.close()
            
            return {
                "type": "image",
                "content": data.get("title", "–ì—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"),
                "data": f"data:image/png;base64,{img_str}",
                "sources": data.get("sources", [])
            }
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: {str(e)}")
            return self._format_text({
                "content": f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫. {str(e)}",
                "sources": data.get("sources", [])
            })

    def _format_file(self, data: Dict) -> Dict[str, Any]:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ñ–∞–π–ª–æ–≤—ã–π –æ—Ç–≤–µ—Ç"""
        # –ï—Å–ª–∏ CSV –¥–∞–Ω–Ω—ã–µ
        if "csv_data" in data:
            return self._create_csv_file(data)
        
        # –ï—Å–ª–∏ Excel –¥–∞–Ω–Ω—ã–µ
        elif "excel_data" in data:
            return self._create_excel_file(data)
        
        # –ï—Å–ª–∏ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
        elif "file_path" in data and os.path.exists(data["file_path"]):
            return {
                "type": "file",
                "file_path": data["file_path"],
                "filename": data.get("filename", os.path.basename(data["file_path"])),
                "caption": data.get("caption", ""),
                "sources": data.get("sources", [])
            }
        
        return self._format_error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞")

    def _create_csv_file(self, data: Dict) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π CSV —Ñ–∞–π–ª"""
        try:
            df = pd.DataFrame(data["csv_data"])
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = data.get("filename", f"data_{timestamp}.csv")
            file_path = os.path.join(self.temp_dir, filename)
            
            df.to_csv(file_path, index=False, encoding='utf-8')
            
            return {
                "type": "file",
                "file_path": file_path,
                "filename": filename,
                "caption": data.get("caption", "–î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV"),
                "sources": data.get("sources", [])
            }
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è CSV: {str(e)}")
            return self._format_error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞: {str(e)}")

    def _create_excel_file(self, data: Dict) -> Dict[str, Any]:
        """–°–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π Excel —Ñ–∞–π–ª"""
        try:
            # –î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ª–∏—Å—Ç–∞–º–∏
            excel_data = data["excel_data"]
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = data.get("filename", f"data_{timestamp}.xlsx")
            file_path = os.path.join(self.temp_dir, filename)
            
            with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                for sheet_name, sheet_data in excel_data.items():
                    if isinstance(sheet_data, pd.DataFrame):
                        sheet_data.to_excel(writer, sheet_name=sheet_name, index=False)
                    else:
                        pd.DataFrame(sheet_data).to_excel(writer, sheet_name=sheet_name, index=False)
            
            return {
                "type": "file",
                "file_path": file_path,
                "filename": filename,
                "caption": data.get("caption", "–î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Excel"),
                "sources": data.get("sources", [])
            }
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Excel: {str(e)}")
            return self._format_error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞: {str(e)}")

    def _format_markdown(self, data: Dict) -> Dict[str, Any]:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç Markdown-–∫–æ–Ω—Ç–µ–Ω—Ç"""
        content = data.get("content", "")
        sources = data.get("sources", [])
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
        if sources:
            content += "\n\n**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**\n" + "\n".join(f"- {src}" for src in sources[:3])
        
        # –û–±—Ä–µ–∑–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        if len(content) > self.max_text_length:
            content = content[:self.max_text_length - 100] + "...\n\n[—Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ]"
        
        return {
            "type": "text",
            "content": content,
            "parse_mode": "MarkdownV2"
        }

    def _format_error(self, message: str) -> Dict[str, Any]:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ"""
        return {
            "type": "text",
            "content": f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: {message}",
            "parse_mode": "HTML"
        }

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(level=logging.INFO)
    
    formatter = ResponseFormatter()
    
    # –¢–µ—Å—Ç 1: –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    text_response = formatter.format({
        "type": "text",
        "content": "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç",
        "sources": ["internal_db", "user_data"]
    })
    print("–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:", json.dumps(text_response, indent=2, ensure_ascii=False))
    
    # –¢–µ—Å—Ç 2: –¢–∞–±–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–ª–µ–Ω—å–∫–∏–π)
    small_table = {
        "type": "table",
        "data": [
            {"id": 1, "name": "–ê–ª–∏—Å–∞", "score": 95},
            {"id": 2, "name": "–ë–æ–±", "score": 88},
            {"id": 3, "name": "–ß–∞—Ä–ª–∏", "score": 92}
        ],
        "title": "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
    }
    table_response = formatter.format(small_table)
    print("\n–¢–∞–±–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–ª–µ–Ω—å–∫–∏–π):", table_response["content"][:200] + "...")
    
    # –¢–µ—Å—Ç 3: –¢–∞–±–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç (–±–æ–ª—å—à–æ–π)
    big_table_data = [{"col{}".format(i): np.random.rand() for i in range(15)} for _ in range(100)]
    big_table = {
        "type": "table",
        "data": big_table_data,
        "title": "–ë–æ–ª—å—à–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö"
    }
    big_table_response = formatter.format(big_table)
    print("\n–¢–∞–±–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç (–±–æ–ª—å—à–æ–π):", big_table_response["type"], big_table_response.keys())
    
    # –¢–µ—Å—Ç 4: –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç
    plot_response = formatter.format({
        "type": "image",
        "plot_data": {
            "x": [1, 2, 3, 4, 5],
            "y": [10, 15, 13, 17, 25]
        },
        "plot_type": "line",
        "title": "–ü—Ä–∏–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞"
    })
    print("\n–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç:", plot_response["type"], len(plot_response["data"]), "—Å–∏–º–≤–æ–ª–æ–≤")
    
    # –¢–µ—Å—Ç 5: –§–∞–π–ª–æ–≤—ã–π –æ—Ç–≤–µ—Ç (CSV)
    csv_response = formatter.format({
        "type": "file",
        "csv_data": [
            {"product": "–Ø–±–ª–æ–∫–∏", "price": 120, "quantity": 50},
            {"product": "–ë–∞–Ω–∞–Ω—ã", "price": 85, "quantity": 30},
            {"product": "–ê–ø–µ–ª—å—Å–∏–Ω—ã", "price": 110, "quantity": 40}
        ],
        "filename": "products.csv",
        "caption": "–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö"
    })
    print("\n–§–∞–π–ª–æ–≤—ã–π –æ—Ç–≤–µ—Ç (CSV):", csv_response["file_path"])
    
    # –¢–µ—Å—Ç 6: –û—à–∏–±–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    error_response = formatter.format({"type": "unsupported"})
    print("\n–û—à–∏–±–æ—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:", error_response["content"])–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤:–¢–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã (—Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º Markdown/HTML)–¢–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ Markdown –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ base64, URL –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤)–§–∞–π–ª—ã (CSV, Excel, –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã)Markdown-–∫–æ–Ω—Ç–µ–Ω—Ç–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤:–õ–∏–Ω–µ–π–Ω—ã–µ, —Å—Ç–æ–ª–±—á–∞—Ç—ã–µ, –∫—Ä—É–≥–æ–≤—ã–µ–¢–æ—á–µ—á–Ω—ã–µ, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã–¢–µ–ø–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã, boxplot–†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∫ –æ—Ç–≤–µ—Ç–∞–º–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–Ω–µ –±–æ–ª–µ–µ 3)–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Telegram:–°–æ–±–ª—é–¥–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π (4096 —Å–∏–º–≤–æ–ª–æ–≤)–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å Telegram–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏:–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–Ω—É—é temp-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ —Ç–∞–±–ª–∏—Ü –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–ì—Ä–µ–π—Å—Ñ—É–ª-–¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–ª–±—ç–∫ –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π:–í —É–∑–ª–µ –≥—Ä–∞—Ñ–∞ `response_formatter_node`:pythonCopyDownloaddef response_formatter_node(state: AgentState) -> AgentState:
    if state.get("response_content") and state.get("response_type"):
        formatter = ResponseFormatter()
        formatted = formatter.format({
            "type": state["response_type"],
            "content": state["response_content"],
            "sources": state.get("sources", []),
            "attachments": state.get("attachments", [])
        })
        return {**state, "final_response": formatted}
    
    # –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if state.get("analysis_result") and state.get("query_result"):
        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ DataStoryteller + ResponseFormatter
        ...
    
    return state–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `config.py`:pythonCopyDownloadclass Config:
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    MAX_TEXT_LENGTH = int(os.getenv("MAX_TEXT_LENGTH", 4000))  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
    MAX_TABLE_ROWS = int(os.getenv("MAX_TABLE_ROWS", 20))
    MAX_TABLE_COLUMNS = int(os.getenv("MAX_TABLE_COLUMNS", 8))
    IMAGE_QUALITY = int(os.getenv("IMAGE_QUALITY", 90))
    TEMP_DIR = os.getenv("TEMP_DIR", "/tmp/telegram_bot")–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:pythonCopyDownloadresponse = formatter.format({
    "type": "text",
    "content": "–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞ –º–µ—Å—è—Ü: 25¬∞C",
    "sources": ["weather_api"]
})–¢–∞–±–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–ª–µ–Ω—å–∫–∏–π):pythonCopyDownloadresponse = formatter.format({
    "type": "table",
    "data": [
        {"–ì–æ—Ä–æ–¥": "–ú–æ—Å–∫–≤–∞", "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞": 22},
        {"–ì–æ—Ä–æ–¥": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞": 20}
    ],
    "title": "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ –≥–æ—Ä–æ–¥–∞—Ö"
})–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç:pythonCopyDownloadresponse = formatter.format({
    "type": "image",
    "plot_data": {
        "x": ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä"],
        "y": [100, 150, 130],
        "labels": ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç"]
    },
    "plot_type": "bar",
    "title": "–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º"
})–§–∞–π–ª–æ–≤—ã–π –æ—Ç–≤–µ—Ç:pythonCopyDownloadresponse = formatter.format({
    "type": "file",
    "csv_data": [
        {"id": 1, "name": "–¢–æ–≤–∞—Ä 1", "price": 100},
        {"id": 2, "name": "–¢–æ–≤–∞—Ä 2", "price": 200}
    ],
    "filename": "products.csv",
    "caption": "–≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤"
})–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã:–ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –¥–∞–Ω–Ω—ã–º:–ú–∞–ª–µ–Ω—å–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã ‚Üí Markdown –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏–ë–æ–ª—å—à–∏–µ —Ç–∞–±–ª–∏—Ü—ã ‚Üí –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ CSV-—Ñ–∞–π–ª–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–∞–º—è—Ç–∏–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö–≠—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≥–∏–±–∫–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã, –∞–¥–∞–ø—Ç–∏—Ä—É—è—Å—å –∫ —Ç–∏–ø—É –¥–∞–Ω–Ω—ã—Ö –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã Telegram, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç.

user: access_check —Ç–µ–ø–µ—Ä—å

assistant: ÊÄùËÄÉÔºö–ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (Access Check) –¥–ª—è —Å–∏—Å—Ç–µ–º—ã.–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∞–≤–æ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–∞ –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º —Ç–∞–±–ª–∏—Ü–∞–º/–¥–∞–Ω–Ω—ã–º.–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ—Ä–≤–∏—Å–æ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (Auth Service) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ RBAC (Role-Based Access Control).3. –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏–∑ SQL-–∑–∞–ø—Ä–æ—Å–∞ —Å –º–∞—Ç—Ä–∏—Ü–µ–π –¥–æ—Å—Ç—É–ø–∞.4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫.–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:- –ò—Å–ø–æ–ª—å–∑—É–µ–º SQL-–ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏–∑ –∑–∞–ø—Ä–æ—Å–∞.- –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É Auth Service.- –°–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –º–∞—Ç—Ä–∏—Ü–µ–π –¥–æ—Å—Ç—É–ø–∞ (–∫–∞–∫–∞—è —Ä–æ–ª—å –∫ –∫–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø).–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ –º–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ –≤ –±–∞–∑–µ (–∑–¥–µ—Å—å –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ –∫–æ–Ω—Ñ–∏–≥–µ).–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `functions/access_check.py`pythonCopyDownloadimport requests
import sqlparse
import re
import logging
from typing import List, Dict, Tuple, Optional
from config import Config
from services.monitoring import tracer
import json
import time
from functools import lru_cache

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

class AccessChecker:
    def __init__(self):
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        self.auth_service_url = Config.AUTH_SERVICE_URL
        self.auth_token = Config.AUTH_SERVICE_TOKEN
        self.timeout = Config.AUTH_SERVICE_TIMEOUT
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RBAC
        self.access_matrix = self.load_access_matrix()
        self.max_retries = Config.AUTH_MAX_RETRIES
        self.retry_delay = Config.AUTH_RETRY_DELAY
        
        # –ö–µ—à —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        self.permission_cache = {}
        self.cache_ttl = Config.ACCESS_CACHE_TTL

    def check_access(self, user_id: str, sql_query: str) -> Tuple[bool, Dict]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –¥–∞–Ω–Ω—ã–º –≤ SQL-–∑–∞–ø—Ä–æ—Å–µ
        
        :param user_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        :param sql_query: SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        :return: –ö–æ—Ä—Ç–µ–∂ (—Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –¥–æ—Å—Ç—É–ø, –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        """
        result = {
            "has_access": False,
            "user_id": user_id,
            "tables": [],
            "required_roles": {},
            "user_roles": [],
            "errors": []
        }
        
        try:
            with tracer.trace("access_check") as span:
                span.input = json.dumps({"user_id": user_id, "sql_query": sql_query[:500]})
                
                # –®–∞–≥ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏–∑ SQL-–∑–∞–ø—Ä–æ—Å–∞
                tables = self.extract_tables(sql_query)
                result["tables"] = tables
                
                if not tables:
                    result["errors"].append("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ –∑–∞–ø—Ä–æ—Å–µ")
                    span.output = json.dumps(result)
                    return False, result
                
                # –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user_roles = self.get_user_roles(user_id)
                result["user_roles"] = user_roles
                
                if not user_roles:
                    result["errors"].append("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ä–æ–ª–µ–π")
                    span.output = json.dumps(result)
                    return False, result
                
                # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã
                required_roles = {}
                has_access = True
                
                for table in tables:
                    table_roles = self.get_required_roles(table)
                    required_roles[table] = table_roles
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∏–∑ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–æ–ª–µ–π
                    if not any(role in user_roles for role in table_roles):
                        result["errors"].append(f"–î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ '{table}' –∑–∞–ø—Ä–µ—â–µ–Ω")
                        has_access = False
                
                result["required_roles"] = required_roles
                result["has_access"] = has_access
                
                span.output = json.dumps(result)
                return has_access, result
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞: {str(e)}")
            result["errors"].append(f"–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
            return False, result

    def extract_tables(self, sql: str) -> List[str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü –∏–∑ SQL-–∑–∞–ø—Ä–æ—Å–∞"""
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º sqlparse –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
            parsed = sqlparse.parse(sql)
            tables = set()
            
            if not parsed:
                return []
            
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Ç–∞–±–ª–∏—Ü
            def find_tables(token):
                if isinstance(token, sqlparse.sql.Identifier):
                    # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã (–±–µ–∑ –∞–ª–∏–∞—Å–æ–≤)
                    tables.add(token.get_real_name().lower())
                elif isinstance(token, sqlparse.sql.IdentifierList):
                    for ident in token.get_identifiers():
                        tables.add(ident.get_real_name().lower())
                elif hasattr(token, 'tokens'):
                    for t in token.tokens:
                        find_tables(t)
            
            # –ò—â–µ–º –≤ –∫–∞–∂–¥–æ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–∏
            for statement in parsed:
                # –ò—â–µ–º —Å–µ–∫—Ü–∏–∏ FROM –∏ JOIN
                from_seen = False
                for token in statement.tokens:
                    if token.ttype is sqlparse.tokens.Keyword and token.value.lower() == 'from':
                        from_seen = True
                    elif from_seen:
                        if token.ttype is sqlparse.tokens.Keyword and token.value.lower().startswith('join'):
                            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ JOIN
                            continue
                        find_tables(token)
            
            return list(tables)
        
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü: {str(e)}")
            # –§–æ–ª–±—ç–∫: –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–≥—É–ª—è—Ä–∫–∞
            tables = re.findall(r'\b(?:from|join)\s+([\w\.]+)', sql, re.IGNORECASE)
            return list(set(table.lower().split('.')[-1] for table in tables))

    @lru_cache(maxsize=1024)
    def get_user_roles(self, user_id: str) -> List[str]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        for attempt in range(self.max_retries):
            try:
                response = requests.get(
                    f"{self.auth_service_url}/users/{user_id}/roles",
                    headers={"Authorization": f"Bearer {self.auth_token}"},
                    timeout=self.timeout
                )
                
                if response.status_code == 200:
                    return response.json().get("roles", [])
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ HTTP
                if response.status_code == 404:
                    logger.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                    return []
                
                if response.status_code == 401:
                    logger.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Å–µ—Ä–≤–∏—Å–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞")
                    return []
                
                logger.warning(f"–°–µ—Ä–≤–∏—Å –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å {response.status_code}")
                
            except requests.exceptions.RequestException as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å—É –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞: {str(e)}")
            
            # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏
            if attempt < self.max_retries - 1:
                time.sleep(self.retry_delay)
        
        return []

    def get_required_roles(self, table: str) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–æ–ª–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
        if table in self.permission_cache:
            return self.permission_cache[table]
        
        # –ü–æ–∏—Å–∫ –≤ –º–∞—Ç—Ä–∏—Ü–µ –¥–æ—Å—Ç—É–ø–∞
        table_lower = table.lower()
        roles = []
        
        # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        if table_lower in self.access_matrix:
            roles = self.access_matrix[table_lower]
        else:
            # –ò—â–µ–º –ø–æ —à–∞–±–ª–æ–Ω–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sales_*")
            for pattern, pattern_roles in self.access_matrix.items():
                if '*' in pattern:
                    regex = pattern.replace('*', '.*')
                    if re.match(regex, table_lower):
                        roles = pattern_roles
                        break
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if not roles:
            roles = self.access_matrix.get('default', ['admin'])
        
        # –ö–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        self.permission_cache[table] = roles
        return roles

    def load_access_matrix(self) -> Dict[str, List[str]]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞—Ç—Ä–∏—Ü—É –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–ª–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞"""
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ –ë–î –∏–ª–∏ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        return {
            # –¢–∞–±–ª–∏—Ü—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            "sales": ["sales_manager", "analyst", "admin"],
            "customers": ["sales_manager", "customer_support", "admin"],
            "products": ["product_manager", "analyst", "admin"],
            
            # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            "users": ["admin", "system_admin"],
            "audit_log": ["admin", "auditor"],
            
            # –®–∞–±–ª–æ–Ω—ã
            "report_*": ["analyst", "report_user"],
            "temp_*": ["analyst", "developer"],
            
            # –ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            "default": ["admin"]
        }

    def clear_cache(self):
        """–û—á–∏—â–∞–µ—Ç –∫–µ—à —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π"""
        self.permission_cache = {}
        self.get_user_roles.cache_clear()

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    class TestConfig:
        AUTH_SERVICE_URL = "https://auth.example.com/api"
        AUTH_SERVICE_TOKEN = "test_token"
        AUTH_SERVICE_TIMEOUT = 5
        AUTH_MAX_RETRIES = 2
        AUTH_RETRY_DELAY = 1
        ACCESS_CACHE_TTL = 300  # 5 –º–∏–Ω—É—Ç
    
    Config = TestConfig()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(level=logging.INFO)
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    user_id = "user_123"
    sql_query = """
    SELECT c.name, SUM(s.amount) AS total
    FROM customers c
    JOIN sales s ON s.customer_id = c.id
    WHERE s.date >= '2023-01-01'
    GROUP BY c.name
    ORDER BY total DESC
    """
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
    checker = AccessChecker()
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    has_access, result = checker.check_access(user_id, sql_query)
    print(f"–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω: {has_access}")
    print("–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:")
    print(json.dumps(result, indent=2, ensure_ascii=False))
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü
    tables = checker.extract_tables(sql_query)
    print(f"\n–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: {tables}")
    
    # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
    print(f"\n–†–æ–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã 'sales': {checker.get_required_roles('sales')}")
    print(f"–†–æ–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã 'users': {checker.get_required_roles('users')}")
    print(f"–†–æ–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã 'report_monthly': {checker.get_required_roles('report_monthly')}")
    print(f"–†–æ–ª–∏ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã: {checker.get_required_roles('unknown_table')}")–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞:–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏–∑ SQL-–∑–∞–ø—Ä–æ—Å–∞–ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –º–∞—Ç—Ä–∏—Ü–µ–π –¥–æ—Å—Ç—É–ø–∞–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü:–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SQL-–ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞–§–æ–ª–±—ç–∫ –Ω–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω —Ç–∞–±–ª–∏—Ü–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–µ—Ä–≤–∏—Å–æ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ —Å–±–æ—è—Ö–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö HTTP-—Å—Ç–∞—Ç—É—Å–æ–≤–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤–ì–∏–±–∫–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞:–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ—á–Ω—ã—Ö –∏–º–µ–Ω —Ç–∞–±–ª–∏—Ü–®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥—Ä—É–ø–ø —Ç–∞–±–ª–∏—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, `report_*`)–ü–æ–ª–∏—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è —Ç–∞–±–ª–∏—ÜLRU-–∫–µ—à –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö–î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å:–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏–°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü –∏ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–æ–ª–µ–π–ü–µ—Ä–µ—á–µ–Ω—å –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π:–í —É–∑–ª–µ –≥—Ä–∞—Ñ–∞ `access_check_node`:pythonCopyDownloaddef access_check_node(state: AgentState) -> AgentState:
    if not state.get("generated_sql") or state.get("error"):
        return state
    
    try:
        from functions.access_check import AccessChecker
        checker = AccessChecker()
        has_access, result = checker.check_access(
            state["user_id"],
            state["generated_sql"]
        )
        
        if not has_access:
            return {
                **state, 
                "error": {
                    "type": "access_denied", 
                    "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞",
                    "details": result
                }
            }
        return state
    
    except Exception as e:
        logger.error(f"AccessCheck error: {str(e)}")
        return {
            **state, 
            "error": {
                "type": "access_check", 
                "message": str(e)
            }
        }–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `config.py`:pythonCopyDownloadclass Config:
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    AUTH_SERVICE_URL = os.getenv("AUTH_SERVICE_URL", "http://auth-service:8080/api")
    AUTH_SERVICE_TOKEN = os.getenv("AUTH_SERVICE_TOKEN")
    AUTH_SERVICE_TIMEOUT = int(os.getenv("AUTH_SERVICE_TIMEOUT", 5))
    AUTH_MAX_RETRIES = int(os.getenv("AUTH_MAX_RETRIES", 3))
    AUTH_RETRY_DELAY = float(os.getenv("AUTH_RETRY_DELAY", 0.5))
    ACCESS_CACHE_TTL = int(os.getenv("ACCESS_CACHE_TTL", 300))  # 5 –º–∏–Ω—É—Ç
    
    # –ü—Ä–∏–º–µ—Ä –º–∞—Ç—Ä–∏—Ü—ã –¥–æ—Å—Ç—É–ø–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ –ë–î)
    ACCESS_MATRIX = {
        "sales": ["sales_manager", "analyst"],
        "customers": ["sales_manager", "customer_support"],
        "products": ["product_manager"],
        "default": ["admin"]
    }–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ Fallback:pythonCopyDownloaddef handle_access_error(self, error_info: dict) -> dict:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞"""
    details = error_info.get("details", {})
    tables = details.get("tables", [])
    user_roles = details.get("user_roles", [])
    required_roles = details.get("required_roles", {})
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º:\n"
    for table in tables:
        req_roles = required_roles.get(table, [])
        message += f"- –¢–∞–±–ª–∏—Ü–∞ '{table}': —Ç—Ä–µ–±—É–µ—Ç—Å—è {', '.join(req_roles)}\n"
    
    message += f"\n–í–∞—à–∏ —Ä–æ–ª–∏: {', '.join(user_roles)}"
    
    return {
        "action": "escalate",
        "message": message,
        "severity": "high",
        "notify_admin": True
    }–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:–£—Å–ø–µ—à–Ω—ã–π –¥–æ—Å—Ç—É–ø:pythonCopyDownload# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–æ–ª—è–º–∏ ['sales_manager', 'report_user']
# SQL: SELECT * FROM sales
has_access = True
details = {
    "tables": ["sales"],
    "user_roles": ["sales_manager", "report_user"],
    "required_roles": {"sales": ["sales_manager", "analyst"]}
}–û—Ç–∫–∞–∑–∞–Ω–æ –≤ –¥–æ—Å—Ç—É–ø–µ:pythonCopyDownload# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–æ–ª—è–º–∏ ['customer_support']
# SQL: SELECT * FROM products
has_access = False
details = {
    "tables": ["products"],
    "user_roles": ["customer_support"],
    "required_roles": {"products": ["product_manager"]},
    "errors": ["–î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ 'products' –∑–∞–ø—Ä–µ—â–µ–Ω"]
}–î–æ—Å—Ç—É–ø –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ç–∞–±–ª–∏—Ü–∞–º:pythonCopyDownload# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–æ–ª—è–º–∏ ['analyst']
# SQL: JOIN sales, customers
has_access = True
details = {
    "tables": ["sales", "customers"],
    "user_roles": ["analyst"],
    "required_roles": {
        "sales": ["sales_manager", "analyst"],
        "customers": ["sales_manager", "customer_support", "analyst"]
    }
}–ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ –∑–∞–ø—Ä–æ—Å–µ–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º:–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞–§–æ–ª–±—ç–∫-—Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–±–æ—è—Ö–ê—É–¥–∏—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø—Ä–∏–Ω—Ü–∏–ø—É –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–µ.

user: —Ç–µ–ø–µ—Ä—å db_exec

assistant: ÊÄùËÄÉÔºö–ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é db_executor, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å SQL-–∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.–£—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫.–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `functions/db_executor.py`pythonCopyDownloadimport sqlalchemy
from sqlalchemy import text, exc
from sqlalchemy.orm import sessionmaker
import pandas as pd
import logging
import time
import hashlib
import json
from typing import Tuple, Optional, Union
from config import Config
from services.monitoring import tracer
from services.cache_service import CacheService
import re
import numpy as np
import traceback

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞
logger = logging.getLogger(__name__)

class DBExecutor:
    def __init__(self):
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        self.engine = self.create_engine()
        self.Session = sessionmaker(bind=self.engine)
        self.cache = CacheService()
        self.max_retries = Config.DB_MAX_RETRIES
        self.query_timeout = Config.DB_QUERY_TIMEOUT
        self.max_rows = Config.DB_MAX_ROWS
        self.read_only = Config.DB_READ_ONLY
        self.allow_caching = Config.DB_ALLOW_CACHING
        self.statement_timeout = Config.DB_STATEMENT_TIMEOUT

    def create_engine(self):
        """–°–æ–∑–¥–∞–µ—Ç –¥–≤–∏–∂–æ–∫ SQLAlchemy —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"""
        pool_size = Config.DB_POOL_SIZE or 5
        max_overflow = Config.DB_MAX_OVERFLOW or 10
        pool_recycle = Config.DB_POOL_RECYCLE or 300  # 5 –º–∏–Ω—É—Ç
        
        return sqlalchemy.create_engine(
            Config.DB_URL,
            pool_size=pool_size,
            max_overflow=max_overflow,
            pool_recycle=pool_recycle,
            connect_args={
                "connect_timeout": Config.DB_CONNECT_TIMEOUT or 10
            }
        )

    def execute_query(self, sql: str) -> Tuple[bool, Union[pd.DataFrame, str], dict]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        
        :param sql: SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        :return: –ö–æ—Ä—Ç–µ–∂ (—É—Å–ø–µ—Ö, —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
        """
        metadata = {
            "sql": sql,
            "cache_key": "",
            "cache_hit": False,
            "execution_time": 0,
            "row_count": 0,
            "error": None
        }
        
        try:
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –∫–µ—à–∞
            cache_key = self.generate_cache_key(sql)
            metadata["cache_key"] = cache_key
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
            if self.allow_caching:
                cached_result = self.cache.get(cache_key)
                if cached_result:
                    logger.info(f"–ö–µ—à-–ø–æ–ø–∞–¥–∞–Ω–∏–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: {cache_key[:20]}...")
                    metadata["cache_hit"] = True
                    return True, pd.read_json(cached_result, orient='split'), metadata
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ read-only —Ä–µ–∂–∏–º
            if self.read_only and not self.is_read_only_query(sql):
                error_msg = "–ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ read-only —Ä–µ–∂–∏–º–µ"
                logger.warning(error_msg)
                metadata["error"] = error_msg
                return False, error_msg, metadata
            
            start_time = time.time()
            
            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–≤—Ç–æ—Ä–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            for attempt in range(self.max_retries):
                try:
                    with self.engine.connect().execution_options(
                        isolation_level="AUTOCOMMIT",
                        stream_results=True
                    ) as conn:
                        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞
                        if self.statement_timeout:
                            conn.execute(text(f"SET statement_timeout = {self.statement_timeout * 1000}"))
                        
                        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
                        result = conn.execute(
                            text(sql).execution_options(
                                timeout=self.query_timeout
                            )
                        )
                        
                        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç—Ä–æ–∫
                        rows = []
                        for i, row in enumerate(result):
                            if i >= self.max_rows:
                                logger.warning(f"–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ ({self.max_rows}), –æ–±—Ä–µ–∑–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
                                break
                            rows.append(dict(row))
                        
                        # –°–æ–∑–¥–∞–Ω–∏–µ DataFrame
                        if rows:
                            df = pd.DataFrame(rows)
                        else:
                            # –î–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                            df = pd.DataFrame(columns=[col.name for col in result.cursor.description])
                        
                        metadata["row_count"] = len(df)
                        metadata["execution_time"] = time.time() - start_time
                        
                        # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                        if self.allow_caching:
                            self.cache.set(
                                cache_key, 
                                df.to_json(orient='split'),
                                ex=Config.DB_CACHE_TTL
                            )
                        
                        return True, df, metadata
                
                except exc.OperationalError as e:
                    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
                    if "connection" in str(e).lower() and attempt < self.max_retries - 1:
                        wait_time = (attempt + 1) * 2
                        logger.warning(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ {attempt+1}): {str(e)}. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time} —Å–µ–∫.")
                        time.sleep(wait_time)
                        continue
                    raise
                
                except exc.StatementError as e:
                    # –û—à–∏–±–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
                    if "timeout" in str(e).lower() and attempt < self.max_retries - 1:
                        logger.warning(f"–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–ø—ã—Ç–∫–∞ {attempt+1}). –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 1 —Å–µ–∫.")
                        time.sleep(1)
                        continue
                    raise
        
        except Exception as e:
            error_msg = self.format_db_error(e)
            logger.error(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: {error_msg}")
            metadata["error"] = error_msg
            metadata["execution_time"] = time.time() - start_time
            return False, error_msg, metadata

    def generate_cache_key(self, sql: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∫–µ—à–∞ –¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–∞"""
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è SQL –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–∑–ª–∏—á–∏–π
        normalized_sql = re.sub(r'\s+', ' ', sql).strip().lower()
        normalized_sql = re.sub(r'[\'"](.*?)[\'"]', '?', normalized_sql)  # –£–¥–∞–ª—è–µ–º –ª–∏—Ç–µ—Ä–∞–ª—ã
        return f"sql:{hashlib.sha256(normalized_sql.encode()).hexdigest()}"

    def is_read_only_query(self, sql: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è"""
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º sqlparse –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        try:
            parsed = sqlparse.parse(sql)
            if not parsed:
                return False
                
            first_token = parsed[0].token_first()
            return first_token and first_token.ttype is sqlparse.tokens.DML and first_token.value.lower() == "select"
        except Exception:
            # –§–æ–ª–±—ç–∫: –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            return sql.strip().lower().startswith("select")

    def format_db_error(self, error: Exception) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –ë–î –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
        if isinstance(error, exc.ProgrammingError):
            return "–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ SQL"
        elif isinstance(error, exc.OperationalError):
            return "–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
        elif isinstance(error, exc.IntegrityError):
            return "–û—à–∏–±–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞—Ä—É—à–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏)"
        elif isinstance(error, exc.DataError):
            return "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)"
        elif "timeout" in str(error).lower():
            return "–¢–∞–π–º–∞—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞"
        elif "connection" in str(error).lower():
            return "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
        
        # –û–±—â–∞—è –æ—à–∏–±–∫–∞
        return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"

    def get_sample_data(self, table: str, limit: int = 5) -> Tuple[bool, Union[pd.DataFrame, str], dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã"""
        sql = f"SELECT * FROM {table} LIMIT {limit}"
        return self.execute_query(sql)

    def test_connection(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
        try:
            with self.engine.connect() as conn:
                conn.execute(text("SELECT 1"))
            return True
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: {str(e)}")
            return False

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    class TestConfig:
        DB_URL = "postgresql://user:pass@localhost/test_db"
        DB_MAX_RETRIES = 2
        DB_QUERY_TIMEOUT = 30
        DB_MAX_ROWS = 1000
        DB_READ_ONLY = True
        DB_ALLOW_CACHING = True
        DB_CACHE_TTL = 300  # 5 –º–∏–Ω—É—Ç
        DB_STATEMENT_TIMEOUT = 60  # 1 –º–∏–Ω—É—Ç–∞
        DB_POOL_SIZE = 5
        DB_CONNECT_TIMEOUT = 5
    
    Config = TestConfig()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    logging.basicConfig(level=logging.INFO)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
    executor = DBExecutor()
    
    # –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    print("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:", executor.test_connection())
    
    # 1. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    success, result, meta = executor.execute_query("SELECT 1 AS test_value")
    print("\n–ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å:")
    print("–£—Å–ø–µ—Ö:", success)
    if success:
        print("–†–µ–∑—É–ª—å—Ç–∞—Ç:", result)
    print("–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:", json.dumps(meta, indent=2))
    
    # 2. –ó–∞–ø—Ä–æ—Å —Å –æ—à–∏–±–∫–æ–π
    success, result, meta = executor.execute_query("SELECT * FROM non_existent_table")
    print("\n–ó–∞–ø—Ä–æ—Å —Å –æ—à–∏–±–∫–æ–π:")
    print("–£—Å–ø–µ—Ö:", success)
    print("–û—à–∏–±–∫–∞:", result)
    print("–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:", json.dumps(meta, indent=2))
    
    # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—Ä–∞–∑—Ü–∞ –¥–∞–Ω–Ω—ã—Ö
    success, sample, meta = executor.get_sample_data("users")
    print("\n–û–±—Ä–∞–∑–µ—Ü –¥–∞–Ω–Ω—ã—Ö:")
    if success:
        print(sample)
    else:
        print("–û—à–∏–±–∫–∞:", sample)
    
    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
    print("\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:")
    _, _, meta1 = executor.execute_query("SELECT NOW() AS current_time")
    time.sleep(1)
    _, _, meta2 = executor.execute_query("SELECT NOW() AS current_time")
    print("–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å (–∫–µ—à-–ø—Ä–æ–º–∞—Ö):", not meta1["cache_hit"])
    print("–í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–∫–µ—à-–ø–æ–ø–∞–¥–∞–Ω–∏–µ):", meta2["cache_hit"])–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î:–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–π–º–∞—É—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—èRead-only —Ä–µ–∂–∏–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—à–∏–±–∫–∞–º:–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–ó–∞—â–∏—Ç–∞ –æ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫–ü–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è SQL –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:–î–µ—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–µ—à–∞–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—Ä–∞–∑—Ü–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π:–í —É–∑–ª–µ –≥—Ä–∞—Ñ–∞ `db_executor_node`:pythonCopyDownloaddef db_executor_node(state: AgentState) -> AgentState:
    if not state.get("generated_sql") or state.get("error"):
        return state
    
    try:
        executor = DBExecutor()
        success, result, meta = executor.execute_query(state["generated_sql"])
        
        if success:
            return {
                **state,
                "query_result": result,
                "execution_metadata": meta
            }
        else:
            return {
                **state,
                "error": {
                    "type": "db_execution",
                    "message": result,
                    "details": meta
                }
            }
    
    except Exception as e:
        logger.error(f"DBExecutor error: {str(e)}")
        return {
            **state,
            "error": {
                "type": "db_execution",
                "message": str(e)
            }
        }–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `config.py`:pythonCopyDownloadclass Config:
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    DB_URL = os.getenv("DB_URL", "postgresql://user:pass@localhost/dbname")
    DB_MAX_RETRIES = int(os.getenv("DB_MAX_RETRIES", 3))
    DB_QUERY_TIMEOUT = int(os.getenv("DB_QUERY_TIMEOUT", 30))
    DB_MAX_ROWS = int(os.getenv("DB_MAX_ROWS", 10000))
    DB_READ_ONLY = os.getenv("DB_READ_ONLY", "true").lower() == "true"
    DB_ALLOW_CACHING = os.getenv("DB_ALLOW_CACHING", "true").lower() == "true"
    DB_CACHE_TTL = int(os.getenv("DB_CACHE_TTL", 3600))  # 1 —á–∞—Å
    DB_STATEMENT_TIMEOUT = int(os.getenv("DB_STATEMENT_TIMEOUT", 120))  # 2 –º–∏–Ω—É—Ç—ã
    DB_POOL_SIZE = int(os.getenv("DB_POOL_SIZE", 5))
    DB_CONNECT_TIMEOUT = int(os.getenv("DB_CONNECT_TIMEOUT", 10))–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:pythonCopyDownloadexecutor = DBExecutor()
success, result, meta = executor.execute_query(
    "SELECT id, name FROM users WHERE status = 'active'"
)

if success:
    print(f"–ü–æ–ª—É—á–µ–Ω–æ {len(result)} —Å—Ç—Ä–æ–∫")
    print(result.head())
else:
    print(f"–û—à–∏–±–∫–∞: {result}")–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—Ä–∞–∑—Ü–∞ –¥–∞–Ω–Ω—ã—Ö:pythonCopyDownloadsuccess, sample, meta = executor.get_sample_data("products", limit=3)
if success:
    print(sample)–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:pythonCopyDownloadif executor.test_connection():
    print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ")
else:
    print("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î")–ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏:–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫–¢–∞–π–º–∞—É—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:Read-only –¥–æ—Å—Ç—É–ø –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥–û—á–∏—Å—Ç–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–æ–≥–æ–≤–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º:–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î–ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤:–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤–≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏.

user: —Ç–µ–ø–µ—Ä—å –∞–≥–µ–Ω—Ç–∞ data_interpreteter