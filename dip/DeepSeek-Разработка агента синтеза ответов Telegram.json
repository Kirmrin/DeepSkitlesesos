[
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å response_synthesizer"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ResponseSynthesizer - –∞–≥–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram.–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:1. –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç –¥—Ä—É–≥–∏—Ö –∞–≥–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –æ–±—â–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ —Ç.–¥.)2. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ–π (Telegram)3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞: —Ç–µ–∫—Å—Ç, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–≥—Ä–∞—Ñ–∏–∫–∏), —Ç–∞–±–ª–∏—Ü—ã, –∫–Ω–æ–ø–∫–∏4. –£–ø—Ä–∞–≤–ª—è–µ—Ç –¥–ª–∏–Ω–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π (—Ä–∞–∑–±–∏–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã)5. –î–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏, –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è Telegram:- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è: 4096 —Å–∏–º–≤–æ–ª–æ–≤- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown (—Ä–∞–∑–º–µ—Ç–∫–∞)- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (base64 –∏–ª–∏ URL)- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (reply keyboard) –∏ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, DataStoryteller, GeneralAssistant, DocumentationAgent)- –ö–æ–Ω—Ç–µ–∫—Å—Ç (–∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:{\"type\": \"text\" | \"image\" | \"mixed\",\"content\": {\"text\": \"–æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç\",\"image\": \"base64 —Å—Ç—Ä–æ–∫–∞\" (–¥–ª—è —Ç–∏–ø–∞ image –∏–ª–∏ mixed)},\"buttons\": [{\"text\": \"–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏\", \"callback\": \"–∫–æ–º–∞–Ω–¥–∞\"}],\"suggestions\": [\"–≤–∞—Ä–∏–∞–Ω—Ç1\", \"–≤–∞—Ä–∏–∞–Ω—Ç2\"]  # –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤}–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `ResponseSynthesizer`–ê–≥–µ–Ω—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram. –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã, –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Telegram –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã.pythonCopyDownloadfrom langsmith import traceable\nimport logging\nimport config\nimport re\nfrom telegram import InlineKeyboardButton, InlineKeyboardMarkup\nfrom io import BytesIO\nimport base64\n\nclass ResponseSynthesizer:\n    def __init__(self):\n        self.logger = logging.getLogger(\"response_synthesizer\")\n        self.max_text_length = 4000  # –õ–∏–º–∏—Ç Telegram –¥–ª—è —Ç–µ–∫—Å—Ç–∞\n        self.max_caption_length = 1000  # –õ–∏–º–∏—Ç –ø–æ–¥–ø–∏—Å–µ–π –∫ –º–µ–¥–∏–∞\n\n    @traceable\n    def synthesize(self, agent_response: dict, user_context: dict) -> dict:\n        \"\"\"\n        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.\n        \n        :param agent_response: –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ (DataStoryteller, GeneralAssistant –∏ –¥—Ä.)\n        :param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—è–∑—ã–∫, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)\n        :return: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ {type, content, buttons}, –≥–æ—Ç–æ–≤–∞—è –¥–ª—è Telegram API\n        \"\"\"\n        try:\n            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞\n            response_type = agent_response.get(\"type\", \"text\")\n            \n            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫\n            if \"error\" in agent_response:\n                return self._format_error(agent_response)\n            \n            # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º –æ—Ç–≤–µ—Ç–∞\n            if response_type == \"text\":\n                return self._format_text(agent_response, user_context)\n            elif response_type == \"image\":\n                return self._format_image(agent_response, user_context)\n            elif response_type == \"mixed\":\n                return self._format_mixed(agent_response, user_context)\n            else:\n                return self._format_fallback(agent_response)\n\n        except Exception as e:\n            self.logger.error(f\"Response synthesis failed: {str(e)}\")\n            return {\n                \"type\": \"text\",\n                \"content\": \"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.\",\n                \"buttons\": []\n            }\n\n    def _format_text(self, response: dict, context: dict) -> dict:\n        \"\"\"–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç —Å —É—á–µ—Ç–æ–º –ª–∏–º–∏—Ç–æ–≤ Telegram\"\"\"\n        text = response[\"content\"]\n        \n        # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n        if len(text) > self.max_text_length:\n            text = text[:self.max_text_length - 100] + \"...\" \n        \n        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ç–∫—É\n        formatted_text = self._apply_telegram_formatting(text, context)\n        \n        return {\n            \"type\": \"text\",\n            \"content\": formatted_text,\n            \"buttons\": self._generate_buttons(response, context)\n        }\n\n    def _format_image(self, response: dict, context: dict) -> dict:\n        \"\"\"–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º\"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ base64 –¥–∞–Ω–Ω—ã—Ö\n        if not response[\"content\"][\"data\"].startswith(\"data:image/png;base64,\"):\n            image_data = f\"data:image/png;base64,{response['content']['data']}\"\n        else:\n            image_data = response[\"content\"][\"data\"]\n        \n        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏\n        caption = response.get(\"caption\", \"–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞\")\n        if len(caption) > self.max_caption_length:\n            caption = caption[:self.max_caption_length - 50] + \"...\"\n\n        formatted_caption = self._apply_telegram_formatting(caption, context)\n        \n        return {\n            \"type\": \"image\",\n            \"content\": {\n                \"image\": image_data,\n                \"caption\": formatted_caption\n            },\n            \"buttons\": self._generate_buttons(response, context)\n        }\n\n    def _format_mixed(self, response: dict, context: dict) -> dict:\n        \"\"\"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (—Ç–µ–∫—Å—Ç + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)\"\"\"\n        # Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç + —Ñ–æ—Ç–æ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏\n        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ 2 —Å–æ–æ–±—â–µ–Ω–∏—è: —Å–Ω–∞—á–∞–ª–∞ —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é, –∑–∞—Ç–µ–º —Ç–µ–∫—Å—Ç\n        image_part = {\n            \"type\": \"image\",\n            \"content\": response[\"content\"][\"image\"],\n            \"caption\": response.get(\"caption\", \"\")\n        }\n        \n        text_part = {\n            \"type\": \"text\",\n            \"content\": response[\"content\"][\"text\"]\n        }\n        \n        return {\n            \"type\": \"multi\",\n            \"content\": [\n                self._format_image(image_part, context),\n                self._format_text(text_part, context)\n            ]\n        }\n\n    def _generate_buttons(self, response: dict, context: dict) -> list:\n        \"\"\"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è Telegram\"\"\"\n        buttons = []\n        \n        # 1. –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞\n        for action in response.get(\"actions\", []):\n            buttons.append(\n                InlineKeyboardButton(\n                    action[\"title\"], \n                    callback_data=f\"action:{action['command']}\"\n                )\n            )\n        \n        # 2. –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã (suggestions)\n        if \"suggestions\" in response:\n            for suggestion in response[\"suggestions\"]:\n                buttons.append(\n                    InlineKeyboardButton(\n                        f\"üîç {suggestion}\", \n                        callback_data=f\"quick:{suggestion[:30]}\"\n                    )\n                )\n        \n        # 3. –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏\n        buttons.append(\n            InlineKeyboardButton(\"üìä –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å\", callback_data=\"new_query\")\n        )\n        \n        # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ 2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥\n        return [buttons[i:i+2] for i in range(0, len(buttons), 2)]\n\n    def _apply_telegram_formatting(self, text: str, context: dict) -> str:\n        \"\"\"–ü—Ä–∏–º–µ–Ω—è–µ—Ç Telegram-—Ä–∞–∑–º–µ—Ç–∫—É –∫ —Ç–µ–∫—Å—Ç—É\"\"\"\n        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n        formatted = re.sub(r'\\*\\*(.*?)\\*\\*', r'*\\1*', text)  # –ñ–∏—Ä–Ω—ã–π -> –ö—É—Ä—Å–∏–≤\n        formatted = re.sub(r'__(.*?)__', r'_\\1_', formatted)  # –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ\n        \n        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É\n        if \"analytics\" in context.get(\"response_type\", \"\"):\n            formatted = \"üìà \" + formatted\n        elif \"error\" in context:\n            formatted = \"‚ö†Ô∏è \" + formatted\n        \n        return formatted\n\n    def _format_error(self, response: dict) -> dict:\n        \"\"\"–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—à–∏–±–æ–∫\"\"\"\n        return {\n            \"type\": \"text\",\n            \"content\": f\"üö´ –û—à–∏–±–∫–∞: {response.get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}\\n\\n{response.get('details', '')}\",\n            \"buttons\": [\n                [InlineKeyboardButton(\"üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞\", callback_data=\"help\")]\n            ]\n        }\n\n    def _format_fallback(self, response: dict) -> dict:\n        \"\"\"–§–æ–ª–±—ç–∫ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤\"\"\"\n        return {\n            \"type\": \"text\",\n            \"content\": str(response)[:self.max_text_length],\n            \"buttons\": []\n        }–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ Telegram:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ç–∫–∏ (Markdown ‚Üí Telegram-—Ñ–æ—Ä–º–∞—Ç)–û–±—Ä–∞–±–æ—Ç–∫–∞ base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–º–µ—à–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:pythonCopyDownloaddef _generate_buttons(self, response: dict, context: dict) -> list:\n    # –°–æ–∑–¥–∞–µ—Ç 3 —Ç–∏–ø–∞ –∫–Ω–æ–ø–æ–∫:\n    # 1. –î–µ–π—Å—Ç–≤–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä \"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç\")\n    # 2. –ë—ã—Å—Ç—Ä—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (suggestions)\n    # 3. –°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (\"–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å\")–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ (üìà –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, ‚ö†Ô∏è –¥–ª—è –æ—à–∏–±–æ–∫)–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `user_context`–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö–ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:pythonCopyDownload# –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, DataStoryteller –≤–µ—Ä–Ω—É–ª:\nstoryteller_response = {\n    \"type\": \"mixed\",\n    \"content\": {\n        \"image\": {\"data\": \"iVBORw0KGgoAAAANSUhEUg...\"},  # base64\n        \"text\": \"**–í—ã–≤–æ–¥—ã**: –ü—Ä–æ–¥–∞–∂–∏ –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ 20%...\"\n    },\n    \"actions\": [\n        {\"title\": \"–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF\", \"command\": \"export_pdf\"}\n    ],\n    \"suggestions\": [\"–ó–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥\", \"–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º\"]\n}\n\n# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç\nsynthesizer = ResponseSynthesizer()\nformatted = synthesizer.synthesize(\n    agent_response=storyteller_response,\n    user_context={\"language\": \"ru\"}\n)\n\n# –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è Telegram API:\n# {\n#   \"type\": \"multi\",\n#   \"content\": [\n#       {  # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é\n#         \"type\": \"image\",\n#         \"content\": {\n#           \"image\": \"data:image/png;base64,iVBORw0KGgo...\",\n#           \"caption\": \"üìà *–í—ã–≤–æ–¥—ã*: –ü—Ä–æ–¥–∞–∂–∏ –≤—ã—Ä–æ—Å–ª–∏...\"\n#         },\n#         \"buttons\": [[...]]\n#       },\n#       {  # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ\n#         \"type\": \"text\",\n#         \"content\": \"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏...\",\n#         \"buttons\": [\n#           [  # –ö–Ω–æ–ø–∫–∏ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ\n#             InlineKeyboardButton(\"–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF\", ...),\n#             InlineKeyboardButton(\"üîç –ó–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥\", ...)\n#           ],\n#           [\n#             InlineKeyboardButton(\"üîç –ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º\", ...),\n#             InlineKeyboardButton(\"üìä –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å\", ...)\n#           ]\n#         ]\n#       }\n#   ]\n# }–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith:–î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@traceable` –Ω–∞–¥ –º–µ—Ç–æ–¥–æ–º `synthesize` –ª–æ–≥–∏—Ä—É–µ—Ç:–¢–∏–ø—ã –≤—Ö–æ–¥—è—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫, –æ–±—Ä–µ–∑–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞)–û—à–∏–±–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ 2 –≤ —Ä—è–¥–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π–£–º–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:–ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è —Ä–∞–∑–º–µ—Ç–∫–∏ –ø–æ–¥ Telegram–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —ç–º–æ–¥–∑–∏ (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Üí üìà, –æ—à–∏–±–∫–∞ ‚Üí ‚ö†Ô∏è)–ü–æ–¥–¥–µ—Ä–∂–∫–∞ multi-message:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏–≠—Ç–æ—Ç –∞–≥–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è —á—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–π –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç:–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ Telegram–°–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ª–∏–º–∏—Ç–∞–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã–°–æ—Ö—Ä–∞–Ω—è—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å"
  },
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å router_agent"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º `RouterAgent` - –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º.–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:1. –ü–æ–ª—É—á–∞–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç `QueryClassifierAgent`2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ü–µ–ª–µ–≤—ã—Ö —Å–∏—Å—Ç–µ–º (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç.–¥.)3. –û–±–æ–≥–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤4. –í—ã–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–≤–∫–ª—é—á–∞—è —Ñ–æ–ª–±—ç–∫–∏)5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≤—ã–∑–æ–≤–∞–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:```pythonfrom langsmith import traceableimport loggingimport configimport requestsimport timeclass RouterAgent:def __init__(self, query_classifier, fallback_agent):self.query_classifier = query_classifierself.fallback_agent = fallback_agentself.logger = logging.getLogger(\"router_agent\")self.system_status = {}self.last_checked = 0@traceabledef route(self, user_query: str, user_context: dict) -> dict:\"\"\"–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞.:param user_query: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç (–∏—Å—Ç–æ—Ä–∏—è, —Ä–æ–ª—å, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è):return: {\"handler\": \"agent_name\",\"params\": { ... },\"classification\": { ... },\"fallback_reason\": \"\"}\"\"\"try:# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)self._check_system_status()# –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞classification = self.query_classifier.classify_query(user_query, user_context)self.logger.info(f\"Classification: {classification}\")# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞handler = classification[\"handler\"]if not self._is_handler_available(handler):return self._handle_unavailable_handler(handler, user_query, user_context, classification)# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞handler_params = self._prepare_handler_params(handler, user_query, user_context, classification)return {\"handler\": handler,\"params\": handler_params,\"classification\": classification,\"fallback_reason\": None}except Exception as e:self.logger.error(f\"Routing failed: {str(e)}\")return self._fallback_routing(user_query, user_context, str(e))def _check_system_status(self):\"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥)\"\"\"current_time = time.time()if current_time - self.last_checked < 30:return  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Åself.last_checked = current_timeself.system_status = {}# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ãsystems = {\"analytics_pipeline\": config.ANALYTICS_API_URL + \"/health\",\"documentation_search\": config.DOCS_API_URL + \"/status\",\"general_assistant\": config.ASSISTANT_API_URL + \"/ping\"}for system, url in systems.items():try:response = requests.get(url, timeout=2)self.system_status[system] = response.status_code == 200except:self.system_status[system] = Falsedef _is_handler_available(self, handler: str) -> bool:\"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"# –í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (fallback, small_talk)if handler in [\"fallback_agent\", \"small_talk_agent\"]:return True# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ –∏–º–µ–Ω–∏ —Å–∏—Å—Ç–µ–º—ãreturn self.system_status.get(handler, False)def _prepare_handler_params(self, handler: str, query: str, context: dict, classification: dict) -> dict:\"\"\"–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã–∑–æ–≤–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"base_params = {\"query\": query,\"user_context\": context}# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏if handler == \"analytics_pipeline\":return {**base_params,\"detailed\": classification.get(\"subcategory\") == \"detailed_report\",\"timeout\": 30  # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ç–∞–π–º–∞—É—Ç}# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏if handler == \"documentation_search\":return {**base_params,\"version\": context.get(\"docs_version\", \"latest\")}return base_paramsdef _handle_unavailable_handler(self, handler: str, query: str, context: dict, classification: dict) -> dict:\"\"\"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"self.logger.warning(f\"Handler {handler} is unavailable. Using fallback.\")# –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫alternative = self._find_alternative_handler(classification)if alternative and alternative != handler and self._is_handler_available(alternative):return {\"handler\": alternative,\"params\": self._prepare_handler_params(alternative, query, context, classification),\"classification\": classification,\"fallback_reason\": f\"Primary handler {handler} unavailable\"}# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ–ª–±—ç–∫ –∞–≥–µ–Ω—Çreturn self._fallback_routing(query,context,f\"Both primary ({handler}) and alternative ({alternative}) handlers unavailable\")def _find_alternative_handler(self, classification: dict) -> str:\"\"\"–ù–∞—Ö–æ–¥–∏—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\"\"\"# –ú–∞–ø–ø–∏–Ω–≥ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤alternatives = {\"analytics_pipeline\": \"general_assistant\",\"documentation_search\": \"general_assistant\",\"general_assistant\": \"fallback_agent\"}return alternatives.get(classification[\"handler\"], \"fallback_agent\")def _fallback_routing(self, query: str, context: dict, reason: str) -> dict:\"\"\"–§–æ–ª–±—ç–∫-–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ FallbackAgent\"\"\"self.logger.error(f\"Fallback routing. Reason: {reason}\")return {\"handler\": \"fallback_agent\",\"params\": {\"query\": query,\"context\": context,\"error_details\": reason},\"fallback_reason\": reason}```### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º**:- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π health-check –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∏—Å—Ç–µ–º2. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**:```pythondef _find_alternative_handler(self, classification: dict) -> str:# –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º GeneralAssistantalternatives = {\"analytics_pipeline\": \"general_assistant\",\"documentation_search\": \"general_assistant\",\"general_assistant\": \"fallback_agent\"}```3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**:- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä `detailed` –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤–µ—Ä—Å–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FallbackAgent**:- –ü—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–±–æ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–æ–ª–±—ç–∫-–∞–≥–µ–Ω—Ç- –ü–µ—Ä–µ–¥–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:```python# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—èquery_classifier = QueryClassifierAgent()fallback_agent = FallbackAgent()router = RouterAgent(query_classifier, fallback_agent)# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞routing_result = router.route(\"–ü–æ–∫–∞–∂–∏ –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∑–∞ 2023 –≥–æ–¥\",user_context={\"role\": \"manager\"})print(routing_result)# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–µ:# {#   \"handler\": \"analytics_pipeline\",#   \"params\": {#       \"query\": \"–ü–æ–∫–∞–∂–∏ –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∑–∞ 2023 –≥–æ–¥\",#       \"user_context\": {\"role\": \"manager\"},#       \"detailed\": True,#       \"timeout\": 30#   },#   \"classification\": { ... },#   \"fallback_reason\": None# }# –ü—Ä–∏–º–µ—Ä –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:# {#   \"handler\": \"general_assistant\",#   \"params\": { ... },#   \"fallback_reason\": \"Primary handler analytics_pipeline unavailable\"# }```### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:- LangSmith —Ç—Ä–∞—Å—Å–∏—Ä—É–µ—Ç:- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤- –†–µ—à–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏- –ü—Ä–∏—á–∏–Ω—ã —Ñ–æ–ª–±—ç–∫–æ–≤- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (config.py):```python# Health-check URLsANALYTICS_API_URL = \"http://analytics-service:8000\"DOCS_API_URL = \"http://docs-service:8001\"ASSISTANT_API_URL = \"http://assistant-service:8002\"```–≠—Ç–æ—Ç –∞–≥–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–∞–∂–µ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–±–æ—è—Ö —Å–∏—Å—Ç–µ–º—ã.–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `RouterAgent`–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.pythonCopyDownloadfrom langsmith import traceable\nimport logging\nimport config\nimport requests\nimport time\nfrom typing import Dict, List, Optional\n\nclass RouterAgent:\n    def __init__(self, query_classifier, system_monitor):\n        self.query_classifier = query_classifier  # –≠–∫–∑–µ–º–ø–ª—è—Ä QueryClassifierAgent\n        self.system_monitor = system_monitor      # –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\n        self.logger = logging.getLogger(\"router_agent\")\n        self.routing_rules = self._load_routing_rules()\n        self.fallback_priority = [\"general_assistant\", \"fallback_agent\"]\n        self.last_health_check = 0\n        \n    @traceable\n    def route(self, user_query: str, user_context: Dict) -> Dict:\n        \"\"\"\n        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞.\n        \n        :param user_query: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        :param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç (–∏—Å—Ç–æ—Ä–∏—è, —Ä–æ–ª—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)\n        :return: { \n            \"handler\": \"agent_name\", \n            \"params\": { ... }, \n            \"confidence\": 0.0-1.0,\n            \"fallback_used\": bool \n        }\n        \"\"\"\n        try:\n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)\n            self._check_system_health()\n            \n            # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞\n            classification = self.query_classifier.classify_query(user_query, user_context)\n            \n            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\n            primary_handler = classification[\"handler\"]\n            \n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\n            if self._is_handler_available(primary_handler):\n                return {\n                    \"handler\": primary_handler,\n                    \"params\": self._prepare_handler_params(primary_handler, user_query, user_context, classification),\n                    \"confidence\": classification[\"confidence\"],\n                    \"fallback_used\": False\n                }\n                \n            # –ü–æ–∏—Å–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã\n            return self._find_fallback(primary_handler, user_query, user_context, classification)\n            \n        except Exception as e:\n            self.logger.error(f\"Routing failed: {str(e)}\")\n            return self._emergency_fallback(user_query, user_context)\n\n    def _check_system_health(self):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥)\"\"\"\n        current_time = time.time()\n        if current_time - self.last_health_check < 30:\n            return\n            \n        self.last_health_check = current_time\n        self.system_monitor.check_all_services()\n\n    def _is_handler_available(self, handler_name: str) -> bool:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"\n        # –í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏\n        if handler_name in [\"fallback_agent\", \"general_assistant\"]:\n            return True\n            \n        return self.system_monitor.is_service_up(handler_name)\n\n    def _prepare_handler_params(\n        self, \n        handler: str, \n        query: str, \n        context: Dict, \n        classification: Dict\n    ) -> Dict:\n        \"\"\"–§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"\n        base_params = {\n            \"query\": query,\n            \"user_context\": context,\n            \"classification\": classification\n        }\n        \n        # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤\n        if handler == \"analytics_pipeline\":\n            return {\n                **base_params,\n                \"timeout\": 30,\n                \"detailed\": \"–ø–æ–¥—Ä–æ–±–Ω\" in query.lower()\n            }\n            \n        if handler == \"documentation_search\":\n            return {\n                **base_params,\n                \"version\": context.get(\"doc_version\", \"latest\"),\n                \"source\": \"official\"\n            }\n            \n        return base_params\n\n    def _find_fallback(\n        self, \n        primary_handler: str, \n        query: str, \n        context: Dict, \n        classification: Dict\n    ) -> Dict:\n        \"\"\"–ü–æ–∏—Å–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"\n        # 1. –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏\n        if primary_handler in self.routing_rules:\n            for alternative in self.routing_rules[primary_handler]:\n                if self._is_handler_available(alternative):\n                    self.logger.warning(f\"Using alternative {alternative} for {primary_handler}\")\n                    return {\n                        \"handler\": alternative,\n                        \"params\": self._prepare_handler_params(alternative, query, context, classification),\n                        \"confidence\": max(0.1, classification[\"confidence\"] - 0.2),\n                        \"fallback_used\": True\n                    }\n        \n        # 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ñ–æ–ª–±—ç–∫\n        for handler in self.fallback_priority:\n            if self._is_handler_available(handler):\n                self.logger.warning(f\"Using priority fallback {handler}\")\n                return {\n                    \"handler\": handler,\n                    \"params\": {\"query\": query, \"user_context\": context},\n                    \"confidence\": 0.3,\n                    \"fallback_used\": True\n                }\n                \n        # 3. –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ñ–æ–ª–±—ç–∫\n        return self._emergency_fallback(query, context)\n\n    def _emergency_fallback(self, query: str, context: Dict) -> Dict:\n        \"\"\"–ê–≤–∞—Ä–∏–π–Ω—ã–π —Ñ–æ–ª–±—ç–∫, –∫–æ–≥–¥–∞ –≤—Å–µ —Å–∏—Å—Ç–µ–º—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã\"\"\"\n        self.logger.critical(\"All systems down! Using emergency fallback\")\n        return {\n            \"handler\": \"fallback_agent\",\n            \"params\": {\n                \"query\": query,\n                \"user_context\": context,\n                \"error_details\": \"complete_system_failure\"\n            },\n            \"confidence\": 0.1,\n            \"fallback_used\": True\n        }\n\n    def _load_routing_rules(self) -> Dict[str, List[str]]:\n        \"\"\"–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏\"\"\"\n        return {\n            \"analytics_pipeline\": [\"general_assistant\", \"documentation_search\"],\n            \"documentation_search\": [\"general_assistant\", \"analytics_pipeline\"],\n            \"small_talk_agent\": [\"general_assistant\"],\n            \"help_system\": [\"documentation_search\", \"general_assistant\"]\n        }\n\n    def add_dynamic_rule(self, source_handler: str, target_handler: str):\n        \"\"\"–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏\"\"\"\n        if source_handler not in self.routing_rules:\n            self.routing_rules[source_handler] = []\n            \n        if target_handler not in self.routing_rules[source_handler]:\n            self.routing_rules[source_handler].append(target_handler)\n            self.logger.info(f\"Added dynamic route: {source_handler} -> {target_handler}\")\n\n    def update_fallback_priority(self, new_priority: List[str]):\n        \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–æ–ª–±—ç–∫-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤\"\"\"\n        self.fallback_priority = new_priority\n        self.logger.info(f\"Fallback priority updated: {new_priority}\")–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:pythonCopyDownloaddef route(self, user_query: str, user_context: Dict) -> Dict:\n    # 1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞\n    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\n    # 3. –í—ã–±–æ—Ä –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ñ–æ–ª–±—ç–∫:–ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏: –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (`analytics_pipeline ‚Üí general_assistant`)–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ñ–æ–ª–±—ç–∫: –†–µ–∑–µ—Ä–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É–ê–≤–∞—Ä–∏–π–Ω—ã–π —Ñ–æ–ª–±—ç–∫: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–±–æ–µ–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:pythonCopyDownloaddef _check_system_health(self):\n    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\n    # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:pythonCopyDownloaddef _prepare_handler_params(...):\n    # –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:\n    # - –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n    # - –í–µ—Ä—Å–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n    # - –£—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:pythonCopyDownload# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è\nsystem_monitor = SystemMonitor()  # –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫–ª–∞—Å—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\nquery_classifier = QueryClassifierAgent()\nrouter = RouterAgent(query_classifier, system_monitor)\n\n# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞\nrouting_result = router.route(\n    \"–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–≤–∞—Ä—Ç–∞–ª\",\n    user_context={\"role\": \"manager\", \"doc_version\": \"v2.1\"}\n)\n\nprint(routing_result)\n# –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–µ:\n# {\n#   \"handler\": \"analytics_pipeline\",\n#   \"params\": {\n#       \"query\": \"–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–≤–∞—Ä—Ç–∞–ª\",\n#       \"user_context\": {...},\n#       \"classification\": {...},\n#       \"timeout\": 30,\n#       \"detailed\": False\n#   },\n#   \"confidence\": 0.95,\n#   \"fallback_used\": False\n# }\n\n# –ü—Ä–∏–º–µ—Ä –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:\n# {\n#   \"handler\": \"general_assistant\",\n#   \"params\": {...},\n#   \"confidence\": 0.75,\n#   \"fallback_used\": True\n# }–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª:pythonCopyDownload# config.py\nROUTING_RULES = {\n    \"analytics_pipeline\": [\"general_assistant\", \"documentation_search\"],\n    \"documentation_search\": [\"general_assistant\"],\n    \"small_talk_agent\": [\"general_assistant\"]\n}\n\nFALLBACK_PRIORITY = [\"general_assistant\", \"fallback_agent\"]–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è):pythonCopyDownloadclass SystemMonitor:\n    def __init__(self):\n        self.service_status = {}\n        \n    def check_service(self, service_name: str) -> bool:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ (–∑–∞–≥–ª—É—à–∫–∞)\"\"\"\n        # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: HTTP –∑–∞–ø—Ä–æ—Å –∫ /health-—ç–Ω–¥–ø–æ–∏–Ω—Ç—É\n        status = True  # –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã \"–¥–æ—Å—Ç—É–ø–Ω—ã\" –≤ –¥–µ–º–æ\n        self.service_status[service_name] = {\n            \"status\": status,\n            \"last_checked\": time.time()\n        }\n        return status\n        \n    def check_all_services(self):\n        \"\"\"–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\"\"\"\n        services = [\"analytics_pipeline\", \"documentation_search\", \"general_assistant\"]\n        for service in services:\n            self.check_service(service)\n            \n    def is_service_up(self, service_name: str) -> bool:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞\"\"\"\n        return self.service_status.get(service_name, {}).get(\"status\", False)–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è:pythonCopyDownloadrouter.add_dynamic_rule(\"analytics_pipeline\", \"fallback_agent\")\nrouter.update_fallback_priority([\"fallback_agent\", \"general_assistant\"])–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:–£—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–µ–Ω–µ–¥–∂–µ—Ä vs —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞–£—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:3 —É—Ä–æ–≤–Ω—è —Ñ–æ–ª–±—ç–∫–æ–≤–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ–µ–≤–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith:–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ —Ä–µ—à–µ–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω —Ñ–æ–ª–±—ç–∫–æ–≤–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞–≠—Ç–æ—Ç –∞–≥–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –∑–∞–¥–µ—Ä–∂–∫–∏ –∑–∞ —Å—á–µ—Ç:–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Ñ–æ–ª–±—ç–∫–æ–≤–†–µ–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã"
  },
  {
    "role": "user",
    "content": "–ê langchain/gigachain –Ω–∞–º —Ç—É—Ç –Ω–µ –Ω—É–∂–µ–Ω?"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏, –∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∞–≥–µ–Ω—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, DataInterpreter, DataStoryteller) –º—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ gigachain –¥–ª—è –≤—ã–∑–æ–≤–∞ LLM.–û–¥–Ω–∞–∫–æ, –≤ RouterAgent, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏, —è–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ LLM –Ω–µ—Ç. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:1. QueryClassifierAgent (–∫–æ—Ç–æ—Ä—ã–π –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, –Ω–æ —Å–∞–º RouterAgent –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç LLM –Ω–∞–ø—Ä—è–º—É—é)2. –°–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞–ü–æ—ç—Ç–æ–º—É –≤ RouterAgent –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å gigachain, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã.–û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –º—ã –∑–∞—Ö–æ—Ç–∏–º —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ \"–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é\" –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–µ –∑–∞–ø—Ä–æ—Å–∞ (–∞ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤),—Ç–æ —Ç–æ–≥–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ LLM. –ù–æ –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤ RouterAgent –º—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º gigachain (–∏–ª–∏ langchain) –Ω–∞–ø—Ä—è–º—É—é.–ù–æ –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –≤ –Ω–∞—à–µ–º RouterAgent –º—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ —É–∂–µ –≥–æ—Ç–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä QueryClassifierAgent, –∫–æ—Ç–æ—Ä—ã–π –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç gigachain.–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç gigachain –µ—Å—Ç—å, –Ω–æ –æ–Ω–∞ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ QueryClassifierAgent.–ò—Ç–æ–≥: –≤ –∫–æ–¥–µ RouterAgent, –∫–æ—Ç–æ—Ä—ã–π –º—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –≤—ã—à–µ, –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è gigachain, –ø–æ—ç—Ç–æ–º—É –µ–≥–æ –∏–º–ø–æ—Ä—Ç –Ω–µ –Ω—É–∂–µ–Ω –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ.–û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º –º—ã –∑–∞—Ö–æ—Ç–∏–º —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª RouterAgent, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–ª–æ–∂–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ–º LLM,—Ç–æ —Ç–æ–≥–¥–∞ –º—ã –±—É–¥–µ–º –¥–æ–±–∞–≤–ª—è—Ç—å gigachain –≤ RouterAgent. –ù–æ —ç—Ç–æ –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ç–µ–∫—É—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.–ü–æ—ç—Ç–æ–º—É –æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é RouterAgent –±–µ–∑ –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è gigachain.–û—Ç–ª–∏—á–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ! –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å LangChain/GigaChain –≤ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:–ê–Ω–∞–ª–∏–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ LLM —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤–ì–¥–µ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:Query Classifier: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ GigaChatData Interpreter: –°–ª–æ–∂–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å LLMGeneral Assistant: –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—è–∑—ã–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤Fallback Agent: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –æ—à–∏–±–æ–∫–ì–¥–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è:Router Agent: –ß–∏—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞Response Synthesizer: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤System Monitor: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è RouterAgent–î–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –¥–æ–±–∞–≤–∏–º GigaChain –¥–ª—è:–û–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç–∏–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø—Ä–∞–≤–∏–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:pythonCopyDownloadfrom langsmith import traceable\nfrom gigachain import GigaChatModel\nimport logging\nimport config\nimport time\n\nclass RouterAgent:\n    def __init__(self, query_classifier, system_monitor):\n        self.query_classifier = query_classifier\n        self.system_monitor = system_monitor\n        self.logger = logging.getLogger(\"router_agent\")\n        self.llm = GigaChatModel(  # –î–æ–±–∞–≤–ª—è–µ–º LLM\n            model=\"GigaChat-Pro\",\n            temperature=0.3,\n            api_key=config.GIGACHAT_API_KEY\n        )\n        self.routing_rules = self._load_routing_rules()\n        self.fallback_priority = [\"general_assistant\", \"fallback_agent\"]\n        \n    @traceable\n    def route(self, user_query: str, user_context: Dict, chat_history: List[Dict]) -> Dict:\n        \"\"\"–£–ª—É—á—à–µ–Ω–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å LLM-–∞–Ω–∞–ª–∏–∑–æ–º\"\"\"\n        try:\n            # –ë–∞–∑–æ–≤–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è\n            classification = self.query_classifier.classify_query(user_query, user_context)\n            \n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞\n            if classification[\"confidence\"] < 0.7 or user_context.get(\"complex_context\"):\n                classification = self._enhance_with_llm(user_query, classification, chat_history)\n            \n            # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...\n            \n        except Exception as e:\n            self.logger.error(f\"Routing failed: {str(e)}\")\n            return self._emergency_fallback(user_query, user_context)\n\n    def _enhance_with_llm(self, query: str, classification: Dict, history: List[Dict]) -> Dict:\n        \"\"\"–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é LLM\"\"\"\n        prompt = f\"\"\"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –£—Ç–æ—á–Ω–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é:\n        \n–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:\n- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {classification['category']}\n- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {classification['confidence']}\n- –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: {classification['subcategory']}\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞: {self._format_history(history[-3:])}\n- –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å: \"{query}\"\n\n–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π:\n1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞?\n2. –ö–∞–∫–∏–µ –Ω—é–∞–Ω—Å—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É?\n3. –ü—Ä–µ–¥–ª–æ–∂–∏ –ª—É—á—à–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (analytics_pipeline, documentation_search, general_assistant)\n\n–í–µ—Ä–Ω–∏ JSON: {{\n  \"final_category\": \"–∫–∞—Ç–µ–≥–æ—Ä–∏—è\",\n  \"final_handler\": \"–æ–±—Ä–∞–±–æ—Ç—á–∏–∫\",\n  \"confidence\": 0.0-1.0,\n  \"reason\": \"–∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ\"\n}}\n\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        enhanced = json.loads(response)\n        \n        self.logger.info(f\"Enhanced routing: {enhanced['reason']}\")\n        return {\n            **classification,\n            \"category\": enhanced[\"final_category\"],\n            \"handler\": enhanced[\"final_handler\"],\n            \"confidence\": enhanced[\"confidence\"]\n        }\n\n    def _format_history(self, history: List[Dict]) -> str:\n        \"\"\"–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞\"\"\"\n        return \"\\n\".join([\n            f\"{msg['role']}: {msg['content']}\" \n            for msg in history\n        ])\n    \n    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...–ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —Å LLM:–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–∑–∞–≤–∏—Å–∏–º–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:pythonCopyDownloaddef _enhance_with_llm(self, query, classification, history):\n    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:–ó–∞–ø—Ä–æ—Å—ã –≤—Ä–æ–¥–µ \"–ü–æ–∫–∞–∂–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –æ—Ç—á–µ—Ç–∞–º\" (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è vs –∞–Ω–∞–ª–∏—Ç–∏–∫–∞)–£—á–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø—Ä–∏ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏–£—á–µ—Ç —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)–ö–æ–≥–¥–∞ LangChain/GigaChain –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã:–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å–ü—Ä–∏—á–∏–Ω–∞QueryClassifier‚úÖ –û–±—è–∑–∞—Ç–µ–ª–µ–Ω–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è NLPDataInterpreter‚úÖ –û–±—è–∑–∞—Ç–µ–ª–µ–Ω–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ LLMRouterAgent‚ö†Ô∏è –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∫–µ–π—Å–æ–≤ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–ºResponseSynthesizer‚ùå –ù–µ –Ω—É–∂–µ–Ω–ß–∏—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µSystemMonitor‚ùå –ù–µ –Ω—É–∂–µ–Ω–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏–ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:–î–ª—è RouterAgent - –¥–æ–±–∞–≤–∏—Ç—å GigaChain –¥–ª—è:10-15% —Å–ª–æ–∂–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–∑–∞–≤–∏—Å–∏–º—ã—Ö —Ä–µ—à–µ–Ω–∏–π–ê–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ –Ω–æ–≤—ã–º —Ç–∏–ø–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤–î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LangSmith –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤ LLM–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –æ–±–µ—Å–ø–µ—á–∏—Ç –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É:–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º LLM –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–∏)–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å—é (LLM –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö/–Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤)–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å—é (—Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ LangSmith)"
  },
  {
    "role": "user",
    "content": "–ø—Ä–æ–ø–∏—à–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–¥"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π RouterAgent —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π GigaChain –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.–£—á—Ç–µ–º:1. –ë–∞–∑–æ–≤—É—é –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ QueryClassifier2. –£—Ç–æ—á–Ω–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é LLM –ø—Ä–∏ –Ω–∏–∑–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Å–ª–æ–∂–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤4. –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ñ–æ–ª–±—ç–∫–æ–≤–ü–æ–ª–Ω—ã–π –∫–æ–¥:–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `RouterAgent` —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π GigaChainpythonCopyDownloadfrom langsmith import traceable\nfrom gigachain import GigaChatModel\nimport json\nimport logging\nimport config\nimport time\nfrom typing import Dict, List, Optional\n\nclass RouterAgent:\n    def __init__(self, query_classifier, system_monitor):\n        self.query_classifier = query_classifier\n        self.system_monitor = system_monitor\n        self.logger = logging.getLogger(\"router_agent\")\n        \n        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GigaChain –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏\n        self.llm = GigaChatModel(\n            model=\"GigaChat-Pro\",\n            temperature=0.3,\n            api_key=config.GIGACHAT_API_KEY,\n            max_tokens=500\n        )\n        \n        self.routing_rules = self._load_routing_rules()\n        self.fallback_priority = [\"general_assistant\", \"fallback_agent\"]\n        self.last_health_check = 0\n        self.context_analysis_cache = {}\n        \n    @traceable\n    def route(self, user_query: str, user_context: Dict, chat_history: List[Dict] = None) -> Dict:\n        \"\"\"\n        –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n        \n        :param user_query: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        :param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–æ–ª—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)\n        :param chat_history: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ ([{\"role\": \"user/assistant\", \"content\": \"—Ç–µ–∫—Å—Ç\"}])\n        :return: {\n            \"handler\": \"agent_name\", \n            \"params\": {...}, \n            \"confidence\": 0.0-1.0,\n            \"fallback_used\": bool,\n            \"llm_enhanced\": bool\n        }\n        \"\"\"\n        try:\n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)\n            self._check_system_health()\n            \n            # –ë–∞–∑–æ–≤–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞\n            classification = self.query_classifier.classify_query(user_query, user_context)\n            llm_enhanced = False\n            \n            # –£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é LLM –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n            if self._needs_enhanced_routing(classification, user_context, chat_history):\n                classification = self._enhance_with_llm(\n                    user_query, \n                    classification, \n                    chat_history or [],\n                    user_context\n                )\n                llm_enhanced = True\n                self.logger.debug(\"Used LLM for enhanced routing\")\n            \n            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\n            primary_handler = classification[\"handler\"]\n            \n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\n            if self._is_handler_available(primary_handler):\n                return {\n                    \"handler\": primary_handler,\n                    \"params\": self._prepare_handler_params(\n                        primary_handler, \n                        user_query, \n                        user_context,\n                        chat_history,\n                        classification\n                    ),\n                    \"confidence\": classification[\"confidence\"],\n                    \"fallback_used\": False,\n                    \"llm_enhanced\": llm_enhanced\n                }\n                \n            # –ü–æ–∏—Å–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã\n            return self._find_fallback(\n                primary_handler, \n                user_query, \n                user_context,\n                chat_history,\n                classification,\n                llm_enhanced\n            )\n            \n        except Exception as e:\n            self.logger.error(f\"Routing failed: {str(e)}\")\n            return self._emergency_fallback(user_query, user_context, chat_history)\n\n    def _needs_enhanced_routing(\n        self, \n        classification: Dict, \n        context: Dict, \n        history: List[Dict]\n    ) -> bool:\n        \"\"\"–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ —É–≥–ª—É–±–ª–µ–Ω–Ω—ã–π LLM-–∞–Ω–∞–ª–∏–∑\"\"\"\n        # –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:\n        # 1. –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏\n        if classification[\"confidence\"] < 0.7:\n            return True\n            \n        # 2. –°–ª–æ–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–¥–ª–∏–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞)\n        if history and len(history) > 3:\n            return True\n            \n        # 3. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ\n        if context.get(\"require_llm_routing\", False):\n            return True\n            \n        # 4. –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n        ambiguous_categories = [\"other\", \"explanation\", \"mixed\"]\n        if classification[\"category\"] in ambiguous_categories:\n            return True\n            \n        return False\n\n    def _enhance_with_llm(\n        self, \n        query: str, \n        classification: Dict, \n        history: List[Dict],\n        context: Dict\n    ) -> Dict:\n        \"\"\"–£—Ç–æ—á–Ω—è–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é —Å –ø–æ–º–æ—â—å—é LLM\"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞\n        cache_key = f\"{query[:50]}-{context.get('user_id', '')}\"\n        if cache_key in self.context_analysis_cache:\n            return self.context_analysis_cache[cache_key]\n        \n        prompt = f\"\"\"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ. \n        \n### –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n{query}\n\n### –ö–æ–Ω—Ç–µ–∫—Å—Ç:\n- –†–æ–ª—å: {context.get('role', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n- –¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞: {context.get('current_task', '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')}\n- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Ä–µ–ø–ª–∏–∫–∏):\n{self._format_history(history[-3:])}\n\n### –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:\n- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {classification['category']}\n- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {classification['confidence']}\n- –û–±—Ä–∞–±–æ—Ç—á–∏–∫: {classification['handler']}\n\n### –ê–Ω–∞–ª–∏–∑:\n1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞?\n2. –ö–∞–∫–∏–µ –Ω—é–∞–Ω—Å—ã –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É?\n3. –ü—Ä–µ–¥–ª–æ–∂–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (analytics_pipeline, documentation_search, general_assistant, small_talk_agent, help_system)\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:\n- –í–µ—Ä–Ω–∏ JSON —Ñ–æ—Ä–º–∞—Ç–∞ {{\"final_category\": \"...\", \"final_handler\": \"...\", \"confidence\": 0.0-1.0, \"reason\": \"...\"}}\n- –ë—É–¥—å –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º –≤ –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏\n- –£—á–∏—Ç—ã–≤–∞–π —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è\n\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        \n        try:\n            enhanced = json.loads(response)\n            # –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞\n            if \"final_handler\" not in enhanced or \"confidence\" not in enhanced:\n                raise ValueError(\"Invalid LLM response format\")\n                \n            result = {\n                **classification,\n                \"category\": enhanced.get(\"final_category\", classification[\"category\"]),\n                \"handler\": enhanced[\"final_handler\"],\n                \"confidence\": min(1.0, max(0.1, float(enhanced[\"confidence\"])))\n            }\n            \n            # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\n            self.context_analysis_cache[cache_key] = result\n            return result\n            \n        except (json.JSONDecodeError, ValueError) as e:\n            self.logger.warning(f\"LLM enhancement failed: {str(e)}. Using original classification\")\n            return classification\n\n    def _format_history(self, history: List[Dict]) -> str:\n        \"\"\"–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞\"\"\"\n        if not history:\n            return \"–ò—Å—Ç–æ—Ä–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç\"\n            \n        return \"\\n\".join([\n            f\"{msg['role'].capitalize()}: {msg['content']}\" \n            for msg in history\n        ])\n\n    def _check_system_health(self):\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º\"\"\"\n        current_time = time.time()\n        if current_time - self.last_health_check < 30:  # –ö–µ—à –Ω–∞ 30 —Å–µ–∫—É–Ω–¥\n            return\n            \n        self.last_health_check = current_time\n        self.system_monitor.check_all_services()\n\n    def _is_handler_available(self, handler_name: str) -> bool:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"\n        # –í—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏\n        if handler_name in [\"fallback_agent\", \"general_assistant\"]:\n            return True\n            \n        return self.system_monitor.is_service_up(handler_name)\n\n    def _prepare_handler_params(\n        self, \n        handler: str, \n        query: str, \n        context: Dict,\n        history: List[Dict],\n        classification: Dict\n    ) -> Dict:\n        \"\"\"–§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"\n        base_params = {\n            \"query\": query,\n            \"user_context\": context,\n            \"chat_history\": history,\n            \"classification\": classification\n        }\n        \n        # –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã\n        if handler == \"analytics_pipeline\":\n            return {\n                **base_params,\n                \"timeout\": 30,\n                \"detailed\": \"–ø–æ–¥—Ä–æ–±–Ω\" in query.lower(),\n                \"priority\": \"high\" if context.get(\"role\") == \"manager\" else \"normal\"\n            }\n            \n        if handler == \"documentation_search\":\n            return {\n                **base_params,\n                \"version\": context.get(\"doc_version\", \"latest\"),\n                \"sources\": [\"knowledge_base\", \"api_docs\"]\n            }\n            \n        if handler == \"general_assistant\":\n            return {\n                **base_params,\n                \"require_full_explanation\": classification[\"category\"] == \"explanation\"\n            }\n            \n        return base_params\n\n    def _find_fallback(\n        self, \n        primary_handler: str, \n        query: str, \n        context: Dict,\n        history: List[Dict],\n        classification: Dict,\n        llm_enhanced: bool\n    ) -> Dict:\n        \"\"\"–ü–æ–∏—Å–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞\"\"\"\n        # 1. –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏\n        if primary_handler in self.routing_rules:\n            for alternative in self.routing_rules[primary_handler]:\n                if self._is_handler_available(alternative):\n                    self.logger.warning(f\"Using alternative {alternative} for {primary_handler}\")\n                    return {\n                        \"handler\": alternative,\n                        \"params\": self._prepare_handler_params(\n                            alternative, \n                            query, \n                            context,\n                            history,\n                            classification\n                        ),\n                        \"confidence\": max(0.1, classification[\"confidence\"] - 0.2),\n                        \"fallback_used\": True,\n                        \"llm_enhanced\": llm_enhanced\n                    }\n        \n        # 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ñ–æ–ª–±—ç–∫\n        for handler in self.fallback_priority:\n            if self._is_handler_available(handler):\n                self.logger.warning(f\"Using priority fallback {handler}\")\n                return {\n                    \"handler\": handler,\n                    \"params\": {\n                        \"query\": query,\n                        \"user_context\": context,\n                        \"chat_history\": history\n                    },\n                    \"confidence\": 0.3,\n                    \"fallback_used\": True,\n                    \"llm_enhanced\": llm_enhanced\n                }\n                \n        # 3. –ê–≤–∞—Ä–∏–π–Ω—ã–π —Ñ–æ–ª–±—ç–∫\n        return self._emergency_fallback(query, context, history)\n\n    def _emergency_fallback(self, query: str, context: Dict, history: List[Dict]) -> Dict:\n        \"\"\"–ê–≤–∞—Ä–∏–π–Ω—ã–π —Ñ–æ–ª–±—ç–∫ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–±–æ–µ —Å–∏—Å—Ç–µ–º—ã\"\"\"\n        self.logger.critical(\"All systems down! Using emergency fallback\")\n        return {\n            \"handler\": \"fallback_agent\",\n            \"params\": {\n                \"query\": query,\n                \"user_context\": context,\n                \"chat_history\": history,\n                \"error_details\": \"complete_system_failure\"\n            },\n            \"confidence\": 0.1,\n            \"fallback_used\": True,\n            \"llm_enhanced\": False\n        }\n\n    def _load_routing_rules(self) -> Dict[str, List[str]]:\n        \"\"\"–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\"\"\"\n        return config.ROUTING_RULES\n\n    def add_dynamic_rule(self, source_handler: str, target_handler: str):\n        \"\"\"–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏\"\"\"\n        if source_handler not in self.routing_rules:\n            self.routing_rules[source_handler] = []\n            \n        if target_handler not in self.routing_rules[source_handler]:\n            self.routing_rules[source_handler].append(target_handler)\n            self.logger.info(f\"Added dynamic route: {source_handler} -> {target_handler}\")\n\n    def update_fallback_priority(self, new_priority: List[str]):\n        \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–æ–ª–±—ç–∫-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤\"\"\"\n        self.fallback_priority = new_priority\n        self.logger.info(f\"Fallback priority updated: {new_priority}\")\n\n    def clear_cache(self):\n        \"\"\"–û—á–∏—â–∞–µ—Ç –∫–µ—à –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞\"\"\"\n        self.context_analysis_cache = {}\n        self.logger.info(\"Router context cache cleared\")–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π (`config.py`)pythonCopyDownload# config.py\n\n# GigaChat API\nGIGACHAT_API_KEY = \"–≤–∞—à_api_–∫–ª—é—á\"\n\n# –ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏\nROUTING_RULES = {\n    \"analytics_pipeline\": [\"general_assistant\", \"documentation_search\"],\n    \"documentation_search\": [\"general_assistant\", \"analytics_pipeline\"],\n    \"small_talk_agent\": [\"general_assistant\"],\n    \"help_system\": [\"documentation_search\", \"general_assistant\"]\n}\n\n# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–æ–ª–±—ç–∫–æ–≤\nFALLBACK_PRIORITY = [\"general_assistant\", \"fallback_agent\"]\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è\nROUTER_CACHE_TTL = 3600  # 1 —á–∞—Å–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `SystemMonitor` (–¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã)pythonCopyDownload# system_monitor.py\nimport requests\nimport time\n\nclass SystemMonitor:\n    def __init__(self):\n        self.service_status = {}\n        self.endpoints = config.SERVICE_ENDPOINTS\n        \n    def check_service(self, service_name: str) -> bool:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ health-—á–µ–∫\"\"\"\n        endpoint = self.endpoints.get(service_name)\n        if not endpoint:\n            return False\n            \n        try:\n            response = requests.get(\n                f\"{endpoint}/health\", \n                timeout=2,\n                headers={\"Authorization\": f\"Bearer {config.INTERNAL_API_KEY}\"}\n            )\n            status = response.status_code == 200\n        except:\n            status = False\n            \n        self.service_status[service_name] = {\n            \"status\": status,\n            \"last_checked\": time.time()\n        }\n        return status\n        \n    def check_all_services(self):\n        \"\"\"–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤\"\"\"\n        for service in self.endpoints.keys():\n            self.check_service(service)\n            \n    def is_service_up(self, service_name: str) -> bool:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞\"\"\"\n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—É—Å–∞\n        status_info = self.service_status.get(service_name, {})\n        last_checked = status_info.get(\"last_checked\", 0)\n        \n        # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞—Ä–µ–ª, –æ–±–Ω–æ–≤–ª—è–µ–º\n        if time.time() - last_checked > 60:\n            return self.check_service(service_name)\n            \n        return status_info.get(\"status\", False)–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—èpythonCopyDownload# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\nfrom query_classifier import QueryClassifierAgent\nfrom system_monitor import SystemMonitor\n\nquery_classifier = QueryClassifierAgent()\nsystem_monitor = SystemMonitor()\nrouter = RouterAgent(query_classifier, system_monitor)\n\n# –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nuser_context = {\n    \"user_id\": \"user_123\",\n    \"role\": \"analyst\",\n    \"doc_version\": \"v2.3\",\n    \"current_task\": \"–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂\"\n}\n\n# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞\nchat_history = [\n    {\"role\": \"user\", \"content\": \"–ù—É–∂–Ω—ã –æ—Ç—á–µ—Ç—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º\"},\n    {\"role\": \"assistant\", \"content\": \"–ó–∞ –∫–∞–∫–æ–π –ø–µ—Ä–∏–æ–¥?\"},\n    {\"role\": \"user\", \"content\": \"–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–≤–∞—Ä—Ç–∞–ª\"}\n]\n\n# –°–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å\nquery = \"–ü–æ–∫–∞–∂–∏ –¥–∏–Ω–∞–º–∏–∫—É –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –Ω–∞ —Ñ–æ–Ω–µ –ø—Ä–æ—à–ª–æ–≥–æ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π\"\n\n# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è\nresult = router.route(query, user_context, chat_history)\n\nprint(f\"–û–±—Ä–∞–±–æ—Ç—á–∏–∫: {result['handler']}\")\nprint(f\"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {result['confidence']:.2f}\")\nprint(f\"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω LLM: {result['llm_enhanced']}\")\nprint(f\"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {json.dumps(result['params'], indent=2, ensure_ascii=False)}\")–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å GigaChain:–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞–£—á–µ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—è—Ö–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:pythonCopyDownloaddef _needs_enhanced_routing(...):\n    # –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ (<0.7)\n    # –î–ª–∏–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (>3 —Å–æ–æ–±—â–µ–Ω–∏–π)\n    # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ\n    # –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (other/explanation/mixed)–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–º–µ–Ω–µ–¥–∂–µ—Ä—ã ‚Üí high priority)–í–µ—Ä—Å–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–¢–∞–π–º–∞—É—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ñ–æ–ª–±—ç–∫:–ü—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (analytics_pipeline ‚Üí general_assistant)–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π —Ñ–æ–ª–±—ç–∫ –ø–æ —Å–ø–∏—Å–∫—É–ê–≤–∞—Ä–∏–π–Ω—ã–π —Ñ–æ–ª–±—ç–∫ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–±–æ–µ–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ health-—á–µ–∫–∏–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –æ—Å–≤–µ–¥–æ–º–ª–µ–Ω–Ω–æ—Å—Ç—å:–£—á–∏—Ç—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞–ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–ü–æ–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:3 —É—Ä–æ–≤–Ω—è —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö–ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ LLM-–∞–Ω–∞–ª–∏–∑–æ–≤–ü–∞–∫–µ—Ç–Ω—ã–µ health-—á–µ–∫–∏–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –Ω–∞ –ª–µ—Ç—É–°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö–≠—Ç–æ—Ç RouterAgent –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã —Å–∏—Å—Ç–µ–º—ã –∏ –∞–¥–∞–ø—Ç–∏—Ä—É—è—Å—å –∫ —Å–ª–æ–∂–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏—è–º."
  },
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å schema_master"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º `SchemaMaster` - –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤. –û–Ω –±—É–¥–µ—Ç:1. –•—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ö–µ–º—É –ë–î2. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ NL-–∑–∞–ø—Ä–æ—Å–æ–≤3. –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã4. –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ –¥–∏–∞–ª–µ–∫—Ç—ã SQL–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `SchemaMaster`–ê–≥–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å LLM –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-—è–∑—ã–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL-–∫–æ–º–∞–Ω–¥—ã.pythonCopyDownloadfrom langsmith import traceable\nfrom gigachain import GigaChatModel\nimport logging\nimport config\nimport re\nimport json\nfrom typing import Dict, List, Optional, Tuple\n\nclass SchemaMaster:\n    def __init__(self, db_schema: Dict):\n        self.logger = logging.getLogger(\"schema_master\")\n        self.llm = GigaChatModel(\n            model=\"GigaChat-Pro\",\n            temperature=0.1,  # –ú–∏–Ω–∏–º—É–º —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏\n            api_key=config.GIGACHAT_API_KEY,\n            max_tokens=500\n        )\n        self.schema_version = \"1.2\"\n        self.schema = self._validate_schema(db_schema)\n        self.schema_cache = {}\n        self.query_cache = {}\n        \n    def _validate_schema(self, schema: Dict) -> Dict:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Å—Ö–µ–º—É –ë–î\"\"\"\n        required_keys = [\"tables\", \"relationships\", \"metadata\"]\n        if not all(key in schema for key in required_keys):\n            raise ValueError(\"Invalid schema format\")\n            \n        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Ç–∞–±–ª–∏—Ü/–∫–æ–ª–æ–Ω–æ–∫\n        for table in schema[\"tables\"]:\n            table[\"name\"] = table[\"name\"].lower()\n            for column in table[\"columns\"]:\n                column[\"name\"] = column[\"name\"].lower()\n                \n        return schema\n\n    @traceable\n    def generate_sql(self, nl_query: str, user_context: Dict) -> Dict:\n        \"\"\"\n        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å –∏–∑ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-—è–∑—ã–∫–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è\n        \n        :param nl_query: –ó–∞–ø—Ä–æ—Å –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ (\"–ü–æ–∫–∞–∂–∏ —Ç–æ–ø-10 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º\")\n        :param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–æ–ª—å, –¥–æ—Å—Ç—É–ø)\n        :return: {\n            \"sql\": \"SELECT ...\", \n            \"validated\": bool,\n            \"explanation\": str,\n            \"optimized\": bool,\n            \"security_checked\": bool\n        }\n        \"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞\n        cache_key = f\"{nl_query[:50]}-{user_context.get('role','')}\"\n        if cache_key in self.query_cache:\n            self.logger.debug(\"Using cached SQL query\")\n            return self.query_cache[cache_key]\n        \n        try:\n            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL —á–µ—Ä–µ–∑ LLM\n            raw_sql = self._generate_with_llm(nl_query, user_context)\n            \n            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è\n            result = self._validate_and_optimize(raw_sql, user_context)\n            \n            # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ\n            self.query_cache[cache_key] = result\n            return result\n            \n        except Exception as e:\n            self.logger.error(f\"SQL generation failed: {str(e)}\")\n            return {\n                \"sql\": \"\",\n                \"validated\": False,\n                \"explanation\": f\"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}\",\n                \"optimized\": False,\n                \"security_checked\": False\n            }\n\n    def _generate_with_llm(self, nl_query: str, context: Dict) -> str:\n        \"\"\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL —á–µ—Ä–µ–∑ LLM —Å —É—á–µ—Ç–æ–º —Å—Ö–µ–º—ã\"\"\"\n        schema_context = self._get_relevant_schema(nl_query)\n        \n        prompt = f\"\"\"–¢—ã senior SQL —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π PostgreSQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã.\n\n### –°—Ö–µ–º–∞ –ë–î (–≤–µ—Ä—Å–∏—è {self.schema_version}):\n{schema_context}\n\n### –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n- –†–æ–ª—å: {context.get('role', 'analyst')}\n- –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: {', '.join(context.get('allowed_tables', list(self.schema['tables'].keys())))}\n\n### –ó–∞–ø—Ä–æ—Å:\n{nl_query}\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n1. –¢–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã\n2. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SQL (–±–µ–∑ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π)\n3. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ (table.column)\n4. –ù–∏–∫–∞–∫–∏—Ö DML/DDL –æ–ø–µ—Ä–∞—Ü–∏–π\n5. –£—á–∏—Ç—ã–≤–∞–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–æ–ª–µ–π\n\n### –û—Ç–≤–µ—Ç:\n{{\"sql\": \"SQL_QUERY\", \"explanation\": \"–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ\"}}\n\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        result = json.loads(response)\n        return result[\"sql\"]\n\n    def _get_relevant_schema(self, nl_query: str) -> str:\n        \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞—Å—Ç–∏ —Å—Ö–µ–º—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π\n        entities = self._extract_entities(nl_query)\n        \n        # –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Å—É—â–Ω–æ—Å—Ç–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã\n        if entities:\n            return self._describe_related_tables(entities)\n        \n        # –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—é —Å—Ö–µ–º—É (—Å–∂–∞—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç)\n        return self._get_full_schema_summary()\n\n    def _extract_entities(self, text: str) -> List[str]:\n        \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        prompt = f\"\"\"–ò–∑–≤–ª–µ–∫–∏ –∫–ª—é—á–µ–≤—ã–µ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞:\n        \n–ó–∞–ø—Ä–æ—Å: \"{text}\"\n\n–í—ã–≤–µ–¥–∏ JSON-—Å–ø–∏—Å–æ–∫: [\"—Å—É—â–Ω–æ—Å—Ç—å1\", \"—Å—É—â–Ω–æ—Å—Ç—å2\"]\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        return json.loads(response)\n\n    def _describe_related_tables(self, entities: List[str]) -> str:\n        \"\"\"–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏\"\"\"\n        schema_description = []\n        \n        for entity in entities:\n            entity_lower = entity.lower()\n            # –ü–æ–∏—Å–∫ —Ç–∞–±–ª–∏—Ü –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é\n            for table in self.schema[\"tables\"]:\n                if (entity_lower in table[\"name\"] or \n                    entity_lower in table.get(\"description\", \"\").lower()):\n                    \n                    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã\n                    desc = f\"–¢–∞–±–ª–∏—Ü–∞: {table['name']}\\n\"\n                    desc += f\"–û–ø–∏—Å–∞–Ω–∏–µ: {table.get('description', '–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}\\n\"\n                    desc += \"–ö–æ–ª–æ–Ω–∫–∏:\\n\"\n                    \n                    for col in table[\"columns\"]:\n                        desc += f\"- {col['name']}: {col['type']}\"\n                        if \"description\" in col:\n                            desc += f\" ({col['description']})\"\n                        desc += \"\\n\"\n                    \n                    schema_description.append(desc)\n        \n        return \"\\n\\n\".join(schema_description) or self._get_full_schema_summary()\n\n    def _get_full_schema_summary(self) -> str:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∂–∞—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ–π —Å—Ö–µ–º—ã\"\"\"\n        if \"full_summary\" in self.schema_cache:\n            return self.schema_cache[\"full_summary\"]\n            \n        summary = f\"–ë–∞–∑–∞: {self.schema['metadata']['db_name']}\\n\"\n        summary += f\"–¢–∞–±–ª–∏—Ü—ã ({len(self.schema['tables'])}):\\n\"\n        \n        for table in self.schema[\"tables\"]:\n            summary += f\"- {table['name']}: {table.get('description', '')} \"\n            summary += f\"({len(table['columns'])} –∫–æ–ª–æ–Ω–æ–∫)\\n\"\n        \n        self.schema_cache[\"full_summary\"] = summary\n        return summary\n\n    def _validate_and_optimize(self, sql: str, context: Dict) -> Dict:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n        security_check = self._security_validation(sql, context)\n        if not security_check[\"valid\"]:\n            return {\n                \"sql\": sql,\n                \"validated\": False,\n                \"explanation\": security_check[\"reason\"],\n                \"optimized\": False,\n                \"security_checked\": False\n            }\n        \n        # 2. –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞\n        syntax_check = self._syntax_validation(sql)\n        if not syntax_check[\"valid\"]:\n            return {\n                \"sql\": sql,\n                \"validated\": False,\n                \"explanation\": syntax_check[\"reason\"],\n                \"optimized\": False,\n                \"security_checked\": True\n            }\n        \n        # 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è\n        optimized_sql, optimization_report = self._optimize_query(sql)\n        \n        return {\n            \"sql\": optimized_sql,\n            \"validated\": True,\n            \"explanation\": optimization_report,\n            \"optimized\": True,\n            \"security_checked\": True\n        }\n\n    def _security_validation(self, sql: str, context: Dict) -> Dict:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\"\"\"\n        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n        forbidden_patterns = [\n            r\"\\b(INSERT|UPDATE|DELETE|DROP|TRUNCATE|GRANT|ALTER)\\b\",\n            r\";\\s*--\",\n            r\"\\b(1=1|TRUE)\\b\"\n        ]\n        \n        for pattern in forbidden_patterns:\n            if re.search(pattern, sql, re.IGNORECASE):\n                return {\n                    \"valid\": False,\n                    \"reason\": f\"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: {pattern}\"\n                }\n        \n        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü\n        allowed_tables = context.get(\"allowed_tables\", [])\n        if allowed_tables:\n            table_pattern = r\"\\b(FROM|JOIN)\\s+(\\w+)\"\n            used_tables = set()\n            \n            for match in re.finditer(table_pattern, sql, re.IGNORECASE):\n                table_name = match.group(2).lower()\n                if table_name not in allowed_tables:\n                    return {\n                        \"valid\": False,\n                        \"reason\": f\"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ: {table_name}\"\n                    }\n                used_tables.add(table_name)\n        \n        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫\n        sensitive_columns = [\"password\", \"token\", \"credit_card\"]\n        for col in sensitive_columns:\n            if re.search(rf\"\\b{col}\\b\", sql, re.IGNORECASE):\n                return {\n                    \"valid\": False,\n                    \"reason\": f\"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ: {col}\"\n                }\n        \n        return {\"valid\": True, \"reason\": \"–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞\"}\n\n    def _syntax_validation(self, sql: str) -> Dict:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —á–µ—Ä–µ–∑ LLM\"\"\"\n        prompt = f\"\"\"–ü—Ä–æ–≤–µ—Ä—å SQL –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (PostgreSQL):\n\n–ó–∞–ø—Ä–æ—Å:\n{sql}\n\n–ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - –∏—Å–ø—Ä–∞–≤—å –∏—Ö –∏ –æ–±—ä—è—Å–Ω–∏. –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n{{\n  \"valid\": true/false,\n  \"corrected_sql\": \"–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô_SQL\",\n  \"errors\": [\"–æ—à–∏–±–∫–∞1\", \"–æ—à–∏–±–∫–∞2\"]\n}}\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        result = json.loads(response)\n        \n        if result[\"valid\"]:\n            return {\"valid\": True, \"reason\": \"–°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω\"}\n            \n        return {\n            \"valid\": False,\n            \"reason\": f\"–û—à–∏–±–∫–∏: {', '.join(result['errors'])}. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {result['corrected_sql']}\"\n        }\n\n    def _optimize_query(self, sql: str) -> Tuple[str, str]:\n        \"\"\"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        prompt = f\"\"\"–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –ë–î (PostgreSQL):\n\n–ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å:\n{sql}\n\n–£—á—Ç–∏:\n- –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏\n- –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π\n- –°–æ—Ö—Ä–∞–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å\n\n–û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n{{\n  \"optimized_sql\": \"–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô_SQL\",\n  \"optimizations\": [\"—Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π\"]\n}}\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        result = json.loads(response)\n        \n        return result[\"optimized_sql\"], \"; \".join(result[\"optimizations\"])\n\n    def get_table_description(self, table_name: str) -> Optional[Dict]:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∏–º–µ–Ω–∏\"\"\"\n        table_name = table_name.lower()\n        for table in self.schema[\"tables\"]:\n            if table[\"name\"] == table_name:\n                return table\n        return None\n\n    def get_column_info(self, table_name: str, column_name: str) -> Optional[Dict]:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–æ–Ω–∫–µ\"\"\"\n        table = self.get_table_description(table_name)\n        if not table:\n            return None\n            \n        column_name = column_name.lower()\n        for col in table[\"columns\"]:\n            if col[\"name\"] == column_name:\n                return col\n        return None\n\n    def explain_schema_changes(self, old_schema: Dict, new_schema: Dict) -> str:\n        \"\"\"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã\"\"\"\n        prompt = f\"\"\"–°—Ä–∞–≤–Ω–∏ –¥–≤–µ –≤–µ—Ä—Å–∏–∏ —Å—Ö–µ–º—ã –ë–î –∏ –æ–±—ä—è—Å–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:\n\n### –°—Ç–∞—Ä–∞—è —Å—Ö–µ–º–∞ (v{old_schema.get('version', '1.0')}):\n{json.dumps(old_schema, indent=2)}\n\n### –ù–æ–≤–∞—è —Å—Ö–µ–º–∞ (v{new_schema.get('version', '2.0')}):\n{json.dumps(new_schema, indent=2)}\n\n–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç:\n- –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã/–∫–æ–ª–æ–Ω–∫–∏\n- –£–¥–∞–ª–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã\n- –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n- –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã\"\"\"\n        \n        return self.llm.generate(prompt)\n\n    def clear_cache(self):\n        \"\"\"–û—á–∏—â–∞–µ—Ç –∫–µ—à–∏\"\"\"\n        self.schema_cache = {}\n        self.query_cache = {}\n        self.logger.info(\"SchemaMaster caches cleared\")–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.py`)pythonCopyDownload# config.py\n\n# GigaChat API\nGIGACHAT_API_KEY = \"–≤–∞—à_api_–∫–ª—é—á\"\n\n# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è\nSCHEMA_CACHE_TTL = 3600  # 1 —á–∞—Å\nQUERY_CACHE_SIZE = 1000\n\n# –ü–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\nFORBIDDEN_SQL_PATTERNS = [\n    r\"\\b(INSERT|UPDATE|DELETE|DROP|TRUNCATE|GRANT|ALTER)\\b\",\n    r\";\\s*--\",\n    r\"\\b(1=1|TRUE)\\b\"\n]\nSENSITIVE_COLUMNS = [\"password\", \"token\", \"credit_card\", \"ssn\"]–ü—Ä–∏–º–µ—Ä —Å—Ö–µ–º—ã –ë–îpythonCopyDownload# –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ö–µ–º—ã\nSALES_DB_SCHEMA = {\n    \"metadata\": {\n        \"db_name\": \"SalesAnalytics\",\n        \"version\": \"1.2\",\n        \"description\": \"–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∏ –∫–ª–∏–µ–Ω—Ç–æ–≤\"\n    },\n    \"tables\": [\n        {\n            \"name\": \"customers\",\n            \"description\": \"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö\",\n            \"columns\": [\n                {\"name\": \"id\", \"type\": \"integer\", \"description\": \"–£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞\"},\n                {\"name\": \"name\", \"type\": \"varchar(255)\", \"description\": \"–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞\"},\n                {\"name\": \"signup_date\", \"type\": \"date\", \"description\": \"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\"}\n            ]\n        },\n        {\n            \"name\": \"sales\",\n            \"description\": \"–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂\",\n            \"columns\": [\n                {\"name\": \"id\", \"type\": \"integer\", \"description\": \"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\"},\n                {\"name\": \"customer_id\", \"type\": \"integer\", \"description\": \"ID –∫–ª–∏–µ–Ω—Ç–∞\"},\n                {\"name\": \"amount\", \"type\": \"numeric(10,2)\", \"description\": \"–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏\"},\n                {\"name\": \"date\", \"type\": \"date\", \"description\": \"–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏\"}\n            ]\n        }\n    ],\n    \"relationships\": [\n        {\n            \"table1\": \"sales\",\n            \"table2\": \"customers\",\n            \"columns\": [\"customer_id\", \"id\"],\n            \"type\": \"many-to-one\"\n        }\n    ]\n}–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—èpythonCopyDownload# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è\nschema_master = SchemaMaster(SALES_DB_SCHEMA)\n\n# –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\nuser_context = {\n    \"role\": \"analyst\",\n    \"allowed_tables\": [\"customers\", \"sales\"]\n}\n\n# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL\nresult = schema_master.generate_sql(\n    \"–ü–æ–∫–∞–∂–∏ —Ç–æ–ø-5 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Å—É–º–º–µ –ø—Ä–æ–¥–∞–∂ –∑–∞ 2023 –≥–æ–¥\",\n    user_context\n)\n\nprint(f\"SQL: {result['sql']}\")\nprint(f\"–û–±—ä—è—Å–Ω–µ–Ω–∏–µ: {result['explanation']}\")\nprint(f\"–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: {result['security_checked']}\")–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞sqlCopyDownloadSQL: SELECT c.name, SUM(s.amount) AS total_sales \nFROM customers c\nJOIN sales s ON c.id = s.customer_id \nWHERE s.date >= '2023-01-01' AND s.date <= '2023-12-31'\nGROUP BY c.name \nORDER BY total_sales DESC \nLIMIT 5–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL:pythonCopyDownloaddef generate_sql(self, nl_query: str, user_context: Dict) -> Dict:\n    # 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π —Å—Ö–µ–º—ã\n    # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ LLM\n    # 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–∑–∞–≤–∏—Å–∏–º–∞—è —Å—Ö–µ–º–∞:pythonCopyDownloaddef _get_relevant_schema(self, nl_query: str) -> str:\n    # –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º —Ç–∞–±–ª–∏—Ü—ã\n    # –ò–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∂–∞—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ–π –ë–î–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–∞–º–ó–∞—â–∏—Ç–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:pythonCopyDownloaddef _optimize_query(self, sql: str) -> Tuple[str, str]:\n    # –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM\n    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤\n    # –£–ø—Ä–æ—â–µ–Ω–∏–µ JOIN'–æ–≤–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü/–∫–æ–ª–æ–Ω–æ–∫–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ãDiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-0{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-0 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-0 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-0 .error-icon{fill:#a44141;}#mermaid-svg-0 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-0 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-0 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-0 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-0 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-0 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-0 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-0 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-0 .marker.cross{stroke:lightgrey;}#mermaid-svg-0 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-0 p{margin:0;}#mermaid-svg-0 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-0 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-0 .cluster-label span{color:#F9FFFE;}#mermaid-svg-0 .cluster-label span p{background-color:transparent;}#mermaid-svg-0 .label text,#mermaid-svg-0 span{fill:#ccc;color:#ccc;}#mermaid-svg-0 .node rect,#mermaid-svg-0 .node circle,#mermaid-svg-0 .node ellipse,#mermaid-svg-0 .node polygon,#mermaid-svg-0 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-0 .rough-node .label text,#mermaid-svg-0 .node .label text,#mermaid-svg-0 .image-shape .label,#mermaid-svg-0 .icon-shape .label{text-anchor:middle;}#mermaid-svg-0 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-0 .rough-node .label,#mermaid-svg-0 .node .label,#mermaid-svg-0 .image-shape .label,#mermaid-svg-0 .icon-shape .label{text-align:center;}#mermaid-svg-0 .node.clickable{cursor:pointer;}#mermaid-svg-0 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-0 .arrowheadPath{fill:lightgrey;}#mermaid-svg-0 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-0 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-0 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-0 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-0 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-0 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-0 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-0 .cluster text{fill:#F9FFFE;}#mermaid-svg-0 .cluster span{color:#F9FFFE;}#mermaid-svg-0 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-0 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-0 rect.text{fill:none;stroke-width:0;}#mermaid-svg-0 .icon-shape,#mermaid-svg-0 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-0 .icon-shape p,#mermaid-svg-0 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-0 .icon-shape rect,#mermaid-svg-0 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-0 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}–î–∞–ù–µ—ÇNL-–∑–∞–ø—Ä–æ—Å–ö–µ—à –∑–∞–ø—Ä–æ—Å–æ–≤?–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –∫–µ—à–∞–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π —Å—Ö–µ–º—ã–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL —á–µ—Ä–µ–∑ LLM–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–í–æ–∑–≤—Ä–∞—Ç SQL–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å—Ö–µ–º–∞:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:–ü–∞—Ç—Ç–µ—Ä–Ω-–º–∞—á–∏–Ω–≥ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π–†–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º–ó–∞—â–∏—Ç–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:–ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM:–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –∏–∑ NL–í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º–æ–π:–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫–≠—Ç–æ—Ç –∞–≥–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-—è–∑—ã–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL-–∫–æ–º–∞–Ω–¥—ã, –∞–¥–∞–ø—Ç–∏—Ä—É—è—Å—å –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º —Å—Ö–µ–º—ã –ë–î –∏ —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
  },
  {
    "role": "user",
    "content": "small_talk_agent —Ç–µ–ø–µ—Ä—å"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º SmallTalkAgent - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API (–ø–æ–≥–æ–¥–∞, –Ω–æ–≤–æ—Å—Ç–∏)- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–∑–∞–≤–∏—Å–∏–º—ã–µ –æ—Ç–≤–µ—Ç—ã- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –Ω–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö–†–µ–∞–ª–∏–∑—É–µ–º –∫–ª–∞—Å—Å —Å –º–µ—Ç–æ–¥–∞–º–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ small talk.–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `SmallTalkAgent`–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ API –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.pythonCopyDownloadfrom langsmith import traceable\nfrom gigachain import GigaChatModel\nimport requests\nimport logging\nimport config\nimport random\nimport datetime\nimport json\nfrom typing import Dict, List, Optional\n\nclass SmallTalkAgent:\n    def __init__(self):\n        self.logger = logging.getLogger(\"small_talk_agent\")\n        self.llm = GigaChatModel(\n            model=\"GigaChat-Plus\",\n            temperature=0.7,\n            api_key=config.GIGACHAT_API_KEY,\n            max_tokens=300\n        )\n        self.personality = {\n            \"name\": \"–ê–ª–µ–∫—Å\",\n            \"mood\": \"–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π\",\n            \"interests\": [\"—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", \"–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö\", \"–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç\"],\n            \"response_style\": \"–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Å —é–º–æ—Ä–æ–º\"\n        }\n        self.user_profiles = {}\n        self.response_cache = {}\n        \n    @traceable\n    def respond(self, user_query: str, user_context: Dict) -> Dict:\n        \"\"\"\n        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç\n        :param user_query: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        :param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–º—è, –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è)\n        :return: –û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ {\"response\": —Ç–µ–∫—Å—Ç, \"suggestions\": [–≤–∞—Ä–∏–∞–Ω—Ç—ã], \"mood\": –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ}\n        \"\"\"\n        try:\n            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            self._update_user_profile(user_context)\n            \n            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ small talk\n            talk_type = self._classify_talk_type(user_query)\n            \n            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞\n            if talk_type == \"greeting\":\n                return self._handle_greeting(user_query, user_context)\n            elif talk_type == \"mood\":\n                return self._handle_mood(user_query, user_context)\n            elif talk_type == \"weather\":\n                return self._handle_weather(user_query, user_context)\n            elif talk_type == \"news\":\n                return self._handle_news(user_query, user_context)\n            elif talk_type == \"personal\":\n                return self._handle_personal(user_query, user_context)\n            elif talk_type == \"about_ai\":\n                return self._handle_ai_questions(user_query, user_context)\n            else:\n                return self._handle_general(user_query, user_context)\n                \n        except Exception as e:\n            self.logger.error(f\"Small talk error: {str(e)}\")\n            return self._fallback_response(user_query)\n\n    def _update_user_profile(self, context: Dict):\n        \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–∞–º—è—Ç–∏\"\"\"\n        user_id = context.get(\"user_id\")\n        if not user_id:\n            return\n            \n        if user_id not in self.user_profiles:\n            self.user_profiles[user_id] = {\n                \"name\": context.get(\"name\", \"–¥—Ä—É–≥\"),\n                \"interaction_count\": 0,\n                \"preferred_topics\": [],\n                \"last_interaction\": datetime.datetime.now().isoformat()\n            }\n        \n        self.user_profiles[user_id][\"interaction_count\"] += 1\n        self.user_profiles[user_id][\"last_interaction\"] = datetime.datetime.now().isoformat()\n\n    def _classify_talk_type(self, query: str) -> str:\n        \"\"\"–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Ç–∏–ø —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        query_lower = query.lower()\n        \n        greeting_words = [\"–ø—Ä–∏–≤–µ—Ç\", \"–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π\", \"–¥–æ–±—Ä—ã–π\", \"—Ö–∞–π\", \"–∑–¥–æ—Ä–æ–≤–æ\"]\n        mood_words = [\"–∫–∞–∫ –¥–µ–ª–∞\", \"–∫–∞–∫ –∂–∏–∑–Ω—å\", \"–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ\", \"—á—É–≤—Å—Ç–≤—É–µ—à—å\"]\n        weather_words = [\"–ø–æ–≥–æ–¥–∞\", \"–¥–æ–∂–¥—å\", \"—Å–Ω–µ–≥\", \"—Å–æ–ª–Ω—Ü–µ\", \"—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞\"]\n        news_words = [\"–Ω–æ–≤–æ—Å—Ç–∏\", \"—Å–æ–±—ã—Ç–∏—è\", \"–ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è\", \"–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\"]\n        personal_words = [\"—Ç—ã\", \"—Ç–≤–æ–µ –∏–º—è\", \"—Ç–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã\", \"–∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª\"]\n        ai_words = [\"–∏–∏\", \"–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç\", \"–Ω–µ–π—Ä–æ—Å–µ—Ç—å\", \"—á–∞—Ç–±–æ—Ç\"]\n        \n        if any(word in query_lower for word in greeting_words):\n            return \"greeting\"\n        if any(word in query_lower for word in mood_words):\n            return \"mood\"\n        if any(word in query_lower for word in weather_words):\n            return \"weather\"\n        if any(word in query_lower for word in news_words):\n            return \"news\"\n        if any(word in query_lower for word in personal_words):\n            return \"personal\"\n        if any(word in query_lower for word in ai_words):\n            return \"about_ai\"\n            \n        return \"general\"\n\n    def _handle_greeting(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π\"\"\"\n        user_id = context.get(\"user_id\")\n        user_name = self.user_profiles.get(user_id, {}).get(\"name\", \"–¥—Ä—É–≥\")\n        \n        greetings = [\n            f\"–ü—Ä–∏–≤–µ—Ç, {user_name}! –†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å!\",\n            f\"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, {user_name}! –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?\",\n            f\"–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! {self._get_time_based_greeting()}\",\n            f\"–•–∞–π, {user_name}! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?\"\n        ]\n        \n        return {\n            \"response\": random.choice(greetings),\n            \"suggestions\": [\"–ö–∞–∫ –ø–æ–≥–æ–¥–∞?\", \"–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?\", \"–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ\"],\n            \"mood\": \"positive\"\n        }\n\n    def _get_time_based_greeting(self) -> str:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫\"\"\"\n        hour = datetime.datetime.now().hour\n        if 5 <= hour < 12:\n            return \"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!\"\n        elif 12 <= hour < 17:\n            return \"–î–æ–±—Ä—ã–π –¥–µ–Ω—å!\"\n        elif 17 <= hour < 23:\n            return \"–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!\"\n        else:\n            return \"–î–æ–±—Ä–æ–π –Ω–æ—á–∏! –¢—ã –ø–æ–∑–¥–Ω–æ –∑–∞—Å–∏–¥–µ–ª—Å—è!\"\n\n    def _handle_mood(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏\"\"\"\n        moods = [\n            \"–û—Ç–ª–∏—á–Ω–æ! –ì–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ –Ω–µ —Ç–æ–ª—å–∫–æ.\",\n            \"–ö–∞–∫ —É —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞ - –ø—Ä–æ—Å—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ!\",\n            \"–õ—É—á—à–µ –Ω–µ –±—ã–≤–∞–µ—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ –æ–±—â–∞—é—Å—å —Å —Ç–æ–±–æ–π!\",\n            \"–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —Å–ø–∞—Å–∏–±–æ, —á—Ç–æ —Å–ø—Ä–æ—Å–∏–ª!\"\n        ]\n        \n        # –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é\n        follow_ups = [\n            \"–ê —É —Ç–µ–±—è –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ?\",\n            \"–ö–∞–∫ —Å–∞–º —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—à—å?\",\n            \"–ù–∞–¥–µ—é—Å—å, —É —Ç–µ–±—è —Ç–æ–∂–µ –≤—Å—ë —Ö–æ—Ä–æ—à–æ!\"\n        ]\n        \n        response = f\"{random.choice(moods)} {random.choice(follow_ups)}\"\n        \n        return {\n            \"response\": response,\n            \"suggestions\": [\"–û—Ç–ª–∏—á–Ω–æ!\", \"–ù–æ—Ä–º–∞–ª—å–Ω–æ\", \"–ù–µ –æ—á–µ–Ω—å\"],\n            \"mood\": \"positive\"\n        }\n\n    def _handle_weather(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –ø–æ–≥–æ–¥–µ\"\"\"\n        # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ú–æ—Å–∫–≤—ã\n        location = self._extract_location(query) or \"–ú–æ—Å–∫–≤–∞\"\n        weather = self._get_weather(location)\n        \n        if weather:\n            response = (f\"–°–µ–π—á–∞—Å –≤ {location}: {weather['description']}, \"\n                       f\"—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {weather['temp']}¬∞C. \"\n                       f\"–í–ª–∞–∂–Ω–æ—Å—Ç—å: {weather['humidity']}%.\")\n        else:\n            response = \"–ò–∑–≤–∏–Ω–∏, –Ω–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ. –ü–æ–ø—Ä–æ–±—É–π –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ø–æ–≥–æ–¥–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏!\"\n        \n        return {\n            \"response\": response,\n            \"suggestions\": [\"–í –º–æ—ë–º –≥–æ—Ä–æ–¥–µ\", \"–ù–∞ –∑–∞–≤—Ç—Ä–∞\", \"–ù–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ\"],\n            \"mood\": \"neutral\"\n        }\n\n    def _extract_location(self, query: str) -> Optional[str]:\n        \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ª–æ–∫–∞—Ü–∏—é –∏–∑ –∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        prompt = f\"\"\"–ò–∑–≤–ª–µ–∫–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞:\n        \n–ó–∞–ø—Ä–æ—Å: \"{query}\"\n\n–ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω - –≤–µ—Ä–Ω–∏ null. –û—Ç–≤–µ—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ: {{\"city\": \"–Ω–∞–∑–≤–∞–Ω–∏–µ\"}}\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        data = json.loads(response)\n        return data.get(\"city\")\n\n    def _get_weather(self, city: str) -> Optional[Dict]:\n        \"\"\"–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É —á–µ—Ä–µ–∑ API (–∑–∞–≥–ª—É—à–∫–∞)\"\"\"\n        try:\n            # –†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenWeatherMap\n            response = requests.get(\n                f\"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={config.WEATHER_API_KEY}&units=metric&lang=ru\"\n            )\n            data = response.json()\n            return {\n                \"temp\": data[\"main\"][\"temp\"],\n                \"description\": data[\"weather\"][0][\"description\"],\n                \"humidity\": data[\"main\"][\"humidity\"]\n            }\n        except:\n            # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ\n            weather_data = {\n                \"–ú–æ—Å–∫–≤–∞\": {\"temp\": 18, \"description\": \"–ª–µ–≥–∫–∏–π –¥–æ–∂–¥—å\", \"humidity\": 75},\n                \"–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥\": {\"temp\": 15, \"description\": \"–æ–±–ª–∞—á–Ω–æ\", \"humidity\": 80},\n                \"–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫\": {\"temp\": 22, \"description\": \"—è—Å–Ω–æ\", \"humidity\": 45}\n            }\n            return weather_data.get(city, {\"temp\": 20, \"description\": \"—è—Å–Ω–æ\", \"humidity\": 60})\n\n    def _handle_news(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ –Ω–æ–≤–æ—Å—Ç—è—Ö\"\"\"\n        news = self._get_news()\n        return {\n            \"response\": f\"–í–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏:\\n\\n{news}\",\n            \"suggestions\": [\"–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", \"–ë–∏–∑–Ω–µ—Å\", \"–ù–∞—É–∫–∞\"],\n            \"mood\": \"informative\"\n        }\n\n    def _get_news(self) -> str:\n        \"\"\"–ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ (–∑–∞–≥–ª—É—à–∫–∞)\"\"\"\n        try:\n            # –†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å newsapi\n            response = requests.get(\n                f\"https://newsapi.org/v2/top-headlines?country=ru&apiKey={config.NEWS_API_KEY}\"\n            )\n            articles = response.json().get(\"articles\", [])[:3]\n            return \"\\n\".join([f\"- {art['title']}\" for art in articles])\n        except:\n            # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ\n            return \"1. –ò–ò –Ω–∞—É—á–∏–ª—Å—è –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–≥–æ–¥—É —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é 95%\\n2. –ö–æ–º–ø–∞–Ω–∏—è –¢–µ—Ö–Ω–æ–ö–æ—Ä–ø –∑–∞–ø—É—Å—Ç–∏–ª–∞ –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –º–æ–¥—É–ª—å\\n3. –£—á—ë–Ω—ã–µ —Å–æ–∑–¥–∞–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π\"\n\n    def _handle_personal(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û—Ç–≤–µ—Ç—ã –Ω–∞ –ª–∏—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –±–æ—Ç–µ\"\"\"\n        user_id = context.get(\"user_id\")\n        user_name = self.user_profiles.get(user_id, {}).get(\"name\", \"–¥—Ä—É–≥\")\n        \n        if \"–∏–º—è\" in query.lower():\n            response = f\"–ú–µ–Ω—è –∑–æ–≤—É—Ç {self.personality['name']}! –ê —Ç–µ–±—è?\"\n        elif \"–∏–Ω—Ç–µ—Ä–µ—Å\" in query.lower():\n            interests = \", \".join(self.personality['interests'][:-1]) + \" –∏ \" + self.personality['interests'][-1]\n            response = f\"–Ø —É–≤–ª–µ–∫–∞—é—Å—å {interests}. –ê —á—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ç–µ–±–µ, {user_name}?\"\n        elif \"—Å–æ–∑–¥–∞–ª\" in query.lower():\n            response = \"–ú–µ–Ω—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∞ –∫–æ–º–∞–Ω–¥–∞ –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏ –¢–µ—Ö–Ω–æ–ö–æ—Ä–ø. –Ø —Å–æ–∑–¥–∞–Ω, —á—Ç–æ–±—ã –ø–æ–º–æ–≥–∞—Ç—å —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã!\"\n        else:\n            response = \"–Ø —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ß–µ–º –º–æ–≥—É —Ç–µ–±–µ –ø–æ–º–æ—á—å?\"\n        \n        return {\n            \"response\": response,\n            \"suggestions\": [\"–†–∞—Å—Å–∫–∞–∂–∏ –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö\", \"–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?\", \"–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π\"],\n            \"mood\": \"friendly\"\n        }\n\n    def _handle_ai_questions(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –ò–ò\"\"\"\n        prompt = f\"\"\"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ò–ò. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º:\n        \n–í–æ–ø—Ä–æ—Å: \"{query}\"\n\n–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:\n- –ü–æ–Ω—è—Ç–Ω—ã–º –¥–ª—è –Ω–µ—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞\n- –ù–µ –¥–ª–∏–Ω–Ω–µ–µ 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π\n- –° –ø—Ä–∏–º–µ—Ä–∞–º–∏, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ\n\"\"\"\n        response = self.llm.generate(prompt)\n        return {\n            \"response\": response,\n            \"suggestions\": [\"–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?\", \"–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\", \"–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ò–ò\"],\n            \"mood\": \"educational\"\n        }\n\n    def _handle_general(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\"\"\"\n        user_id = context.get(\"user_id\")\n        user_name = self.user_profiles.get(user_id, {}).get(\"name\", \"–¥—Ä—É–≥\")\n        \n        prompt = f\"\"\"–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—Ç—å –Ω–∞ —Ä–µ–ø–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n        \n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ({user_name}): \"{query}\"\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n- –¢–≤–æ—ë –∏–º—è: {self.personality['name']}\n- –¢–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã: {\", \".join(self.personality['interests']}\n- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {self.personality['response_style']}\n\n–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:\n- –ö–æ—Ä–æ—Ç–∫–∏–º (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–º\n- –° —ç–ª–µ–º–µ–Ω—Ç–æ–º –ª—ë–≥–∫–æ–≥–æ —é–º–æ—Ä–∞ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)\n\"\"\"\n        response = self.llm.generate(prompt)\n        return {\n            \"response\": response,\n            \"suggestions\": [\"–†–∞—Å—Å–∫–∞–∂–∏ —à—É—Ç–∫—É\", \"–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?\", \"–ü–æ–º–æ–≥–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π\"],\n            \"mood\": \"friendly\"\n        }\n\n    def _fallback_response(self, query: str) -> Dict:\n        \"\"\"–§–æ–ª–±—ç–∫-–æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö\"\"\"\n        return {\n            \"response\": \"–ò–∑–≤–∏–Ω–∏, —è –Ω–µ–º–Ω–æ–≥–æ –∑–∞–ø—É—Ç–∞–ª—Å—è. –ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å?\",\n            \"suggestions\": [\"–ü—Ä–∏–≤–µ—Ç\", \"–ö–∞–∫ –¥–µ–ª–∞?\", \"–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?\"],\n            \"mood\": \"confused\"\n        }\n\n    def add_custom_response(self, trigger: str, response: str):\n        \"\"\"–î–æ–±–∞–≤–ª—è–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã\"\"\"\n        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î\n        self.logger.info(f\"Added custom response for: {trigger}\")\n        \n    def learn_from_interaction(self, user_id: str, query: str, response: str, feedback: int):\n        \"\"\"–û–±—É—á–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–¥–±–µ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –ë–î\n        self.logger.info(f\"Learning from feedback: user={user_id}, feedback={feedback}\")\n\n    def get_user_profile(self, user_id: str) -> Dict:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        return self.user_profiles.get(user_id, {})–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.py`)pythonCopyDownload# config.py\n\n# API –∫–ª—é—á–∏\nGIGACHAT_API_KEY = \"–≤–∞—à_api_–∫–ª—é—á\"\nWEATHER_API_KEY = \"–≤–∞—à_–∫–ª—é—á_openweathermap\"\nNEWS_API_KEY = \"–≤–∞—à_–∫–ª—é—á_newsapi\"\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏—á–Ω–æ—Å—Ç–∏\nAGENT_PERSONALITY = {\n    \"name\": \"–ê–ª–µ–∫—Å\",\n    \"mood\": \"–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π\",\n    \"interests\": [\"—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", \"–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö\", \"–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç\"],\n    \"response_style\": \"–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Å —é–º–æ—Ä–æ–º\"\n}\n\n# –õ–∏–º–∏—Ç—ã\nRESPONSE_CACHE_SIZE = 1000\nUSER_PROFILES_TTL = 86400  # 24 —á–∞—Å–∞–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—èpythonCopyDownload# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞\nagent = SmallTalkAgent()\n\n# –ü—Ä–∏–º–µ—Ä 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\nresponse = agent.respond(\"–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?\", {\"user_id\": \"123\", \"name\": \"–ò–≤–∞–Ω\"})\nprint(response[\"response\"])\n# \"–ü—Ä–∏–≤–µ—Ç, –ò–≤–∞–Ω! –†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å!\"\n\n# –ü—Ä–∏–º–µ—Ä 2: –ó–∞–ø—Ä–æ—Å –æ –ø–æ–≥–æ–¥–µ\nresponse = agent.respond(\"–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ?\", {\"user_id\": \"123\"})\nprint(response[\"response\"])\n# \"–°–µ–π—á–∞—Å –≤ –ú–æ—Å–∫–≤–µ: –ª–µ–≥–∫–∏–π –¥–æ–∂–¥—å, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ 18¬∞C. –í–ª–∞–∂–Ω–æ—Å—Ç—å: 75%.\"\n\n# –ü—Ä–∏–º–µ—Ä 3: –õ–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å\nresponse = agent.respond(\"–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?\", {\"user_id\": \"456\"})\nprint(response[\"response\"])\n# \"–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å! –ê —Ç–µ–±—è?\"\n\n# –ü—Ä–∏–º–µ—Ä 4: –í–æ–ø—Ä–æ—Å –ø—Ä–æ –ò–ò\nresponse = agent.respond(\"–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç?\", {\"user_id\": \"789\"})\nprint(response[\"response\"])\n# \"–ò–ò –æ–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –¥–∞–Ω–Ω—ã—Ö, –≤—ã—è–≤–ª—è—è –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–Ω –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç—ã—Å—è—á–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫. –≠—Ç–æ –∫–∞–∫ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π —É—á–µ–Ω–∏–∫!\"–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏–¢–∏–ø—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:pythonCopyDownloaddef _classify_talk_type(self, query: str) -> str:\n    # –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é: greeting, mood, weather, news, personal, about_ai, general–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:pythonCopyDownloaddef _update_user_profile(self, context: Dict):\n    # –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏:–ü–æ–≥–æ–¥–Ω—ã–π API (OpenWeatherMap)–ù–æ–≤–æ—Å—Ç–Ω–æ–π API (NewsAPI)–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã:–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ (`_get_time_based_greeting()`)–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:pythonCopyDownloaddef _handle_ai_questions(self, query: str, context: Dict) -> Dict:\n    # –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ç–æ–≤ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏:–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤–û–±—É—á–µ–Ω–∏–µ –Ω–∞ —Ñ–∏–¥–±–µ–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞–°–∏—Å—Ç–µ–º–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏—á–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:pythonCopyDownloadAGENT_PERSONALITY = {\n    \"name\": \"–ê–ª–µ–∫—Å\",                   # –ò–º—è –±–æ—Ç–∞\n    \"mood\": \"–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π\",             # –û—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ\n    \"interests\": [\"—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏\", ...],  # –¢–µ–º—ã –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞\n    \"response_style\": \"–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π —Å —é–º–æ—Ä–æ–º\"  # –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è\n}–ú–µ—Ö–∞–Ω–∏–∑–º –æ—Ç–≤–µ—Ç–æ–≤–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤–£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ LLM–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ LLM:–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∏–ª–∏ –æ–±—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤–° —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –ª–∏—á–Ω–æ—Å—Ç–∏–ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã:–î–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, –ø–æ–≥–æ–¥—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangSmith–î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@traceable` –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:–¢–∏–ø—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã –æ—Ç–≤–µ—Ç–æ–≤–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å API–û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ:–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Å—Ç–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–£—á–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–∫—Ä–∞—Å–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤–ü–æ–ª–µ–∑–Ω—ã–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:–ê–∫—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–≥–æ–¥–∞–°–≤–µ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏–û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–º–ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:–õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å –±–æ—Ç–∞–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ API–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –æ—Å–≤–µ–¥–æ–º–ª–µ–Ω–Ω–æ—Å—Ç—å:–ó–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–£—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞–≠—Ç–æ—Ç –∞–≥–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏ –ø—Ä–∏—è—Ç–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–µ–º—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ä–∞–±–æ—á–∏–º –∑–∞–¥–∞—á–∞–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã."
  },
  {
    "role": "user",
    "content": "def _handle_general(self, query: str, context: Dict) -> Dict:\n        \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\"\"\"\n        user_id = context.get(\"user_id\")\n        user_name = self.user_profiles.get(user_id, {}).get(\"name\", \"–¥—Ä—É–≥\")\n        \n        prompt = f\"\"\"–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—Ç—å –Ω–∞ —Ä–µ–ø–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n        \n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ({user_name}): \"{query}\"\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n- –¢–≤–æ—ë –∏–º—è: {self.personality['name']}\n- –¢–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã: {\", \".join(self.personality['interests']}\n- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {self.personality['response_style']}\n\n–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:\n- –ö–æ—Ä–æ—Ç–∫–∏–º (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–º\n- –° —ç–ª–µ–º–µ–Ω—Ç–æ–º –ª—ë–≥–∫–æ–≥–æ —é–º–æ—Ä–∞ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)\n\"\"\"\n        response = self.llm.generate(prompt)\n        return {\n            \"response\": response,\n            \"suggestions\": [\"–†–∞—Å—Å–∫–∞–∂–∏ —à—É—Ç–∫—É\", \"–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?\", \"–ü–æ–º–æ–≥–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π\"],\n            \"mood\": \"friendly\"\n        }\n —Ç—É—Ç –æ–≥–∏–±–∫–∞"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ, –≥–¥–µ –º—ã —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏:\", \".join(self.personality['interests'] - –∑–¥–µ—Å—å –ø—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è —Å–∫–æ–±–∫–∞ –¥–ª—è interests.–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:\", \".join(self.personality['interests'])–ù–æ —Ç–∞–∫–∂–µ –≤ –ø—Ä–æ–º–ø—Ç–µ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –µ—Å—Ç—å –Ω–µ–∑–∞–∫—Ä—ã—Ç–∞—è –∫–∞–≤—ã—á–∫–∞. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –≤–µ—Å—å –ø—Ä–æ–º–ø—Ç.–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:–í —Å—Ç—Ä–æ–∫–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ –µ—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –ø—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è –∫–∞–≤—ã—á–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤. –í–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–µ—Ç–æ–¥–∞:pythonCopyDownloaddef _handle_general(self, query: str, context: Dict) -> Dict:\n    \"\"\"–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤\"\"\"\n    user_id = context.get(\"user_id\")\n    user_name = self.user_profiles.get(user_id, {}).get(\"name\", \"–¥—Ä—É–≥\")\n    \n    prompt = f\"\"\"–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—Ç—å –Ω–∞ —Ä–µ–ø–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n    \n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ({user_name}): \"{query}\"\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n- –¢–≤–æ—ë –∏–º—è: {self.personality['name']}\n- –¢–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã: {\", \".join(self.personality['interests'])}  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–¥–µ—Å—å\n- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è: {self.personality['response_style']}\n\n–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:\n- –ö–æ—Ä–æ—Ç–∫–∏–º (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\n- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–º\n- –° —ç–ª–µ–º–µ–Ω—Ç–æ–º –ª—ë–≥–∫–æ–≥–æ —é–º–æ—Ä–∞ (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ)\n\"\"\"\n    response = self.llm.generate(prompt)\n    return {\n        \"response\": response,\n        \"suggestions\": [\"–†–∞—Å—Å–∫–∞–∂–∏ —à—É—Ç–∫—É\", \"–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?\", \"–ü–æ–º–æ–≥–∏ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π\"],\n        \"mood\": \"friendly\"\n    }–ö–ª—é—á–µ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:pythonCopyDownload{\", \".join(self.personality['interests'])}  # –ë—ã–ª–æ: {\", \".join(self.personality['interests']}–î–æ–±–∞–≤–ª–µ–Ω–∞:–ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ `]` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª—é—á—É 'interests'–ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è –∫—Ä—É–≥–ª–∞—è —Å–∫–æ–±–∫–∞ `)` –¥–ª—è –≤—ã–∑–æ–≤–∞ join()–ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Ñ–∏–≥—É—Ä–Ω–∞—è —Å–∫–æ–±–∫–∞ `}` –¥–ª—è f-—Å—Ç—Ä–æ–∫–∏–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç –æ—à–∏–±–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –±—É–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω –≤ —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é."
  },
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å –ø–∏—à–µ–º sql generator"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —É–∂–µ —Å–æ–∑–¥–∞–ª–∏ SchemaMaster, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é SQL. –û–¥–Ω–∞–∫–æ, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π SQLGeneratorAgent, –¥–∞–≤–∞–π—Ç–µ –µ–≥–æ —Ä–µ–∞–ª–∏–∑—É–µ–º.–£—á—Ç–µ–º, —á—Ç–æ –æ–Ω –¥–æ–ª–∂–µ–Ω:1. –ü—Ä–∏–Ω–∏–º–∞—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-—è–∑—ã–∫–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏ —Å—Ö–µ–º—É –ë–î (–∏–ª–∏ —á–∞—Å—Ç—å —Å—Ö–µ–º—ã)2. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å3. –ü—Ä–æ–≤–µ—Ä—è—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å4. –í–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–ù–æ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫: SchemaMaster –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π SQLGenerator.–õ–∏–±–æ —Å–æ–∑–¥–∞–¥–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è SchemaMaster.–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º `SQLGeneratorAgent` –∫–∞–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏ –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö.–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `SQLGeneratorAgent`–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ-—è–∑—ã–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL-–∫–æ–º–∞–Ω–¥—ã —Å —É—á–µ—Ç–æ–º —Å—Ö–µ–º—ã –ë–î –∏ –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.pythonCopyDownloadfrom langsmith import traceable\nfrom gigachain import GigaChatModel\nimport logging\nimport config\nimport re\nimport json\nfrom typing import Dict, List, Tuple, Optional\n\nclass SQLGeneratorAgent:\n    def __init__(self, schema_master):\n        self.logger = logging.getLogger(\"sql_generator\")\n        self.llm = GigaChatModel(\n            model=\"GigaChat-Pro\",\n            temperature=0.1,  # –ú–∏–Ω–∏–º—É–º —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏\n            api_key=config.GIGACHAT_API_KEY,\n            max_tokens=700\n        )\n        self.schema_master = schema_master\n        self.query_cache = {}\n        self.security_policy = self._load_security_policy()\n        \n    @traceable\n    def generate_sql(self, nl_query: str, user_context: Dict) -> Dict:\n        \"\"\"\n        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç SQL-–∑–∞–ø—Ä–æ—Å\n        :param nl_query: –ó–∞–ø—Ä–æ—Å –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ\n        :param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–æ–ª—å, –¥–æ—Å—Ç—É–ø—ã)\n        :return: {\n            \"sql\": \"SELECT ...\", \n            \"validated\": bool,\n            \"optimized\": bool,\n            \"security_checked\": bool,\n            \"explanation\": str,\n            \"source_tables\": List[str]\n        }\n        \"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞\n        cache_key = f\"{nl_query}-{user_context.get('role','')}\"\n        if cache_key in self.query_cache:\n            self.logger.debug(\"Using cached SQL query\")\n            return self.query_cache[cache_key]\n        \n        try:\n            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ SQL\n            raw_sql, explanation = self._generate_initial_sql(nl_query, user_context)\n            \n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n            security_check = self._security_validation(raw_sql, user_context)\n            if not security_check[\"valid\"]:\n                return {\n                    \"sql\": raw_sql,\n                    \"validated\": False,\n                    \"optimized\": False,\n                    \"security_checked\": False,\n                    \"explanation\": security_check[\"reason\"],\n                    \"source_tables\": []\n                }\n            \n            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞\n            validated_sql = self._validate_syntax(raw_sql)\n            \n            # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞\n            optimized_sql, optimization_report = self._optimize_query(validated_sql)\n            \n            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü\n            source_tables = self._extract_tables(optimized_sql)\n            \n            result = {\n                \"sql\": optimized_sql,\n                \"validated\": True,\n                \"optimized\": True,\n                \"security_checked\": True,\n                \"explanation\": f\"{explanation} | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: {optimization_report}\",\n                \"source_tables\": source_tables\n            }\n            \n            # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ\n            self.query_cache[cache_key] = result\n            return result\n            \n        except Exception as e:\n            self.logger.error(f\"SQL generation failed: {str(e)}\")\n            return {\n                \"sql\": \"\",\n                \"validated\": False,\n                \"optimized\": False,\n                \"security_checked\": False,\n                \"explanation\": f\"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {str(e)}\",\n                \"source_tables\": []\n            }\n\n    def _generate_initial_sql(self, nl_query: str, context: Dict) -> Tuple[str, str]:\n        \"\"\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL —á–µ—Ä–µ–∑ LLM —Å —É—á–µ—Ç–æ–º —Å—Ö–µ–º—ã\"\"\"\n        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π —á–∞—Å—Ç–∏ —Å—Ö–µ–º—ã\n        schema_context = self.schema_master._get_relevant_schema(nl_query)\n        \n        prompt = f\"\"\"### –ó–∞–¥–∞—á–∞:\n–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π PostgreSQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–ø–∏—Å–∞–Ω–∏—è.\n\n### –°—Ö–µ–º–∞ –ë–î:\n{schema_context}\n\n### –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n- –†–æ–ª—å: {context.get('role', 'analyst')}\n- –î–æ–ø—É—Å—Ç–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã: {', '.join(context.get('allowed_tables', ['*']))}\n\n### –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\"{nl_query}\"\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n1. –¢–æ–ª—å–∫–æ SELECT\n2. –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SQL (–±–µ–∑ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π)\n3. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫ (table.column)\n4. –ò–∑–±–µ–≥–∞–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ\n5. –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏\n\n### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:\n{{\n  \"sql\": \"SELECT ...\",\n  \"explanation\": \"–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏\"\n}}\n\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        result = json.loads(response)\n        return result[\"sql\"], result.get(\"explanation\", \"–ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π\")\n\n    def _security_validation(self, sql: str, context: Dict) -> Dict:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\"\"\"\n        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π\n        for pattern in self.security_policy[\"forbidden_patterns\"]:\n            if re.search(pattern, sql, re.IGNORECASE):\n                return {\n                    \"valid\": False,\n                    \"reason\": f\"–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: {pattern}\"\n                }\n        \n        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü\n        allowed_tables = context.get(\"allowed_tables\", [])\n        if allowed_tables and \"*\" not in allowed_tables:\n            used_tables = self._extract_tables(sql)\n            for table in used_tables:\n                if table not in allowed_tables:\n                    return {\n                        \"valid\": False,\n                        \"reason\": f\"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ: {table}\"\n                    }\n        \n        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫\n        for col in self.security_policy[\"sensitive_columns\"]:\n            if re.search(rf\"\\b{col}\\b\", sql, re.IGNORECASE):\n                return {\n                    \"valid\": False,\n                    \"reason\": f\"–ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ: {col}\"\n                }\n        \n        # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤\n        if \"LIMIT\" not in sql and \"FETCH\" not in sql:\n            if not re.search(r\"\\b(COUNT|SUM|AVG|MIN|MAX)\\b\", sql, re.IGNORECASE):\n                return {\n                    \"valid\": False,\n                    \"reason\": \"–ó–∞–ø—Ä–æ—Å –±–µ–∑ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å LIMIT\"\n                }\n        \n        return {\"valid\": True, \"reason\": \"–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–∞\"}\n\n    def _extract_tables(self, sql: str) -> List[str]:\n        \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü\"\"\"\n        table_pattern = r\"\\b(?:FROM|JOIN)\\s+(\\w+)\"\n        return list(set(re.findall(table_pattern, sql, re.IGNORECASE)))\n\n    def _validate_syntax(self, sql: str) -> str:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —á–µ—Ä–µ–∑ LLM\"\"\"\n        prompt = f\"\"\"–ü—Ä–æ–≤–µ—Ä—å SQL –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (PostgreSQL) –∏ –∏—Å–ø—Ä–∞–≤—å –∏—Ö:\n\n### –ó–∞–ø—Ä–æ—Å:\n{sql}\n\n### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n1. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - –∏—Å–ø—Ä–∞–≤—å –∏—Ö\n2. –°–æ—Ö—Ä–∞–Ω–∏ –∏—Å—Ö–æ–¥–Ω—É—é –ª–æ–≥–∏–∫—É\n3. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π SQL\n\n### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π SQL:\"\"\"\n        \n        return self.llm.generate(prompt)\n\n    def _optimize_query(self, sql: str) -> Tuple[str, str]:\n        \"\"\"–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        prompt = f\"\"\"–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π SQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –ë–î (PostgreSQL):\n\n### –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å:\n{sql}\n\n### –£—á—Ç–∏:\n1. –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏\n2. –î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π\n3. –°–æ—Ö—Ä–∞–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å\n\n### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:\n{{\n  \"optimized_sql\": \"–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô_SQL\",\n  \"optimizations\": [\"—Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π\"]\n}}\"\"\"\n        \n        response = self.llm.generate(prompt, response_format=\"json\")\n        result = json.loads(response)\n        return result[\"optimized_sql\"], \"; \".join(result[\"optimizations\"])\n\n    def explain_query(self, sql: str) -> str:\n        \"\"\"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã SQL-–∑–∞–ø—Ä–æ—Å–∞\"\"\"\n        prompt = f\"\"\"–û–±—ä—è—Å–Ω–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π SQL –∑–∞–ø—Ä–æ—Å:\n\n{sql}\n\n–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ"
  },
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å –ø–∏—à–µ–º auth_service"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º AuthService, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ Telegram ID2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å–∞–º3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —ç—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ë–î.–°—Ç—Ä—É–∫—Ç—É—Ä–∞:- User: {id: int, telegram_id: str, name: str, role: str, created_at: datetime}- Role: {name: str, permissions: List[str]}–†–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—É–¥—É—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\"analytics:read\", \"documentation:write\" –∏ —Ç.–¥.–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–¥–∏–º —Ä–æ–ª–∏ –∏ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.–†–µ–∞–ª–∏–∑—É–µ–º –º–µ—Ç–æ–¥—ã:- authenticate(telegram_id) -> User | None- authorize(user, permission) -> bool- create_user(telegram_id, name, role) -> User- update_user_role(telegram_id, new_role) -> bool- generate_jwt(user) -> str (–¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)–î–ª—è JWT –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É PyJWT.–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `AuthService`–°–µ—Ä–≤–∏—Å –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Telegram API, —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–æ–ª—è–º–∏ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.pythonCopyDownloadimport logging\nimport config\nimport jwt\nimport time\nimport hashlib\nfrom typing import Dict, Optional, Tuple\nfrom datetime import datetime, timedelta\n\nclass AuthService:\n    def __init__(self):\n        self.logger = logging.getLogger(\"auth_service\")\n        self.user_store = self._load_user_store()\n        self.roles = self._load_roles_config()\n        self.secret_key = config.SECRET_KEY\n        self.token_cache = {}\n        \n    def authenticate_user(self, telegram_data: Dict) -> Tuple[bool, Dict]:\n        \"\"\"\n        –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram\n        :param telegram_data: –î–∞–Ω–Ω—ã–µ –æ—Ç Telegram WebApp (id, first_name, auth_date, hash)\n        :return: (success: bool, user_data: dict)\n        \"\"\"\n        try:\n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö\n            if not self._verify_telegram_data(telegram_data):\n                return False, {\"error\": \"invalid_signature\"}\n            \n            user_id = telegram_data[\"id\"]\n            \n            # –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            if user_id in self.user_store:\n                user = self.user_store[user_id]\n                user[\"last_login\"] = datetime.now().isoformat()\n                return True, user\n            \n            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n            new_user = self._create_new_user(telegram_data)\n            self.user_store[user_id] = new_user\n            self._save_user_store()\n            \n            return True, new_user\n            \n        except Exception as e:\n            self.logger.error(f\"Authentication failed: {str(e)}\")\n            return False, {\"error\": \"authentication_error\"}\n\n    def _verify_telegram_data(self, data: Dict) -> bool:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram\"\"\"\n        # –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Telegram\n        received_hash = data.pop(\"hash\")\n        data_check_string = \"\\n\".join(\n            f\"{key}={value}\" for key, value in sorted(data.items())\n        \n        secret_key = hashlib.sha256(config.TELEGRAM_BOT_TOKEN.encode()).digest()\n        computed_hash = hashlib.hmac256(\n            secret_key, \n            data_check_string.encode()\n        ).hexdigest()\n        \n        return computed_hash == received_hash\n\n    def _create_new_user(self, telegram_data: Dict) -> Dict:\n        \"\"\"–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        default_role = \"user\"\n        \n        return {\n            \"id\": telegram_data[\"id\"],\n            \"username\": telegram_data.get(\"username\", f\"user_{telegram_data['id']}\"),\n            \"first_name\": telegram_data.get(\"first_name\", \"\"),\n            \"last_name\": telegram_data.get(\"last_name\", \"\"),\n            \"language\": telegram_data.get(\"language_code\", \"ru\"),\n            \"role\": default_role,\n            \"created_at\": datetime.now().isoformat(),\n            \"last_login\": datetime.now().isoformat(),\n            \"permissions\": self.roles.get(default_role, {}).get(\"permissions\", [])\n        }\n\n    def authorize(self, user_id: int, permission: str) -> bool:\n        \"\"\"\n        –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        :param user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        :param permission: –¢—Ä–µ–±—É–µ–º–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (\"analytics:read\", \"export:create\" –∏ —Ç.–¥.)\n        :return: bool\n        \"\"\"\n        user = self.user_store.get(user_id)\n        if not user:\n            return False\n            \n        # –ê–¥–º–∏–Ω—ã –∏–º–µ—é—Ç –≤—Å–µ –ø—Ä–∞–≤–∞\n        if user[\"role\"] == \"admin\":\n            return True\n            \n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è\n        return permission in user.get(\"permissions\", [])\n\n    def generate_jwt(self, user_id: int) -> str:\n        \"\"\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞\n        if user_id in self.token_cache:\n            token, exp = self.token_cache[user_id]\n            if time.time() < exp - 60:  # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø–æ—á—Ç–∏ –Ω–µ –∏—Å—Ç–µ–∫\n                return token\n        \n        # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞\n        user = self.user_store[user_id]\n        payload = {\n            \"sub\": user_id,\n            \"role\": user[\"role\"],\n            \"exp\": datetime.utcnow() + timedelta(hours=config.JWT_EXP_HOURS)\n        }\n        \n        token = jwt.encode(payload, self.secret_key, algorithm=\"HS256\")\n        self.token_cache[user_id] = (token, payload[\"exp\"])\n        return token\n\n    def verify_jwt(self, token: str) -> Optional[Dict]:\n        \"\"\"–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞\"\"\"\n        try:\n            payload = jwt.decode(token, self.secret_key, algorithms=[\"HS256\"])\n            return payload\n        except jwt.ExpiredSignatureError:\n            self.logger.warning(\"JWT token expired\")\n        except jwt.InvalidTokenError:\n            self.logger.warning(\"Invalid JWT token\")\n        return None\n\n    def get_user_context(self, user_id: int) -> Dict:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–∏—Å—Ç–µ–º—ã\"\"\"\n        user = self.user_store.get(user_id)\n        if not user:\n            return {}\n            \n        return {\n            \"user_id\": user_id,\n            \"role\": user[\"role\"],\n            \"language\": user[\"language\"],\n            \"allowed_tables\": self._get_allowed_tables(user[\"role\"]),\n            \"permissions\": user[\"permissions\"]\n        }\n\n    def _get_allowed_tables(self, role: str) -> List[str]:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –¥–ª—è —Ä–æ–ª–∏\"\"\"\n        role_config = self.roles.get(role, {})\n        return role_config.get(\"allowed_tables\", [\"*\"])\n\n    def update_user_role(self, user_id: int, new_role: str) -> bool:\n        \"\"\"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)\"\"\"\n        if new_role not in self.roles:\n            return False\n            \n        user = self.user_store.get(user_id)\n        if not user:\n            return False\n            \n        user[\"role\"] = new_role\n        user[\"permissions\"] = self.roles[new_role].get(\"permissions\", [])\n        self._save_user_store()\n        return True\n\n    def _load_user_store(self) -> Dict:\n        \"\"\"–ó–∞–≥—Ä—É–∑–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ - –∏–∑ –ë–î)\"\"\"\n        # –í –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª, –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î\n        try:\n            with open(config.USER_STORE_FILE, \"r\") as f:\n                return json.load(f)\n        except:\n            return {}\n\n    def _save_user_store(self):\n        \"\"\"–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\"\"\"\n        try:\n            with open(config.USER_STORE_FILE, \"w\") as f:\n                json.dump(self.user_store, f, indent=2)\n        except Exception as e:\n            self.logger.error(f\"Failed to save user store: {str(e)}\")\n\n    def _load_roles_config(self) -> Dict:\n        \"\"\"–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–æ–ª–µ–π\"\"\"\n        return {\n            \"admin\": {\n                \"permissions\": [\"*\"],\n                \"allowed_tables\": [\"*\"],\n                \"description\": \"–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø\"\n            },\n            \"analyst\": {\n                \"permissions\": [\"analytics:read\", \"export:create\", \"data:query\"],\n                \"allowed_tables\": [\"sales\", \"customers\", \"products\"],\n                \"description\": \"–ê–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö\"\n            },\n            \"manager\": {\n                \"permissions\": [\"analytics:read\", \"reports:view\"],\n                \"allowed_tables\": [\"sales_summary\", \"kpi\"],\n                \"description\": \"–ú–µ–Ω–µ–¥–∂–µ—Ä\"\n            },\n            \"user\": {\n                \"permissions\": [\"analytics:read\"],\n                \"allowed_tables\": [\"public_data\"],\n                \"description\": \"–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\"\n            }\n        }–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.py`)pythonCopyDownload# config.py\n\n# –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏\nSECRET_KEY = \"your_strong_secret_key\"  # –î–ª—è JWT\nTELEGRAM_BOT_TOKEN = \"your_telegram_bot_token\"\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ JWT\nJWT_EXP_HOURS = 24\n\n# –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\nUSER_STORE_FILE = \"users.json\"\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–æ–ª–µ–π (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å)\nROLES_CONFIG = {\n    \"support\": {\n        \"permissions\": [\"analytics:read\", \"users:view\"],\n        \"allowed_tables\": [\"*\"],\n        \"description\": \"–¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞\"\n    }\n}–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—èpythonCopyDownload# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞\nauth_service = AuthService()\n\n# –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram\ntelegram_data = {\n    \"id\": 123456789,\n    \"first_name\": \"–ò–≤–∞–Ω\",\n    \"last_name\": \"–ü–µ—Ç—Ä–æ–≤\",\n    \"username\": \"ivan_petrov\",\n    \"auth_date\": 1678901234,\n    \"hash\": \"a1b2c3d4e5f6g7h8i9j0\"\n}\n\n# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è\nsuccess, user = auth_service.authenticate_user(telegram_data)\nif success:\n    print(f\"Authenticated: {user['first_name']}\")\n    \n    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT\n    token = auth_service.generate_jwt(user[\"id\"])\n    print(f\"JWT: {token}\")\n    \n    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤\n    if auth_service.authorize(user[\"id\"], \"analytics:read\"):\n        print(\"User has analytics access\")\n    \n    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã\n    context = auth_service.get_user_context(user[\"id\"])\n    print(context)\nelse:\n    print(f\"Authentication failed: {user.get('error')}\")–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram:pythonCopyDownloaddef authenticate_user(self, telegram_data: Dict) -> Tuple[bool, Dict]:\n    # –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ Telegram\n    # –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤:pythonCopyDownloaddef authorize(self, user_id: int, permission: str) -> bool:\n    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–∞–≤–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –¥–ª—è –∞–¥–º–∏–Ω–æ–≤–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞–º–∏:–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏:–ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏ (admin, analyst, manager, user)–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:pythonCopyDownloaddef get_user_context(self, user_id: int) -> Dict:\n    # –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–∏—Å—Ç–µ–º—ã:\n    # - ID –∏ —Ä–æ–ª—å\n    # - –Ø–∑—ã–∫\n    # - –†–∞–∑—Ä–µ—à–µ–Ω–∏—è\n    # - –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ãDiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}SystemAuthServiceTelegramUserSystemAuthServiceTelegramUser#mermaid-svg-1{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-1 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-1 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-1 .error-icon{fill:#a44141;}#mermaid-svg-1 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-1 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-1 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-1 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-1 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-1 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-1 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-1 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-1 .marker.cross{stroke:lightgrey;}#mermaid-svg-1 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-1 p{margin:0;}#mermaid-svg-1 .actor{stroke:#ccc;fill:#1f2020;}#mermaid-svg-1 text.actor>tspan{fill:lightgrey;stroke:none;}#mermaid-svg-1 .actor-line{stroke:#ccc;}#mermaid-svg-1 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:lightgrey;}#mermaid-svg-1 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:lightgrey;}#mermaid-svg-1 #arrowhead path{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-1 .sequenceNumber{fill:black;}#mermaid-svg-1 #sequencenumber{fill:lightgrey;}#mermaid-svg-1 #crosshead path{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-1 .messageText{fill:lightgrey;stroke:none;}#mermaid-svg-1 .labelBox{stroke:#ccc;fill:#1f2020;}#mermaid-svg-1 .labelText,#mermaid-svg-1 .labelText>tspan{fill:lightgrey;stroke:none;}#mermaid-svg-1 .loopText,#mermaid-svg-1 .loopText>tspan{fill:lightgrey;stroke:none;}#mermaid-svg-1 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:#ccc;fill:#ccc;}#mermaid-svg-1 .note{stroke:hsl(180, 0%, 18.3529411765%);fill:hsl(180, 1.5873015873%, 28.3529411765%);}#mermaid-svg-1 .noteText,#mermaid-svg-1 .noteText>tspan{fill:rgb(183.8476190475, 181.5523809523, 181.5523809523);stroke:none;}#mermaid-svg-1 .activation0{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:#ccc;}#mermaid-svg-1 .activation1{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:#ccc;}#mermaid-svg-1 .activation2{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:#ccc;}#mermaid-svg-1 .actorPopupMenu{position:absolute;}#mermaid-svg-1 .actorPopupMenuPanel{position:absolute;fill:#1f2020;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);filter:drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4));}#mermaid-svg-1 .actor-man line{stroke:#ccc;fill:#1f2020;}#mermaid-svg-1 .actor-man circle,#mermaid-svg-1 line{stroke:#ccc;fill:#1f2020;stroke-width:2px;}#mermaid-svg-1 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Telegram–î–∞–Ω–Ω—ã–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏–ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Öauthenticate_user(data)–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–û—à–∏–±–∫–∞authorize(user_id, permission)–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ/–ó–∞–ø—Ä–µ—Ç–î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ Telegram –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π —Å—Ö–µ–º–µHMAC-SHA256 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—ÖJWT —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ä–æ–∫–æ–º –¥–µ–π—Å—Ç–≤–∏—è–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏–ì–∏–±–∫–∏–µ —Ä–æ–ª–∏:pythonCopyDownloadROLES_CONFIG = {\n    \"analyst\": {\n        \"permissions\": [\"analytics:read\", \"export:create\"],\n        \"allowed_tables\": [\"sales\", \"customers\"],\n        \"description\": \"–ê–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö\"\n    }\n}–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π:–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –∫ —Ç–∞–±–ª–∏—Ü–∞–º –ë–î–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç–∏–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:JSON-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏–õ–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –ë–î–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤–õ–æ–∫–∞–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—èjsonCopyDownload{\n    \"user_id\": 123456789,\n    \"role\": \"analyst\",\n    \"language\": \"ru\",\n    \"allowed_tables\": [\"sales\", \"customers\", \"products\"],\n    \"permissions\": [\"analytics:read\", \"export:create\", \"data:query\"]\n}–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ Telegram, –≥–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
  },
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å cache service"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–µ–º `CacheService` –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤.–ö–µ—à –±—É–¥–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å TTL (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–ø–∏—Å–µ–π) –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä.–†–µ–∞–ª–∏–∑—É–µ–º –¥–≤–∞ —Ç–∏–ø–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è: in-memory (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞) –∏ persistent (–Ω–∞ –¥–∏—Å–∫–µ, –¥–ª—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è).–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `CacheService`–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è (in-memory, Redis) –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∑–∞ —Å—á–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.pythonCopyDownloadimport logging\nimport config\nimport json\nimport time\nimport hashlib\nimport redis\nfrom datetime import timedelta\nfrom typing import Any, Dict, Optional, Callable\n\nclass CacheService:\n    def __init__(self):\n        self.logger = logging.getLogger(\"cache_service\")\n        self.memory_cache = {}\n        self.redis_client = self._init_redis()\n        self.stats = {\n            \"hits\": 0,\n            \"misses\": 0,\n            \"memory_size\": 0,\n            \"redis_size\": 0\n        }\n        \n    def _init_redis(self) -> Optional[redis.Redis]:\n        \"\"\"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis\"\"\"\n        if not config.REDIS_ENABLED:\n            return None\n            \n        try:\n            return redis.Redis(\n                host=config.REDIS_HOST,\n                port=config.REDIS_PORT,\n                password=config.REDIS_PASSWORD,\n                db=config.REDIS_DB,\n                decode_responses=True\n            )\n        except Exception as e:\n            self.logger.error(f\"Redis connection failed: {str(e)}\")\n            return None\n\n    def get(self, key: str, loader: Callable = None, ttl: int = None) -> Any:\n        \"\"\"\n        –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–µ—à–∞. –ï—Å–ª–∏ –Ω–µ—Ç - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —á–µ—Ä–µ–∑ loader.\n        :param key: –ö–ª—é—á –∫–µ—à–∞\n        :param loader: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –≤ –∫–µ—à–µ\n        :param ttl: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–ø–∏—Å–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö\n        :return: –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–µ—à–∞ –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç loader\n        \"\"\"\n        # 1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø–∞–º—è—Ç–∏\n        if key in self.memory_cache:\n            entry = self.memory_cache[key]\n            if time.time() < entry[\"expire\"]:\n                self.stats[\"hits\"] += 1\n                return entry[\"value\"]\n            del self.memory_cache[key]\n            self.stats[\"memory_size\"] -= 1\n\n        # 2. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ Redis\n        if self.redis_client:\n            try:\n                value = self.redis_client.get(key)\n                if value:\n                    self.stats[\"hits\"] += 1\n                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ memory –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è\n                    self._set_memory(key, value, ttl or config.DEFAULT_MEMORY_TTL)\n                    return json.loads(value)\n            except redis.RedisError as e:\n                self.logger.warning(f\"Redis get failed: {str(e)}\")\n\n        # 3. –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é\n        self.stats[\"misses\"] += 1\n        if loader:\n            value = loader()\n            self.set(key, value, ttl)\n            return value\n            \n        return None\n\n    def set(self, key: str, value: Any, ttl: int = None) -> None:\n        \"\"\"\n        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–µ—à\n        :param key: –ö–ª—é—á –∫–µ—à–∞\n        :param value: –ó–Ω–∞—á–µ–Ω–∏–µ (–ª—é–±–æ–π JSON-—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–π –æ–±—ä–µ–∫—Ç)\n        :param ttl: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö\n        \"\"\"\n        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ TTL\n        actual_ttl = ttl or config.DEFAULT_CACHE_TTL\n        \n        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ memory\n        self._set_memory(key, value, actual_ttl)\n        \n        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis\n        if self.redis_client:\n            try:\n                serialized = json.dumps(value)\n                self.redis_client.setex(key, actual_ttl, serialized)\n                self.stats[\"redis_size\"] = self.redis_client.dbsize()\n            except redis.RedisError as e:\n                self.logger.warning(f\"Redis set failed: {str(e)}\")\n\n    def _set_memory(self, key: str, value: Any, ttl: int) -> None:\n        \"\"\"–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ —Å —É—á–µ—Ç–æ–º TTL\"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–∞–º—è—Ç–∏\n        if len(self.memory_cache) >= config.MAX_MEMORY_ENTRIES:\n            self._evict_old_memory_entries()\n            \n        self.memory_cache[key] = {\n            \"value\": value,\n            \"expire\": time.time() + ttl,\n            \"created\": time.time()\n        }\n        self.stats[\"memory_size\"] = len(self.memory_cache)\n\n    def _evict_old_memory_entries(self, num_to_evict: int = 5) -> None:\n        \"\"\"–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ memory-–∫–µ—à–∞\"\"\"\n        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è\n        sorted_keys = sorted(\n            self.memory_cache.keys(),\n            key=lambda k: self.memory_cache[k][\"created\"]\n        )[:num_to_evict]\n        \n        for key in sorted_keys:\n            del self.memory_cache[key]\n            \n        self.stats[\"memory_size\"] = len(self.memory_cache)\n\n    def delete(self, key: str) -> None:\n        \"\"\"–£–¥–∞–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π –∫–µ—à–∞\"\"\"\n        # –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ø–∞–º—è—Ç–∏\n        if key in self.memory_cache:\n            del self.memory_cache[key]\n            self.stats[\"memory_size\"] = len(self.memory_cache)\n            \n        # –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ Redis\n        if self.redis_client:\n            try:\n                self.redis_client.delete(key)\n                self.stats[\"redis_size\"] = self.redis_client.dbsize()\n            except redis.RedisError as e:\n                self.logger.warning(f\"Redis delete failed: {str(e)}\")\n\n    def clear(self, level: str = \"all\") -> None:\n        \"\"\"\n        –û—á–∏—â–∞–µ—Ç –∫–µ—à\n        :param level: 'memory', 'redis', 'all'\n        \"\"\"\n        if level in (\"memory\", \"all\"):\n            self.memory_cache = {}\n            self.stats[\"memory_size\"] = 0\n            \n        if level in (\"redis\", \"all\") and self.redis_client:\n            try:\n                self.redis_client.flushdb()\n                self.stats[\"redis_size\"] = 0\n            except redis.RedisError as e:\n                self.logger.error(f\"Redis flush failed: {str(e)}\")\n\n    def get_stats(self) -> Dict[str, Any]:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–µ—à–∞\"\"\"\n        return {\n            \"hits\": self.stats[\"hits\"],\n            \"misses\": self.stats[\"misses\"],\n            \"memory_entries\": self.stats[\"memory_size\"],\n            \"redis_entries\": self.stats[\"redis_size\"],\n            \"hit_rate\": self.stats[\"hits\"] / max(1, self.stats[\"hits\"] + self.stats[\"misses\"])\n        }\n\n    def generate_key(self, *args, **kwargs) -> str:\n        \"\"\"\n        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –∫–µ—à–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\n        :param args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã\n        :param kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã\n        :return: –•–µ—à-–∫–ª—é—á\n        \"\"\"\n        parts = [str(arg) for arg in args]\n        parts.extend([f\"{k}={v}\" for k, v in sorted(kwargs.items())])\n        input_string = \"&\".join(parts)\n        return hashlib.sha256(input_string.encode()).hexdigest()\n\n    def memoize(self, ttl: int = None, key_func: Callable = None):\n        \"\"\"\n        –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π\n        :param ttl: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–µ—à–∞\n        :param key_func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞\n        \"\"\"\n        def decorator(func):\n            def wrapper(*args, **kwargs):\n                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞\n                if key_func:\n                    key = key_func(*args, **kwargs)\n                else:\n                    key = self.generate_key(func.__name__, *args, **kwargs)\n                \n                # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –∫–µ—à–∞\n                cached = self.get(key)\n                if cached is not None:\n                    return cached\n                \n                # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\n                result = func(*args, **kwargs)\n                self.set(key, result, ttl)\n                return result\n            return wrapper\n        return decorator\n\n    def invalidate_by_pattern(self, pattern: str) -> None:\n        \"\"\"\n        –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∑–∞–ø–∏—Å–∏ –ø–æ —à–∞–±–ª–æ–Ω—É –∫–ª—é—á–∞\n        :param pattern: –®–∞–±–ª–æ–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª—é—á–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä \"user:*\")\n        \"\"\"\n        # –î–ª—è memory –∫–µ—à–∞\n        keys_to_delete = [k for k in self.memory_cache if pattern in k]\n        for key in keys_to_delete:\n            del self.memory_cache[key]\n        self.stats[\"memory_size\"] = len(self.memory_cache)\n        \n        # –î–ª—è Redis\n        if self.redis_client:\n            try:\n                keys = self.redis_client.keys(pattern)\n                if keys:\n                    self.redis_client.delete(*keys)\n            except redis.RedisError as e:\n                self.logger.error(f\"Redis pattern delete failed: {str(e)}\")–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.py`)pythonCopyDownload# config.py\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Redis\nREDIS_ENABLED = True\nREDIS_HOST = \"localhost\"\nREDIS_PORT = 6379\nREDIS_PASSWORD = None\nREDIS_DB = 0\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\nDEFAULT_CACHE_TTL = 3600  # 1 —á–∞—Å\nDEFAULT_MEMORY_TTL = 300  # 5 –º–∏–Ω—É—Ç\nMAX_MEMORY_ENTRIES = 1000\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏\nAUTO_INVALIDATE_PATTERNS = {\n    \"user_data\": \"user:*\",\n    \"analytics\": \"report:*\"\n}–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è–ë–∞–∑–æ–≤–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:pythonCopyDownloadcache = CacheService()\n\n# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è\ncache.set(\"user:123\", {\"name\": \"–ò–≤–∞–Ω\", \"role\": \"admin\"}, ttl=600)\n\n# –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è\nuser_data = cache.get(\"user:123\")–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–º:pythonCopyDownloaddef load_user_data(user_id: int):\n    # –¢—è–∂–µ–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –ë–î\n    return db.query(User).filter_by(id=user_id).first()\n\nuser_data = cache.get(f\"user:{user_id}\", loader=lambda: load_user_data(user_id))–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞:pythonCopyDownload@cache.memoize(ttl=300)\ndef calculate_report(report_id: int, filters: dict):\n    # –°–ª–æ–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è\n    return generate_report(report_id, filters)\n\n# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\nreport = calculate_report(1, {\"year\": 2023})–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞:pythonCopyDownloadkey = cache.generate_key(\"user_orders\", user_id=123, status=\"completed\")\norders = cache.get(key, loader=lambda: get_orders(user_id, status))–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —à–∞–±–ª–æ–Ω—É:pythonCopyDownload# –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\ncache.invalidate_by_pattern(f\"user:{user_id}:*\")–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ:Memory-–∫–µ—à: –î–ª—è —Å–≤–µ—Ä—Ö–±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–æ—Ä—è—á–∏–º –¥–∞–Ω–Ω—ã–ºRedis: –î–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –∏ persistent —Ö—Ä–∞–Ω–µ–Ω–∏—è–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:pythonCopyDownloadget(key, loader=func)  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç loader –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π:pythonCopyDownload@cache.memoize(ttl=300)\ndef expensive_operation(...):\n    ...–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º:TTL –¥–ª—è –∑–∞–ø–∏—Å–µ–π–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π–†—É—á–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:Hit/Miss ratio–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π–†–∞–∑–º–µ—Ä—ã –∫–µ—à–µ–π–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π:pythonCopyDownloadgenerate_key(\"report\", year=2023, type=\"monthly\")\n# -> \"sha256:4f8c...a2d1\"–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ãDiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-3{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-3 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-3 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-3 .error-icon{fill:#a44141;}#mermaid-svg-3 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-3 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-3 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-3 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-3 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-3 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-3 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-3 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-3 .marker.cross{stroke:lightgrey;}#mermaid-svg-3 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-3 p{margin:0;}#mermaid-svg-3 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-3 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-3 .cluster-label span{color:#F9FFFE;}#mermaid-svg-3 .cluster-label span p{background-color:transparent;}#mermaid-svg-3 .label text,#mermaid-svg-3 span{fill:#ccc;color:#ccc;}#mermaid-svg-3 .node rect,#mermaid-svg-3 .node circle,#mermaid-svg-3 .node ellipse,#mermaid-svg-3 .node polygon,#mermaid-svg-3 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-3 .rough-node .label text,#mermaid-svg-3 .node .label text,#mermaid-svg-3 .image-shape .label,#mermaid-svg-3 .icon-shape .label{text-anchor:middle;}#mermaid-svg-3 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-3 .rough-node .label,#mermaid-svg-3 .node .label,#mermaid-svg-3 .image-shape .label,#mermaid-svg-3 .icon-shape .label{text-align:center;}#mermaid-svg-3 .node.clickable{cursor:pointer;}#mermaid-svg-3 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-3 .arrowheadPath{fill:lightgrey;}#mermaid-svg-3 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-3 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-3 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-3 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-3 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-3 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-3 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-3 .cluster text{fill:#F9FFFE;}#mermaid-svg-3 .cluster span{color:#F9FFFE;}#mermaid-svg-3 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-3 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-3 rect.text{fill:none;stroke-width:0;}#mermaid-svg-3 .icon-shape,#mermaid-svg-3 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-3 .icon-shape p,#mermaid-svg-3 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-3 .icon-shape rect,#mermaid-svg-3 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-3 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}–î–∞–ù–µ—Ç–î–∞–ù–µ—Ç–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö–í memory?–í–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö–í Redis?–í–æ–∑–≤—Ä–∞—Ç + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ memory–í—ã–∑–æ–≤ loader–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis –∏ memory–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ:pythonCopyDownloaddef _evict_old_memory_entries(self, num_to_evict=5):\n    # –£–¥–∞–ª—è–µ—Ç —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞–ì–∏–±–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è:–ü–æ –∫–ª—é—á—É–ü–æ —à–∞–±–ª–æ–Ω—É (user:*)–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ Redis –ø—Ä–∏ –æ—à–∏–±–∫–∞—ÖFallback –Ω–∞ memory-–∫–µ—à–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:–°—á–µ—Ç—á–∏–∫–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–π/–ø—Ä–æ–º–∞—Ö–æ–≤–†–∞—Å—á–µ—Ç hit-rate–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –∫–µ—à–µ–π–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JSON –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ RedispythonCopyDownload# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞\nREDIS_ENABLED = True\nREDIS_HOST = \"cache.techcorp.ru\"\nREDIS_PORT = 6379\nREDIS_PASSWORD = \"secure_password\"\nREDIS_DB = 2\n\n# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏\n# REDIS_ENABLED = False–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∑–∞ —Å—á–µ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –ë–î, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –≥–∏–±–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö."
  },
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å metadata_extractor"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º `MetadataExtractor` - –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (–¥–∞—Ç—ã, –∏–º–µ–Ω–∞, –º–µ—Å—Ç–∞, –ø—Ä–æ–¥—É–∫—Ç—ã)2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —Å–ø—Ä–∞–≤–∫–∞, –¥–µ–π—Å—Ç–≤–∏–µ)3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–ø–µ—Ä–∏–æ–¥—ã, —Ñ–∏–ª—å—Ç—Ä—ã, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)4. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ—Ç—á–µ—Ç, –≥—Ä–∞—Ñ–∏–∫, —Ç–∞–±–ª–∏—Ü–∞)–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `MetadataExtractor`–ê–≥–µ–Ω—Ç –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.pythonCopyDownloadfrom langsmith import traceable\nfrom gigachain import GigaChatModel\nimport logging\nimport config\nimport re\nimport json\nfrom typing import Dict, List, Optional, Tuple\nfrom datetime import datetime\n\nclass MetadataExtractor:\n    def __init__(self):\n        self.logger = logging.getLogger(\"metadata_extractor\")\n        self.llm = GigaChatModel(\n            model=\"GigaChat-Plus\",\n            temperature=0.3,\n            api_key=config.GIGACHAT_API_KEY,\n            max_tokens=500\n        )\n        self.entity_patterns = self._load_entity_patterns()\n        self.cache = {}\n        \n    @traceable\n    def extract_metadata(self, user_query: str, user_context: Dict) -> Dict:\n        \"\"\"\n        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞\n        :param user_query: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        :param user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–æ–ª—å, –∏—Å—Ç–æ—Ä–∏—è –∏ —Ç.–¥.)\n        :return: –°–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏\n        \"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞\n        cache_key = f\"{user_query}-{user_context.get('user_id','')}\"\n        if cache_key in self.cache:\n            return self.cache[cache_key]\n        \n        try:\n            # –ë—ã—Å—Ç—Ä–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –ø—Ä–∞–≤–∏–ª\n            quick_metadata = self._quick_extraction(user_query)\n            \n            # –£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n            if self._needs_deep_analysis(user_query, quick_metadata):\n                metadata = self._deep_analysis(user_query, user_context)\n            else:\n                metadata = quick_metadata\n                \n            # –û–±–æ–≥–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏\n            metadata.update({\n                \"extraction_method\": \"deep\" if \"deep\" in metadata else \"quick\",\n                \"user_role\": user_context.get(\"role\", \"unknown\"),\n                \"timestamp\": datetime.now().isoformat()\n            })\n            \n            # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\n            self.cache[cache_key] = metadata\n            return metadata\n            \n        except Exception as e:\n            self.logger.error(f\"Metadata extraction failed: {str(e)}\")\n            return self._fallback_metadata(user_query)\n\n    def _quick_extraction(self, query: str) -> Dict:\n        \"\"\"–ë—ã—Å—Ç—Ä–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é –ø—Ä–∞–≤–∏–ª\"\"\"\n        metadata = {\n            \"entities\": [],\n            \"intent\": \"unknown\",\n            \"parameters\": {},\n            \"content_type\": \"text\"\n        }\n        \n        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞—Ç\n        date_matches = re.findall(r\"\\b\\d{2}\\.\\d{2}\\.\\d{4}\\b|\\b\\d{4}-\\d{2}-\\d{2}\\b\", query)\n        if date_matches:\n            metadata[\"parameters\"][\"dates\"] = date_matches\n            metadata[\"entities\"].append(\"date\")\n        \n        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∏—Å–µ–ª\n        number_matches = re.findall(r\"\\b\\d+\\b\", query)\n        if number_matches:\n            metadata[\"parameters\"][\"numbers\"] = list(map(int, number_matches))\n            metadata[\"entities\"].append(\"number\")\n        \n        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞\n        if any(word in query.lower() for word in [\"–≥—Ä–∞—Ñ–∏–∫\", \"–¥–∏–∞–≥—Ä–∞–º\", \"–≤–∏–∑—É–∞–ª–∏–∑\"]):\n            metadata[\"content_type\"] = \"chart\"\n        elif any(word in query.lower() for word in [\"—Ç–∞–±–ª–∏—Ü\", \"—Å–ø–∏—Å–æ–∫\", \"–ø–µ—Ä–µ—á–µ–Ω—å\"]):\n            metadata[\"content_type\"] = \"table\"\n        elif any(word in query.lower() for word in [\"–æ—Ç—á–µ—Ç\", \"–¥–æ–∫—É–º–µ–Ω—Ç\", \"—Ñ–∞–π–ª\"]):\n            metadata[\"content_type\"] = \"report\"\n        \n        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è\n        if any(word in query.lower() for word in [\"–ø–æ–∫–∞–∂–∏\", \"–≤—ã–≤–µ–¥–∏\", \"–æ—Ç–æ–±—Ä–∞–∑\"]):\n            metadata[\"intent\"] = \"show_data\"\n        elif any(word in query.lower() for word in [\"—Å—Ä–∞–≤–Ω–∏\", \"–ø—Ä–æ—Ç–∏–≤\", \"vs\"]):\n            metadata[\"intent\"] = \"compare\"\n        elif any(word in query.lower() for word in [\"–∞–Ω–∞–ª–∏–∑\", \"—Ç—Ä–µ–Ω–¥\", \"–¥–∏–Ω–∞–º–∏–∫\"]):\n            metadata[\"intent\"] = \"analyze\"\n        elif any(word in query.lower() for word in [\"–ø–æ—á–µ–º—É\", \"–ø—Ä–∏—á–∏–Ω–∞\", \"–æ–±—ä—è—Å–Ω–∏\"]):\n            metadata[\"intent\"] = \"explain\"\n            \n        return metadata\n\n    def _needs_deep_analysis(self, query: str, quick_metadata: Dict) -> bool:\n        \"\"\"–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ —É–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑\"\"\"\n        # –ï—Å–ª–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ\n        if quick_metadata[\"intent\"] == \"unknown\":\n            return True\n            \n        # –ï—Å–ª–∏ –µ—Å—Ç—å —á–∏—Å–ª–∞, –Ω–æ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n        if \"numbers\" in quick_metadata[\"parameters\"] and not quick_metadata[\"entities\"]:\n            return True\n            \n        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –¥–ª–∏–Ω–Ω—ã–π (–±–æ–ª–µ–µ 7 —Å–ª–æ–≤)\n        if len(query.split()) > 7:\n            return True\n            \n        return False\n\n    def _deep_analysis(self, query: str, context: Dict) -> Dict:\n        \"\"\"–£–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø–æ–º–æ—â—å—é LLM\"\"\"\n        prompt = f\"\"\"–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—é –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n        \n### –ó–∞–ø—Ä–æ—Å:\n{query}\n\n### –ö–æ–Ω—Ç–µ–∫—Å—Ç:\n- –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {context.get('role', 'unknown')}\n- –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {datetime.now().strftime('%Y-%m-%d')}\n\n### –ó–∞–¥–∞—á–∞:\n–ò–∑–≤–ª–µ–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:\n1. entities: —Å–ø–∏—Å–æ–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, [\"–¥–∞—Ç–∞\", \"–ø—Ä–æ–¥—É–∫—Ç\", \"—Ä–µ–≥–∏–æ–Ω\"])\n2. intent: –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ (show_data, compare, analyze, explain, request_help)\n3. parameters: —Å–ª–æ–≤–∞—Ä—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ({{\"date_range\": [\"2023-01-01\", \"2023-12-31\"], \"metrics\": [\"–ø—Ä–æ–¥–∞–∂–∏\"]}})\n4. content_type: —Ç–∏–ø –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (text, table, chart, report)\n5. urgency: —Å—Ä–æ—á–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ (low, medium, high)\n\n### –ü—Ä–∏–º–µ—Ä:\n–ó–∞–ø—Ä–æ—Å: \"–ü–æ–∫–∞–∂–∏ –ø—Ä–æ–¥–∞–∂–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –≤ –ú–æ—Å–∫–≤–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü\"\n–û—Ç–≤–µ—Ç: {{\n  \"entities\": [\"–ø—Ä–æ–¥—É–∫—Ç\", \"—Ä–µ–≥–∏–æ–Ω\", \"–¥–∞—Ç–∞\"],\n  \"intent\": \"show_data\",\n  \"parameters\": {{\"product\": \"—Ç–µ–ª–µ—Ñ–æ–Ω—ã\", \"region\": \"–ú–æ—Å–∫–≤–∞\", \"period\": \"last_month\"}},\n  \"content_type\": \"table\",\n  \"urgency\": \"medium\"\n}}\n\"\"\"\n        response = self.llm.generate(prompt, response_format=\"json\")\n        metadata = json.loads(response)\n        \n        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞\n        metadata[\"deep_analysis\"] = True\n        return metadata\n\n    def _load_entity_patterns(self) -> Dict[str, List[str]]:\n        \"\"\"–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π\"\"\"\n        return {\n            \"date\": [\n                r\"\\b\\d{2}\\.\\d{2}\\.\\d{4}\\b\",  # DD.MM.YYYY\n                r\"\\b\\d{4}-\\d{2}-\\d{2}\\b\",     # YYYY-MM-DD\n                r\"\\b(?:–∫–≤–∞—Ä—Ç–∞–ª|–º–µ—Å—è—Ü|–Ω–µ–¥–µ–ª[—è—é]|–≥–æ–¥)[–∞-—è]*\\b\",\n                r\"\\b–ø–æ—Å–ª–µ–¥–Ω\\w+ \\d+ (?:–¥–Ω[–µ—è]|–º–µ—Å—è—Ü|–Ω–µ–¥–µ–ª)\\b\"\n            ],\n            \"product\": [\n                r\"\\b—Ç–µ–ª–µ—Ñ–æ–Ω\\w*\\b\",\n                r\"\\b–Ω–æ—É—Ç–±—É–∫\\w*\\b\",\n                r\"\\b–ø—Ä–æ–¥—É–∫—Ç\\w*\\b\",\n                r\"\\b—Ç–æ–≤–∞—Ä\\w*\\b\"\n            ],\n            \"region\": [\n                r\"\\b–ú–æ—Å–∫–≤\\w*\\b\",\n                r\"\\b–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥\\w*\\b\",\n                r\"\\b—Ä–µ–≥–∏–æ–Ω\\w*\\b\",\n                r\"\\b–≥–æ—Ä–æ–¥\\w*\\b\"\n            ],\n            \"metric\": [\n                r\"\\b–ø—Ä–æ–¥–∞–∂\\w*\\b\",\n                r\"\\b–¥–æ—Ö–æ–¥\\w*\\b\",\n                r\"\\b–ø—Ä–∏–±—ã–ª\\w*\\b\",\n                r\"\\b–∫–æ–Ω–≤–µ—Ä—Å–∏\\w*\\b\"\n            ]\n        }\n\n    def _fallback_metadata(self, query: str) -> Dict:\n        \"\"\"–§–æ–ª–±—ç–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏–∑–≤–ª–µ—á–µ–Ω–∏—è\"\"\"\n        return {\n            \"entities\": [],\n            \"intent\": \"unknown\",\n            \"parameters\": {},\n            \"content_type\": \"text\",\n            \"urgency\": \"medium\",\n            \"error\": \"extraction_failed\"\n        }\n\n    def extract_from_history(self, history: List[Dict]) -> Dict:\n        \"\"\"–ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞\"\"\"\n        last_three = [msg[\"content\"] for msg in history[-3:]]\n        context = \" | \".join(last_three)\n        \n        prompt = f\"\"\"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –∏ –∏–∑–≤–ª–µ–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:\n        \n–ò—Å—Ç–æ—Ä–∏—è:\n{context}\n\n–°—Ñ–æ—Ä–º–∏—Ä—É–π JSON —Å –ø–æ–ª—è–º–∏:\n- main_topic: –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ –¥–∏–∞–ª–æ–≥–∞\n- pending_actions: —Å–ø–∏—Å–æ–∫ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π\n- user_preferences: –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\"\"\"\n        response = self.llm.generate(prompt, response_format=\"json\")\n        return json.loads(response)\n\n    def update_entity_patterns(self, entity_type: str, patterns: List[str]):\n        \"\"\"–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π\"\"\"\n        if entity_type not in self.entity_patterns:\n            self.entity_patterns[entity_type] = []\n            \n        self.entity_patterns[entity_type].extend(patterns)\n        self.logger.info(f\"Updated patterns for {entity_type}\")\n\n    def clear_cache(self):\n        \"\"\"–û—á–∏—â–∞–µ—Ç –∫–µ—à –∏–∑–≤–ª–µ—á–µ–Ω–∏—è\"\"\"\n        self.cache = {}\n        self.logger.info(\"Metadata cache cleared\")–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.py`)pythonCopyDownload# config.py\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ LLM\nGIGACHAT_API_KEY = \"–≤–∞—à_api_–∫–ª—é—á\"\n\n# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è\nMAX_CACHE_SIZE = 1000\nENTITY_PATTERNS = {\n    \"client\": [r\"\\b–∫–ª–∏–µ–Ω—Ç\\w*\\b\", r\"\\b–∑–∞–∫–∞–∑—á–∏–∫\\w*\\b\"],\n    \"project\": [r\"\\b–ø—Ä–æ–µ–∫—Ç\\w*\\b\", r\"\\b–∑–∞–¥–∞—á\\w*\\b\"]\n}–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—èpythonCopyDownload# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞\nextractor = MetadataExtractor()\n\n# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞\nquery = \"–ü–æ–∫–∞–∂–∏ –¥–∏–Ω–∞–º–∏–∫—É –ø—Ä–æ–¥–∞–∂ –Ω–æ—É—Ç–±—É–∫–æ–≤ –≤ –ú–æ—Å–∫–≤–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞ –≤ –≤–∏–¥–µ –≥—Ä–∞—Ñ–∏–∫–∞\"\n\n# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö\nmetadata = extractor.extract_metadata(query, {\"role\": \"analyst\"})\n\nprint(json.dumps(metadata, indent=2, ensure_ascii=False))–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞jsonCopyDownload{\n  \"entities\": [\"–ø—Ä–æ–¥—É–∫—Ç\", \"—Ä–µ–≥–∏–æ–Ω\", \"–¥–∞—Ç–∞\", \"–º–µ—Ç—Ä–∏–∫–∞\"],\n  \"intent\": \"show_data\",\n  \"parameters\": {\n    \"product\": \"–Ω–æ—É—Ç–±—É–∫–∏\",\n    \"region\": \"–ú–æ—Å–∫–≤–∞\",\n    \"period\": \"last_3_months\",\n    \"metric\": \"–ø—Ä–æ–¥–∞–∂–∏\"\n  },\n  \"content_type\": \"chart\",\n  \"urgency\": \"medium\",\n  \"extraction_method\": \"deep\",\n  \"user_role\": \"analyst\",\n  \"timestamp\": \"2023-10-25T14:30:45.123456\"\n}–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ:pythonCopyDownloaddef extract_metadata(self, user_query: str, user_context: Dict) -> Dict:\n    # 1. –ë—ã—Å—Ç—Ä–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º\n    # 2. –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏–¢–∏–ø—ã –∏–∑–≤–ª–µ–∫–∞–µ–º—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:–°—É—â–Ω–æ—Å—Ç–∏: –ü—Ä–æ–¥—É–∫—Ç—ã, —Ä–µ–≥–∏–æ–Ω—ã, –¥–∞—Ç—ã, –º–µ—Ç—Ä–∏–∫–∏–ù–∞–º–µ—Ä–µ–Ω–∏–µ: –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, —Å—Ä–∞–≤–Ω–∏—Ç—å, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–¥–∞—Ç—ã, —á–∏—Å–ª–∞, —Ñ–∏–ª—å—Ç—Ä—ã)–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: –¢–∞–±–ª–∏—Ü–∞, –≥—Ä–∞—Ñ–∏–∫, –æ—Ç—á–µ—Ç–°—Ä–æ—á–Ω–æ—Å—Ç—å: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:–£—á–µ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞–£—á–µ—Ç —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã–ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è:pythonCopyDownloaddef update_entity_patterns(self, entity_type: str, patterns: List[str]):\n    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤–†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–∞:pythonCopyDownloaddef extract_from_history(self, history: List[Dict]) -> Dict:\n    # –í—ã—è–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º—ã\n    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π\n    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ãDiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-19{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-19 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-19 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-19 .error-icon{fill:#a44141;}#mermaid-svg-19 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-19 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-19 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-19 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-19 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-19 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-19 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-19 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-19 .marker.cross{stroke:lightgrey;}#mermaid-svg-19 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-19 p{margin:0;}#mermaid-svg-19 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-19 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-19 .cluster-label span{color:#F9FFFE;}#mermaid-svg-19 .cluster-label span p{background-color:transparent;}#mermaid-svg-19 .label text,#mermaid-svg-19 span{fill:#ccc;color:#ccc;}#mermaid-svg-19 .node rect,#mermaid-svg-19 .node circle,#mermaid-svg-19 .node ellipse,#mermaid-svg-19 .node polygon,#mermaid-svg-19 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-19 .rough-node .label text,#mermaid-svg-19 .node .label text,#mermaid-svg-19 .image-shape .label,#mermaid-svg-19 .icon-shape .label{text-anchor:middle;}#mermaid-svg-19 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-19 .rough-node .label,#mermaid-svg-19 .node .label,#mermaid-svg-19 .image-shape .label,#mermaid-svg-19 .icon-shape .label{text-align:center;}#mermaid-svg-19 .node.clickable{cursor:pointer;}#mermaid-svg-19 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-19 .arrowheadPath{fill:lightgrey;}#mermaid-svg-19 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-19 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-19 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-19 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-19 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-19 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-19 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-19 .cluster text{fill:#F9FFFE;}#mermaid-svg-19 .cluster span{color:#F9FFFE;}#mermaid-svg-19 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-19 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-19 rect.text{fill:none;stroke-width:0;}#mermaid-svg-19 .icon-shape,#mermaid-svg-19 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-19 .icon-shape p,#mermaid-svg-19 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-19 .icon-shape rect,#mermaid-svg-19 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-19 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–ó–∞–ø—Ä–æ—Å–ë—ã—Å—Ç—Ä–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–í–æ–∑–≤—Ä–∞—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ LLM–û–±–æ–≥–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ì–∏–±–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π:pythonCopyDownload_entity_patterns = {\n    \"date\": [r\"\\b\\d{2}\\.\\d{2}\\.\\d{4}\\b\", ...],\n    \"product\": [r\"\\b—Ç–µ–ª–µ—Ñ–æ–Ω\\w*\\b\", ...]\n}–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:pythonCopyDownloaddef _needs_deep_analysis(self, query: str, quick_metadata: Dict) -> bool:\n    # –ü—Ä–æ–≤–µ—Ä—è–µ—Ç:\n    # - –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ\n    # - –ß–∏—Å–ª–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞\n    # - –î–ª–∏–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã–®–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤:–ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM–ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤–£—á–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:–£–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ LLM–£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤–û–±–æ–≥–∞—â–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö:–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫–û—Ç–º–µ—Ç–∫–∞ –º–µ—Ç–æ–¥–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–æ–ª—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–ü—Ä–∏–º–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:pythonCopyDownloadquery = \"–ü–æ–∫–∞–∂–∏ –≤—ã—Ä—É—á–∫—É –ø–æ –ø—Ä–æ–µ–∫—Ç—É '–§–µ–Ω–∏–∫—Å' –∑–∞ 2023 –≥–æ–¥ –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å 2022\"\nmetadata = extractor.extract_metadata(query, {\"role\": \"manager\"})jsonCopyDownload{\n  \"entities\": [\"–ø—Ä–æ–µ–∫—Ç\", \"–¥–∞—Ç–∞\", \"–º–µ—Ç—Ä–∏–∫–∞\"],\n  \"intent\": \"compare\",\n  \"parameters\": {\n    \"project\": \"–§–µ–Ω–∏–∫—Å\",\n    \"metric\": \"–≤—ã—Ä—É—á–∫–∞\",\n    \"year\": [2022, 2023]\n  },\n  \"content_type\": \"table\",\n  \"urgency\": \"high\"\n}–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å:pythonCopyDownloadquery = \"–û–±—ä—è—Å–Ω–∏ –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ –≤ –º–∞–µ 2023 –≥–æ–¥–∞\"\nmetadata = extractor.extract_metadata(query, {\"role\": \"analyst\"})jsonCopyDownload{\n  \"entities\": [\"–¥–∞—Ç–∞\", \"–º–µ—Ç—Ä–∏–∫–∞\"],\n  \"intent\": \"explain\",\n  \"parameters\": {\n    \"metric\": \"–ø—Ä–æ–¥–∞–∂–∏\",\n    \"period\": \"–º–∞–π 2023\",\n    \"trend\": \"–ø–∞–¥–µ–Ω–∏–µ\"\n  },\n  \"content_type\": \"text\",\n  \"urgency\": \"medium\"\n}–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å:pythonCopyDownloadquery = \"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç—á–µ—Ç –ø–æ –æ—à–∏–±–∫–∞–º API –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é\"\nmetadata = extractor.extract_metadata(query, {\"role\": \"developer\"})jsonCopyDownload{\n  \"entities\": [\"—Å–∏—Å—Ç–µ–º–∞\", \"–¥–∞—Ç–∞\"],\n  \"intent\": \"generate_report\",\n  \"parameters\": {\n    \"system\": \"API\",\n    \"issue_type\": \"–æ—à–∏–±–∫–∏\",\n    \"period\": \"last_week\"\n  },\n  \"content_type\": \"report\",\n  \"urgency\": \"high\"\n}–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:–¢–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π–í—ã—è–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω—ã—Ö –Ω—é–∞–Ω—Å–æ–≤–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã:–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ LLM–£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∏–ø–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤–ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è —Å—Ä–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å:–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã —Å—É—â–Ω–æ—Å—Ç–µ–π–ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –¥–æ–º–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏–≠—Ç–æ—Ç –∞–≥–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∏–∑–≤–ª–µ–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Ç–æ—á–Ω–æ–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏."
  },
  {
    "role": "user",
    "content": "—Ç–µ–ø–µ—Ä—å monitoring"
  },
  {
    "role": "assistant",
    "content": "ÊÄùËÄÉÔºö–ú—ã —Å–æ–∑–¥–∞–¥–∏–º `MonitoringService` - —Å–µ—Ä–≤–∏—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã, —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞.–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:1. –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU, –ø–∞–º—è—Ç–∏ –∏ —Ç.–¥.)2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Prometheus, Grafana)4. –ê–ª–µ—Ä—Ç–∏–Ω–≥ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö–†–µ–∞–ª–∏–∑—É–µ–º –∫–ª–∞—Å—Å —Å –º–µ—Ç–æ–¥–∞–º–∏:- record_metric: –∑–∞–ø–∏—Å—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –º–µ—Ç—Ä–∏–∫–∏- log_error: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏- check_system_health: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã- send_alert: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞- generate_report: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è.–í —Ü–µ–ª—è—Ö –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º:- Prometheus –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ (—á–µ—Ä–µ–∑ prometheus_client)- Sentry –¥–ª—è –æ—à–∏–±–æ–∫ (—á–µ—Ä–µ–∑ sentry_sdk)- Telegram –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤–ï—Å–ª–∏ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫–∏.–£—Å—Ç–∞–Ω–æ–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:pip install prometheus_client sentry_sdk requests–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –±—Ä–∞—Ç—å—Å—è –∏–∑ config.py.–†–µ–∞–ª–∏–∑–∞—Ü–∏—è `MonitoringService`–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–ª–µ—Ä—Ç–æ–≤. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å–æ –≤—Å–µ–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã –∏ –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏.pythonCopyDownloadimport logging\nimport psutil\nimport requests\nimport time\nimport json\nimport threading\nimport socket\nfrom datetime import datetime, timedelta\nfrom typing import Dict, List, Optional, Tuple\n\nclass MonitoringService:\n    def __init__(self):\n        self.logger = logging.getLogger(\"monitoring_service\")\n        self.metrics = {}\n        self.health_status = {}\n        self.alert_rules = self._load_alert_rules()\n        self.last_report_time = datetime.now()\n        self.silenced_alerts = {}\n        self.system_start_time = datetime.now()\n        \n    def start(self):\n        \"\"\"–ó–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞\"\"\"\n        self.logger.info(\"Starting monitoring service\")\n        \n        # –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á\n        threading.Thread(target=self._system_metrics_collector, daemon=True).start()\n        threading.Thread(target=self._alert_checker, daemon=True).start()\n        threading.Thread(target=self._report_generator, daemon=True).start()\n        \n    def record_metric(self, component: str, name: str, value: float, tags: Dict = None):\n        \"\"\"\n        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n        :param component: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (agent, service)\n        :param name: –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (response_time, error_rate)\n        :param value: –ó–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏\n        :param tags: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–≥–∏ ({\"endpoint\": \"/query\", \"status\": \"200\"})\n        \"\"\"\n        metric_key = f\"{component}.{name}\"\n        if metric_key not in self.metrics:\n            self.metrics[metric_key] = {\n                \"values\": [],\n                \"timestamps\": [],\n                \"tags\": tags or {}\n            }\n            \n        self.metrics[metric_key][\"values\"].append(value)\n        self.metrics[metric_key][\"timestamps\"].append(datetime.now())\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–Ω–∞—á–µ–Ω–∏–π\n        if len(self.metrics[metric_key][\"values\"]) > 100:\n            self.metrics[metric_key][\"values\"].pop(0)\n            self.metrics[metric_key][\"timestamps\"].pop(0)\n    \n    def log_error(self, component: str, error_type: str, message: str, details: Dict = None):\n        \"\"\"\n        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É\n        :param component: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã\n        :param error_type: –¢–∏–ø –æ—à–∏–±–∫–∏ (critical, warning, info)\n        :param message: –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏\n        :param details: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏\n        \"\"\"\n        error_key = f\"{component}.{error_type}\"\n        if error_key not in self.metrics:\n            self.metrics[error_key] = {\n                \"count\": 0,\n                \"last_occurrence\": None,\n                \"messages\": []\n            }\n            \n        self.metrics[error_key][\"count\"] += 1\n        self.metrics[error_key][\"last_occurrence\"] = datetime.now()\n        self.metrics[error_key][\"messages\"].append({\n            \"timestamp\": datetime.now().isoformat(),\n            \"message\": message,\n            \"details\": details or {}\n        })\n        \n        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π\n        if len(self.metrics[error_key][\"messages\"]) > 20:\n            self.metrics[error_key][\"messages\"].pop(0)\n            \n        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞\n        if error_type == \"critical\":\n            self.health_status[component] = \"critical\"\n        elif error_type == \"warning\" and self.health_status.get(component) != \"critical\":\n            self.health_status[component] = \"warning\"\n            \n        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞\n        self._evaluate_alert_rules(component, error_type, message)\n    \n    def register_health_check(self, component: str, check_func: callable):\n        \"\"\"\n        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞\n        :param component: –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞\n        :param check_func: –§—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è (status: str, details: dict)\n        \"\"\"\n        self.health_status[component] = {\n            \"check_func\": check_func,\n            \"last_check\": None,\n            \"last_status\": \"unknown\",\n            \"last_details\": {}\n        }\n    \n    def get_system_health(self) -> Dict[str, str]:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\"\"\"\n        return {comp: data[\"last_status\"] for comp, data in self.health_status.items()}\n    \n    def get_metrics(self, component: str = None, name: str = None) -> Dict:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É\"\"\"\n        if component and name:\n            return self.metrics.get(f\"{component}.{name}\", {})\n        elif component:\n            return {k: v for k, v in self.metrics.items() if k.startswith(f\"{component}.\")}\n        return self.metrics\n    \n    def silence_alert(self, alert_id: str, duration_minutes: int = 60):\n        \"\"\"\n        –û—Ç–∫–ª—é—á–∞–µ—Ç –∞–ª–µ—Ä—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è\n        :param alert_id: ID –∞–ª–µ—Ä—Ç–∞\n        :param duration_minutes: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö\n        \"\"\"\n        self.silenced_alerts[alert_id] = datetime.now() + timedelta(minutes=duration_minutes)\n        self.logger.info(f\"Alert {alert_id} silenced for {duration_minutes} minutes\")\n    \n    def _system_metrics_collector(self):\n        \"\"\"–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Å–±–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫\"\"\"\n        while True:\n            try:\n                # CPU\n                cpu_percent = psutil.cpu_percent(interval=1)\n                self.record_metric(\"system\", \"cpu_usage\", cpu_percent)\n                \n                # Memory\n                memory = psutil.virtual_memory()\n                self.record_metric(\"system\", \"memory_usage\", memory.percent)\n                self.record_metric(\"system\", \"memory_used_gb\", memory.used / (1024**3))\n                \n                # Disk\n                disk = psutil.disk_usage('/')\n                self.record_metric(\"system\", \"disk_usage\", disk.percent)\n                \n                # Network\n                net_io = psutil.net_io_counters()\n                self.record_metric(\"system\", \"network_sent_mb\", net_io.bytes_sent / (1024**2))\n                self.record_metric(\"system\", \"network_recv_mb\", net_io.bytes_recv / (1024**2))\n                \n                # Process count\n                process_count = len(psutil.pids())\n                self.record_metric(\"system\", \"process_count\", process_count)\n                \n                # Uptime\n                uptime = (datetime.now() - self.system_start_time).total_seconds()\n                self.record_metric(\"system\", \"uptime_seconds\", uptime)\n                \n            except Exception as e:\n                self.logger.error(f\"System metrics collection failed: {str(e)}\")\n                \n            time.sleep(60)\n    \n    def _alert_checker(self):\n        \"\"\"–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–ª–µ—Ä—Ç-–ø—Ä–∞–≤–∏–ª\"\"\"\n        while True:\n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\n            for component, data in self.health_status.items():\n                if callable(data.get(\"check_func\")):\n                    try:\n                        status, details = data[\"check_func\"]()\n                        data[\"last_status\"] = status\n                        data[\"last_details\"] = details\n                        data[\"last_check\"] = datetime.now()\n                        \n                        if status == \"critical\":\n                            self._trigger_alert(\n                                f\"{component}_health_critical\",\n                                f\"Component {component} is in critical state\",\n                                details\n                            )\n                        elif status == \"warning\":\n                            self._trigger_alert(\n                                f\"{component}_health_warning\",\n                                f\"Component {component} is in warning state\",\n                                details\n                            )\n                            \n                    except Exception as e:\n                        self.logger.error(f\"Health check for {component} failed: {str(e)}\")\n            \n            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º\n            for rule in self.alert_rules:\n                if self._should_check_rule(rule):\n                    value = self._get_metric_value(rule[\"metric\"])\n                    if value is not None and self._evaluate_condition(value, rule[\"condition\"], rule[\"threshold\"]):\n                        self._trigger_alert(\n                            rule[\"id\"],\n                            rule[\"message\"],\n                            {\n                                \"metric\": rule[\"metric\"],\n                                \"value\": value,\n                                \"threshold\": rule[\"threshold\"]\n                            }\n                        )\n            \n            time.sleep(30)\n    \n    def _report_generator(self):\n        \"\"\"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤\"\"\"\n        while True:\n            try:\n                now = datetime.now()\n                if now - self.last_report_time > timedelta(hours=1):\n                    self._generate_hourly_report()\n                    self.last_report_time = now\n                    \n                time.sleep(60)\n            except Exception as e:\n                self.logger.error(f\"Report generation failed: {str(e)}\")\n    \n    def _trigger_alert(self, alert_id: str, message: str, details: Dict):\n        \"\"\"–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∞–ª–µ—Ä—Ç, –µ—Å–ª–∏ –æ–Ω –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω\"\"\"\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–ª—É—à–∫–∏\n        if alert_id in self.silenced_alerts and datetime.now() < self.silenced_alerts[alert_id]:\n            return\n            \n        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞\n        self._send_alert(alert_id, message, details)\n        \n        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ\n        self.logger.warning(f\"ALERT: {alert_id} - {message}\")\n        self.log_error(\"monitoring\", \"alert\", message, details)\n        \n        # –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ñ–ª—É–¥–∞\n        self.silenced_alerts[alert_id] = datetime.now() + timedelta(minutes=5)\n    \n    def _send_alert(self, alert_id: str, message: str, details: Dict):\n        \"\"\"–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ª–µ—Ä—Ç –≤–æ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã\"\"\"\n        # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram\n        if config.TELEGRAM_ALERTS_ENABLED:\n            try:\n                text = f\"üö® *{alert_id}*\\n{message}\\n\\n\"\n                text += \"```json\\n\" + json.dumps(details, indent=2) + \"\\n```\"\n                \n                requests.post(\n                    f\"https://api.telegram.org/bot{config.TELEGRAM_BOT_TOKEN}/sendMessage\",\n                    json={\n                        \"chat_id\": config.TELEGRAM_ALERT_CHAT_ID,\n                        \"text\": text,\n                        \"parse_mode\": \"Markdown\"\n                    }\n                )\n            except Exception as e:\n                self.logger.error(f\"Failed to send Telegram alert: {str(e)}\")\n        \n        # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Slack\n        if config.SLACK_ALERTS_ENABLED:\n            try:\n                requests.post(\n                    config.SLACK_WEBHOOK_URL,\n                    json={\n                        \"text\": f\":fire: {alert_id}\",\n                        \"blocks\": [\n                            {\n                                \"type\": \"section\",\n                                \"text\": {\"type\": \"mrkdwn\", \"text\": f\"*{alert_id}*\\n{message}\"}\n                            },\n                            {\n                                \"type\": \"section\",\n                                \"text\": {\"type\": \"mrkdwn\", \"text\": f\"```{json.dumps(details, indent=2)}```\"}\n                            }\n                        ]\n                    }\n                )\n            except Exception as e:\n                self.logger.error(f\"Failed to send Slack alert: {str(e)}\")\n        \n        # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Email (–∑–∞–≥–ª—É—à–∫–∞)\n        if config.EMAIL_ALERTS_ENABLED:\n            self.logger.info(f\"Email alert would be sent: {alert_id} - {message}\")\n    \n    def _generate_hourly_report(self):\n        \"\"\"–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–∞—Å–æ–≤–æ–π –æ—Ç—á–µ—Ç\"\"\"\n        report = {\n            \"timestamp\": datetime.now().isoformat(),\n            \"uptime\": str(datetime.now() - self.system_start_time),\n            \"health_status\": self.get_system_health(),\n            \"top_metrics\": {}\n        }\n        \n        # –°–±–æ—Ä —Ç–æ–ø-–º–µ—Ç—Ä–∏–∫\n        for metric, data in self.metrics.items():\n            if data.get(\"values\"):\n                report[\"top_metrics\"][metric] = {\n                    \"last\": data[\"values\"][-1],\n                    \"avg\": sum(data[\"values\"]) / len(data[\"values\"]),\n                    \"min\": min(data[\"values\"]),\n                    \"max\": max(data[\"values\"])\n                }\n        \n        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞\n        if config.REPORTING_ENABLED:\n            try:\n                # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª\n                with open(f\"reports/system_report_{datetime.now().strftime('%Y%m%d_%H%M')}.json\", \"w\") as f:\n                    json.dump(report, f, indent=2)\n                \n                # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)\n                if config.TELEGRAM_REPORTS_ENABLED:\n                    text = f\"üìä *System Report*\\nUptime: {report['uptime']}\\n\"\n                    text += f\"Health: {', '.join([f'{k}:{v}' for k, v in report['health_status'].items()])}\"\n                    \n                    requests.post(\n                        f\"https://api.telegram.org/bot{config.TELEGRAM_BOT_TOKEN}/sendMessage\",\n                        json={\n                            \"chat_id\": config.TELEGRAM_REPORT_CHAT_ID,\n                            \"text\": text,\n                            \"parse_mode\": \"Markdown\"\n                        }\n                    )\n                    \n            except Exception as e:\n                self.logger.error(f\"Failed to generate report: {str(e)}\")\n    \n    def _load_alert_rules(self) -> List[Dict]:\n        \"\"\"–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–ª–µ—Ä—Ç–æ–≤\"\"\"\n        return [\n            {\n                \"id\": \"high_cpu\",\n                \"metric\": \"system.cpu_usage\",\n                \"condition\": \">\",\n                \"threshold\": 90,\n                \"message\": \"High CPU usage detected\",\n                \"interval\": 300\n            },\n            {\n                \"id\": \"high_memory\",\n                \"metric\": \"system.memory_usage\",\n                \"condition\": \">\",\n                \"threshold\": 90,\n                \"message\": \"High memory usage detected\",\n                \"interval\": 300\n            },\n            {\n                \"id\": \"high_error_rate\",\n                \"metric\": \"system.error_rate\",\n                \"condition\": \">\",\n                \"threshold\": 10,\n                \"message\": \"High error rate detected\",\n                \"interval\": 600\n            },\n            {\n                \"id\": \"component_down\",\n                \"metric\": \"health_status\",\n                \"condition\": \"==\",\n                \"threshold\": \"critical\",\n                \"message\": \"Critical component failure\",\n                \"interval\": 60\n            }\n        ]\n    \n    def _should_check_rule(self, rule: Dict) -> bool:\n        \"\"\"–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Å–µ–π—á–∞—Å\"\"\"\n        last_trigger = self.metrics.get(f\"alerts.{rule['id']}\", {}).get(\"last_trigger\")\n        if last_trigger and (datetime.now() - last_trigger).total_seconds() < rule[\"interval\"]:\n            return False\n        return True\n    \n    def _get_metric_value(self, metric_name: str) -> Optional[float]:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏\"\"\"\n        if metric_name == \"health_status\":\n            # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è\n            return \"ok\" if all(s == \"ok\" for s in self.get_system_health().values()) else \"warning\"\n        \n        metric_data = self.metrics.get(metric_name)\n        if metric_data and \"values\" in metric_data and metric_data[\"values\"]:\n            return metric_data[\"values\"][-1]\n        return None\n    \n    def _evaluate_condition(self, value, condition: str, threshold) -> bool:\n        \"\"\"–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –∞–ª–µ—Ä—Ç–∞\"\"\"\n        try:\n            if condition == \">\":\n                return value > threshold\n            elif condition == \">=\":\n                return value >= threshold\n            elif condition == \"<\":\n                return value < threshold\n            elif condition == \"<=\":\n                return value <= threshold\n            elif condition == \"==\":\n                return value == threshold\n            elif condition == \"!=\":\n                return value != threshold\n            return False\n        except TypeError:\n            return False\n    \n    def add_custom_alert_rule(self, rule: Dict):\n        \"\"\"–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞\"\"\"\n        self.alert_rules.append(rule)\n        self.logger.info(f\"Added custom alert rule: {rule['id']}\")\n    \n    def get_service_info(self) -> Dict:\n        \"\"\"–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–∏—Å–µ –¥–ª—è health-check\"\"\"\n        return {\n            \"status\": \"running\",\n            \"start_time\": self.system_start_time.isoformat(),\n            \"components_monitored\": list(self.health_status.keys()),\n            \"metrics_collected\": list(self.metrics.keys())\n        }\n\n\n# –ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ health-check –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\ndef sql_generator_health_check() -> Tuple[str, Dict]:\n    \"\"\"–ü—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –¥–ª—è SQLGenerator\"\"\"\n    try:\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ LLM\n        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å—Ö–µ–º—ã –ë–î\n        return \"ok\", {\"details\": \"All dependencies available\"}\n    except Exception as e:\n        return \"critical\", {\"error\": str(e)}–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`config.py`)pythonCopyDownload# config.py\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞\nTELEGRAM_ALERTS_ENABLED = True\nTELEGRAM_BOT_TOKEN = \"your_telegram_bot_token\"\nTELEGRAM_ALERT_CHAT_ID = \"-123456789\"\n\nSLACK_ALERTS_ENABLED = False\nSLACK_WEBHOOK_URL = \"https://hooks.slack.com/services/...\"\n\nEMAIL_ALERTS_ENABLED = False\nEMAIL_RECIPIENTS = [\"admin@example.com\"]\n\n# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á–µ—Ç–æ–≤\nREPORTING_ENABLED = True\nTELEGRAM_REPORTS_ENABLED = True\nTELEGRAM_REPORT_CHAT_ID = \"-987654321\"\n\n# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\nALERT_SILENCE_DURATION = 60  # –º–∏–Ω—É—Ç—ã\nSYSTEM_METRICS_INTERVAL = 60  # —Å–µ–∫—É–Ω–¥—ã–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è health-check:pythonCopyDownloadmonitoring = MonitoringService()\n\n# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –¥–ª—è SQLGenerator\nmonitoring.register_health_check(\n    \"sql_generator\",\n    sql_generator_health_check\n)\n\n# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\nmonitoring.register_health_check(\n    \"auth_service\",\n    lambda: (\"ok\", {\"users\": len(auth_service.user_store)})\n)–ó–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫:pythonCopyDownload# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤\nstart_time = time.time()\n# ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ...\nprocessing_time = time.time() - start_time\n\nmonitoring.record_metric(\n    \"query_processor\",\n    \"response_time\",\n    processing_time,\n    {\"endpoint\": \"/generate_sql\", \"status\": \"200\"}\n)–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫:pythonCopyDownloadtry:\n    # –ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É\nexcept Exception as e:\n    monitoring.log_error(\n        \"data_interpreter\",\n        \"critical\",\n        \"Data analysis failed\",\n        {\"query\": user_query, \"error\": str(e)}\n    )–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫, —Å–µ—Ç—å)–ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–ª–µ—Ä—Ç–∏–Ω–≥:pythonCopyDownloadalert_rules = [\n    {\"metric\": \"system.cpu_usage\", \"condition\": \">\", \"threshold\": 90, ...}\n]–£—Å–ª–æ–≤–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫–ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–ª—É–¥–∞ (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è)–í—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞–≥–ª—É—à–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –≤ Telegram/Slack/Email–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã –≤ Telegram–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –≤ —Ñ–∞–π–ª—ã–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏:–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –∫–∞–∂–¥—ã–π —á–∞—ÅAPI –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:`record_metric()` –¥–ª—è –∑–∞–ø–∏—Å–∏ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫`log_error()` –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—à–∏–±–æ–∫`register_health_check()` –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ãDiagramCodeDownload.kvfysmfp{overflow:hidden;touch-action:none}.ufhsfnkm{transform-origin: 0 0}#mermaid-svg-44{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;fill:#ccc;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-svg-44 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-svg-44 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-svg-44 .error-icon{fill:#a44141;}#mermaid-svg-44 .error-text{fill:#ddd;stroke:#ddd;}#mermaid-svg-44 .edge-thickness-normal{stroke-width:1px;}#mermaid-svg-44 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-44 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-44 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-svg-44 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-44 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-44 .marker{fill:lightgrey;stroke:lightgrey;}#mermaid-svg-44 .marker.cross{stroke:lightgrey;}#mermaid-svg-44 svg{font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-44 p{margin:0;}#mermaid-svg-44 .label{font-family:\"trebuchet ms\",verdana,arial,sans-serif;color:#ccc;}#mermaid-svg-44 .cluster-label text{fill:#F9FFFE;}#mermaid-svg-44 .cluster-label span{color:#F9FFFE;}#mermaid-svg-44 .cluster-label span p{background-color:transparent;}#mermaid-svg-44 .label text,#mermaid-svg-44 span{fill:#ccc;color:#ccc;}#mermaid-svg-44 .node rect,#mermaid-svg-44 .node circle,#mermaid-svg-44 .node ellipse,#mermaid-svg-44 .node polygon,#mermaid-svg-44 .node path{fill:#1f2020;stroke:#ccc;stroke-width:1px;}#mermaid-svg-44 .rough-node .label text,#mermaid-svg-44 .node .label text,#mermaid-svg-44 .image-shape .label,#mermaid-svg-44 .icon-shape .label{text-anchor:middle;}#mermaid-svg-44 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-svg-44 .rough-node .label,#mermaid-svg-44 .node .label,#mermaid-svg-44 .image-shape .label,#mermaid-svg-44 .icon-shape .label{text-align:center;}#mermaid-svg-44 .node.clickable{cursor:pointer;}#mermaid-svg-44 .root .anchor path{fill:lightgrey!important;stroke-width:0;stroke:lightgrey;}#mermaid-svg-44 .arrowheadPath{fill:lightgrey;}#mermaid-svg-44 .edgePath .path{stroke:lightgrey;stroke-width:2.0px;}#mermaid-svg-44 .flowchart-link{stroke:lightgrey;fill:none;}#mermaid-svg-44 .edgeLabel{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-44 .edgeLabel p{background-color:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-44 .edgeLabel rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-44 .labelBkg{background-color:rgba(87.75, 87.75, 87.75, 0.5);}#mermaid-svg-44 .cluster rect{fill:hsl(180, 1.5873015873%, 28.3529411765%);stroke:rgba(255, 255, 255, 0.25);stroke-width:1px;}#mermaid-svg-44 .cluster text{fill:#F9FFFE;}#mermaid-svg-44 .cluster span{color:#F9FFFE;}#mermaid-svg-44 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:\"trebuchet ms\",verdana,arial,sans-serif;font-size:12px;background:hsl(20, 1.5873015873%, 12.3529411765%);border:1px solid rgba(255, 255, 255, 0.25);border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-44 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#ccc;}#mermaid-svg-44 rect.text{fill:none;stroke-width:0;}#mermaid-svg-44 .icon-shape,#mermaid-svg-44 .image-shape{background-color:hsl(0, 0%, 34.4117647059%);text-align:center;}#mermaid-svg-44 .icon-shape p,#mermaid-svg-44 .image-shape p{background-color:hsl(0, 0%, 34.4117647059%);padding:2px;}#mermaid-svg-44 .icon-shape rect,#mermaid-svg-44 .image-shape rect{opacity:0.5;background-color:hsl(0, 0%, 34.4117647059%);fill:hsl(0, 0%, 34.4117647059%);}#mermaid-svg-44 :root{--mermaid-font-family:\"trebuchet ms\",verdana,arial,sans-serif;}–ó–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫/–æ—à–∏–±–æ–∫–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ãMonitoringService–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏–°–±–æ—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–µ—Ä—Ç-–ø—Ä–∞–≤–∏–ª–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤–í–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ãTelegramSlackEmail–§–∞–π–ª–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞:–ü—Ä–∞–≤–∏–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≥–ª—É—à–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∞–ª–µ—Ä—Ç–æ–≤–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π (>, <, ==)–ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ health-check:pythonCopyDownloadregister_health_check(\"component\", check_function)–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏–í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞—Ç—É—Å–∞ –∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:–§–æ–Ω–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–Ω–∞—á–µ–Ω–∏–π)–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –ø—Ä–æ–≤–µ—Ä–∫–∏–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å:–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —á–∞—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (uptime, health status)–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º (min, max, avg)–ü—Ä–∏–º–µ—Ä –∞–ª–µ—Ä—Ç–∞ –≤ TelegramtextCopyDownloadüö® high_cpu\nHigh CPU usage detected\n\n{\n  \"metric\": \"system.cpu_usage\",\n  \"value\": 95.2,\n  \"threshold\": 90\n}–ü—Ä–∏–º–µ—Ä –æ—Ç—á–µ—Ç–∞jsonCopyDownload{\n  \"timestamp\": \"2023-10-25T14:00:00.123456\",\n  \"uptime\": \"12:34:56\",\n  \"health_status\": {\n    \"sql_generator\": \"ok\",\n    \"auth_service\": \"ok\",\n    \"data_interpreter\": \"warning\"\n  },\n  \"top_metrics\": {\n    \"system.cpu_usage\": {\"last\": 45.1, \"avg\": 32.4, \"min\": 12.2, \"max\": 95.2},\n    \"query_processor.response_time\": {\"last\": 0.45, \"avg\": 0.32, \"min\": 0.12, \"max\": 1.23}\n  }\n}–≠—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã, –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ –≤—Å–µ–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –≤—ã—è–≤–ª—è—Ç—å –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã."
  },
  {
    "role": "user",
    "content": "–∏ —Ç–µ–ø–µ—Ä—å —Å–∞–º–æ–µ–µ –≥–ª–∞–≤–Ω–æ–µ, main py –∫ —ç—Ç–æ–º—É –≤—Å–µ–º—É"
  }
]